\documentclass[a4paper,12pt]{article}

\usepackage[T2A]{fontenc}
\usepackage[cp1251]{inputenc}
\usepackage[english,russian]{babel}
\usepackage{indentfirst}
%\usepackage{amsfonts, amssymb, amsmath}
\usepackage[pdftex]{graphicx, color}
%\usepackage[all]{xy}
\usepackage[pdftex,unicode,linktocpage,colorlinks]{hyperref}
\hypersetup{
pdftitle={Язык запросов 2.0},
pdfauthor={ООО Яндекс}
%bookmarksnumbered=true
}

\extrasrussian
\pagestyle{plain}
%\righthyphenmin=2

% Modifications to the page parameters
\hoffset = -0.5in
\voffset = -0.5in
\headheight = 0pt
\headsep = 0pt
\topmargin = 15mm
\oddsidemargin = 15mm
\evensidemargin = 15mm
%\columnsep = 7mm
\textwidth = 155mm
%\textheight = 267mm
\parskip = 4pt

\definecolor{defcolor}{rgb}{0, 0, 0.5}
\newcommand\termdef{\em\color{defcolor}}

\begin{document}
\shorthandoff{"}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{Язык запросов 2.0}

\author{ООО "Яндекс"}

\maketitle

\begin{abstract}
Описан язык запросов Яндекса версии 2 и соответствующие ему алгоритмы фильтрации документов во время поиска.
Документ может быть полезен для программистов и администраторов веб-сервисов,
использующих поисковую платформу Яндекса.
\end{abstract}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Предварительные сведения}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Для полного понимания всех деталей языка запросов необходимы некоторые сведения
о структуре поискового индекса и механизме выполнения запроса, а также понимание
терминологии зон и атрибутов. Эти вопросы рассматриваются в данной секции.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Документы и словопозиции}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

В дальнейшем термин {\termdef документ} используется для обозначения предмета {\termdef поиска}.
Документ содержит сведения, нужные пользователю. Документы входят в {\termdef коллекцию документов},
которая подвергается процедуре {\termdef индексирования} для того, чтобы стал возможен поиск по этой коллекции.

Все слова, встречающиеся в коллекции документов, приводятся к своей
канонической словарной форме ({\termdef лемматизируются}).
Полученные ({\termdef леммы}) запоминаются в {\termdef индексе}
и в дальнейшем называются {\termdef ключами}.
Для каждого ключа запоминается список {\termdef словопозиций}, или просто позиций.

Каждая словопозиция ключа-леммы включает:
\begin{itemize}
\item уникальный {\termdef идентификатор документа}, приписанный ему во время индексирования;
\item номер предложения, в котором встретился ключ;
\item номер слова в предложении;
\item вес, назначенный данной позиции во время индексирования;
\item номер словоформы в списке данного ключа;
\end{itemize}
Эти данные позволяют указывать в языке запросов требуемое расстояние между словами и предложениями. 

{\footnotesize {\bf Пример.}
Типичный пример представления леммы в индексе (слова с заглавной буквы считаются отдельными формами):
\begin{verbatim}
признавать(признав,признавал,признавать,признает,Признан,признать)
    [2.20.1.1.4]
    [4.132.25.1.5]
    [4.153.26.1.1]
    [4.171.9.1.0]
    [4.171.40.1.2]
    [4.269.28.1.3]
    [13.90.3.1.5]
\end{verbatim}

}

В дополнение к словам, встречающимся в документе, ключами индекса (и, соответственно,
частью языка запросов) служат названия поисковых зон и атрибутов документа, которые
рассмативаются в следующем разделе.
Словопозиции некоторых атрибутов вместо номеров предложений и слов содержат
другую информацию; подробности можно найти в следующих разделах.


{\termdef Поисковый запрос}, сформулированный на {\termdef языке запросов Яндекса},
указывает, какие ключи надо найти в индексе, и какие операции (объединение, пересечение,
взятие диапазона и т.п.) надо произвести над соответствующими списками словопозиций.
Результатом выполнения запроса является список документов
из итогового множества словопозиций.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Документные атрибуты}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Каждый документ может иметь некоторый набор свойств,
таких как заголовок, дата создания, размер, принадлежность к определенному разделу сайта или каталога.
Такие свойства документа будем называть {\termdef документными атрибутами}, или просто {\termdef атрибутами}.
Атрибуты могут быть непосредственно не связаны с текстом документа, видимым при его просмотре.

Каждый атрибут документа получает идентификатор в виде текстовой строки,
который в дальнейшем будем называть {\termdef именем атрибута}.
Само свойство документа, выражаемое атрибутом, будем называть {\termdef значением атрибута}.
Документ, в общем случае, может иметь произвольное число атрибутов.
Каждый атрибут документа может иметь несколько различных значений.
С другой стороны, не все атрибуты, определенные в коллекции документов, должны быть определены для данного документа.

{\footnotesize {\bf Пример.}
Рассмотрим коллекцию из двух документов, включающих литературные произведения.
Каждый из них имеет документный атрибут datecreated, имеющий значение даты написания произведения его автором.
Первый документ имеет атрибут author со значением Pushkin, а у второго документа этот атрибут имеет 
два значения --- Shecly и Zelazny, так как произведение написано в соавторстве.
Наконец, у первого документа имеется атрибут inmeter со значением iambus, а у второго документа этот атрибут отсутствует.

}

В дальнейшем будут рассматриваться только {\termdef поисковые атрибуты},
имена которых используются в языке запросов\footnote{
    О {\termdef группировочных} и {\termdef архивных} атрибутах можно узнать в документации к Яндекс.Серверу.
}.
Поисковые документные атрибуты являются частным случаем {\termdef зонных} атрибутов, рассмотренных ниже.
Словопозиции, соответствующие документным атрибутам, не содержат номеров слов и предложений.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Зоны и зонные атрибуты}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Большинство документов имеет внутреннюю структуру,
которая позволяет выделить различные части документов --- поисковые {\termdef зоны}.

{\footnotesize {\bf Примеры.}
Параграфы, заголовки различных уровней, ссылки, картинки.
Формат электронного письма подразумевает наличие в нем полей from, to, служебных областей, поля сообщения и т.п.

}

Каждая зона может иметь одно или несколько свойств, не связанных непосредственно с ее текстом. 
Такие свойства зон будем называть {\termdef зонными атрибутами}.
Зона, в общем случае, может иметь произвольное число атрибутов.
Каждый атрибут может иметь несколько различных значений.
Разумеется, не все атрибуты, определенные в данном массиве документов, должны быть определены для данной зоны.

{\footnotesize {\bf Примеры.}
Зона "to" в электронном письме могла бы иметь свойство "количество адресов рассылки",
а зона "ссылка" на другой документ в HTML-документе имеет свойство "URL документа".

}

% Это более правильный текст, чем в ЯС-доке --- без ссылок на парсер.

Документ размечается на зоны во время индексирования.
Каждая зона получает уникальное {\termdef имя зоны} (текстовую строку), используемое в языке запросов,
и может быть предметом поиска независимо от других зон.
Мы будем называть эти размеченные области документа поисковыми зонами.

Каждая поисковая зона имеет точки начала и конца в теле документа, которые
всегда приходятся на границы слов. Таким образом, каждой зоне в индексе соответствует два ключа,
словопозиции которых содержат номера слов и предложений, в которых зона начинается и заканчивается.

Зонные атрибуты также могут быть помечены в качестве независимых объектов поиска.
Такие атрибуты будем называть зонными поисковыми атрибутами, или просто атрибутами.
Каждый атрибут имеет уникальное имя (текстовую строку), и значение, которое может быть различного типа,
в зависимости от способа его обработки при индексировании. Каждой паре (имя, значение)
атрибута соответствует один ключ индекса, словопозиции которого содержат 
номера слов и предложений, в которых начинается соответствующая зона.

Важным частным случаем зоны является зона нулевой длины.
Она используется для того, чтобы иметь возможность назначить атрибуты определенной точке внутри документа.
Это может быть полезным в случае, когда документ имеет "вложенные потоки",
отличающиеся форматом или медиа-типом.

{\footnotesize {\bf Пример.}
Картинка из HTML-документа расположена в отдельном файле с заданным именем.
Это имя --- свойство (атрибут) точки документа, в которой расположена картинка.

}

Язык запросов Яндекса позволяет искать в нужной зоне с нужным значением атрибута.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Язык запросов и алгоритмы фильтрации}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Язык запросов Яндекса представляет собой контекстно-свободную грамматику, терминалами которой служат
слова естественного языка, а также имена зон и атрибутов.

В результате анализа запроса формируется набор ключей, по которым из индекса загружаются соответствующие
списки словопозиций - {\termdef листовые ноды} или просто {\termdef листы}.
Полученные списки позиций затем комбинируются и фильтруются в соответствии с операторами языка в два этапа.

Сначала формируются несколько списков {\termdef эффективных позиций}.
Каждая эффективная позиция является либо {\termdef элементарной позицией},
соответствующей листовой ноде, либо {\termdef скобкой}.
Позиции-скобки получаются комбинированием операций пересечения
(строгого многоместного $AND$) и объединения $OR$ и, по сравнению с элементарными позициями, имеют длину,
то есть позиции начала и конца. 
Разбиение строки запроса на скобки осуществляется как явным заданием скобок, так и при помощи использования
приоритета операций.% (см.~\ref{sectOperPrior}).

На заключительном этапе выполняется
{\termdef многоместный оператор $AND$}, который может быть {\termdef мягким}.

К листу, скобке как к целому, а также к многоместному $AND$ верхнего уровня могут быть последовательно применены
один или несколько {\termdef фильтров}. Фильтры могут быть {\termdef простые} и {\termdef ранжирующие}.
Простые фильтры отфильтровывают ненужные позиции, а ранжирующие не изменяют множество позиций,
но устанавливают свойство, что в итоговом результате документы, в которых есть
только позиции, не прошедшие фильтр, будут гарантированно ниже остальных документов.

В дальнейшем мы будем обозначать латинскими буквами $a,b,c,\dots$ лист или скобку.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Основные операторы языка запросов}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Большинство поисковых запросов задается пользователями на "естественном языке",
то есть без использования операторов языка. Поэтому для уменьшения числа "ложных срабатываний"
для всех бинарных операторов $\&$, $\&\&$, $\sim$, $\sim\sim$, $|$, $<<$, $<\!\!\!-$,
описанных ниже, требуется наличие пробелов с каждой строны.
Если пробел отсутствует, операторы будут проигнорированы.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Объединение {\em OR}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Представляет собой цепочку листов или скобок, разделенных операторами  $|$.
В результате выполнения операции множества позиций объединяются.
Семантика операции объединения --- задание тер\-ми\-нов-си\-но\-ни\-мов (или вы\-ра\-же\-ний-си\-но\-ни\-мов).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Многоместный {\em AND}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Представляет собой цепочку листов или скобок, разделенных операторами $\&$ и $\&\&$ с возможным указанием расстояния.
Одинарный оператор $\&$ соответствует пересечению внутри предложения, а двойной $\&\&$ --- пересечению внутри документа.
Если оператор не указан, то есть листы или скобки разделены пробелом, применяется двойной
оператор, то есть дополнительная фильтрация отсутствует.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Задание расстояния}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Если слова в тексте перенумеровать по порядку их следования, то расстояние между
словами $a$ и $b$ --- это  разница между номерами слов $a$ и $b$.
Таким образом, расстояние между соседними словами равно $1$, а не $0$.

%TODO: расстояние между скобками.

При задании расстояния существенен порядок следования слов.
Высказывание {\em на расстоянии в -2 слова} означает {\em на расстоянии в 2 слова cлева},
а высказывание {\em на расстоянии в +2 слова} означает {\em на расстоянии в 2 слова справа}.

Аналогично определяется расстояние между предложениями (если заменить термин {\em слово} на термин {\em предложение}).

Синтаксис задания расстояния: /($m$ $n$),
при этом число $m$ должно быть не больше, чем число $n$.

Применяются различные сокращенные формы:
\begin{itemize}
\item /$n$ равнозначно /(-$n$ +$n$)
\item /+$n$ равнозначно /(+$n$ +$n$)
\item /-$n$ равнозначно /(-$n$ -$n$)
\end{itemize}

Если задана область действия оператора, но не задан сам оператор,
то применяется оператор $\&$, то есть $a$ /2 $b$ эквивалентно запросу $a$ $\&$/2 $b$.


{\footnotesize {\bf Примеры.}

$a$ $\&$ $b$      --- $a$ и $b$ должны находиться в одном предложении.

$a$ /+1 $b$    --- $b$ должно следовать за $a$.

$a$ /2 $b$     --- расстояние в словах независимо от порядка следования (то же что и $a$ $\&$/2 $b$ ).

$a$ /(-2 4) $b$  --- $b$ должно находиться от $a$ в интервале расстояний от 2 слов слева до 4 слов справа.

$a$ /0 $b$     --- расстояние в словах, позиции должны совпадать (то же, что и $a$ $\&$/0 $b$).

$a$ $\&\&$ $b$     --- $a$ и $b$ должны находиться в одном документе.

$a$ $\&\&$/1 $b$   --- $b$ должно находиться в том же предложении, что и $a$, либо в соседнем.

$a$ $\&\&$/2 $b$   --- расстояние в предложениях.

$a$ $\&\&$/0 $b$   --- расстояние в предложениях (то же что и $a$ $\&$ $b$).

}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Префиксы и кавычки}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Перед листом могут быть указаны некоторые префиксные операторы. Префикс может быть и у скобки,
в этом случае он распространяется на все ее листы.

\begin{description}
\item[{\tt !}] Поиск точной формы (отключение морфологии).

{\footnotesize {\bf Пример.}
По запросу {\tt !лужков} будут найдены словоформа {\em лужков}, но не {\em лужкову}, {\em лужки}. 

}

В общем случае слова с большой и маленькой буквы считаются разными формами одного слова,
поэтому всеравно, какой регистр использовать в запросе.
Исключением является оператор точной формы.
По запросу {\tt !лужков} будут найдены все документы, содержащие эту словоформу в любом регистре,
а по запросу {\tt !Лужков} - только документы, в которых имеется форма {\em Лужков} с большой буквы.

\item[{\tt !!}] Поиск точной леммы. Указанный ключ считается леммой, и будут найдены все формы этой леммы,
но не формы других лемм, отличных по написанию от указанной, но таких, которым соответствует данный ключ,
рассматриваемый как форма.

Если указанный ключ является словарной леммой, поиск ограничивается этим ключем, иначе
запрос дополняется операторами точной формы.

{\footnotesize {\bf Пример.}
По запросу {\tt !!лужков} найдутся формы леммы {\em лужков}, но не леммы {\em лужок},
т.е. найдутся формы {\em лужкову}, {\em лужкова}, но не {\em лужки}.

}

\end{description}


%TODO +-\%

%TODO Фильтрация Кондратьева.

Выражение в кавычках применяется для поиска точной фразы и почти эквивалентно многоместному $AND$
на уровне предложения с расстояниями в +1 между соответствующими точными формами.
Небольшое отличие в том, что для выражения в кавычках регистр точной формы игнорируется.

{\footnotesize {\bf Пример.}

Запрос {\em "рисовать квадрат и круг"}
эквивалентен запросу !{\em рисовать} /+1 !{\em квадрат} /+1 !{\em и} /+1 !{\em круг}.

}

Оператор расстояния /+$n$ в кавычках не распознается.
Вместо него поддерживается конструкция {\em "a * * b"},
которая эквивалентна запросу !{\em a} /+3 !{\em b}.
Символы звездочки должны быть окружены пробелами.

{\footnotesize {\bf Примеры.}

{\em "a * b"},

{\em "раз * три * * шесть"},

{\em "a * * * e f * h"}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Простые фильтры}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{itemize}

\item {\termdef Исключение} $a \sim b$ или $a \sim\sim b$.
Возможно указание расстояния точно таким же образом, как в многоместном $AND$.
В результате выполнения операции из левого множества позиций удаляются элементы, которые ближе,
чем указанное расстояние к любому из элементов правого множества словопозиций.
Одинарный оператор $\sim$ соответствует уровню предложения, а двойной $\sim\sim$ --- уровню документа.

{\footnotesize {\bf Пример.}

$a$ $\sim$/(-4 +8) $b$  --- $b$ не должно находиться рядом с $a$, причём "рядом" 
здесь означает "в интервале расстояний от 4 слов слева до 8 слов справа".

}

\item {\termdef Поиск в зонах} {\em zone:a}.
В результате выполнения операции из множества $a$ удаляются позиций вне указанной зоны.
Более подробно зонно-атрибутивный поиск описан в разделе~\ref{sectAttrZoneSearch}.

\item {\termdef Ограничение по документам} $a << b$.
В результате выполнения операции из левого множества позиций удаляются позиции с документами,
отсутствующими в правом множестве.
Оператор похож на документный $AND$ ($\&\&$), с той лишь разницей,
что правый операнд влияет на возможность документов попасть в результаты поиска, но не влияет на ранжирование.
Этот оператор следует использовать при ограничении результатов поиска атрибутивным выражением.

\item {\termdef Интервальное ограничение по позициям} {\em a inpos:lo..hi}.
Назовем {\termdef величиной} словопозиции число, которое получается из словопозиции
после обнуления идентификатора документа.
В результате выполнения данной операции из множества словопозиций $a$ удаляются позиции,
величина которых лежит вне указанного интервала.
%TODO как подсчитать величину в разных случаях.

{\footnotesize {\bf Пример.}

Запрос {\em date:20060514 inpos:60..120}
найдет документы, созданные 14 мая 2006 года с часу до двух ночи.

}

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Ранжирующие фильтры}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{itemize}

\item {\termdef Уточнение} {\tt a $<\!\!\!-$ b}.
Эквивалентен операции $OR$, но правые позиции должны ранжироваться выше.
%добавляет приоритет документу, если в нем есть b, но b не попадает в результат поиска (и не учитывается в ранжировании, на отображается в сниппетах итп)

\item {\termdef Ранжирующий поиск в зонах} {\tt zone$-\!\!\!>$a}.
Позиции вне указанной зоны ранжируются ниже.

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsection{Приоритеты операторов}
%\label{sectOperPrior}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%TODO.

%Поиск в найденном ПЕРЕПИСАТЬ ПРАВИЛЬНО
%Поставив в поисковой строке '$$_идентификатор_запроса_' можно ограничить область поиска
%- осуществлять его не по всем документам, а только по тем, которые были найдены в предыдущем поиске.
%Оператор позволяет последовательно сужать область поиска 
%(при очень узком поиске есть опасность не найти ни одного релевантного документа).
%Следует помнить, что для работы этого оператора в конфигурационном файле должна быть определена секция QueryCache


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Поиск в зонах и атрибутах}
\label{sectAttrZoneSearch}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

В операторах зонно-атрибутивного поиска используются имена поисковых зон и атрибутов,
заданные во время индексирования и описанные в специальном конфигурационном файле (см. раздел~\ref{sectAttrZoneConfig}).
Если имя зоны или атрибута не описано в конфигурационном файле,
или значение атрибута не соответствует его типу, как описано в разделе~\ref{sectAttrTypes},
вся конструкция преобразуется в набор слов. Также, во всех конструкциях должны
отсутствовать пробелы с обеих сторон двоеточия.

Ниже в качестве имени зоны мы будем использовать {\em zone}, а в качестве имени атрибута --- {\em attr}.
Вместо {\em zone} и {\em attr} следует подставить одно из действительных значений.

{\footnotesize {\bf Пример.}
В веб-поиске Яндекса (www.yandex.ru) можно использовать {\em title} или {\em anchor} вместо {\em zone}
и {\em link}, {\em image} или {\em date} вместо {\em attr}.

}

Операторы зонно-атрибутивного поиска могут составлять под\-зап\-рос более сложного запроса.
В этом случае они комбинируются с другими частями запроса с помощью операторов языка запросов, описанных ранее.

\subsection{Синтаксические правила зонно-атрибутивного поиска}

\begin{description}

\item[{\termdef {\tt zone:слово}}]

Ищет {\em слово} в зонах с именем {\em zone}.
Токен {\em слово} не может содержать пробелы. 

{\footnotesize {\bf Пример.}
Найти документы, в тексте которых встречается слово {\em ошибка},
но это слово не встречается в тексте ссылок на другие документы: 

{\tt ошибка $\sim\sim$ anchor:ошибка}

}

\item[{\termdef {\tt zone:(текст-в-зоне)}}]

Ищет {\em текст-в-зоне} в зонах с именем {\em zone}.
В подзапросе {\em текст-в-зоне} могут употребляться любые языковые конструкции, описанные ранее,
в частности, он может состоять из нескольких слов. 

\item[{\termdef {\tt zone:"текст-в-зоне"}}]
\item[{\termdef {\tt zone:'текст-в-зоне'}}]
\item[{\termdef {\tt zone:`текст-в-зоне`}}]

Ищет запрос в кавычках {\em "текст-в-зоне"} (то есть точные формы подряд идущих слов) в зонах с именем {\em zone}.

\item[{\termdef {\tt zone:((текст-в-зоне))}}]

По сравнению с вариантом с одной парой скобок, ищет {\em текст-в-зоне} 
целиком в одной зоне с именем {\em zone}.
Имеет смысл, когда в документе есть несколько разных одноименных зон,
а {\em текст-в-зоне} состоит из нескольких слов.

\item[{\termdef {\tt attr:значение}}]
\item[{\termdef {\tt attr:"значение"}}]
\item[{\termdef {\tt attr:'значение'}}]
\item[{\termdef {\tt attr:`значение`}}]
\item[{\termdef {\tt attr:(значение)}}]

Все формы записи эквивалентны, за исключением того, что в первом случае {\em значение}
не может включать пробелы.

Ищет документы, в которых существуют зоны (в том числе документ как целое и зона нулевой длины),
имеющие атрибут с именем {\em attr} и значением {\em значение}.
Возможный формат значения зависит от типа атрибута, подробности описаны в разделе~\ref{sectAttrTypes}.

Для всех типов атрибутов, кроме логических, возможно
указывать операторы сравнения >, >=, <, <= вслед за двоеточием:
{\tt date:<20090101} или {\tt size:>=1024}

{\footnotesize {\bf Пример.}
Найти документы, в которых есть картинки, расположенные в файле apple.gif:

{\tt image:apple.gif}

В этом примере использован атрибут специальной зоны нулевой длины. 

}

{\footnotesize {\bf Пример.}
Найти документы, созданные 14 мая 1999 года:

{\tt date:19990514}

В этом примере использован документный атрибут. 

}

{\footnotesize {\bf Пример.}
Найти все документы, которые ссылаются на сайт www.site.ru:

{\tt link:www.site.ru/*}

В этом примере использован атрибут зоны anchor. 

}

Таким образом, поиск документов с зонным атрибутом, встречающимся где угодно в тесте,
ничем синтаксически и по смыслу не отличается от поиска по документным атрибутам.

Однако зонные атрибуты (в том числе и атрибуты пустой зоны) отличаются от документных тем,
что имеют координатную привязку к тексту документа.
То есть для поисковой системы это такие же объекты для поиска, как и слова, и они могут участвовать
во всех допустимых операциях с заданным поисковым контекстом. 

{\footnotesize {\bf Пример.}
Найти все документы, в которых картинки из файла apple.gif находятся рядом со словом {\em яблоко}:

{\tt image:apple.gif \&/1 яблоко}

}

\item[{\termdef {\tt zone:(attr:значение текст)}}]

Ищет {\em текст} в зонах с именем {\em zone}, имеющих атрибут
с именем {\em attr} и значением {\em значение}.
В подзапросе {\em текст} могут употребляться любые языковые конструкции, описанные ранее, в том
числе и другие атрибуты. Отличие атрибута, стоящего на первом месте в том, что он привязан к указанной зоне.

{\footnotesize {\bf Пример.}
Найти документы, которые ссылаются на сайт www.site.ru словами {\em мягкая мебель}:

{\tt anchor:(link:www.site.ru/* мягкая мебель)}

}

\end{description}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Типизация поисковых атрибутов}
\label{sectAttrTypes}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Поисковые атрибуты различаются по способам распознавания и обработки. В зависимости от типа
возможны также некоторые вариации синтаксиса задания значения атрибута.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Встроенные зоны и атрибуты}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Несколько зон и атрибутов изначально встроены в язык запросов и имеют зарезервированные имена.

\begin{itemize}

\item[{\termdef {\tt intext}}] Специальное имя зоны для поиска только в текстах документов.

\item[{\termdef {\tt inlink}}] Специальное имя зоны для поиска только в ссылках на документы.

\item[{\termdef {\tt softness}}] Специальное имя атрибута для указания мягкости многоместного оператора AND
верхнего уровня. Имеет синтаксис {\em softness:N}, где N - целое число от 0 до 100 включительно.
Следует задавать не более одного softness-атрибута в запросе,
так как будет использовано только последнее заданное значение.

\item[{\termdef {\tt prevreq}}] Специальное имя атрибута для указания идентификатора предварительно
сохраненного запроса. Имеет синтаксис {\em prevreq:ID}, где ID может содержать буквы и цифры,
и может также быть отрицательным целым числом.

\item[{\termdef {\tt inpos}}] Специальное имя атрибута для указания точного диапазона
позиций, в которых должен находиться предыдущий лист или скобка.
Имеет синтаксис {\em inpos:N1..N2}, где N1 и N2 --- целые положительные числа.

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Литеральные атрибуты}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Значение атрибута распознается как неделимая последовательность символов,
участвующая в индексировании и поиске как целое. Может быть документным или зонным.

Возможен поиск по префиксу, в этом случае значение атрибута (требуемый префикс) должно заканчиваться
звездочкой ($*$).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Даты}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Значение атрибута распознается как дата или время. Этот тип атрибута может быть только
документным, при этом в ключах хранится дата с точностью до дня,
аналогично литеральному атрибуту, а в словопозициях хранятся секунды от полуночи.

Поддрерживаются несколько вариантов задания даты: {\em YYYYMMDD} или {\em YYYY-MM-DD} или {\em YYYY-MM-DDTHH:MM:SS}.
В первом варианте можно использовать символ $*$ для поиска диапазона,
в последнем можно не задавать секунды или секунды и минуты,
в этом случае поиск также будет выполнен по диапазону.

Поддерживается также интервальный поиск: {\tt date:20080101..20080212}


{\footnotesize {\bf Примеры.}

{\tt date:20080119} --- найти документы, созданные 19 января 2008 года

{\tt date:2008*} --- найти документы, созданные в 2008 году

{\tt date:2009-01-19T19:23:45} найти документы, созданные 19 января 2008 года
в 19 часов 23 минуты 45 секунд, тот же результат достигается запросом
{\tt date:20090119 inpos:69825..69826}

{\tt date:2009-01-19T19:23} преобразуется в {\tt date:2009-01-19 inpos:69780..69840}

{\tt date:2009-01-19T19} преобразуется в {\tt date:2009-01-19 inpos:68400..72000}

}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{URL}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Значение атрибута распознается как Uniform Resource Locator.

Значения атрибутов данного типа имеют дополнительную обработку: из них удаляется протокол
http:// и https://, а также все русские символы преобразуются в utf-8
и кодируются в соответствии с RFC1738.

{\footnotesize {\bf Примеры.}

{\tt url:http://ru.wikipedia.org/wiki/Уткин\_Иосиф\_Павлович} работает как\\
{\tt url:ru.wikipedia.org/wiki/\%D0\%A3\%D1\%82\%D0\%BA\%D0\%B8\%D0\%BD\_\%D0\%98\%D0\%BE\%D1\%81\\
\%D0\%B8\%D1\%84\_\%D0\%9F\%D0\%B0\%D0\%B2\%D0\%BB\%D0\%BE\%D0\%B2\%D0\%B8\%D1\%87}\\
(Искуственный перевод строки в действительности отсутствует.)

{\tt url:https://www.telebank.ru/web/front/login.x} работает как\\
{\tt url:www.telebank.ru/web/front/login.x}

}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Целочисленные атрибуты}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Значение атрибута распознается как целое десятичное число.

{\footnotesize {\bf Примеры.}

{\tt cat:100004}, {\tt size:200}

Запрос {\tt size:0xFFFF} будет обработан как запрос {\tt size 0xFFFF} из двух слов.

}

Поддерживается также интервальный поиск: {\tt cat:100004..1000010}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Логические атрибуты}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

В качестве значений атрибута могут использоваться:\\
{\em 1/0, true/false, yes/no, on/off}

{\footnotesize {\bf Примеры.}

{\tt new:yes}, {\tt cyrillic:false}

}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Конфигурирование}
\label{sectAttrZoneConfig}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Для каждой коллекции документов в конфигурационном файле может быть задан список зон и атрибутов.
Секция Collection может содержать одну подсекцию QueryLanguage. В секции QueryLanguage указываются
зоны и атрибуты в формате {\em имя: тип}. Имя может состоять из латинских букв в нижнем регистре
и цифр, а также может содержать подчеркивания. Имя может начинаться только с буквы.
Имена атрибутов не проверяются при загрузке конфигурации.
При неверном указании типа будет выдано об ошибке и данный атрибут будет пропущен.
Поддерживаемые типы: ZONE, ATTR\_LITERAL, ATTR\_INTEGER, ATTR\_URL, ATTR\_DATE, ATTR\_BOOLEAN.
Названия типов могут быть заданы в любом регистре.

{\footnotesize {\bf Пример.}
\begin{verbatim}
   <Collection id="work">
     IndexDir /yandex/db/workindex/

     <QueryLanguage>
       title    : ZONE
       address  : ZONE
       anchor   : ZONE
       mime     : ATTR\_LITERAL
       cat      : ATTR\_INTEGER
       url      : ATTR\_URL
       date     : ATTR\_DATE
       new      : ATTR\_BOOLEAN
       cyrillic : ATTR\_BOOLEAN
     </QueryLanguage>

   </Collection>
\end{verbatim}

}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Зоны и атрибуты по умолчанию}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Ниже приведены имена зон и атрибутов, которые будут использованы по умолчанию,
в случае отсутствия конфигурационного файла. Эти имена и типы используются на веб-поиске Яндекса.

\begin{itemize}

\item[{\termdef Зоны}] title, address, anchor, anchorint, anchormus, quote, del, ins
\item[{\termdef Литеральные}] charset, language, robots, style, profile, script, image,
applet, object, action, domain, host, hostip, lang, mime, rhost, upath, whois
\item[{\termdef URL}] base, refresh, link, linkint, linkmus, url
\item[{\termdef Даты}] date, idate
\item[{\termdef Логические}] cyrillic, new
\item[{\termdef Целочисленные}] cat, size

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Сравнение со старым синтаксисом}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{tabular}{|l|l|}
\hline
По старому & По новому\\[5pt]
\hline
a|b\&\&c & a | b \&\& c\\
\hline
(!a | !A) /+1 !b & "a * b"\\
\hline
title[слово] & title:слово\\
\hline
title[слово]\$\$\$ & title->слово\\
\hline
keyword=(слово) & не поддерживается в прежнем смысле\\
\hline
date="20080101" & date:20080101\\
\hline
[[date="20060514",,60,,120]] & date:20060514 inpos:60..120\\
\hline
size<="1024" & size:<=1024\\
\hline
anchor\#link="www.site.ru/*" [мебель] & anchor:(link:www.site.ru/* мягкая мебель)\\
\hline
\end{tabular}

\end{document}
