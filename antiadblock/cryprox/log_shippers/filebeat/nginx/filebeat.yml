# Internal queue configuration for buffering events to be published.
queue:
  # Queue type by name (default 'mem')
  # The memory queue will present all available events (up to the outputs
  # bulk_max_size) to the output, the moment the output is ready to server
  # another batch of events.
  mem:
    # Max number of events the queue can buffer.
    events: 20000
    # Hints the minimum number of events stored in the queue,
    # before providing a batch of events to the outputs.
    # The default value is set to 2048.
    # A value of 0 ensures events are immediately available
    # to be sent to the outputs.
    #flush.min_events: 2048

    # Maximum duration after which events are available to the outputs,
    # if the number of events stored in the queue is < min_flush_events.
    flush.timeout: 5s

# If enabled, filebeat periodically logs its internal metrics that have changed
# in the last period. For each metric that changed, the delta from the value at
# the beginning of the period is logged. Also, the total values for
# all non-zero internal metrics are logged on shutdown. The default is true.
logging.metrics.enabled: false
# Logging to rotating files. Set logging.to_files to false to disable logging to
# files.
logging.to_files: true
logging.files:
  # Configure the path where the logs are written. The default is the logs directory
  # under the home path (the binary location).
  path: /logs/filebeat-nginx
  # The name of the files where the logs are written to.
  name: filebeat
  # Configure log file size limit. If limit is reached, log file will be
  # automatically rotated
  rotateeverybytes: 104857600 # = 100MB
  # Number of rotated log files to keep. Oldest files will be deleted first.
  keepfiles: 7

filebeat.inputs:
- type: log
  # By default, the decoded JSON is placed under a "json" key in the output document.
  # If you enable this setting, the keys are copied top level in the output document.
  json.keys_under_root: true
  # If keys_under_root and this setting are enabled, then the values from the decoded
  # JSON object overwrite the fields that Filebeat normally adds (type, source, offset, etc.)
  # in case of conflicts.
  json.overwrite_keys: true
  # If this setting is enabled, Filebeat adds a "error.message" and "error.key: json" key in case of JSON
  # unmarshaling errors or when a text key is defined in the configuration but cannot
  # be used.
  ignore_decoding_error: true
  paths:
    - /logs/nginx/access.log*
  # Optional fields that you can specify to add additional information to the
  # output. Fields can be scalar values, arrays, dictionaries, or any nested
  # combination of these.
  fields:
    tags: ${FILEBEAT_TAGS:['nginx','bm']}
    env_type: ${ENV_TYPE:production}
  # If this option is set to true, the custom fields are stored as top-level
  # fields in the output document instead of being grouped under a fields
  # sub-dictionary. Default is false.
  fields_under_root: true

  # https://st.yandex-team.ru/ANTIADB-2055
  # When enabling this option, a file handler is closed immediately in case a file can't be found
  # any more. In case the file shows up again later, harvesting will continue at the last known position
  # after scan_frequency.
  close_removed: true
  # Removes the state for file which cannot be found on disk anymore immediately
  clean_removed: true
  # Close timeout closes the harvester after the predefined time. This is independent if the harvester did finish reading the file or not.
  close_timeout: 60m

processors:
  # Fun fact: one can't just overwrite "host"-field filebeat adds.
  # So we extracting it into temporary 'hostname' removing 'host' (and other f-beat fields) and than renaming "hostname"-field from decoded JSON
  # About drop_fields: https://www.elastic.co/guide/en/beats/filebeat/6.4/drop-fields.html
  - rename:
      fields:
        - from: "host.name"
          to: "hostname"
  - drop_fields:
      fields: ["host", "input", "log", "ecs", "agent"]
  - rename:
      fields:
        - from: "hostname"
          to: "host"
  # removing log records with 2xx, 3xx "response_code"-field in producton environment
  # About drop_event: https://www.elastic.co/guide/en/beats/filebeat/6.4/drop-event.html
  - drop_event:
     when:
        and:
          - equals:
              env_type: "production"
          - not:
              has_fields: ["bamboozled"]
          - range:
              response_code:
                lt: 400
  # removing original "message"-field and "timestamp"
  # "timestamp" used only by push-clinet, "env_type" was added for above drop_event logic
  - drop_fields:
      fields: ["timestamp", "message", "env_type", "yandexuid", "crookie", "icookie", "x_req_id", "x_request_id", "forcecry"]

output.elasticsearch:
  # Boolean flag to enable or disable the output module.
  enabled: true
  # Array of hosts to connect to.
  # Scheme and port can be left out and will be set to the default (http and 9200)
  # In case you specify and additional path, the scheme is required: http://localhost:9200/path
  # IPv6 addresses should always be defined as: https://[2001:db8::1]:9200
  hosts: ${ELASTIC_HOSTS}
  # The maximum number of events to bulk in a single Elasticsearch bulk API index request.
  # The default is 50.
  bulk_max_size: 2000
  # Optional index name. The default is "filebeat" plus date
  # and generates [filebeat-]YYYY.MM.DD keys.
  # In case you modify this pattern you must update setup.template.name and setup.template.pattern accordingly.
  index: "${ENV_TYPE}-antiadb-nginx-filebeat-%{index_num}"

setup.template:
  # filebeat ignores next two fields, but we can't delete them :(
  name: '${ENV_TYPE}-antiadb-nginx-filebeat'
  pattern: '*-antiadb-nginx-filebeat-*'
  # Name under which the template is stored in Elasticsearch
  json.name: '${ENV_TYPE}-antiadb-nginx-filebeat'
  # Template index pattern.
  json.pattern: '*-antiadb-nginx-filebeat-*'
  # Enable json template loading. If this is enabled, the fields.yml is ignored.
  json.enabled: true
  # Path to the json template file
  json.path: "/log_shippers/filebeat/${ENV_TYPE}-nginx-filebeat.template.json"
  # Overwrite existing template
  setup.template.overwrite: false

# enables index lifecycle management
setup.ilm:
  enabled: true
  rollover_alias: "${ENV_TYPE}-antiadb-nginx-filebeat"
  pattern: "000001"
  policy_name: "nginx"

# for local output testing
output.file:
  # Boolean flag to enable or disable the output module.
  enabled: false
  codec.json:
    pretty: true
  path: "/tmp"
  filename: "filebeat.output"
