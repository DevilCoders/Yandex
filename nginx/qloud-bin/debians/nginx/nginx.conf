user www-data;
worker_processes 16;
worker_rlimit_nofile 40000;
daemon off;

pid /var/run/nginx.pid;

events {
    worker_connections 16384;
    multi_accept on;
}

http {

    log_format qloud_access 'dt=$time_iso8601\t'
        'ts=$msec\t'
        'ra=$remote_addr\t'
        'up=$upstream_addr\t'
        'me=$request_method\t'
        'q=$request_uri\t'
        'sc=$scheme\t'
        'hr=$http_referer\t'
        'ua=$http_user_agent\t'
        'st=$status\t'
        'ho=$http_host\t'
        'rt=$request_time\t'
        'rx=$request_length\t'
        'tx=$bytes_sent\t'
        'ut=$upstream_response_time\t'
        'sa=$ship_access\t'
        'qp=$qloud_project\t'
        'qa=$qloud_application\t'
        'qi=$instance_name\t'
        'qe=$qloud_environment';

    access_log syslog:server=localhost:12201 qloud_access;
    access_log /var/log/nginx/qloud-nginx-access.log qloud_access;
    error_log  /var/log/nginx/qloud-nginx-error.log;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    client_max_body_size 4096M;

    include /etc/nginx/mime.types;

    server_names_hash_bucket_size 256;
    server_names_hash_max_size 2048;

    keepalive_timeout 120 120;

    resolver [2a02:6b8::1:1] [2a02:6b8:0:3400::1] ipv6=only;

    ########## SSL {

    # Protocols and ciphers
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers kEECDH+AESGCM+AES128:kEECDH+AES128:kRSA+AESGCM+AES128:kRSA+AES128:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2;

    # Sessions cache
    ssl_session_cache    shared:SSL:128m;
    ssl_session_timeout  28h;

    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_responder http://yandex.ocsp-responder.com/;

    # HSTS for 1y
    add_header Strict-Transport-Security "max-age=31536000";

    # Permanent redirect to HTTPS
    server {
        listen 80;
        listen [::]:80;
	    server_name whatever.qloud.yandex-team.ru;
        location / {
            return 301 https://$host$request_uri;
        }

        # setting default values for qloud variables
        set $qloud_installation '-';
        set $qloud_project      '-';
        set $qloud_application  '-';
        set $qloud_environment  '-';
        set $ship_access        'false';
        set $instance_name      'unknown';
    }

    ########## } SSL

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Balancer-Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_buffer_size 8k;

    # tunables
    proxy_connect_timeout 1s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    proxy_next_upstream error timeout;

    error_page 500 /usr/share/nginx/error-pages/500.txt;
    error_page 502 /usr/share/nginx/error-pages/502.txt;
    error_page 504 /usr/share/nginx/error-pages/504.txt;


    gzip on;
    gzip_vary on;
    gzip_static on;
    gzip_http_version 1.0;
    gzip_comp_level 2;
    gzip_proxied any;
    gzip_disable "msie6";
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/x-javascript application/xml application/xml+rss application/json;

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}

