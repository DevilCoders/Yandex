## primary KUBR domains
server {
	include listen_xfront;
	
	server_name pogoda.yandex.ru;
	server_name pogoda.yandex.ua pogoda.yandex.by pogoda.yandex.kz;
	server_name pogoda.load.yandex.ru;
	server_name ~^pogoda\.[a-z0-9]+\.yandex\.(ru|ua|by|kz)$;

	root /usr/local/www5/weather;

	rewrite ^/data/(.*) /get/weather-embed/$1?embed=1 break;

	# xscript fastcgi daemon
	include fastcgi_params_yandex;
	include xscripts/weather;
#	include locations/404-xml;
#	include locations/robots-xscript-default;
#	include locations/rss-x-default;

	# allow access to i-helper__social
	location ~* \.(html) { }
	include locations/lego-xml-deny;
	include locations/weather/vuln-deny;
	location = / {
		rewrite ^/$ /index.xml?page=brief; 
		}

	location ^~ /get {
		include /etc/nginx/locations/weather/elliptics_proxy_pass;
		}
	location ~* \.(bz2|gz|xml|csv|png|jpg|jpeg|gif|ico|css|js|txt) { }

	location / {
		#rewrite ^/index.xml\?city=([0-9]+) /$1/ permanent;
		rewrite ^/city.xml\?city=([0-9]+) / permanent;
		rewrite ^/othercity.xml /choose/ permanent;
		rewrite ^/russia.xml /russia/ permanent;
		rewrite ^/mosregion.xml /russia/ permanent;
		rewrite ^/(sng.xml|countries.xml|world.xml|alonecountry.xml) /region/ permanent;
		rewrite ^/([^/]+)/tune/?$ / permanent;
		rewrite ^/(tips.xml|save_tune.xml|resorts.xml|print_index.xml|print_detailed.xml|city.xml|detailed.xml)$ / permanent;
		rewrite ^/(([^/]+)/tune/?\?(.*)|^/([^/]+)/tune/?)$ / permanent;
		rewrite ^/maps.xml /maps/ permanent;
		#rewrite ^/maps.xml\?type=5&typeitem=14$ /maps/fire/moscow/ permanent;
		#rewrite ^(/maps.xml\?type=3&typeitem=7|/maps.xml\?section=satellite|/maps/satellite/)$ /maps/#eu_sat permanent;
		#rewrite ^/maps.xml$ /maps/ permanent;
		#rewrite ^/weather_chooser\.xml\?wt=1&t=[0-9]+&deg=(-?[0-9]+) /delivery/water/$1/ permanent;
		#rewrite ^/weather_chooser\.xml\?wt=0&t=[0-9]+&deg=(-?[0-9]+) /delivery/$1/ permanent;
		#rewrite ^/weather_chooser.xml / permanent;
		#rewrite ^/\?yasoft=([^&]*)&city=([0-9]+) /$2/?yasoft=$1 permanent;
		#rewrite ^/\?city=([0-9]+)&yasoft=([^&]*) /$1/?yasoft=$2 permanent;
		#rewrite ^/[^/]*[?&]city=([0-9]+) /$1/ permanent;
		rewrite ^/([0-9]+)$ /$1/ permanent;
		rewrite ^/static/perblock-informer([0-9])(_white)?/([0-9]+) http://umbrella-informer.yandex.net/$1$2/$3.png permanent;
		rewrite ^/i/(n?1?[0-9])\.png?$ http://i.yandex.st/weather/i/icons/$1.png permanent;
		rewrite ^/([^/]+)/detail(ed)?/?$ /$1/details/ permanent;
		rewrite ^/([^/]+)/[ck]limat/?$ /$1/climate/ permanent;
		rewrite ^/search.xml$ / permanent;
		rewrite ^/(detail|details|detailed|climate|climat|health|choose|informer|reception|климат|подробно|slice)/?$ /index.xml?page=$1 last;
		#rewrite ^(/.*[?&]city=([0-9]+).*)$ $1 last;
		#rewrite ^(/\?attention_type=achtung&city=[0-9]+)$ $1 last;
		#rewrite ^(/\?attention_type=rus)$ $1 last;
		#rewrite ^(/index.xml\?attention_type=rus)$ $1 last;
		#rewrite ^(/\?attention_type=mosc)$ $1 last;
		#rewrite ^(/index.xml\?attention_type=mosc)$ $1 last;
		#rewrite ^(/climate.xml\?city=[0-9]+)$ $1 last;
		#rewrite ^/agreement\.xml$ /help.xml?page=agreement last;
		#rewrite ^(/\?.*)$ $1 last;
		rewrite ^/(\d+)/?$ /index-geo.xml?geo=$1 last;
		rewrite ^/(\d+)/?\?(.*)$ /index-geo.xml?geo=$1&$2 last;
		rewrite ^/(\d+)/([^/?]+)/?$ /index-geo.xml?geo=$1&page=$2 last;
		rewrite ^/(\d+)/([^/?]+)/?\?(.*)$ /index-geo.xml?geo=$1&page=$2&$3 last;
		rewrite ^/([^?]+)/(choose|выбор)/?$ /router.xml?page=choose&geo-name=$1 last;
		rewrite ^/region/?$ /router.xml?page=region last;
		rewrite ^/region/([^/]+)/?$ /router.xml?page=region&id=$1 last;
		rewrite ^/russia/?$ /router.xml?page=region&id=1ed1c408a4ac822b728a2077a1d9935c last;
		rewrite ^/russia/all/?$ /router.xml?page=region&id=1ed1c408a4ac822b728a2077a1d9935c&all=1 last;
		rewrite ^/ukraine/?$ /router.xml?page=region&id=a36132306e4574ca78381ceaac5b9e15 last;
		rewrite ^/ukraine/all/?$ /router.xml?page=region&id=a36132306e4574ca78381ceaac5b9e15&all=1 last;
		rewrite ^/russia/mo/?$ /router.xml?page=region&id=687a3cb544818a00175a60b1402ba800 last;
		rewrite ^/about/?$ /help.xml?page=about? last;
		rewrite ^/agreement/?$ /help.xml?page=agreement? last;
		rewrite ^/informer.xml$ /informer/ permanent;
		rewrite ^/informer_tips.xml /informer/tips/ permanent;
		rewrite ^/([^?]+)/informers?/?$ /router.xml?page=informer&geo-name=$1? last;
		rewrite ^/informer/tips/?$ /help.xml?page=tips? last;
		rewrite ^/delivery/(-?[0-9]+)/?(\?.*)?$ /router.xml?page=delivery&deg=$1 last;
		rewrite ^/delivery/water/(-?[0-9]+)/?(\?.*)?$ /router.xml?page=delivery&deg=$1&wt=1 last;
		rewrite ^/maps/?$ /router.xml?page=maps&no-redirect last;
		#rewrite ^/maps/?\?(.*)$ /maps.xml?$1 last;
		#rewrite ^/maps/([^/]+)/?$ /maps.xml?section=$1 last;
		#rewrite ^/maps/([^/]+)/([^/]+)/?$ /maps.xml?section=$1&region=$2 last;
		#rewrite ^/([^?]+)/(slice)/?$ /slice.xml?geo-name=$1 last;
		rewrite ^/search/?$ /router.xml?page=search last;
		rewrite ^/search/\?request=(.*)$ /router.xml?page=search?request=$1 last;
		rewrite ^/search/\?text=(.*)$ /router.xml?page=search?request=$1 last;
		rewrite ^/piter /saint-petersburg permanent;
		rewrite ^/(.*?)/(details|подробно|detailed) /router.xml?geo-name=$1&page=forecast&widget=detailed? last;
		rewrite ^/(.*?)/(climate|климат)/? /router.xml?geo-name=$1&page=forecast&widget=climate? last;
		rewrite ^/(.*?)/hourly /router.xml?geo-name=$1&page=forecast&widget=hourly? last;
		rewrite ^/(.*?)(/(brief)?)?/?$ /router.xml?geo-name=$1&page=forecast&widget=brief? last;
		rewrite ^/(([^?/]+/)*?[^?/]+)/?$ /router.xml?geo-name=$1 last;
		}
}

