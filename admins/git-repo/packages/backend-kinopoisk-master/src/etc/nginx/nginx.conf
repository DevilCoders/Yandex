user  www-data www-data;
worker_processes  8;
worker_priority  -20;
worker_rlimit_nofile 65536;
pid /var/run/nginx.pid;

error_log /var/log/nginx/error.log;

events {
    worker_connections  65536;
    use epoll;
}

http {
    server_names_hash_bucket_size 128;

    reset_timedout_connection on;
    proxy_next_upstream error timeout invalid_header;

    proxy_cache_path  /var/lib/nginx/cache levels=1:2 keys_zone=cache:8m max_size=4000m inactive=600m;
    proxy_cache_key "$request_uri";
    proxy_temp_path /var/lib/nginx/tmp; 

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    client_header_timeout 10m;
    client_body_timeout 10m;
    send_timeout 10m;
    client_max_body_size 4000m;

    connection_pool_size 2048;
    client_header_buffer_size 4k;
    large_client_header_buffers 1000 8k;
    request_pool_size 4k;
    log_not_found off;

    gzip on;
    gzip_comp_level 5;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain application/xml text/css application/x-javascript;
    gzip_min_length 600;
    gzip_buffers 1000 64k;

    output_buffers 128 64k;
    postpone_output 1460;

    sendfile off;
    tcp_nopush on;
    tcp_nodelay on;

    keepalive_timeout 75 60;

    ignore_invalid_headers on;

    proxy_buffers 8000 16k;
    proxy_read_timeout 600;

    log_format main  '[$time_local] $http_host $remote_addr "$request" $status "$http_referer" "$http_user_agent" "$http_cookie" $request_time $upstream_cache_status $bytes_sent'; 

    access_log /var/log/nginx/access.log main;

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;

    server {
        listen  80;
        server_name master01h.kp.yandex.net www.kinopoisk.ru kinopoisk.ru;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        #proxy_set_header X-Geo-Country $geo;

        location ~* \.(inc|ht.*|hg|svn|git)$ {
            return 403;
        }

        location /cf {
            root /home/www/master01h.kp.yandex.net;
        }

        location /d {
            root /home/www/static.kinopoisk.ru;
            
            
        }
        location @imhandler {
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_intercept_errors off;
            proxy_pass http://127.0.0.1:8080;
            rewrite ^/im/(.*+)$ /handler_im.php?im=$1 break;
        }
        location /shab/chart_data {
            root /home/www/static.kinopoisk.ru;
        }
        location /graph_data {
            root /home/www/static.kinopoisk.ru/;
            expires 1d;
        }
        location /im {
            root /home/www/static.kinopoisk.ru;
            
            error_page 404 = @imhandler;
            log_not_found off;
            #
            expires 30d;
        }
        location /im/sms/ {
            root /home/www/kinopoisk.ru/;
        }
        location /error500.html {
            root /home/www/kinopoisk.ru/images;
        }
        location = /images/spacer.gif {
            empty_gif;
        }
        location = /images/spacer.jpg {
            empty_gif;
        }
        location =  /images/bnnr/viera_rebus.flv {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location /images/bnnr {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location ~* ^/images/.*\.(swf|flv|wmv)$ {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location /images/logonew2.gif {
            root /home/www/kinopoisk.ru/;
        }
        location ~* ^/images/[^/]+\.(html|jpg|jpeg|gif|png|ico|css|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|mid|midi|wav|bmp|rtf|js|swf|flv|wma|wmv|mp3)$
        {
            root /home/www/kinopoisk.ru/;
            expires 30d;
            break;
        }
        location = /images/favicon.ico
        {
            root /home/www/kinopoisk.ru/;
            break;
        }
        location /images/blog_kp/ {
            
            root /home/www/kinopoisk.ru/;
        }
        location /images/sm_actor/ {
            root /home/www/kinopoisk.ru/;
            expires 30d;
            
            
        }
        location /images/sm_film/ {
            root         /home/www/kinopoisk.ru/;
            expires      3d;
        
            
        }
        location /images/ {
            root         /home/www/kinopoisk.ru/;
            expires      30d;
            
        }
        location ~ /images/(kadr|kadr_2|kadr_sp|poster|events)/.*sm_ {
            root         /home/www/kinopoisk.ru/;
            expires      30d;
        }
        location ~ /images/wallpaper/.*sm_ {
            root         /home/www/kinopoisk.ru/;
            expires      30d;
        
        }
        location ~* ^/(.*/)?\.(hg|svn|git|mc|ht.*)/ {
            deny all;
        }
        location /omlet_price.php {
            proxy_pass http://127.0.0.1:8080;
        }
        location /adriver/ {
            root /home/www/kinopoisk.ru;
            expires 30d;
        }
        location /adriver/flap/ {
            proxy_pass http://127.0.0.1:8080;
        }
        location /js/ticket/ {
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* ^/adriver/.*\.(wma|avi|wmv|flv|swf|mov|mpg|mov)$ {
            root /home/www/kinopoisk.ru;
            expires 1d;
        }
        location = /kinopoisk.flv {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location ~ ^/podcast/[0-9]+\.mp3 {
            rewrite ^/podcast/([0-9]+)\.mp3 /handler_podcast.php?podcast=$1 break;
            proxy_pass http://127.0.0.1:8080;
        }
        location = /toolbar_news.xml {
            root /home/www/kinopoisk.ru/;
        }
        location = /tmp/player4.2/video.flv {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
       location ~* .*\.sw(fz) { 
            root /home/www/kinopoisk.ru/;
            expires 1d;
        }
        location ~* /js/.*\.swf {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location  ~* ^/trailers/flv/.*\.jpg$ {
            rewrite ^(.*) http://trailers.kinopoisk.ru$1 permanent;
        }
        location = /crossdomain.xml {
            root         /home/www/kinopoisk.ru/;
            expires      3d;
        }
        location = /level/403/ {
            rewrite ^/ http://error.kinopoisk.ru/?ht=2 redirect;
        }
        location ~* ^/tmp/.*\.(wma|avi|wmv|mov|mp4|mpg|flv|rss)$ {
            root /home/www/kinopoisk.ru/;
        }
        location ~* \.(wma|avi|wmv|flv|swf|mov|mpg|mov)$ {
            rewrite ^(.*) http://trailers.kinopoisk.ru$1 permanent;
        }
        location = /favicon.ico {
            root /home/www/kinopoisk.ru/;
            break;
        }
        location = /robots.txt {
            root /home/www/kinopoisk.ru/;
            expires 10d;
            break;
        }
        location = /sitemap.xml
        {
            return 404;
            break;
        }
        location ~* ^/.+\.(rss)$ {
            root /home/www/kinopoisk.ru/;
            break;
        }
        location /iframe_right.html {
            root /home/www/kinopoisk.ru/;
            break;
        }
        location /shab/chart {
            root /home/www/kinopoisk.ru/;
            break;
        }
        location /shab/chart_settings {
            #rewrite ^/(.*)$ http://st.kinopoisk.ru/$1 redirect;
            root /home/www/kinopoisk.ru/;
            expires 1d;
            break;
        }
        location ~* /rambler_stat/*.xml {
            root /home/www/kinopoisk.ru/;
            expires -1;
        }
        location /shab/ {
            root /home/www/kinopoisk.ru/;
            expires 1d;
            break;
        }
        location /plugins {
            root /home/www/kinopoisk.ru/;
            expires 3d;
            break;
        }
        location /screens {
            root /home/www/static.kinopoisk.ru/;
            expires 3d;
            break;
        }
        location /posters {
            root /home/www/kinopoisk.ru/;
            expires 3d;
            break;
        }
        location = /level {
           return 404;
           break;
        }
        location = /shablon {
           return 404;
           break;
        }
        location = /rating {
           return 404;
           break;
        }
        location /js/charts_swf/charts_key.txt {
            root /home/www/kinopoisk.ru/;
            
            
        }
        location /js/ {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location ~ ^/index.php$ {
#            limit_req   zone=search  burst=20;
            proxy_pass http://127.0.0.1:8080;
            if ($args ~ ^kpq= ) {
                proxy_pass http://127.0.0.1:8080;
            }
            if ($args ~ &kpq= ) {
                proxy_pass http://127.0.0.1:8080;
            }
            if ($args ~ ^kp_query= ) {
                proxy_pass http://127.0.0.1:8080;
            }
            if ($args ~ &kp_query= ) {
                proxy_pass http://127.0.0.1:8080;
            }
            if ($args ~ ^level=7& ) {
                proxy_pass http://127.0.0.1:8080;
            }
            if ($args ~ ^level=10& ) {
                proxy_pass http://127.0.0.1:8080;
            }
        }
        location = /level/404/ {
            #access_log /var/log/nginx/404-access.log notfound buffer=8192;
            proxy_pass http://127.0.0.1:8080;
            proxy_intercept_errors off;
        }
        location @error404 {
            proxy_intercept_errors off;
            #internal;
            #access_log /var/log/nginx/error404-access.log small;
            rewrite ^.*$ /level/404/ break;
            proxy_pass http://127.0.0.1:8080;
        }
        location / {
            return 403;
        }
        location ~* /level/(1|4|83)/ {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location /test.php {
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /level/(8|9|16|19|87|88|93|94|13)/ {
            #include /etc/nginx/access/deny.conf;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /level/(79|47|77)/ {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /handler_(recom|film_cf)\.php {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /level/(2)/ {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /(handler_stars|handler_mustsee.php)\.php {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /handler_calendar.php {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /handler_search.php {
            #rewrite ^/(.*)$ http://s.kinopoisk.ru/handler_search.php redirect;
            proxy_pass http://127.0.0.1:8080;
        }
        # April the 1st
        #location ~* /images/actor/[0-9]+.jpg {
        #    rewrite ^/images/actor/([0-9]+).jpg /handler_bw.php?id=$1 break;
        #}
        location /rating {
            location = /rating {
                error_page 404 /error404.html;
                return 404;
                break;
            }
            location = /rating/ {
                error_page 404 /error404.html;
                return 404;
                break;
            }
            location ~ ^/rating/[0-9]+.gif {
                #limit_req   zone=ratingbtn  burst=500;
                rewrite ^/rating/([0-9]+).gif /button_rating.php?id=$1 break;
                proxy_pass http://127.0.0.1:8080;
            }
            location ~ ^/rating/[0-9]+.xml {
                #limit_req   zone=ratingbtn  burst=500;
                rewrite ^/rating/([0-9]+).xml /button_rating.php?id=$1&type=xml break;
            proxy_pass http://127.0.0.1:8080;
            }
        }
        location /bo2/bo/images {
            root /home/www/kinopoisk.ru;
            expires 7d;
        }
        location ~ /bo2/bo/.*\.(js|css)$ {
            root /home/www/kinopoisk.ru;
        }
        location /export/ {
            deny all;
            proxy_pass http://127.0.0.1:8080;
        }
        location /export/export.php {
            proxy_pass http://127.0.0.1:8080;
        }
        location /bo {
            return 403;
        }
        location /handler_bo_dvd_release.php {
            proxy_pass http://127.0.0.1:8080;
        }
        location /tmp {
            proxy_pass http://127.0.0.1:8080;
        }
        location /adm-link {
            proxy_pass http://127.0.0.1:8080;
        }
        location /review/killbill/ {
            root home/www/kinopoisk.ru/;
            expires 1d;
            break;
        }
        #include /etc/nginx/statuspages.conf;
        location /airbender/ {
            rewrite ^/airbender/ /airbender.php break;
            proxy_pass http://127.0.0.1:8080;
        }

	#include /etc/nginx/fetch_from_old_st.conf;
    } # endof master01h.kp.yandex.net


   server {
        listen  [::]:80;
        server_name master01h.kp.yandex.net www.kinopoisk.ru kinopoisk.ru;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        #proxy_set_header X-Geo-Country $geo;

        location ~* \.(inc|ht.*|hg|svn|git)$ {
            return 403;
        }

        location /cf {
            root /home/www/master01h.kp.yandex.net;
        }

        location /d {
            root /home/www/static.kinopoisk.ru;
            
            
        }
        location @imhandler {
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_intercept_errors off;
            proxy_pass http://127.0.0.1:8080;
            rewrite ^/im/(.*+)$ /handler_im.php?im=$1 break;
        }
        location /shab/chart_data {
            root /home/www/static.kinopoisk.ru;
        }
        location /graph_data {
            root /home/www/kinopoisk.ru/;
            expires 1d;
        }
        location /im {
            root /home/www/static.kinopoisk.ru;
            
            error_page 404 = @imhandler;
            log_not_found off;
            #
            expires 30d;
        }
        location /im/sms/ {
            root /home/www/kinopoisk.ru/;
        }
        location /board/ {
            rewrite ^/board/(.*) http://forum.kinopoisk.ru/$1 permanent;
        }
        location /error500.html {
            root /home/www/kinopoisk.ru/images;
        }
        location = /images/spacer.gif {
            empty_gif;
        }
        location = /images/spacer.jpg {
            empty_gif;
        }
        location =  /images/bnnr/viera_rebus.flv {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location /images/bnnr {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location ~* ^/images/.*\.(swf|flv|wmv)$ {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location /images/logonew2.gif {
            root /home/www/kinopoisk.ru/;
        }
        location ~* ^/images/[^/]+\.(html|jpg|jpeg|gif|png|ico|css|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|mid|midi|wav|bmp|rtf|js|swf|flv|wma|wmv|mp3)$
        {
            root /home/www/kinopoisk.ru/;
            expires 30d;
            break;
        }
        location = /images/favicon.ico
        {
            root /home/www/kinopoisk.ru/;
            break;
        }
        location /images/blog_kp/ {
            
            root /home/www/kinopoisk.ru/;
        }
        location /images/sm_actor/ {
            root /home/www/kinopoisk.ru/;
            expires 30d;
            
            
        }
        location /images/sm_film/ {
            root         /home/www/kinopoisk.ru/;
            expires      3d;
        
            
        }
        location /images/ {
            root         /home/www/kinopoisk.ru/;
            expires      30d;
            
        }
        location ~ /images/(kadr|kadr_2|kadr_sp|poster|events)/.*sm_ {
            root         /home/www/kinopoisk.ru/;
            expires      30d;
        
        }
        location ~ /images/wallpaper/.*sm_ {
            root         /home/www/kinopoisk.ru/;
            expires      30d;
        
        }
        location ~* ^/(.*/)?\.(hg|svn|git|mc|ht.*)/ {
            deny all;
        }
        location /omlet_price.php {
            proxy_pass http://127.0.0.1:8080;
        }
        location /adriver/ {
            root /home/www/kinopoisk.ru;
            expires 30d;
        }
        location /adriver/flap/ {
            proxy_pass http://127.0.0.1:8080;
        }
        location /js/ticket/ {
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* ^/adriver/.*\.(wma|avi|wmv|flv|swf|mov|mpg|mov)$ {
            root /home/www/kinopoisk.ru;
            expires 1d;
        }
        location = /kinopoisk.flv {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location ~ ^/podcast/[0-9]+\.mp3 {
            rewrite ^/podcast/([0-9]+)\.mp3 /handler_podcast.php?podcast=$1 break;
            proxy_pass http://127.0.0.1:8080;
        }
        location = /toolbar_news.xml {
            root /home/www/kinopoisk.ru/;
        }
        location = /tmp/player4.2/video.flv {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
       location ~* .*\.sw(fz) { 
            root /home/www/kinopoisk.ru/;
            expires 1d;
        }
        location ~* /js/.*\.swf {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location  ~* ^/trailers/flv/.*\.jpg$ {
            rewrite ^(.*) http://trailers.kinopoisk.ru$1 permanent;
        }
        location = /crossdomain.xml {
            root         /home/www/kinopoisk.ru/;
            expires      3d;
        }
        location = /level/403/ {
            rewrite ^/ http://error.kinopoisk.ru/?ht=2 redirect;
        }
        location ~* ^/tmp/.*\.(wma|avi|wmv|mov|mp4|mpg|flv|rss)$ {
            root /home/www/kinopoisk.ru/;
        }
        location ~* \.(wma|avi|wmv|flv|swf|mov|mpg|mov)$ {
            rewrite ^(.*) http://trailers.kinopoisk.ru$1 permanent;
        }
        location = /favicon.ico {
            root /home/www/kinopoisk.ru/;
            break;
        }
        location = /robots.txt {
            root /home/www/kinopoisk.ru/;
            expires 10d;
            break;
        }
        location = /sitemap.xml
        {
            return 404;
            break;
        }
        location ~* ^/.+\.(rss)$ {
            root /home/www/kinopoisk.ru/;
            break;
        }
        location /iframe_right.html {
            root /home/www/kinopoisk.ru/;
            break;
        }
        location /shab/chart {
            root /home/www/kinopoisk.ru/;
            break;
        }
        location /shab/chart_settings {
            #rewrite ^/(.*)$ http://st.kinopoisk.ru/$1 redirect;
            root /home/www/kinopoisk.ru/;
            expires 1d;
            break;
        }
        location ~* /rambler_stat/*.xml {
            root /home/www/kinopoisk.ru/;
            expires -1;
        }
        location /shab/ {
            root /home/www/kinopoisk.ru/;
            expires 1d;
            break;
        }
        location /plugins {
            root /home/www/kinopoisk.ru/;
            expires 3d;
            break;
        }
        location /screens {
            root /home/www/static.kinopoisk.ru/;
            expires 3d;
            break;
        }
        location /posters {
            root /home/www/kinopoisk.ru/;
            expires 3d;
            break;
        }
        location = /level {
           return 404;
           break;
        }
        location = /shablon {
           return 404;
           break;
        }
        location = /rating {
           return 404;
           break;
        }
        location /js/charts_swf/charts_key.txt {
            root /home/www/kinopoisk.ru/;
            
            
        }
        location /js/ {
            root /home/www/kinopoisk.ru/;
            expires 30d;
        }
        location ~ ^/index.php$ {
#            limit_req   zone=search  burst=20;
            proxy_pass http://127.0.0.1:8080;
            if ($args ~ ^kpq= ) {
                proxy_pass http://127.0.0.1:8080;
            }
            if ($args ~ &kpq= ) {
                proxy_pass http://127.0.0.1:8080;
            }
            if ($args ~ ^kp_query= ) {
                proxy_pass http://127.0.0.1:8080;
            }
            if ($args ~ &kp_query= ) {
                proxy_pass http://127.0.0.1:8080;
            }
            if ($args ~ ^level=7& ) {
                proxy_pass http://127.0.0.1:8080;
            }
            if ($args ~ ^level=10& ) {
                proxy_pass http://127.0.0.1:8080;
            }
        }
        location = /level/404/ {
            #access_log /var/log/nginx/404-access.log notfound buffer=8192;
            proxy_pass http://127.0.0.1:8080;
            proxy_intercept_errors off;
        }
        location @error404 {
            proxy_intercept_errors off;
            #internal;
            #access_log /var/log/nginx/error404-access.log small;
            rewrite ^.*$ /level/404/ break;
            proxy_pass http://127.0.0.1:8080;
        }
        location / {
            return 403;
        }
        location ~* /level/(1|4|83)/ {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location /test.php {
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /level/(8|9|16|19|87|88|93|94|13)/ {
            #include /etc/nginx/access/deny.conf;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /level/(79|47|77)/ {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /handler_(recom|film_cf)\.php {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /level/(2)/ {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /(handler_stars|handler_mustsee.php)\.php {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /handler_calendar.php {
            #include /etc/nginx/access/deny.conf;
            proxy_pass http://127.0.0.1:8080;
        }
        location ~* /handler_search.php {
            #rewrite ^/(.*)$ http://s.kinopoisk.ru/handler_search.php redirect;
            proxy_pass http://127.0.0.1:8080;
        }
        # April the 1st
        #location ~* /images/actor/[0-9]+.jpg {
        #    rewrite ^/images/actor/([0-9]+).jpg /handler_bw.php?id=$1 break;
        #}
        location /rating {
            location = /rating {
                error_page 404 /error404.html;
                return 404;
                break;
            }
            location = /rating/ {
                error_page 404 /error404.html;
                return 404;
                break;
            }
            location ~ ^/rating/[0-9]+.gif {
                #limit_req   zone=ratingbtn  burst=500;
                rewrite ^/rating/([0-9]+).gif /button_rating.php?id=$1 break;
                proxy_pass http://127.0.0.1:8080;
            }
            location ~ ^/rating/[0-9]+.xml {
                #limit_req   zone=ratingbtn  burst=500;
                rewrite ^/rating/([0-9]+).xml /button_rating.php?id=$1&type=xml break;
            proxy_pass http://127.0.0.1:8080;
            }
        }
        location /bo2/bo/images {
            root /home/www/kinopoisk.ru;
            expires 7d;
        }
        location ~ /bo2/bo/.*\.(js|css)$ {
            root /home/www/kinopoisk.ru;
        }
        location /export/ {
            deny all;
            proxy_pass http://127.0.0.1:8080;
        }
        location /export/export.php {
            proxy_pass http://127.0.0.1:8080;
        }
        location /bo {
            return 403;
        }
        location /handler_bo_dvd_release.php {
            proxy_pass http://127.0.0.1:8080;
        }
        location /tmp {
            proxy_pass http://127.0.0.1:8080;
        }
        location /adm-link {
            proxy_pass http://127.0.0.1:8080;
        }
        location /review/killbill/ {
            root home/www/kinopoisk.ru/;
            expires 1d;
            break;
        }
        #include /etc/nginx/statuspages.conf;
        location /airbender/ {
            rewrite ^/airbender/ /airbender.php break;
            proxy_pass http://127.0.0.1:8080;
        }
	#include /etc/nginx/fetch_from_old_st.conf;
    } # endof master01h.kp.yandex.net

########################### ssl server for bo. #######################

    server {
        listen  80;
        server_name bo.kinopoisk.ru;
        location / {
            rewrite ^(.*)$ https://bo.kinopoisk.ru$1 permanent;
        }
    }

    server {
        listen 443;

        ssl on;

        ssl_protocols SSLv3 TLSv1; 
        ssl_certificate /etc/nginx/ssl_auth/host_bo.kinopoisk.ru.crt;
        ssl_certificate_key /etc/nginx/ssl_auth/host_bo.kinopoisk.ru.key;

        ssl_crl /etc/nginx/ssl_auth/crl.crt;
        ssl_client_certificate /etc/nginx/ssl_auth/ca_root.crt;
        ssl_verify_client on;
        ssl_verify_depth 2;
        ssl_session_cache  builtin:1000  shared:SSL:10m;
        ssl_session_timeout 24h;

        proxy_set_header Host $http_host;
        proxy_next_upstream error timeout invalid_header;
        proxy_read_timeout 600;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;

        access_log /var/log/nginx/access_ssl.log main;

        location /bo/podcast {
            proxy_pass http://conv01h.kp.yandex.net;
        }
        location /bo/trailer {
            proxy_pass http://conv01h.kp.yandex.net;
        }
        location /bo/channel {
            proxy_pass http://conv01h.kp.yandex.net;
        }
        location = /bo/file_upload.php {
            proxy_pass http://conv01h.kp.yandex.net;
        }

        location /bo2 {
            proxy_pass http://127.0.0.1:8080;
        }

        location /bo {
            proxy_pass http://127.0.0.1:8080;
        }

        location /backadmin {
            proxy_pass http://127.0.0.1:8080;
        }
        location /backoffice {
            proxy_pass http://127.0.0.1:8080;
        }

        location ~* /hg {
            proxy_pass http://127.0.0.1:8000;
            proxy_set_header Host 127.0.0.1;
        }
        location /hg/static {
            root /usr/share/mercurial/templates;
            rewrite ^/hg(.*) $1 break;
        }
        location ~ ^/server-face/([^/])(.*)$ {
            proxy_set_header Host www.kinopoisk.ru;
            proxy_pass http://$1;
            rewrite_log on;
            rewrite ^/server-face/([^/]+)(/|/(.*))?$ /$3 break;
        }
        location ~* \.(xml|js|swf|css|gif|jpg)$ {
            root /home/www/kinopoisk.ru;
        }
        location / {
            rewrite ^(.*)$ http://www.kinopoisk.ru$1 permanent;
        }
    }
# end of ################## ssl server for bo. #######################

############ Host for images with different sizes ####################
    server {
        server_name win8.st.kinopoisk.ru;
        root /home/www/kinopoisk.ru/images/win8;
        # access_log /home/logs/win8.log;
        # error_log /home/logs/win8.err.log debug;

        # Example http://win8.st.kinopoisk.ru/film/2/263531.jpg?scale=576
        # $tp = /film
        # $n1 = 2
        # $n2 = 263531
        # $t = .jpg
        # $arg_scale 576
        location ~* ^(?<tp>.+)/(?<n1>\d)/(?<n2>\d+)(?<t>\..+) {
            if ( $args ~ scale ) {
                rewrite ^ $tp/$n1/$arg_scale/$n2$t? last;
            }
        }

        # Example http://win8.st.kinopoisk.ru/film/2/576/263531.jpg
        # $tp = /film
        # $n = 2
        # $t = 263531.jpg
        # $scale 576
        location ~* ^(?<tp>.+)/(?<n>\d)/(?<scale>\d+/)(?<t>.+) {
            if ( !-f $request_filename ) {
                rewrite ^ http://win8.st.kinopoisk.ru$tp/$n/$t redirect;
            }
        }
    }
# end of ### Host for images with different sizes ###################

    server {
        server_name ios.st.kinopoisk.ru;
        root /home/www/static.kinopoisk.ru/;
        
       location ~* ^/images/(?<tp>.+)/iphone_(?<n1>\d+)(?<t>\..+) {
            if ( $args ~ width ) {
                rewrite ^ /images/$tp/iphone${arg_width}_$n1$t? redirect;
            }
            if ( $args ~ height ) {
                rewrite ^ /images/$tp/iphone${arg_height}z_$n1$t? redirect;
            }
        }
    }
# end of ### Host for images with different sizes ###################

  server {
        listen [::]:80;
        server_name test-ro-graphdata.kp.yandex.net;
        root /home/www/static.kinopoisk.ru;
    }

}
