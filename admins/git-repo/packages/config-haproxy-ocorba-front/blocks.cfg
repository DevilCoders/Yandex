{% set id = 10 %}
{% macro acl(name, vhost) %}
acl is_{{ vhost }} hdr_dom(X-Service) -i {{ name }}
use_backend {{ name }} if is_{{ vhost }}
{%- endmacro %}

{% macro backend(id, name, vhost, group) %}
backend {{ name }}
    balance roundrobin
    id {{ id }}
    option httpchk GET / HTTP/1.1\r\nHost:{{ vhost }}\r\nAccept:text/html
    option forwardfor except 127.0.0.1
    http-check disable-on-404
    stats enable
    timeout server 24000
 
{%- set backends = conductor.group_hostnames(group) %}

{% for backend in backends %}
    server {{ backend }} {{ backend }}:80 cookie site412ha check inter 3000 fall 4{% if not conductor.in_my_root_datacenter(backend) %} backup{% endif %}

{% endfor %}
{%- endmacro %}

