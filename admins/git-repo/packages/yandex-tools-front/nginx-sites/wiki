upstream wiki_upstream {
	server wiki01e.tools.yandex-team.ru max_fails=10 fail_timeout=10s weight=1000000;
	server wiki01d.tools.yandex-team.ru max_fails=0 weight=1;
#	server wiki01d.tools.yandex-team.ru backup;
}

server {
	listen 80;
        listen 84;
	listen 443 ssl;
        listen 444 ssl;

	client_max_body_size 210m;	
	server_name wiki;
	access_log /var/log/nginx/wiki.access.log main;

        location /ping {
                return 200 ok;
        }

	location / {
		rewrite ^/planning(.*) $scheme://planner.yandex-team.ru$1 permanent; 	
		rewrite ^(.*) $scheme://wiki.yandex-team.ru$1 permanent;
	}

        ssl_protocols SSLv3 TLSv1;
        ssl_certificate /etc/nginx/ssl/wc.yandex-team.ru.crt;
        ssl_certificate_key /etc/nginx/ssl/wc.yandex-team.ru.key;
}


server {
	listen 80;
        listen 84;
	listen 443 ssl;
        listen 444 ssl;

	client_max_body_size 210m;
	server_name wiki.yandex.net;
	access_log /var/log/nginx/wiki.access.log main;
		
	location / {
		proxy_http_version 1.1;
		proxy_pass           http://wiki_upstream;
		proxy_set_header     Host      wiki.yandex.net;
		proxy_set_header     X-Real-IP $remote_addr;
		if ($scheme = https) {
			set $SSL  on;
		}
		proxy_set_header  X-HTTPS  $SSL;
	}

        ssl_protocols SSLv3 TLSv1;
        ssl_certificate /etc/nginx/ssl/wc.yandex-team.ru.crt;
        ssl_certificate_key /etc/nginx/ssl/wc.yandex-team.ru.key;
}

server {
	listen 80;
        listen 84;
	listen 443 ssl;
        listen 444 ssl;

	client_max_body_size 210m;
	server_name wiki.*;
	access_log /var/log/nginx/wiki.access.log main;

	if ($http_user_agent ~* Apple-PubSub) {
	   return 403;
	   }

	location / {
		proxy_http_version 1.1;
		rewrite ^/planning(.*) $scheme://planner.yandex-team.ru$1 permanent;
		proxy_connect_timeout   10000ms;
		proxy_next_upstream  timeout http_502;
		proxy_pass           http://wiki_upstream;
		proxy_set_header     Host      $host;
		proxy_set_header     X-Real-IP $remote_addr;
		if ($scheme = https) {
			set $SSL  on;
		}
		proxy_set_header  X-HTTPS  $SSL;

	}

        ssl_protocols SSLv3 TLSv1;
        ssl_certificate /etc/nginx/ssl/wc.yandex-team.ru.crt;
        ssl_certificate_key /etc/nginx/ssl/wc.yandex-team.ru.key;
}
