upstream ml-upstream {
    server django-front01e5.tools.yandex.net max_fails=2 fail_timeout=60s;
    server django-front02e5.tools.yandex.net max_fails=2 fail_timeout=60s;
    server django-front01d.tools.yandex.net max_fails=2 fail_timeout=60s;
    server django-front02d.tools.yandex.net max_fails=2 fail_timeout=60s;
    server django-front01g.tools.yandex.net max_fails=2 fail_timeout=60s;
    server django-front02g.tools.yandex.net max_fails=2 fail_timeout=60s;
}

server {
    include listen;
    server_name ml.tools.yandex.net;

    location /api {
   	     proxy_connect_timeout   1000ms;
             proxy_next_upstream error timeout invalid_header http_502;
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header Host $host;
             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
             proxy_pass http://ml-upstream;
	}

    location /apiv2 {
   	     proxy_connect_timeout   1000ms;
             proxy_next_upstream error timeout invalid_header http_502;
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header Host $host;
             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
             proxy_pass http://ml-upstream;
	}


     location / { return 403; }
}