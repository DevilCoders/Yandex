upstream gr_upstream {
        server graphite01d.corba.yandex.net max_fails=1 fail_timeout=10s;
        server graphite02d.corba.yandex.net max_fails=1 fail_timeout=10s;
        server graphite03d.corba.yandex.net max_fails=1 fail_timeout=10s;
        server graphite01g.corba.yandex.net max_fails=1 fail_timeout=10s;
        server graphite02g.corba.yandex.net max_fails=1 fail_timeout=10s;
        server graphite03g.corba.yandex.net max_fails=1 fail_timeout=10s;
        server graphite01f.corba.yandex.net max_fails=1 fail_timeout=10s;
        server graphite02f.corba.yandex.net max_fails=1 fail_timeout=10s;
        server graphite03f.corba.yandex.net max_fails=1 fail_timeout=10s;
}

server {
        include listen;

        server_name gr-api;
        location / {
                rewrite ^(.*) $scheme://gr-api.yandex-team.ru$1 permanent;
        }
}

server {
        include listen;

        server_name  gr-api.*;

        access_log /var/log/nginx/gr-api.access.log main;

        location / {
                proxy_pass http://gr_upstream;
                proxy_set_header Host                   gr.yandex-team.ru;
                proxy_set_header X-Real-IP              $remote_addr;
        }
}
