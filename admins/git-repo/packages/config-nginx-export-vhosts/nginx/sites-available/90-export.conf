server {
	include listen;
	include listen_ssl;
	
	server_name export.yandex.ru export-ng.yandex.ru;
	server_name browser.export.yandex.com;
	server_name ~^export\.[a-z0-9\-]+\.yandex\.ru$;
	server_name ~^browser\.export\.[a-z0-9\-]+\.yandex\.ru$;
	server_name ~^export-ng\.[a-z0-9\-]+\.yandex\.ru$;

	include locations/404-xml;
	include locations/add-final-slash;
	root /usr/local/www5/export;

	rewrite /weather\-ng/([^/]*/.*) /get/weather/$1 last;
	rewrite /weather\-ng/(export)([^/]*\.tar\.[^/]*) /get/weather/$1/$1$2 last;
	rewrite /weather\-ng/(forecasts|forecasts\-by\-geo)(\.tar\.[^/]*) /get/weather/$1/$1$2 last;
	rewrite ^/for/.*/(.*\.xml)\?(.*)$ /$1?$2&usepdd=1 last;
	rewrite ^/for/.*/(.*\.xml)$ /$1?usepdd=1 last;

	if ($http_referer = "" ) { set $access_ok 1; }
	if ($http_referer ~* ^(http(s)?:\/\/)?(([^\?\/]*\.)?(yandex(-team)?\.(ru|ua|com|net|kz|by|st|com\.tr)|ya\.ru|moikrug\.ru)(:\d+)?(\/.*)?|x-gadget.*)$ ) { 
		set $access_ok 1; }
	if ($http_referer ~* ^file:\/\/) { set $access_ok 1; }
	if ($access_ok !~ 1) { return 403; }

	location /get/weather { 
		#proxy_cache weather-archive;
		#proxy_cache_valid 5m;
		#proxy_cache_valid 404 1m;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		# https://st.yandex-team.ru/CADMIN-806
		# corba_export has no IPv6
		#proxy_pass http://weather-elliptics.weather.yandex.net;
		proxy_pass http://5.255.240.146;
		}	
	
	location =/counters-js {
		fastcgi_intercept_errors on;
		if ($args ~* usepdd) {
			fastcgi_pass unix:/tmp/xscript-multiple/xscript-pdd.sock;
			}
		fastcgi_pass unix:/tmp/xscript-multiple/xscript-export.sock;
		include fastcgi_params_yandex;
		}
	location /xml/services.mybar.xml { root /usr/local/www5/export; }
	location /last/last20x-static.xml { root /usr/local/www5/export; }
	location /cards/mail_banner.xml { root /usr/local/www5/export; }
	location /phonedetect-export { root /usr/local/www5/export; }
	location /bar/config.xml { root /usr/local/www5/export; }
	location /geobase/ { root /usr/local/www5/export; }

	location / {
		location ~* \.xml(\?.*)?$ {
			fastcgi_intercept_errors on;
			if ($args ~* usepdd) {
				fastcgi_pass unix:/tmp/xscript-multiple/xscript-pdd.sock;
				}
			fastcgi_pass unix:/tmp/xscript-multiple/xscript-export.sock;
			include fastcgi_params_yandex;
			}
		}
}

