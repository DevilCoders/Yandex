server {
       server_name pda.lenta.yandex.ru;
       server_name m.lenta.yandex.ru;
       server_name ~^pda\.lenta\.[a-z0-9\-]+\.yandex\.ru$;
       server_name ~^m\.lenta\.[a-z0-9\-]+\.yandex\.ru$;

       include listen;
       include locations/404-xml;
       root /usr/local/www5/pda.lenta;

       location ^~ /for/ {
       		set $pdd 1;
		#rewrite ^/for/pdd-domain.xml  /pdd-domain.xml last;
		#rewrite ^/for/[^/]+/?(.*)$    /$1 last;
		rewrite ^(/for/[^/]+)(/[^?]*)$ $2?usepdd=$1 last;
		rewrite ^(/for/[^/]+)(/[^?]*\?.*)$ $2&usepdd=$1 last;
		rewrite ^(/for/[^?/]+)$ $1/ permanent;
		rewrite ^(/for/[^?/]+)(\?.*)$ permanent;
		}

       location ~* \.xml$ {
       		fastcgi_intercept_errors on;
		fastcgi_pass unix:/tmp/xscript-multiple/xscript-default.sock;
		if ($pdd = 1) {
		   fastcgi_pass unix:/tmp/xscript-multiple/xscript-pdd.sock;
		   }
		include fastcgi_params_yandex;
		}		
}


