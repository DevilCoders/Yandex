server {
    include listen;

    server_name safe.yandex.ru;
    server_name safe.yandex.ua;
    server_name safe.yandex.by;
    server_name safe.yandex.kz;
    server_name safe.yandex.com;
    server_name safe.yandex.com.tr;

    server_name ~^safe\.[a-z0-9\-]+\.yandex\.ru$;
    server_name ~^safe\.[a-z0-9\-]+\.yandex\.ua$;
    server_name ~^safe\.[a-z0-9\-]+\.yandex\.by$;
    server_name ~^safe\.[a-z0-9\-]+\.yandex\.kz$;
    server_name ~^safe\.[a-z0-9\-]+\.yandex\.com$;
    server_name ~^safe\.[a-z0-9\-]+\.yandex\.com\.tr$;

    root /usr/local/www5/sbapi;

    location ~ /configs/ {
        return 404;
    }

    include fastcgi_params_yandex;
    include xscripts/default;

    include locations/404-xml;
    include locations/add-final-slash;
    include locations/lego-xml-deny;

    rewrite ^/(\?.*)?$ /pages-desktop/main.xml$1 last;
    rewrite ^/(\w+)/(\?.*)?$ /pages-desktop/main.xml$2 last;
    rewrite ^/robots.txt$ /pages-desktop/robots.txt last;
}

server {
    include listen;
    server_name www.safe.yandex.ru;
    rewrite ^/(.*) http://safe.yandex.ru/$1 redirect;
}
server {
    include listen;
    server_name www.safe.yandex.ua;
    rewrite ^/(.*) http://safe.yandex.ua/$1 redirect;
}
server {
    include listen;
    server_name www.safe.yandex.by;
    rewrite ^/(.*) http://safe.yandex.by/$1 redirect;
}
server {
    include listen;
    server_name www.safe.yandex.kz;
    rewrite ^/(.*) http://safe.yandex.kz/$1 redirect;
}
server {
    include listen;
    server_name www.safe.yandex.com;
    rewrite ^/(.*) http://safe.yandex.com/$1 redirect;
}
server {
    include listen;
    server_name www.safe.yandex.com.tr;
    rewrite ^/(.*) http://safe.yandex.com.tr/$1 redirect;
}
server {
    include listen;
    server_name ~^www\.safe(?<server>\.[a-z0-9\-]+)\.yandex\.(?<tld>ru|ua|by|kz|com|com\.tr)$;
    rewrite ^/(.*)$ http://safe$server.yandex.$tld/$1 redirect;
}
