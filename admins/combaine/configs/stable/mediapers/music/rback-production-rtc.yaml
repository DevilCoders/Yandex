---
name: mediapers_stable_music_web_execution_rtc
parsing:
  groups: [mediapers_stable_music_web_man, mediapers_stable_music_web_sas, mediapers_stable_music_web_vla]
  HostFetcher:
    type: "rtc"
    geo: [""]
    BasicUrl: "http://nanny.yandex-team.ru/v2/services/%s/current_state/instances/"
  metahost: mediapers_stable_music_web
  DataFetcher:
    logname : "ichwill/music-web/execution.log"
    timetail_url: "/timetail?pattern=execution&type=tskv&log_ts="
aggregate:
  data:
    nginx:
      type: custom
      class: Multimetrics
      factor: 1000
      values: [50, 75, 90, 95, 99, 100]
      perHost: YES
  senders:
    solomon:
      type: solomon
      cluster: stable
      project: mediapers
      Fields: [ "50_prc", "75_prc", "90_prc", "95_prc", "99_prc", "100_prc" ]
      service: nginx
    graphite:
      type: graphite
      cluster: media.mediapers.music.stable
      Fields: [ "50_prc", "75_prc", "90_prc", "95_prc", "99_prc", "100_prc" ]
---
name: mediapers_stable_music_web_nginx_handlers_rtc
parsing:
  groups: [mediapers_stable_music_web_man, mediapers_stable_music_web_sas, mediapers_stable_music_web_vla]
  HostFetcher:
    type: "rtc"
    geo: [""]
    BasicUrl: "http://nanny.yandex-team.ru/v2/services/%s/current_state/instances/"
  metahost: mediapers_stable_music_web
  DataFetcher:
    timetail_url: "/timetail?pattern=handles&type=tskv&log_ts="
aggregate:
  data:
    nginx:
      type: custom
      class: Multimetrics
      factor: 1000
      values: [50, 75, 90, 95, 99, 100]
      perHost: YES
  senders:
    solomon:
      type: solomon
      cluster: stable
      project: mediapers
      Fields: [ "50_prc", "75_prc", "90_prc", "95_prc", "99_prc", "100_prc" ]
      service: nginx
    graphite:
      type: graphite
      cluster: media.mediapers.music.stable
      Fields: [ "50_prc", "75_prc", "90_prc", "95_prc", "99_prc", "100_prc" ]
    http_status_workday: &picker-conf
        type: juggler
        namespace: mediapers
        notifications:
            - template_name: on_status_change
              template_kwargs:
                  delay: 300 # seconds
                  status:
                    - {from: OK, to: CRIT}
                    - {from: WARN, to: CRIT}
                  method: [telegram, email]
                  login:  [mediapers-monitoring, burlada]
        plugin: picker
        Host: "mediapers_stable_music_web_workday"
        Aggregator: timed_more_than_limit_is_problem
        checkname: rback_http_error
        description: rback_http_error
        ttl: 90
        tags: ['music', 'rtc']
        aggregator_kwargs:
            nodata_mode: force_ok
            limits:
            - {time_start: 11, time_end: 19, day_start: 1, day_end: 5, crit: 0}
            - {time_start: 11, time_end: 19, day_start: 6, day_end: 7, crit: 101%}
            - {time_start: 20, time_end: 10, day_start: 1, day_end: 7, crit: 101%}
        config:
            type: metahost
            as_percent: true
            query: "handles.api%-v1.(.+([45]xx))$"
            limits:
                "default": 1
    http_status_holiday:
        << : *picker-conf
        Host: "mediapers_stable_music_web_holiday"
        aggregator_kwargs:
            nodata_mode: force_ok
            limits:
            - {time_start: 11, time_end: 19, day_start: 1, day_end: 5, crit: 101%}
            - {time_start: 11, time_end: 19, day_start: 6, day_end: 7, crit: 0}
            - {time_start: 20, time_end: 10, day_start: 1, day_end: 7, crit: 0}
        config:
            type: metahost
            as_percent: true
            query: "handles.api%-v1.(.+([45]xx))$"
            limits:
                "default": 15
    upstream_timings:
        << : *picker-conf
        Host: "mediapers_stable_music_web"
        aggregator_kwargs:
            nodata_mode: force_ok
            limits: [{day_start: 1, day_end: 7, time_start: 0, time_end: 23, crit: 0}]
        config:
            type: metahost
            query: "handles.api%-v1%.(.+total_upstream_timings(/[4]))$"
            limits:
                "get-feed.total_upstream_timings/4": [2000, "95prc"]
                "get-radio.total_upstream_timings/4": [3000, "95prc"]
                "get-playlist-from-seed.total_upstream_timings/4": [2000, "95prc"]
                "get-auto-playlist.total_upstream_timings/4": [3000, "95prc"]
                "get-alice.total_upstream_timings/4": [3000, "95prc"]
                "get-recommended-stations.total_upstream_timings/4": [2000, "95prc"]
                "radio-is-available-batch.total_upstream_timings/4": [2000, "95prc"]
                default: [5000, default_ok]
---
name: mediapers_stable_music_web_nginx_rtc
parsing:
  groups: [mediapers_stable_music_web_man, mediapers_stable_music_web_sas, mediapers_stable_music_web_vla]
  HostFetcher:
    type: "rtc"
    geo: [""]
    BasicUrl: "http://nanny.yandex-team.ru/v2/services/%s/current_state/instances/"
  metahost: mediapers_stable_music_web
  DataFetcher:
    timetail_url: "/timetail?pattern=web&type=tskv&log_ts="
aggregate:
  data:
    nginx:
      type: custom
      class: Multimetrics
      factor: 1000
      values: [50, 75, 90, 95, 99, 100]
      perHost: YES
  senders:
    solomon:
      type: solomon
      cluster: stable
      project: mediapers
      Fields: [ "50_prc", "75_prc", "90_prc", "95_prc", "99_prc", "100_prc" ]
      service: nginx
    graphite:
      type: graphite
      cluster: media.mediapers.music.stable
      Fields: [ "50_prc", "75_prc", "90_prc", "95_prc", "99_prc", "100_prc" ]
    5xx: &picker-conf
      type: juggler
      namespace: mediapers
      notifications:
      - template_name: on_status_change
        template_kwargs:
          delay: 300 # seconds
          status:
          - {from: OK, to: CRIT}
          - {from: WARN, to: CRIT}
          method: [telegram, email]
          login:  [mediapers-monitoring, burlada]
      plugin: picker
      Host: "mediapers_stable_music_web"
      Aggregator: timed_more_than_limit_is_problem
      ttl: 90
      tags: ['music', 'rtc']
      aggregator_kwargs:
        nodata_mode: force_ok
        limits: [{day_start: 1, day_end: 7, time_start: 0, time_end: 23, crit: 0}]
      checkname: 5xx
      description: 5xx
      config:
        history: 3
        type: metahost
      CRIT: ["${nginx}['5xx']>0.35"]
    4xx:
      << : *picker-conf
      checkname: 4xx
      description: 4xx
      config:
        history: 3
        type: metahost
      CRIT: ["${nginx}['4xx']>0.1"]
---
name: mediapers_stable_music_web_java_rtc
parsing:
  groups: [mediapers_stable_music_web_man, mediapers_stable_music_web_sas, mediapers_stable_music_web_vla]
  HostFetcher:
    type: "rtc"
    geo: [""]
    BasicUrl: "http://nanny.yandex-team.ru/v2/services/%s/current_state/instances/"
  metahost: mediapers_stable_music_web
  DataFetcher:
    logname : "ichwill/music-web/ichwill.log"
    timetail_url: "/timetail?&pattern=java&type=java&log_ts="
aggregate:
  data:
    java:
      type: custom
      class: Multimetrics
      perHost: YES
  senders:
    solomon:
      type: solomon
      cluster: stable
      project: mediapers
      service: java
    graphite:
      type: graphite
      cluster: media.mediapers.music.stable
---
name: mediapers_stable_music_web_no_log_stats_rtc
parsing:
  groups: [mediapers_stable_music_web_man, mediapers_stable_music_web_sas, mediapers_stable_music_web_vla]
  HostFetcher:
    type: "rtc"
    geo: [""]
    BasicUrl: "http://nanny.yandex-team.ru/v2/services/%s/current_state/instances/"
  metahost: mediapers_stable_music_web
  DataFetcher:
    timetail_url: "/exec_pattern?pattern=no_log_stats&log_ts="
aggregate:
  data:
    no_log_stats:
      type: custom
      class: Multimetrics
      rps: "no"
      perHost: YES
  senders:
    solomon:
      type: solomon
      cluster: stable
      project: mediapers
      service: no_log_stats
    graphite:
      type: graphite
      cluster: media.mediapers.music.stable
---
name: mediapers_stable_music_web_java_non_request_rtc
parsing:
  groups: [mediapers_stable_music_web_man, mediapers_stable_music_web_sas, mediapers_stable_music_web_vla]
  HostFetcher:
    type: "rtc"
    geo: [""]
    BasicUrl: "http://nanny.yandex-team.ru/v2/services/%s/current_state/instances/"
  metahost: mediapers_stable_music_web
  DataFetcher:
    logname : "ichwill/music-web/ichwill.log"
    timetail_url: "/timetail?&pattern=java_non_request&type=java&log_ts="
aggregate:
  data:
    java_non_request:
      type: custom
      class: Multimetrics
      rps: "no"
      perHost: NO
  senders:
    solomon:
      type: solomon
      cluster: stable
      project: mediapers
      service: java_non_request
    graphite:
      type: graphite
      cluster: media.mediapers.music.stable
    snapshot_decay_monitor:
      type: "juggler"
      namespace: "mediapers"
      notifications:
        - template_name: on_status_change
          template_kwargs:
              delay: 300 #seconds
              status:
                - {from: OK, to: CRIT}
                - {from: WARN, to: CRIT}
              method: [telegram, email]
              login:  [mediapers-monitoring, burlada]
      plugin: picker
      Host: "mediapers_stable_music_web"
      Aggregator: timed_more_than_limit_is_problem
      checkname: snapshot_decay
      description: snapshot_decay
      ttl: 90
      tags: ['music', 'rtc']
      aggregator_kwargs:
          nodata_mode: force_ok
          limits:
          - {time_start: 11, time_end: 19, day_start: 1, day_end: 5, crit: 0}
          - {time_start: 11, time_end: 19, day_start: 6, day_end: 7, crit: 101%}
          - {time_start: 20, time_end: 10, day_start: 1, day_end: 7, crit: 101%}
      config:
          type: metahost
          query: "(snapshot_decay)_(.+)$"
          limits:
              "default": 1000
---
name: mediapers_stable_music_web_sysmon_rtc
parsing:
  groups: [mediapers_stable_music_web_man, mediapers_stable_music_web_sas, mediapers_stable_music_web_vla]
  HostFetcher:
    type: "rtc"
    geo: [""]
    BasicUrl: "http://nanny.yandex-team.ru/v2/services/%s/current_state/instances/"
  metahost: mediapers_stable_music_web
  DataFetcher:
    timetail_url: "/exec_pattern?pattern=sysmon&log_ts="
aggregate:
  data:
    sysmon:
      type: custom
      class: Multimetrics
      rps: "no"
      perHost: YES
  senders:
    solomon:
      type: solomon
      cluster: stable
      project: mediapers
      service: sysmon
    graphite:
      type: graphite
      cluster: media.mediapers.music.stable
