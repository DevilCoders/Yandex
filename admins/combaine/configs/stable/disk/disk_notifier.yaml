---
name: disk_notifier-logbroker_lag
parsing:
  groups: [disk_notifier]
  metahost: notifier.disk.yandex.net
  DataFetcher:
    type: http
    port: 3132
    uri: "/exec_pattern?pattern=logbroker_lag&timeout=100"
  Combainer:
    MINIMUM_PERIOD: 55
aggregate:
  data:
    logbroker_lag:
      type: "custom"
      class: "Max"
      rps: no
  senders:
    graphite:
      cluster: "media.disk"
      type: graphite

    juggler_logbroker_pull_lag_sas: &juggler-conf
      type: juggler
      namespace: disk
      Host: "notifier.disk.yandex.net"
      notifications:
        - template_name: phone_escalation
          template_kwargs:
            on_success_next_call_delay: 120
            repeat: 100
            delay: 900
            logins:
                - robot-disk-duty-adm
                - robot-disk-duty-jun
                - ivanov-d-s
                - kolyann
                - ignition
      Aggregator: logic_or
      checkname: logbroker_pull_lag_sas
      description: logbroker_pull_lag_sas
      aggregator_kwargs:
        nodata_mode: force_ok
      flaps: { stable_time: 120, critical_time: 180 }
      CRIT: [ "${logbroker_lag}['sas_sas']  > 150000" ]
      tags:
        - production

    juggler_logbroker_lag_myt:
      << : *juggler-conf
      checkname: logbroker_pull_lag_myt
      description: logbroker_pull_lag_myt
      CRIT: [ "${logbroker_lag}['myt_myt']  > 150000" ]

    juggler_logbroker_lag_fol:
      << : *juggler-conf
      checkname: logbroker_pull_lag_fol
      description: logbroker_pull_lag_fol
      CRIT: [ "${logbroker_lag}['fol_fol']  > 150000" ]

    juggler_logbroker_lag_iva:
      << : *juggler-conf
      checkname: logbroker_pull_lag_iva
      description: logbroker_pull_lag_iva
      CRIT: [ "${logbroker_lag}['iva_iva']  > 150000" ]

    juggler_logbroker_lag_man:
      << : *juggler-conf
      checkname: logbroker_pull_lag_man
      description: logbroker_pull_lag_man
      CRIT: [ "${logbroker_lag}['man_man']  > 150000" ]

---
name: disk_notifier-logbroker_stat
parsing:
  groups: [disk_notifier]
  metahost: notifier.disk.yandex.net
  DataFetcher:
    logname: 'yandex/disk/notifier-tskv.log'
    timetail_url: '/timetail?pattern=logbroker_stat&timeout=60&type=java&log_ts='
  Combainer:
    MINIMUM_PERIOD: 60
aggregate:
  data:
    logbroker_stat:
      type: "custom"
      class: "Multimetrics"
  senders:
    graphite:
      cluster: "media.disk"
      type: graphite

    juggler_lag_timings_90perc: &juggler-conf
      type: juggler
      namespace: disk
      Host: "notifier.disk.yandex.net"
      notifications:
        - template_name: phone_escalation
          template_kwargs:
            on_success_next_call_delay: 120
            repeat: 100
            delay: 900
            logins:
                - robot-disk-duty-adm
                - robot-disk-duty-jun
                - ivanov-d-s
                - kolyann
                - ignition
      Aggregator: logic_or
      checkname: lag_timings_90perc
      description: lag_timings_90perc
      flaps: { stable_time: 300, critical_time: 3600 }
      aggregator_kwargs:
        nodata_mode: force_ok
      CRIT: [" ${logbroker_stat}['lag_timings'][1] > 1800 "]
      tags:
        - production

---
name: disk_notifier-requests_http
parsing:
  groups: [disk_notifier]
  metahost: notifier.disk.yandex.net
  DataFetcher: 
    logname: 'yandex/disk/notifier-tskv.log'
    timetail_url: '/timetail?pattern=requests_http&type=java&timeout=60&log_ts='
  Combainer:
    MINIMUM_PERIOD: 60
aggregate:
  data:
    requests_http:
      type: "custom"
      class: "Multimetrics"
  senders:
    graphite:
      cluster: "media.disk"
      type: graphite

---
name: disk_notifier-requests_pg
parsing:
  groups: [disk_notifier]
  metahost: notifier.disk.yandex.net
  DataFetcher: 
    logname: 'yandex/disk/notifier-tskv.log'
    timetail_url: '/timetail?pattern=requests_pg&type=java&timeout=60&log_ts='
  Combainer:
    MINIMUM_PERIOD: 60
aggregate:
  data:
    requests_pg:
      type: "custom"
      class: "Multimetrics"
  senders:
    graphite:
      cluster: "media.disk"
      type: graphite

---
name: disk_notifier-nginx_stat
parsing:
  groups: [disk_notifier]
  metahost: notifier.disk.yandex.net
  DataFetcher:
    logname: "nginx/access-tskv.log"
    timetail_url: "/timetail?pattern=nginx&type=tskv&log_ts="

aggregate:
  data:
    nginx:
      type: "custom"
      class: "Multimetrics"
  senders:
    graphite:
      cluster: "media.disk"
      type: graphite

    juggler_disk_notifier_nginx_status_5xx: &juggler-conf
      type: juggler
      namespace: disk
      host: "notifier.disk.yandex.net"
      notifications:
        - template_name: phone_escalation
          template_kwargs:
            on_success_next_call_delay: 120
            repeat: 100
            delay: 900
            logins:
                - robot-disk-duty-adm
                - robot-disk-duty-jun
                - ivanov-d-s
                - kolyann
                - ignition
      Aggregator: logic_or
      checkname: disk_notifier_nginx_status_5xx
      description: disk_notifier_nginx_status_5xx
      flaps: { stable_time: 120, critical_time: 300 }
      aggregator_kwargs:
        nodata_mode: force_ok
      CRIT: [" ${nginx}['5xx'] > 5"]
      tags:
        - disk_notifier
        - production
        - disk_admin_critical
        
    juggler_disk_notifier_nginx_timings_99perc:
      << : *juggler-conf
      checkname: disk_notifier_nginx_timings_99perc
      description: disk_notifier_nginx_timings_99perc
      CRIT: [" ${nginx}['request_timings'][6] > 500" ]
      tags:
        - disk_notifier
        - disk_timings
        - disk_admin_critical
        - production
        
    juggler_disk_notifier_nginx_status_5xx_peak:
      << : *juggler-conf
      notifications:
        - template_name: on_status_change
          description: СМС в полминуты
          template_kwargs:
              status:
                  - to: CRIT
                    from: OK
                  - to: OK
                    from: CRIT
                  - to: WARN
                    from: CRIT
                  - to: CRIT
                    from: WARN
              min_interval: 30
              login:
                - robot-disk-java-mntr
                - shirankov
                - akinfold
                - kis8ya
                - sanya2013
                - yak-dmitriy
                - friendlyevil
                - c4et4uk
                - derovi
              method:
                  - sms
      checkname: disk_notifier_nginx_status_5xx_peak
      description: disk_notifier_nginx_status_5xx_peak
      flaps: { stable_time: 120, critical_time: 30 }
      CRIT: [" ${nginx}['5xx'] > 20"]
      tags:
        - disk_notifier
        - production
        
