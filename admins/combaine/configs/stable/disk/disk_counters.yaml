name: disk_counters-counters_nginx
parsing:
  groups: [disk_counters]
  metahost: disk_counters
  DataFetcher:
    timetail_port: 3132
    logname: "nginx/access-tskv.log"
    timetail_url: "/timetail?pattern=counters_nginx&type=tskv&log_ts="
aggregate:
  data:
    counters_nginx:
      type: "custom"
      class: "Multimetrics"
      factor: 1000
      perHost: NO

  senders:
    graphite:
      cluster: "media.disk"
      type: graphite

    juggler_counters_nginx_status_5xx: &juggler-conf
      type: juggler
      namespace: disk
      Host: "disk_counters"
      notifications:
        - template_name: phone_escalation
          template_kwargs:
            on_success_next_call_delay: 120
            repeat: 100
            delay: 900
            logins:
                - robot-disk-duty-adm
                - robot-disk-duty-jun
                - ivanov-d-s
                - kolyann
                - ignition
      Aggregator: logic_or
      aggregator_kwargs:
        nodata_mode: force_ok
      flaps: { stable_time: 120, critical_time: 300 }
      checkname: counters_nginx_status_5xx
      description: counters_nginx_status_5xx
      CRIT: [" ${urlshortener_nginx}['5xx'] > 5 "]
      tags:
        - production

    juggler_valid_traffic:
      << : *juggler-conf
      checkname: valid_traffic
      description: valid_traffic
      CRIT: [" ${counters_nginx}['2xx'] <= 100 "]
      config:
          type: metahost

    juggler_counters_nginx_timings_99perc:
      << : *juggler-conf
      checkname: counters_nginx_timings_99perc
      description: counters_nginx_timings_99perc
      CRIT: [" ${counters_nginx}['request_timings'][8] > 90 "]

    juggler_datacenter_valid_traffic:
      << : *juggler-conf
      checkname: datacenter_valid_traffic
      description: datacenter_valid_traffic
      CRIT: [" ${counters_nginx}['2xx'] <= 10 "]
      aggregator_kwargs:
        nodata_mode: force_ok
        unreach_checks: ["disk_counters:valid_traffic", "mpfs.disk.yandex.net:datacenter_valid_traffic"]
      config:
          type: datacenter

    juggler_low_traffic:
      <<: *juggler-conf
      checkname: low_traffic
      description: low_traffic
      config:
          type: metahost
      variables:
        trigger_n100_d200: "iftimeofday(22, 10, 100, 200)"
      CRIT: [" ${counters_nginx}['2xx'] < trigger_n100_d200 "]
      aggregator_kwargs:
        nodata_mode: force_ok
        unreach_checks: [":valid_traffic"]

    juggler_datacenter_low_traffic:
      << : *juggler-conf
      checkname: datacenter_low_traffic
      description: datacenter_low_traffic
      config:
          type: datacenter
      variables:
        trigger_n30_d50: "iftimeofday(22, 10, 30, 50)"
      CRIT: [" ${counters_nginx}['2xx'] < trigger_n30_d50 "]
      aggregator_kwargs:
        nodata_mode: force_ok
        unreach_checks: [":datacenter_valid_traffic", "mpfs.disk.yandex.net:datacenter_low_traffic", "mpfs.disk.yandex.net:datacenter_valid_traffic"]
