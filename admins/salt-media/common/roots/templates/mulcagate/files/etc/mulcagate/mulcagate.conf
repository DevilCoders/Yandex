<config>
    <system>
        <daemon>0</daemon>
        <dir>/</dir>
        <pid>/var/run/mulcagate/mulcagate.pid</pid>
        <libpath>/usr/lib64</libpath>
        <libpath>/usr/lib64/modules</libpath>
    </system>
    <log>
        <Core>
            <DisableLogging>false</DisableLogging>
        </Core>

        <Sinks>
            <File>
                <Destination>RotateTextFile</Destination>
                <Filter>%Severity% > debug and not %AccessLog%</Filter>
                <Asynchronous>true</Asynchronous>
                <Format>[%TimeStamp%] %RequestID% %Severity%: %_%</Format>
                <AutoFlush>true</AutoFlush>
                <FileName>var/log/mulcagate/yplatform.log</FileName>
            </File>
            <AccessLog>
                <Destination>RotateTextFile</Destination>
                <Filter>!!%AccessLog%</Filter>
                <FileName>var/log/mulcagate/access.log</FileName>
                <Asynchronous>true</Asynchronous>
                <Format>[%TimeStamp%] %RemoteAddress% \"%Request%\" result %Status% \"%Description%\" %RequestLength% %BytesSent% \"%RequestID%\" %RequestTime%</Format>
                <AutoFlush>true</AutoFlush>
            </AccessLog>
        </Sinks>
    </log>
    <modules>
        <module>
            <system>
                <name>http</name>
                <type>service_object</type>
                <library>ymod_httpserver</library>
                <factory>ymod_http_server::impl</factory>
            </system>
            <configuration>
                <reactor io_threads="{{ io_threads }}" accept_threads="{{ accept_threads }}" pool_count="{{ pool_count }}"/>
                <endpoints>
                    <listen addr="::" port="10010">
                        <parameterized_access_log>1</parameterized_access_log>
                        <read_timeout>120000</read_timeout>
                        <write_timeout>120000</write_timeout>
                        <keep_alive>
                            <enable>{{ keep_alive }}</enable>
                        </keep_alive>
                    </listen>
                </endpoints>
            </configuration>
        </module>
        <module>
            <system>
                <name>mulca_gate</name>
                <type>service_object</type>
                <library>ymod_mulcagate</library>
                <factory>mulcagate::processor</factory>
            </system>
            <configuration>
                <prefix>/gate</prefix>
                <max_buffers_size>{{ max_buffers_size }}</max_buffers_size>
                <client_chunk_size>{{ client_chunk_size }}</client_chunk_size>
                <backend_chunk_size>{{ backend_chunk_size }}</backend_chunk_size>
                <reject_initially_deprived_requests>{{ reject_initially_deprived_requests }}</reject_initially_deprived_requests>
                <mulca_write_enabled>{{ mulca_write_enabled }}</mulca_write_enabled>
                <mulca_delete_enabled_for_mapped_units>{{ mulca_delete_enabled_for_mapped_units }}</mulca_delete_enabled_for_mapped_units>
                <put>
                    <pool_size>{{ put_pool_size }}</pool_size>
                    <pool_threads>{{ put_pool_threads }}</pool_threads>
                    <streaming_threshold>{{ put_streaming_threshold }}</streaming_threshold>
                </put>
                <get>
                    <pool_size>{{ get_pool_size }}</pool_size>
                    <pool_threads>{{ get_pool_threads }}</pool_threads>
                    <rules>
                         <rule content-type="*/*">elliptics</rule>
                    </rules>
                </get>
                <del>
                    <pool_size>{{ del_pool_size }}</pool_size>
                    <pool_threads>{{ del_pool_threads }}</pool_threads>
                </del>
                <redirect_threshold>655360</redirect_threshold>
                <redirect_enabled>{{ redirect_enabled|lower }}</redirect_enabled>
                {% if redirect_enabled and redirect_options %}
                {%- for key, val in redirect_options.items() -%}
                <{{ key }}>{{ val }}</{{ key }}>
                {% endfor %}
                {%- endif -%}
                <small_data_compression_threshold>{{ small_data_compression_threshold|lower }}</small_data_compression_threshold>
                {% if small_data_compression_threshold -%}
                <small_data_compression_namespaces>
                    {% for ns in small_data_compression_namespaces -%}
                    <namespace>{{ ns }}</namespace>
                    {% endfor -%}
                </small_data_compression_namespaces>
                {% endif -%}
                {% if custom_handystat_config -%}
                <handystats_config_file>/etc/mulcagate/handystats.conf</handystats_config_file>
                {% endif -%}
                <elliptics_prefer_couple_from_unit_mapping>{{ elliptics_prefer_couple_from_unit_mapping|lower }}</elliptics_prefer_couple_from_unit_mapping>
                {% if not disable_elliptics -%}
                <elliptics>
                    {% if elliptics_auth and elliptics_auth_options %}
                    <auth>
                        <enabled>true</enabled>
                        <tvm>
                                <client_id>{{ elliptics_auth_options }}</client_id>
                                <keys_cache_path>/var/tmp/mulcagate-tvm-public-keys.cache</keys_cache_path>
                                <update_period>60000</update_period>
                                <connect_timeout>5</connect_timeout>
                                <read_timeout>5</read_timeout>
                        </tvm>
                    </auth>
                    {% endif -%}
                    <log_file>/var/log/mulcagate/elliptics.log</log_file>
                    <log_level>{{ elliptics_log_level }}</log_level>
                    <timeout>
                        <default>{{ elliptics_timeout_default }}</default>
                        <read>{{ elliptics_timeout_read }}</read>
                        <write>{{ elliptics_timeout_write }}</write>
                        <write_prepare>{{ elliptics_timeout_write_prepare }}</write_prepare>
                        <lookup>{{ elliptics_timeout_lookup }}</lookup>
                        <remove>{{ elliptics_timeout_remove }}</remove>
                    </timeout>
                    <check_timeout>30</check_timeout>
                    <io_thread_num>{{ elliptics_io_thread_num }}</io_thread_num>
                    <nonblocking_io_thread_num>{{ elliptics_nonblocking_io_thread_num }}</nonblocking_io_thread_num>
                    <net_thread_num>{{ elliptics_net_thread_num }}</net_thread_num>
                    <data_flow_rate>10000000</data_flow_rate>
                    {% if elliptics_mds2079_lower_bound -%}
                    <mds2079_lower_bound>{{ elliptics_mds2079_lower_bound }}</mds2079_lower_bound>
                    {% endif -%}
                    <remotes>
                        {% for r in elliptics_remotes -%}
                        <remote>{{ r }}</remote>
                        {% endfor %}
                    </remotes>
                    <mastermind>
                        <cache_path>/var/tmp/libmastermind.cache</cache_path>
                        <update-period>{{ elliptics_mastermind_update_period }}</update-period>
                        <warning_time>300</warning_time>
                        <expire_time>{{ elliptics_mastermind_expire_time }}</expire_time>
                        <enqueue_retries>{{ elliptics_mastermind_enqueue_retries }}</enqueue_retries>
                        <worker_name>{{ elliptics_mastermind_worker_name }}</worker_name>
                        <remotes>
                            {% for r in elliptics_mastermind_remotes -%}
                            <remote>{{ r }}</remote>
                            {% endfor %}
                        </remotes>
                        <port>10053</port>
                        <group_count>2</group_count>
                        <namespace>disk</namespace>
                        <!-- miliseconds -->
                        <enqueue_timeout>15000</enqueue_timeout>
                        <reconnect_timeout>5000</reconnect_timeout>
                    </mastermind>
                    <libmds>
                        <thread_num>{{ elliptics_libmds_thread_num }}</thread_num>
                        {%- if redirect_enabled and redirect_options %}
                        <redirect_check_port>{{ elliptics_redirect_check_port }}</redirect_check_port>
                        <redirect_check_query>{{ elliptics_redirect_check_query }}</redirect_check_query>
                        <redirect_check_timeout_ms>{{ elliptics_redirect_check_timeout_ms }}</redirect_check_timeout_ms>
                        {%- endif %}
                    </libmds>
                </elliptics>
                {%- endif %}
            </configuration>
        </module>
    </modules>
</config>
