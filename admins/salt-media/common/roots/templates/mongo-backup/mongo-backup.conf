#!/bin/bash

hostname=`hostname -f`
PROJECT=`curl -s "http://c.yandex-team.ru/api-cached/hosts2projects/$hostname"`
BACKUP_GROUP=`curl -s "http://c.yandex-team.ru/api-cached/hosts2groups/$hostname" | egrep 'backup|hidden' | wc -l`

if grep -q 'test' /etc/yandex/environment.type &>/dev/null; then _MONGO_ENV_TYPE='-test'; fi

USE_DOWNTIME=1
JCTL_HOSTS=("jmon01e.media.yandex.net" "jmon01g.media.yandex.net" "jmon01f.media.yandex.net")
DT_HOURS=8
DT_DESCRIPTION="MongoDB backup"

MONGO_BACKUP_ENABLED=0
if [[ $BACKUP_GROUP -gt 0 ]]; then
	MONGO_BACKUP_ENABLED=1
fi
BREAK_ON_WRONG_STATE=1

ZK_LOCK_RETRIES=5

MONGO_DATA_DIR=`grep -e '^dbpath' /etc/mongodb.conf | awk -F"=" {' print $2 '} | sed 's/^[ \t]*//' | sed 's/mongodb//'`
MONGO_DUMP_PORT=`grep -e '^port' /etc/mongodb.conf | awk -F"=" {' print $2 '} | sed 's/^[ \t]*//'`
if [[ -f /etc/mongos.conf ]]; then
        MONGO_MONGOS_PORT=`grep -e '^port' /etc/mongos.conf | awk -F"=" {' print $2 '} | sed 's/^[ \t]*//'`
        if [ -z $MONGO_MONGOS_PORT ]; then
                MONGO_MONGOS_PORT=27017
        fi
elif [[ $MONGO_DUMP_PORT -eq 27018 ]]; then
        MONGO_MONGOS_PORT=27017
else
        MONGO_MONGOS_PORT=27018
fi
for ((i=3;i>0;i--));do
   MONGOS_GROUP=$(curl -sf "http://c.yandex-team.ru/api-cached/hosts2groups/`hostname -f`?format=yaml"|\
      awk '/'"$PROJECT"'.*mongos/{x=x?length(x)>length($NF)?x:$NF:$NF}END{print x}')
   [ -z ${MONGOS_GROUP} ] && sleep 3 || break
done
MONGOS_HOST=`curl -sf "http://c.yandex-team.ru/api-cached/groups2hosts/${MONGOS_GROUP:-${PROJECT}${_MONGO_ENV_TYPE}-mongos}"|sort -R|head -n 1`
MONGOS=`curl -sf "http://c.yandex-team.ru/api-cached/groups2hosts/${MONGOS_GROUP:-${PROJECT}${_MONGO_ENV_TYPE}-mongos}"|grep 'No groups found'|wc -l`

if [ $MONGOS -eq 0 ]; then
    STANDALONE=0
else
    STANDALONE=2
fi

R_PASSWORD='ufufhby'
R_REALM="backup-mongodb"
R_SERVER=`curl -s "http://c.yandex-team.ru/api-cached/groups2hosts/${PROJECT}-backup"`
R_USER=`curl -s "http://c.yandex-team.ru/api-cached/hosts2projects/$hostname"`

BACKUP_OPLOG=0

DISABLE_BALANCER=0

SHARD_NAME=''

ZK_FLOCK_CONFIG='/etc/distributed-flock-backup.json'

M_USER=""
M_PASSWD=""

MONITORING_FILE='/var/lib/mongo-backup/backup.rslt'
LOG_FILE="/var/log/mongo-backup.log"

if [ $PROJECT = 'disk' ]; then 
	SYNCDIR="$MONGO_DATA_DIR/tmp/$(date +%Y%m%d)"	
else 
	SYNCDIR="/tmp/$(date +%Y%m%d)"
fi
