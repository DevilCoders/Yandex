upstream elproxy {
    server unix:/var/run/ell-proxy/cocaine.sock;
}

fastcgi_cache_path /var/cache/nginx/fastcgi-cache/elliptics-cached levels=2 keys_zone=elliptics-cached:128m max_size=4096m inactive=1h;

server {

        listen 81;

        location / {
                include         fastcgi_params_ell;
                fastcgi_pass    elproxy;
        }
}
server {
        listen 8080;
        listen [::]:8080;
	server_name storage.tst.ape.yandex.net;

        add_header Access-Control-Allow-Origin "*";

        location / {
                include         fastcgi_params_ell;
                fastcgi_pass    elproxy;
        }
}
server {
    server_name storage.tst.ape.yandex.net;
    listen 80 default backlog=16834;
    listen [::]:80 ipv6only=on backlog=16834;
    listen 443 ssl default backlog=16834;
    listen [::]:443 ssl ipv6only=on backlog=16834;
    ssl_certificate /etc/nginx/ssl/storagecert.pem;
    ssl_certificate_key /etc/nginx/ssl/storagekey.pem;

    add_header Access-Control-Allow-Origin '*';

    location /ping {
        include         fastcgi_params_ell;
        fastcgi_pass        elproxy;
    }

    location / {
        include         fastcgi_params_ell;
        fastcgi_pass        elproxy;
        fastcgi_cache          elliptics-cached;
        fastcgi_cache_key      $request_method$request_uri;
        fastcgi_cache_use_stale error timeout invalid_header updating http_500 http_503;
        fastcgi_cache_valid  200 301 302 1d;
        fastcgi_cache_valid  404 6h;
        fastcgi_cache_min_uses 2;
    }
}
