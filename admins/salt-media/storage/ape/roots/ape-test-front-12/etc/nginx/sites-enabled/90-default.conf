lua_package_path '/usr/share/lua/5.1/?;/usr/share/lua/5.1/?.lua;;';

server {
	server_name apefront.tst12.ape.yandex.net front.tst.ape.yandex.net;
	listen 80 default;
	listen [::]:80 default;
	#listen 443 ssl;
	#listen [::]:443 ssl;
	#ssl_certificate /etc/nginx/ssl/api_front.tst.pem;
	#ssl_certificate_key /etc/nginx/ssl/api_front.tst.pem;
	#ssl_stapling_responder http://yandex.ocsp-responder.com/;
	#ssl_trusted_certificate /etc/nginx/ssl/certuml4.pem;

	location /ping {
		return 200;
	}
	location ~* ^/imageparser-zen__v012/(?<event>[^/]*) {
                rewrite ^/imageparser-zen__v012/([^/?]*)[/]?(.*) /$3 break;
                proxy_pass http://cocaine-http-proxy;
                proxy_read_timeout 600s;
		access_by_lua_block {
                	local plugin = require("yarl/yarl-go")
                	plugin.limit_by_unique_name("cocaine_app_test_zen", 1)
                }
                proxy_set_header        Host    $host;
                proxy_set_header        X-Request-Id    $request_id;
                request_id_from_header on;
                request_id_header_name X-Request-Id;
                proxy_set_header        X-Forwarded-Proto       $scheme;
                proxy_set_header        X-Cocaine-Event         "${event}";
                proxy_set_header        X-Cocaine-Service       "imageparser-zen__v012";
                proxy_set_header        X-Forwarded-For-Y       $remote_addr;
                proxy_set_header        X-Real-IP       $remote_addr;
                proxy_http_version      1.1;
        }
	location ~* ^/(?<app>[^/]*)/(?<event>[^/]*) {
	        rewrite ^/(.*?)/([^/?]*)[/]?(.*) /$3 break;
	        proxy_pass http://cocaine-http-proxy;
	        proxy_read_timeout 600s;
	        proxy_set_header	Host	$host;
        	proxy_set_header	X-Request-Id	$request_id;
		request_id_from_header on;
		request_id_header_name X-Request-Id;
	        proxy_set_header	X-Forwarded-Proto	$scheme;
       		proxy_set_header	X-Cocaine-Event		"${event}";
	        proxy_set_header	X-Cocaine-Service	"${app}";
	        proxy_set_header	X-Forwarded-For-Y	$remote_addr;
	        proxy_set_header	X-Real-IP	$remote_addr;
	        proxy_http_version	1.1;
	}
}

