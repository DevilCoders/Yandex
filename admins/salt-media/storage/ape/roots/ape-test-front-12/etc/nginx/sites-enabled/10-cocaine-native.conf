upstream cocaine-http-proxy {
        server [::1]:10100 fail_timeout=30s max_fails=0;
        keepalive 64;
}

upstream cocaine-native {
	server [::1]:10000 fail_timeout=30s max_fails=0;
	keepalive 64;
}

proxy_cache_path  /var/cache/nginx/cache  levels=1:2   keys_zone=cocaine-cached:4000m inactive=365d  max_size=8G;

server {
	server_name resize.rs.yandex.net;
	listen 80;
	listen [::]:80;
	location / {
		rewrite ^/(ping|genurl)$ /resizer/$1 break;
		rewrite ^/(.*)$ /resizer/resize/$1 break;
		proxy_pass	http://cocaine-http-proxy;
		proxy_set_header	Host	$host;
		proxy_set_header        X-Real-IP       $remote_addr;
		proxy_http_version	1.1;
		proxy_set_header	Connection	"";
		set_real_ip_from ::/0;
                set_real_ip_from 0.0.0.0/0;
		proxy_set_header	X-Real-IP	$remote_addr;
		proxy_set_header	X-Request-Id	$request_id;
		proxy_read_timeout	30s;
	}
}

server {
	listen 81;
	listen [::]:81;
	location /nginx-status {
		stub_status on;
	}
}

