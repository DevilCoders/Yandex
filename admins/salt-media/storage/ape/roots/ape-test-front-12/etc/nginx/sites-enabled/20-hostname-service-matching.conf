server {
	server_name ~^(?<appname>[a-zA-Z0-9_-]+)\.(?<username>[a-zA-Z0-9_-]+)\.apefront\.tst12\.ape\.yandex\.(net|ru|tr|com\.tr|ua|com\.ua|kz|com\.kz|by|com\.by)$;
	server_name ~^(?<appname>[a-zA-Z0-9_-]+)\.(?<username>[a-zA-Z0-9_-]+)\.front\.tst\.ape\.yandex\.(net|ru|tr|com\.tr|ua|com\.ua|kz|com\.kz|by|com\.by)$;
	listen 80;
	listen [::]:80;

	request_id_from_header on;
	request_id_header_name X-Request-Id;

	location / {
		proxy_pass http://cocaine-http-proxy;
		proxy_set_header Host $host;
		proxy_http_version 1.1;
		proxy_set_header Connection "";
		proxy_set_header        X-Request-Id    $request_id;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Cocaine-Service "${username}_did_${appname}";
		proxy_set_header X-Cocaine-Event "http";
		proxy_read_timeout 1800s;
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
	}
}


server {
	server_name ~^(?<appversion>[a-fA-F0-9]+)\.(?<appname>[a-zA-Z0-9_-]+)\.(?<username>[a-zA-Z0-9_-]+)\.apefront\.tst12\.ape\.yandex\.(net|ru|tr|com\.tr|ua|com\.ua|kz|com\.kz|by|com\.by)$;
	server_name ~^(?<appversion>[a-fA-F0-9]+)\.(?<appname>[a-zA-Z0-9_-]+)\.(?<username>[a-zA-Z0-9_-]+)\.front\.tst\.ape\.yandex\.(net|ru|tr|com\.tr|ua|com\.ua|kz|com\.kz|by|com\.by)$;
	listen 80;
	listen [::]:80;

	request_id_from_header on;
	request_id_header_name X-Request-Id;

	location / {
		proxy_pass http://cocaine-http-proxy;
		proxy_set_header Host $host;
		proxy_http_version 1.1;
		proxy_set_header Connection "";
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header        X-Request-Id    $request_id;
		proxy_set_header X-Cocaine-Service "${username}_did_${appname}_at_${appversion}";
		proxy_set_header X-Cocaine-Event "http";
		proxy_read_timeout 1800s;
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
	}
}


server {
	server_name ~^(?<appname>[a-zA-Z0-9-]+)\_(?<version>.+)\.apefront\.tst12\.ape\.(yandex-team|yandex)\.(net|ru|tr|com\.tr|ua|com\.ua|kz|com\.kz|by|com\.by)$;
	server_name ~^(?<appname>[a-zA-Z0-9-]+)\_(?<version>.+)\.front\.tst\.ape\.(yandex-team|yandex)\.(net|ru|tr|com\.tr|ua|com\.ua|kz|com\.kz|by|com\.by)$;
	listen 80;
	listen [::]:80;

	request_id_from_header on;
	request_id_header_name X-Request-Id;

	location / {
		proxy_pass http://cocaine-http-proxy;
		proxy_set_header Host $host;
		proxy_http_version 1.1;
		proxy_set_header Connection "";
		proxy_set_header        X-Request-Id    $request_id;
		proxy_set_header X-Real-IP $remote_addr;
		set $app "${appname}:${version}";
		if ($version ~ _v012) {
			set $app "${appname}__v012";
		}
		proxy_set_header X-Cocaine-Service "$app";
		proxy_set_header X-Cocaine-Event "http";
		proxy_read_timeout 1800s;
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
	}
}


server {
	server_name ~^(?<appversion>[a-fA-F0-9]+)\.(?<appname>[a-zA-Z0-9_-]+)\.apefront\.tst12\.ape\.yandex-team\.ru$;
	listen 80;
	listen [::]:80;

	request_id_from_header on;
	request_id_header_name X-Request-Id;

	location / {
		proxy_pass http://cocaine-http-proxy;
		proxy_set_header Host $host;
		proxy_http_version 1.1;
		proxy_set_header Connection "";
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header        X-Request-Id    $request_id;
		proxy_set_header X-Cocaine-Service "${appname}_at_${appversion}";
		proxy_set_header X-Cocaine-Event "http";
		proxy_read_timeout 1800s;
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
	}
}

