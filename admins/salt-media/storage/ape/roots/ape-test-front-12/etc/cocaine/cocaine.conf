{
    "version": 4,
    "logging": {
        "loggers" : {
            "core": [
                {
                    "formatter": {
                        "type": "tskv",
                        "create": {
                            "tskv_format": "cocaine-testing-log",
                            "type": "cocaine-front"
                        },
                        "mutate": {
                            "unixtime_microsec_utc": {"strftime": "%s.%f", "gmtime": false},
                            "timestamp": {"strftime": "%Y-%m-%dT%H:%M:%S"},
                            "timezone": {"strftime": "%z"}
                        }
                    },
                    "sinks": [
                        {
                                "type" : "file",
                                "path" : "/var/log/cocaine-runtime/core.log",
                                "flush" : 10000
                        }
                    ]
                }
            ],
            "log": [
                {
                    "formatter": {
                        "type": "tskv",
                        "create": {
                            "tskv_format": "cocaine-testing-log",
                            "type": "cocaine-front"
                        },
                        "mutate": {
                            "unixtime_microsec_utc": {"strftime": "%s.%f", "gmtime": false},
                            "timestamp": {"strftime": "%Y-%m-%dT%H:%M:%S"},
                            "timezone": {"strftime": "%z"}
                        }
                    },
                    "sinks": [
                        {
                                "type" : "file",
                                "path" : "/var/log/cocaine-runtime/cocaine.log",
                                "flush" : 10000
                        }
                    ]
                }
            ]
        },
        "severity": "debug"
    },
    "network": {
        "pinned": {
		"locator": 10053,
		"storage": 10387,
		"logging": 10388,
		"unicorn": 10390,
		"unicorn_dark": 10391,
                "tvm2": 10392
	}
    },
    "paths": {
        "plugins": "/usr/lib/cocaine",
        "runtime": "/var/run/cocaine"
    },
    "services": {
        "locator": {
            "type": "locator",
            "args": {
                "cluster": {
                    "type": "unicorn",
                    "args": {
                        "backend": "discovery",
                        "check_interval": 10
                    }
                },
                "restrict": [
                    "metrics",
		    "storage",
                    "logging",
                    "unicorn"
                ],
		"extra_param":{
		    "x-cocaine-cluster": "testing_offload_{{ grains['conductor']['root_datacenter'] }}"
		},
                "gateway": {
                    "type": "vicodyn",
                    "args" : {
                        "balancer" : {
                            "type" : "smart",
                            "args" : {
                                "mastermind_remotes" : [["collector01myt.mdst.yandex.net", 8383], ["collector01man.mdst.yandex.net", 8383]],
                                "mastermind_app_name" : "mastermind-drooz-http",
                                "mastermind_update_period": 180,
                                "locator_port" : "10071",
                                "info_period" : 15,
                                "storage-try-count" : 0,
                                "ban-timeout-ms": 1000,
                                "mmm_cache_enabled" : true,
                                "mmm_cache_remotes" : ["mavrodi.mdst.yandex.net:9999"],
                                "mmm_cache_tls_enabled" : true,
                                "mmm_cache_tls_cert_path": "/etc/mavrodi/ssl/mavrodi.crt",
                                "mmm_cache_tls_key_path": "/etc/mavrodi/ssl/mavrodi.key",
                                "mmm_cache_tls_ca_paths": ["/etc/mavrodi/ssl/ca.crt"]
                            }
                        },
                        "timings": {
                            "enabled": true
                        },
                        "attempts": {
                            "by_key": 2,
                            "storage": 3,
                            "simple": 2
                        },
                        "darkmetrics": {
                            "enabled": true,
                            "unicorn": "dark",
                            "unicorn_prefix": "/darkvoice",
                            "unicorn_retry_after_s": 10,    
                            "ttl_s": 300
                        }
                    }
                }
            }
        },
        "logging": {
            "type": "logging::v2",
            "args": {
                "backend": "log",
                "default_metafilter": [
                    ["&&",
                        ["&&",
                            ["severity", 0],
                            ["||",
                                ["!=", "source", "unistorage/mds/elliptics/client"],
                                ["&&",
                                    ["==", "source", "unistorage/mds/elliptics/client"],
                                    ["severity", 3]
                                ]
                            ]
                        ],
                        ["&&",
                            ["!=", "source", "storage/elliptics_core/elliptics_client"],
                            ["&&",
                                ["!=", "source", "storage/elliptics-cache/elliptics_client"],
                                ["!=", "source", "mastermind"]
                            ]
                        ]
                    ],
                    ["traced"]
                ],
                "truncate": {
                    "message_size": 100000
                }
            }
        },
	"metrics": {
            "type": "metrics"
        },
        "unicorn": {
           "type": "unicorn",
           "args": {
             "backend": "core"
           }
	},
        "unicorn_dark": {
           "type": "unicorn",
           "args": {
             "backend": "dark"
           }
        },
	"storage": {
            "type": "storage",
            "args": {
                "backend": "core"
            }
	},
        "tvm2": {
            "type": "tvm2",
            "args": {
                "base_url": "https://tvm-api.yandex.net",
                "client_id": 92,
                "client_secret": "{{ pillar['yav']['tvm_92_client_secret'] }}"
            }
        }
    },
    "storages": {
        "core": {
		"type" : "postgres",
		"args" : {
			"pg_backend" : "core",
                        "pg_table_name" : "cocaine_index_testing",
			"pg_underlying_storage" : "elliptics_core",
			"pg_key_column" : "key",
			"pg_collection_column" : "collection",
			"pg_tags_column" : "tags"
		}
	},
        "elliptics_core": {
            "type": "elliptics",
            "args": {
                "nodes" : [
                    "elisto01i.tst.ape.yandex.net:1025:10",
                    "elisto01f.tst.ape.yandex.net:1025:10"
                ],
                "io-thread-num" : 8,
                "wait-timeout" : 30,
                "check-timeout" : 60,
                "net-thread-num" : 8,
                "groups" : [3, 4],
		"timeouts" : {
                    "read" : 60,
                    "write" : 60,
                    "remove" : 60,
                    "find" : 60
                },
                "success-copies-num" : "any",
                "flags" : 4,
		"read_latest": true,
                "verbosity" : 4
            }
        }
    },
    "unicorns": {
        "core": {
            "type": "zookeeper",
            "args": {
                "endpoints": [
                    {"host":"zk01h.tst.ape.yandex.net", "port": 2181},
                    {"host":"zk01i.tst.ape.yandex.net", "port": 2181},
                    {"host":"zk01f.tst.ape.yandex.net", "port": 2181}
                ],
                "prefix": "/ape-test",
                "recv_timeout_ms": 5000
            }
        },
        "dark": {
            "type": "zookeeper",
            "args": {
                "endpoints": [
                    {"host":"zk01h.tst.ape.yandex.net", "port": 2181},
                    {"host":"zk01i.tst.ape.yandex.net", "port": 2181},
                    {"host":"zk01f.tst.ape.yandex.net", "port": 2181}
                ],
                "prefix": "/ape-test-dark",
                "recv_timeout_ms": 5000
            }
        },
        "discovery": {
            "type": "zookeeper",
            "args": {
                "endpoints": [
		    {"host":"zk01h.tst.ape.yandex.net", "port": 2181},
                    {"host":"zk01i.tst.ape.yandex.net", "port": 2181},
                    {"host":"zk01f.tst.ape.yandex.net", "port": 2181}
                ],
                "prefix": "/ape-test-discovery",
                "recv_timeout_ms": 5000
            }
        }
    },
    "authentications": {
        "core": {
            "type": "tvm",
            "args": {
                "allow_anonymous": true,
                "client_id": 92,
                "client_secret": "{{ pillar['yav']['tvm_92_client_secret'] }}",
                "secure_storage": "core",
                "base_url": "https://tvm-api.yandex.net",
                "keyring_path": "/etc/cocaine/auth.keys"
            }
        }
    },
    "authorizations": {
        "event": {
            "type": "disabled",
            "args": {
                "unicorn": "core"
            }
        },
        "storage": {
            "type": "storage",
            "args": {
                "backend": "core"
            }
        },
        "unicorn": {
            "type": "unicorn",
            "args": {
                "backend": "core"
            }
        }
    },
    "vicodyn_pools": {
        "basic": {
            "type": "basic"
        }
    },
    "postgres": {
        "core": {
            "args" : {
                "pool_size" : 3,
                "connection_string" : "dbname=ape_test user=ape_test port=6432 host=c-dce9af9b-999a-4c0a-87f7-3a66aeacfb59.rw.db.yandex.net sslmode=verify-full sslrootcert=/usr/share/yandex-internal-root-ca/YandexInternalRootCA.crt"
            }
        }
    }
}

