server {
        server_name idm.ape.yandex.net;
	listen 141.8.146.189:80;
	listen [2a02:6b8:0:3400::189]:80;
        listen 141.8.146.189:443 ssl;
        listen [2a02:6b8:0:3400::189]:443 ssl;

        ssl_certificate /etc/nginx/ssl/idm.ape.yandex.net.pem;
        ssl_certificate_key /etc/nginx/ssl/idm.ape.yandex.net.pem;
	
	ssl_client_certificate /etc/nginx/ssl/allCAs.pem; 
  	ssl_verify_client optional;
 	ssl_verify_depth 3;

        location / {
		if ($ssl_client_verify != SUCCESS) {
			return 403;
		}
		if ($ssl_client_i_dn != "/DC=ru/DC=yandex/DC=ld/CN=YandexInternalCA") {
			return 403;
		}
		if ($ssl_client_s_dn != "/C=RU/ST=Moscow/L=Moscow/O=Yandex LLC/OU=ITO/CN=idm.yandex-team.ru/emailAddress=pki@yandex-team.ru") {
			return 403;
		}
                proxy_set_header 	Host $http_host;
                proxy_http_version 	1.1;
                proxy_set_header 	Connection "";
                proxy_set_header        X-Real-IP       $remote_addr;
        	proxy_pass http://localhost:10000;
	}
}

