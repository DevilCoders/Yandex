server {
    server_name rbtorrent.ape.yandex.net;
    listen 5.255.240.178:80;
    listen [2a02:6b8:0:3400::1:178]:80;

    request_id_from_header on;
    request_id_header_name X-Request-Id;
    request_id_length 16;

    location / {
        proxy_pass http://cocaine-http-proxy;
        proxy_set_header Host $host;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header	X-Request-Id	$request_id;
        proxy_set_header	X-Cocaine-Event		"http";
        proxy_set_header	X-Cocaine-Service	"rbtorrent__v012";
        proxy_set_header	X-Real-IP	$remote_addr;
        proxy_read_timeout 300s;
    }

    location ~ ^/(?<version>[0-9]+) {
        rewrite ^/(.*?)/(.*)$ /$2 break;
        proxy_pass http://cocaine-http-proxy;
        proxy_set_header Host $host;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header        X-Request-Id    $request_id;
        proxy_set_header        X-Cocaine-Event         "http";
        proxy_set_header        X-Cocaine-Service       "rbtorrent:${version}";
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_read_timeout 300s;
    }
}
