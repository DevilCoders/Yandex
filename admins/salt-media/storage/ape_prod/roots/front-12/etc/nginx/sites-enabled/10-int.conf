#limit_req_zone $server_name zone=echo:1m rate=1r/s;

server {
	server_name front.intape.yandex.net;

	listen 5.255.240.178:80;
	listen [2a02:6b8:0:3400::1:178]:80;
	listen 5.255.240.178:443 ssl;
	listen [2a02:6b8:0:3400::1:178]:443 ssl;

	ssl_certificate /etc/nginx/ssl/front.intape.yandex.net.pem;
	ssl_certificate_key /etc/nginx/ssl/front.intape.yandex.net.pem;

	location / {
		proxy_pass	http://cocaine-http-proxy;
		proxy_set_header	Host	$host;
		proxy_http_version	1.1;
		proxy_set_header	Connection	"";
		proxy_set_header	X-Real-IP	$remote_addr;
		proxy_set_header	X-Request-Id	$request_id;
		proxy_set_header        X-Forwarded-For-Y       $remote_addr;
		proxy_read_timeout	30s;	
	}
	location /echo {
		proxy_pass      http://cocaine-http-proxy;
		access_by_lua_block {
                	local plugin = require("yarl/yarl-go")
                	plugin.limit_by_unique_name("cocaine_app_echo", 1)
                }
		#limit_req zone=echo burst=2 nodelay;
		#limit_req_status 429;
                proxy_set_header        Host    $host;
                proxy_http_version      1.1;
                proxy_set_header        Connection      "";
                proxy_read_timeout      10s;
	}
}

