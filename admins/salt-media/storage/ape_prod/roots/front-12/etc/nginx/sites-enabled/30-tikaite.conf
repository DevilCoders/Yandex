
server {
	server_name tikaite.ape.yandex.net;
	listen 5.255.240.178:80;
	listen [2a02:6b8:0:3400::1:178]:80;

	#TVM2 service section
        tvm2_service_id 200;
        tvm2_keys_url "/keys?lib_version=2.4.2";

	location ~* ^/disk/([a-zA-Z0-9_-]+) {
		include include/tikaite_common.conf;
		access_by_lua_block {
                        local plugin = require("yarl/yarl-go")
                        plugin.limit_by_unique_name("cocaine_app_tikaite_disk", 1)
                }
		proxy_set_header X-Cocaine-Service "tikaite-srw__v012";
		proxy_set_header X-Cocaine-Event "disk";
		proxy_pass http://cocaine-http-proxy;
	}
	location ~* ^/(?<handle>[a-zA-Z0-9_-]+) {
        	include include/tikaite_common.conf;
		access_by_lua_block {
                        local plugin = require("yarl/yarl-go")
                        plugin.limit_by_unique_name("cocaine_app_tikaite", 1)
                }
		proxy_set_header X-Cocaine-Service "tikaite-srw__v012";
		proxy_set_header X-Cocaine-Event "${handle}";
        	proxy_set_header X-Srw-Namespace "disk";
	        proxy_set_header X-Srw-Key-Type  "STID";
        	proxy_set_header X-Srw-Key  $arg_stid;
		proxy_pass http://cocaine-http-proxy;
	}
	location = /keys{
                internal;
                proxy_pass https://tvm-api.yandex.net/2/keys;
        }
}

server {
	server_name tikaite-fast-srw.ape.yandex.net;
	listen 5.255.240.178:80;
	listen [2a02:6b8:0:3400::1:178]:80;

	#TVM2 service section
        tvm2_service_id 200;
        tvm2_keys_url "/keys?lib_version=2.4.2";

	location = /text/ {
                include include/tikaite_common.conf;
		access_by_lua_block {
                        local plugin = require("yarl/yarl-go")
                        plugin.limit_by_unique_name("cocaine_app_tikaite_fast_text", 1)
                }
                proxy_set_header X-Cocaine-Service "tikaite-fast-srw__v012";
                proxy_set_header X-Cocaine-Event "text";
		proxy_pass http://cocaine-http-proxy;
        }
	location ~* ^/(?<handle>[a-zA-Z0-9_-]+) {
		include include/tikaite_common.conf;
		access_by_lua_block {
                        local plugin = require("yarl/yarl-go")
                        plugin.limit_by_unique_name("cocaine_app_tikaite_fast", 1)
                }
		proxy_set_header X-Cocaine-Service "tikaite-fast-srw__v012";
		proxy_set_header X-Cocaine-Event "${handle}";
		proxy_set_header X-Srw-Namespace "disk";
		proxy_set_header X-Srw-Key-Type  "STID";
		proxy_set_header X-Srw-Key  $arg_stid;
		proxy_pass http://cocaine-http-proxy;
	}
	location = /keys{
                internal;
                proxy_pass https://tvm-api.yandex.net/2/keys;
        }
}

server {
        server_name tikaite-ml.ape.yandex.net;
        listen 5.255.240.178:80;
        listen [2a02:6b8:0:3400::1:178]:80;

        #TVM2 service section
        tvm2_service_id 200;
        tvm2_keys_url "/keys?lib_version=2.4.2";

        location ~* ^/(?<handle>[a-zA-Z0-9_-]+) {
                include include/tikaite_common.conf;
                access_by_lua_block {
                        local plugin = require("yarl/yarl-go")
                        plugin.limit_by_unique_name("cocaine_app_tikaite_ml", 1)
                }
                proxy_set_header X-Cocaine-Service "tikaite-ml-srw__v012";
                proxy_set_header X-Cocaine-Event "${handle}";
                proxy_set_header X-Srw-Namespace "disk";
                proxy_set_header X-Srw-Key-Type  "STID";
                proxy_set_header X-Srw-Key  $arg_stid;
                proxy_pass http://cocaine-http-proxy;
        }
        location = /keys{
                internal;
                proxy_pass https://tvm-api.yandex.net/2/keys;
        }
}
