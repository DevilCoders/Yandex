{%- set conf = pillar['nginx_mulcagate'] -%}

server {
    listen 8080;
    listen [::]:8080;
    listen 8181 backlog=4096;
    listen [::]:8181 ipv6only=on backlog=4096;

    server_name {{ conf['slb'] }};

    include include/proxy_options.conf;
    include include/proxy_parameters.conf;

    location ^~ /ping {
        proxy_pass http://mediastorage/ping;
        set $unistat_request_type "ping";
    }

    location = /hostlist {
        add_header "Content-Type" "application/json";
        keepalive_timeout 0;
        return 200 "{\n \"host\": \"$hostname\"\n}";
    }

    location ^~ /gate/get {
        auth_sign $uri;
        auth_sign_signature $arg_sign;
        auth_sign_expire 7fffffffffffffff;
        auth_sign_hash sha256;
        # https://st.yandex-team.ru/CHEMODAN-26744
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['mulcagate_disk_0'] }}";
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['mulcagate_disk_1'] }}";

        set $unistat_request_type "get";
        set $unistat_namespace "unknown";
        proxy_pass http://mediastorage/gate/get;
    }

    location ^~ /gate/sq2 {
        auth_sign $uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['mulcagate_sq2'] }}";

        set $unistat_namespace "mail";
        set $unistat_request_type "get";
        proxy_pass http://mediastorage/gate/get;
    }

    location ^~ /gate/dv {
        auth_sign $uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['mulcagate_dv'] }}";

        set $unistat_namespace "disk";
        proxy_pass http://mediastorage/gate;
    }

    location ^~ /gate/sherlock {
        auth_sign $uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['mulcagate_sherlock'] }}";

        set $unistat_namespace "mail";
        set $unistat_request_type "get";
        proxy_pass http://mediastorage/gate/get;
    }

    location ^~ /gate/mail/ {
        location ~* ^/gate/mail/(?<stid>(.*)) {
            auth_sign $stid/$arg_ts;
            auth_sign_signature $arg_sign;
            auth_sign_expire $arg_ts;
            auth_sign_hash sha256;
            auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['mulcagate_gate_mail'] }}";

            set $unistat_namespace "mail";
            set $unistat_request_type "get";
            proxy_pass http://mediastorage/gate/get/$stid?$args;
        }
    }

    # https://st.yandex-team.ru/MDS-4809
    header_filter_by_lua_block {
        increment_metric("stat_monitor_dmmm", 1)
    }
    set $unistat_cluster_type "mulcagate";
    log_by_lua_file /etc/nginx/include/metrics.lua;
}

server {
    listen 4443 ssl backlog=4096;
    listen [::]:4443 ssl ipv6only=on backlog=4096;

    include include/proxy_options.conf;
    include include/proxy_parameters.conf;

    server_name {{ conf['slb'] }};
    ssl_certificate      {{ conf['ssl_certificate'] }};
    ssl_certificate_key  {{ conf['ssl_certificate_key'] }};
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers kEECDH+AESGCM+AES128:kEECDH+AES128:kRSA+AESGCM+AES128:kRSA+AES128:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2;
    ssl_session_cache shared:SSL:128m;
    ssl_session_timeout 28h;

    location ^~ /ping {
        proxy_pass http://mediastorage/ping;
        set $unistat_request_type "ping";
    }

    location = /hostlist {
        add_header "Content-Type" "application/json";
        keepalive_timeout 0;
        return 200 "{\n \"host\": \"$hostname\"\n}";
    }

    location ^~ /gate/del/ {
        access_by_lua_block {
            local plugin = require("yarl/yarl-go")
            plugin.limit_by_unique_name("mulcagate_delete", 1)
        }

        proxy_pass http://mediastorage/gate/del/;
        set $unistat_namespace "unknown";
        set $unistat_request_type "delete";
    }

    location ^~ /gate/ {
        set $unistat_namespace "unknown";
        proxy_pass http://mediastorage/gate/;
    }

    location ^~ /gate/mail/ {
        location ~* ^/gate/mail/(?<stid>(.*)) {
            auth_sign $stid/$arg_ts;
            auth_sign_signature $arg_sign;
            auth_sign_expire $arg_ts;
            auth_sign_hash sha256;
            auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['mulcagate_gate_mail'] }}";

            proxy_pass http://mediastorage/gate/get/$stid?$args;

            set $unistat_namespace "mail";
            set $unistat_request_type "get";
        }
    }

    # https://st.yandex-team.ru/MDS-4809
    header_filter_by_lua_block {
        increment_metric("stat_monitor_dmmm", 1)
    }
    set $unistat_cluster_type "mulcagate";
    log_by_lua_file /etc/nginx/include/metrics.lua;
}
