include include/upstream.conf;

# external use only: visible from internet
server {
    #localhost - 80
    listen 127.0.0.1:80;
    listen 37.140.134.135:80;
    listen [::1]:80;

    #localhost - 443
    listen 127.0.0.1:443 ssl;
    listen [::1]:443 ssl;

    #storage.mds.yandex.net - HTTP
    listen 213.180.204.158:80;
    listen [2a02:6b8::158]:80;

    #storage.mds.yandex.net - SSL
    listen 213.180.204.158:443 ssl http2;
    listen [2a02:6b8::158]:443 ssl http2;

    server_name storage.mds.yandex.net
                storage.mdst.yandex.net
                *.storage.mds.yandex.net;

    tskv_log /var/log/nginx/tskv.log mds-access-log;

    http2_max_requests 32768;
    http2_max_concurrent_streams 6;
    http2_idle_timeout 1m;

    include include/proxy_options.conf;

    # Потому что при чтении больших файлов, мы чексуммим файл в сторадже полностью.
    # Файл может быть несколько гигабайт.
    # прежде чем начать отдавать файл - ждём проверки чексумм
    # в будущем нужно будет убрать этот костылик, либо наоборот залить в бетон
    proxy_read_timeout 3600s;

    #https://st.yandex-team.ru/MDS-849
    include crossdomain/crossdomain-xml;
    include ssl/https.conf;

    #https://st.yandex-team.ru/MDS-54 - НЕ УБИРАТЬ НИКОГДА
    proxy_set_header X-MDS-SECURITY "{{ pillar['yav']['x_mds_security'] }}";
    proxy_set_header X-Request-Id    $request_id;

    #https://st.yandex-team.ru/MDS-7737
    proxy_set_header X-MDS-NGINX-URI $uri;

    #https://st.yandex-team.ru/MDS-12286
    add_header NEL "{\"report_to\": \"network-errors\", \"max_age\": 600, \"success_fraction\": 0.001, \"failure_fraction\": 0.01}";
    add_header Report-To "{\"group\": \"network-errors\", \"max_age\": 600, \"endpoints\": [ { \"url\": \"https://dr.yandex.net/s3_nel\"}]}";

    set $port 80;
    if ($scheme = https) {
            set $port 443;
    }

    include include/namespace-ext.conf;

    # https://st.yandex-team.ru/MDS-4809
    set $unistat_cluster_type "mdsproxy";
    header_filter_by_lua_block {
        increment_metric("stat_monitor_dmmm", 1)
    }
    # MDS-15314
    set $unistat_prior '';
    access_by_lua_file /etc/nginx/include/mds_yarl.lua;
}
