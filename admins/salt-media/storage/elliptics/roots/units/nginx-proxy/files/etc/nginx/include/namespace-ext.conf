{% set speed_iface = salt['cmd.shell']('source /usr/local/sbin/autodetect_active_eth; ethtool $default_route_iface |grep Speed |awk "{print $NF}"  |egrep "[0-9]+" -o') | int %}

{% if speed_iface > 0 %}
     {% set slb_weight = ((( speed_iface / 1000 ) + 40 ) / 5 ) %}
     {% if slb_weight <= 0 %}
         {% set slb_weight = 2 %}
     {% endif %}
{% endif %}

    location ~ ^/get-(imgmturk|expert|erika-ota|bem-info|phrase-spotter|msearch|authority|traffic_signs|metro|beta-lego-site|traffictoloka|antidup|entitysearch_static|yamb|toloka-fresh|ang2-data|stories-toloka|npm|launcher|autoru|market-sbs|photobot|ydf-public|speechkit|tdi_toloka|banana|afishanew-sitemap|radius|artifactory|lnchr|zenkit-resources|appmetrica-mobile-sdk|adlibimages|market-pages-cpm|afisha|synthia|addappter|yamarec-public|onlinemedia|scutum|market-export-public|maps_mrc_public|musictoloka|ads-mobile-sdk|autoru-cabinet|rasp-toloka|devtools-opensource|shinyserp|oscar|screenshots|disk-notes|mediana|canvas-html5-test|ranking|spravcontent|geoadv|pagedumps|mturk|bsinfo|selenium|get-frame-content|assessorrating|dptempstatic|matrix-router-result|ydo|zapravki-oebs|test-karl|music-shots|blender-serps|bunker|matrix-router-result-testing|curiosity|matrix-router-osm-result|curiosity-load|maps_mrc_public_testing)/ {
        proxy_pass http://mediastorage;
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        #https://st.yandex-team.ru/MDS-6609
        more_set_headers -s '200 206 302 404' "Access-Control-Allow-Origin: *";

        set $unistat_namespace $1;
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-mimcache/ {
        proxy_pass http://mediastorage;
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        #https://st.yandex-team.ru/MDS-6609
        more_set_headers -s '200 206 302 404' "Access-Control-Allow-Origin: *";

        set $unistat_namespace "mimcache";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-voicetoloka/ {
        proxy_pass http://mediastorage;
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        #https://st.yandex-team.ru/MDS-6609
        more_set_headers -s '200 206 302 404' "Access-Control-Allow-Origin: *";

        set $unistat_namespace "voicetoloka";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-browser-components/ {
        proxy_pass http://mediastorage;
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        #https://st.yandex-team.ru/MDS-6609
        more_set_headers -s '200 206 302 404' "Access-Control-Allow-Origin: *";

        set $unistat_namespace "browser-components";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;

        proxy_cache_valid 200 4h;
        proxy_cache_key "$request_method$uri";
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_404;
        proxy_cache browser-components;
    }

    # MDS-4896: CORS yastatic.net canvas-html5
    location ^~ /get-canvas-html5/ {
        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }
        add_header Cache-Control "max-age=31536000, immutable";
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;

        set $unistat_namespace "canvas-html5";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-cid-offline/ {
        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        gzip_types
            application/json
            application/octet-stream
            application/x-javascript
            application/x-sqlite3
            application/xml
            image/svg+xml
            text/css
            text/js
            text/plain;

        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;

        set $unistat_namespace "cid-offline";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-yambo/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['yambo'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "yambo";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    # BOBR-2644
    location ^~ /get-browser-d2m/ {
        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;
        header_filter_by_lua_block {
            local args = ngx.req.get_uri_args()
            local filename = ""
            local escaped_fn = ngx.escape_uri(args.filename)
            escaped_fn = ngx.re.gsub(escaped_fn, ",", "%2C")
            filename ="filename*=UTF-8''" .. escaped_fn

            if filename ~= nil and args.disposition ~= nil and args.disposition ~= "" then
                ngx.header.Content_Disposition = args.disposition .. "; " .. filename
            end

            increment_metric("stat_monitor_dmmm", 1)
        }

        set $unistat_namespace "browser-d2m";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    # MDS-3504
    location ^~ /get-webmaster-download/ {
        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;
        header_filter_by_lua_block {
            local args = ngx.req.get_uri_args()
            local filename = ""
            local escaped_fn = ngx.escape_uri(args.filename)
            escaped_fn = ngx.re.gsub(escaped_fn, ",", "%2C")
            filename ="filename*=UTF-8''" .. escaped_fn

            if filename ~= nil and args.disposition ~= nil and args.disposition ~= "" then
                ngx.header.Content_Disposition = args.disposition .. "; " .. filename
            end

            increment_metric("stat_monitor_dmmm", 1)
        }

        set $unistat_namespace "webmaster-download";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    # MDS-14501
    location /get-business/ {
        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }
        proxy_pass http://mediastorage;
        header_filter_by_lua_block {
            local args = ngx.req.get_uri_args()
            local filename = ""
            local escaped_fn = ngx.escape_uri(args.filename)
            escaped_fn = ngx.re.gsub(escaped_fn, ",", "%2C")
            filename ="filename*=UTF-8''" .. escaped_fn

            if filename ~= nil and args.disposition ~= nil and args.disposition ~= "" then
                ngx.header.Content_Disposition = args.disposition .. "; " .. filename
            end

            increment_metric("stat_monitor_dmmm", 1)
        }

        set $unistat_namespace "business";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-geosearch/ {
        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;

        set $unistat_namespace "geosearch";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-sport/ {
        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;

        set $unistat_namespace "sport";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-bstor/ {
        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        location /get-bstor/ {
            add_header Cache-Control "max-age=31536000, immutable";
            more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
            proxy_pass http://mediastorage;

            set $unistat_namespace "bstor";
            set $unistat_request_type "get";
            log_by_lua_file /etc/nginx/include/metrics.lua;
        }
        #https://st.yandex-team.ru/MDS-3496
        location ~ /get-bstor/([0-9]+?)/c/ {
            add_header Cache-Control "max-age=31536000, immutable";
            add_header Content-Security-Policy  "default-src 'self' *.storage.yandex.net storage.mds.yandex.net streaming.video.yandex.ru strm.yandex.ru data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' awaps.yandex.net 'unsafe-inline' 'unsafe-eval' data: ; object-src 'none';";
            proxy_pass http://mediastorage;

            set $unistat_namespace "bstor";
            set $unistat_request_type "get";
            log_by_lua_file /etc/nginx/include/metrics.lua;
        }
    }

    location ~ /(downloadinfo|get)-video-news/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-news'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-news";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-nda/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-nda'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-nda";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-study-hr/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-study-hr'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-study-hr";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-disk/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-disk'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-disk";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-an/ {
        #https://st.yandex-team.ru/MDS-3550
        ## auth_sign $http_host$uri/$arg_ts;
        ## auth_sign_signature $arg_sign;
        ## auth_sign_expire $arg_ts;
        ## auth_sign_hash sha256;
        ## auth_sign_token "eishaetiePai5paaNoob";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-an";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-user-backup/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-user-backup'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-user-backup";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-edu-platform/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-edu-platform'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-edu-platform";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-kinopoisk-trailers/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-kinopoisk-trailers'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-kinopoisk-trailers";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-holiday/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-holiday'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-holiday";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ruscorpora/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ruscorpora'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ruscorpora";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-developers/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-developers'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-developers";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-autoru-office/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-autoru-office'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-autoru-office";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-expert/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-expert'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-expert";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-ukraine-official/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-ukraine-official'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-ukraine-official";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-events/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-events'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-events";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-afisha-trailers/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-afisha-trailers'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-afisha-trailers";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-maps/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-maps'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-maps";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-fishki/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-fishki'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-fishki";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-cinema/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-cinema'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-cinema";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-platon/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-platon'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-platon";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-podskazky/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-podskazky'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-podskazky";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-direct/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-direct'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-direct";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-adv-blog/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-adv-blog'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-adv-blog";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-shad-spb/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-shad-spb'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-shad-spb";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-taxi/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-taxi'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-taxi";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-money/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-money'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-money";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-zno/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-zno'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-zno";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-market-review/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-market-review'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-market-review";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-sales-edu/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-sales-edu'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-sales-edu";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-maps-help/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-maps-help'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-maps-help";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-histrf/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-histrf'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-histrf";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-traffic/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-traffic'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-traffic";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-adfox/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ya-adfox'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-adfox";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ott/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-ott'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ott";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-agencyevents/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-agencyevents'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-agencyevents";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-hosting/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-hosting'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-hosting";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-launcher/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "Tz4RsWKs44Bu3Cesmv0f";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-launcher";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-ya-display/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "0XwiLHikyXqGowDW1bjd";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-ya-display";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-geo/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-geo'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-geo";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(downloadinfo|get)-video-videodirekt/ {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['video-videodirekt'] }}";

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "video-videodirekt";
        set $unistat_request_type $1;
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-promenad/ {

        location ~ /[0-9]+/audio/ {
            auth_sign $http_host$uri/$arg_ts;
            auth_sign_signature $arg_sign;
            auth_sign_expire $arg_ts;
            auth_sign_hash sha256;
            auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['promenad'] }}";

            proxy_pass http://mediastorage;
        }

        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;

        set $unistat_namespace "promenad";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-music/ {
        #https://st.yandex-team.ru/MDS-925
        rewrite ^(.*)/2.xml /get-music/24417/meta/2.xml break;

        location ~ /[0-9]+/public/ {
            proxy_pass http://mediastorage;
            more_set_headers -s '200 206 404 401 500' "Access-Control-Allow-Origin: *";
            more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
            set $unistat_namespace "music";
            set $unistat_request_type "get";
            log_by_lua_file /etc/nginx/include/metrics.lua;
        }

        location ~ '.*\.(aac|mp3)$' {
                return 403;
                set $unistat_namespace "music";
                set $unistat_request_type "get";
                log_by_lua_file /etc/nginx/include/metrics.lua;
        }

        proxy_pass http://mediastorage;
        more_set_headers -s '200 206 404 401 500' "Access-Control-Expose-Headers: Content-Length";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "music";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ ^/get-alice/([0-9]+?)(/|_)(.*)/(.*) {
        auth_sign $http_host$uri/$arg_ts;
        auth_sign_signature $arg_sign;
        auth_sign_expire $arg_ts;
        auth_sign_hash sha256;
        auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['music'] }}";

        more_set_headers -s '200 206 404 401 500' "Access-Control-Expose-Headers: Content-Length";

        # MDSSUPPORT-1064
        if ($arg_service = 'alice') {
            set $unistat_service 'alice';
        }

        #https://st.yandex-team.ru/MDS-1361 see conf.d/map.conf;
        set $musicformat $4;

        proxy_pass http://mediastorage/get-music/$1/$3/$real_file_name?$args;
        set $unistat_namespace "music";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    #https://st.yandex-team.ru/MDS-876
    #---------------------------------
    location ~ ^/download-info/([0-9]+?)(/|_)(.*/.*) {
        #https://st.yandex-team.ru/MDS-908
        proxy_method GET;
        proxy_pass http://mediastorage/downloadinfo-music/$1/$3.mp3?$args;
        #https://st.yandex-team.ru/MUSIC-2448
        more_set_headers -s '200 206 404 401 500' "Access-Control-Allow-Origin: *";
        more_set_headers -s '200 206 404 401 500' "Access-Control-Expose-Headers: Content-Length";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "music";
        set $unistat_request_type "downloadinfo";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }
    location ~ ^/download-info/([0-9]+?)(/|_)(.*/.*\.mp3*) {
        proxy_pass http://mediastorage/downloadinfo-music/$1/$3?$args;
        #https://st.yandex-team.ru/MUSIC-2448
        more_set_headers -s '200 206 404 401 500' "Access-Control-Allow-Origin: *";
        more_set_headers -s '200 206 404 401 500' "Access-Control-Expose-Headers: Content-Length";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        set $unistat_namespace "music";
        set $unistat_request_type "downloadinfo";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /downloadinfo-music/ {
        #https://st.yandex-team.ru/MDS-908
        proxy_method GET;
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;

        set $unistat_namespace "music";
        set $unistat_request_type "downloadinfo";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    #https://st.yandex-team.ru/MUSIC-2814
    location ^~ /file-download-info/ {
        location ~ ^/file-download-info/([0-9]+?)(/|_)(.*)/(.*) {
            auth_sign $http_host$uri/$arg_ts;
            auth_sign_signature $arg_sign;
            auth_sign_expire $arg_ts;
            auth_sign_hash sha256;
            auth_sign_token "{{ pillar['mediastorage_proxy_auth_sign_token']['music'] }}";

            # MDSSUPPORT-1064
            if ($arg_service = 'alice') {
                set $unistat_service 'alice';
            }

            #https://st.yandex-team.ru/MDS-1361 see conf.d/map.conf;
            set $musicformat $4;

            proxy_pass http://mediastorage/downloadinfo-music/$1/$3/$real_file_name?$args;
            #https://st.yandex-team.ru/MUSIC-2448
            more_set_headers -s '200 206 404 401 500' "Access-Control-Allow-Origin: *";
            more_set_headers -s '200 206 404 401 500' "Access-Control-Expose-Headers: Content-Length";
            more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

            set $unistat_namespace "music";
            set $unistat_request_type "downloadinfo";
            log_by_lua_file /etc/nginx/include/metrics.lua;
        }
    }



    location ^~ /get-sbs/ {
        if ($uri ~ '.*\.html$') {
            more_set_headers -s '200 206' "Content-Type: text/html";
        }

        if ($arg_content_type) {
                more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        proxy_pass http://mediastorage;
        #proxy_cache_valid 200 1h;
        #proxy_cache_key "$request_method$uri";
        #proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_404;
        #proxy_cache sbs;

        add_header Cache-Control max-age=7200;

        set $unistat_namespace "sbs";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-edgesearch/ {
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;
        proxy_cache_valid 200 5m;
        proxy_cache_key "$request_method$uri";
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_404;
        proxy_cache edgesearch;


        set $unistat_namespace "edgesearch";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-crx/ {
        if ($uri ~ '.*\.crx$') {
            more_set_headers -s '200 206' "Content-Type: application/x-chrome-extension";
        }

        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        proxy_pass http://mediastorage;
        proxy_cache_valid 200 5m;
        proxy_cache_key "$request_method$uri";
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_404;
        proxy_cache crx;

        add_header Cache-Control max-age=7200;

        set $unistat_namespace "crx";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-browser-store/ {
        if ($uri ~ '.*\.crx$') {
            more_set_headers -s '200 206' "Content-Type: application/x-chrome-extension";
        }

        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        proxy_pass http://mediastorage;
        #proxy_cache_valid 200 5m;
        #proxy_cache_key "$request_method$uri";
        #proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_404;
        #proxy_cache crx;

        add_header Cache-Control max-age=7200;

        set $unistat_namespace "browser-store";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-browser/ {
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;
        proxy_cache_valid 200 12h;
        proxy_cache_key "$request_method$uri$args";
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_404;
        proxy_cache browser;

        add_header Cache-Control max-age=7200;

        set $unistat_namespace "browser";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-weather-public/ {
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;
        # proxy_cache_valid 200 12h;
        # proxy_cache_key "$request_method$uri$args";
        # proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_404;
        # proxy_cache weather-public;

        # add_header Cache-Control max-age=7200;

        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        set $unistat_namespace "weather-public";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-education/ {
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;
        #proxy_cache_valid 200 24h;
        #proxy_cache_key "$request_method$uri$args";
        #proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_404;
        #proxy_cache education;

        set $unistat_namespace "education";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-partner/ {
        include include/cache/range.conf;
        #proxy_cache_valid 200 24h;
        #proxy_cache_key "$request_method$uri";
        #proxy_cache partner;

        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        add_header Cache-Control max-age=7200;

        set $unistat_namespace "partner";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-maps-offline-caches/ {
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;

        set $unistat_namespace "maps-offline-caches";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-tickets/ {
        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        if ($uri ~ '.*\.pkpass$') {
            more_set_headers -s '200 206' "Content-Type: application/vnd.apple.pkpass";
        }
        # https://st.yandex-team.ru/MDS-2855
        more_set_headers -s '200 206 302 404' "Access-Control-Allow-Origin: *";
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";
        proxy_pass http://mediastorage;

        set $unistat_namespace "tickets";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /get-taximeter/ {
        proxy_pass http://mediastorage;
        more_set_headers "X-Robots-Tag: noindex, noarchive, nofollow";

        if ($arg_content_type) {
            more_set_headers -s '200 206' "Content-Type: $arg_content_type";
        }

        #https://st.yandex-team.ru/MDS-6609
        more_set_headers -s '200 206 302 404' "Access-Control-Allow-Origin: *";

        set $unistat_namespace "taximeter";
        set $unistat_request_type "get";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ^~ /ping {
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_pass http://mediastorage;

        more_set_headers -s '200' "RS-Weight: {{ slb_weight | int }}";

        set $unistat_request_type "ping";
        log_by_lua_file /etc/nginx/include/metrics.lua;
    }

    location ~ /(jars|loading.gif|dognose.(.*)) {
        root /usr/lib/yandex/yandex-media-dognose-storage/;

        log_by_lua_block {
            increment_metric("stat_system_dmmm", 1)
        }
    }

    location ~ /(favicon.ico|404.gif) {
        return 200;

        log_by_lua_block {
            increment_metric("stat_system_dmmm", 1)
        }
    }

    location =/robots.txt {
        root /var/www/;

        log_by_lua_block {
            increment_metric("stat_system_dmmm", 1)
        }
    }

    location =/google419fbd824d7ff97d.html {
        root /var/www/;

        log_by_lua_block {
            increment_metric("stat_system_dmmm", 1)
        }
    }

    location / {
        return 410;

        log_by_lua_block {
            increment_metric("stat_system_dmmm", 1)
        }
    }
