{% set fqdn = grains['fqdn']-%}
{% set dc = grains['conductor']['root_datacenter']-%}
{% set id = fqdn | regex_replace('^.*?0?(\d+).*$', '\\1') %}
{%- set dcid = {
            'iva': '1',
            'myt': '2',
            'sas': '3',
            'man': '4',
            'vla': '5',
            'klg': '6'
        }
%}
<yandex>
{% if dcid[dc]+id in ['11','24','35'] %}
    <keeper_server>
        <tcp_port>2181</tcp_port>
        <server_id>{{ dcid[dc] }}{{ id }}</server_id>
        <log_storage_path>/var/lib/clickhouse/coordination/log</log_storage_path>
        <snapshot_storage_path>/var/lib/clickhouse/coordination/snapshots</snapshot_storage_path>

        <coordination_settings>
            <raft_logs_level>trace</raft_logs_level>
            <election_timeout_lower_bound_ms>4000</election_timeout_lower_bound_ms>
            <election_timeout_upper_bound_ms>8000</election_timeout_upper_bound_ms>
            <max_requests_batch_size>50</max_requests_batch_size>
            <operation_timeout_ms>40000</operation_timeout_ms>
            <session_timeout_ms>120000</session_timeout_ms>
            <force_sync>false</force_sync>
        </coordination_settings>

        <raft_configuration>
            <server>
                <id>11</id>
                <hostname>clickhouse01iva.mds.yandex.net</hostname>
                <port>9444</port>
            </server>
            <server>
                <id>24</id>
                <hostname>clickhouse04myt.mds.yandex.net</hostname>
                <port>9444</port>
            </server>
            <server>
                <id>35</id>
                <hostname>clickhouse05sas.mds.yandex.net</hostname>
                <port>9444</port>
            </server>
        </raft_configuration>
    </keeper_server>
{% endif %}
</yandex>