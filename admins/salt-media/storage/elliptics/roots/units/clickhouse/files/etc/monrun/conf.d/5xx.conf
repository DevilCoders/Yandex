[cocaine5xx]
execution_interval=600
execution_timeout=30
command=echo "SELECT count(host), host from cocaine_logs.cocaine_logs where timestamp between toUnixTimestamp(now()) - 600 and toUnixTimestamp(now())  AND (status=500 OR status=502 OR status=503 OR status=504) group by host order by count() desc"  | curl -s "http://reader@127.0.0.1:8123/?query=" -d @- | awk 'BEGIN {i=0;sum=0;max=0} {if (i==0) {max=$1; host=$2;i++;} else {sum += $1 ;i++}} END {if (max/(sum/i) > 7 && max/600 > 100) {print "2;"host" generate 5xx("max/600" rps) in "max/(sum/i)" times more then average("sum/i/600" rps)"} else if(max/(sum/i) > 3) {print "1;"host" generate 5xx("max/600" rps) in "max/(sum/i)" times more then average("sum/i/600" rps)"} else {print "0;Ok"}}'
type=ape
docstring=check top of 5xx hosts

