recursive_error_pages on;
error_page 429 = @aws_too_many_requests_error;
error_page 408 = @aws_request_timeout_error;

location @aws_too_many_requests_error {
    more_set_headers "Content-Type: application/xml";
    more_set_headers "X-Amz-Request-Id: $request_id";
    return 429 '<?xml version="1.0" encoding="UTF-8"?>
<Error><Code>TooManyRequestsException</Code><Message>Please reduce your request rate.</Message><RequestId>$request_id</RequestId></Error>';
}

location @aws_request_timeout_error {
    more_set_headers "Content-Type: application/xml";
    more_set_headers "X-Amz-Request-Id: $request_id";
    return 400 '<?xml version="1.0" encoding="UTF-8"?>
<Error><Code>RequestTimeout</Code><Message>Your socket connection to the server was not read from or written to within the timeout period. Idle connections will be closed.</Message><RequestId>$request_id</RequestId></Error>';
}
