{% set env = grains['yandex-environment'] %}
{% if env == 'testing' %}
  {% set idm_workers_group = [grains["fqdn"]] %}
{% else %}
  {% set idm_workers_group = [
  "proxy01iva.mds.yandex.net",
  "proxy02iva.mds.yandex.net",
  "proxy03iva.mds.yandex.net",
  "proxy04iva.mds.yandex.net",
  "proxy05iva.mds.yandex.net",
  "proxy01myt.mds.yandex.net",
  "proxy02myt.mds.yandex.net",
  "proxy03myt.mds.yandex.net",
  "proxy04myt.mds.yandex.net",
  "proxy05myt.mds.yandex.net",
  "proxy01sas.mds.yandex.net",
  "proxy02sas.mds.yandex.net",
  "proxy03sas.mds.yandex.net",
  "proxy04sas.mds.yandex.net",
  "proxy05sas.mds.yandex.net",
  "proxy01vla.mds.yandex.net",
  "proxy02vla.mds.yandex.net",
  "proxy03vla.mds.yandex.net",
  "proxy04vla.mds.yandex.net",
  "proxy05vla.mds.yandex.net",
  "proxy01man.mds.yandex.net",
  "proxy02man.mds.yandex.net",
  "proxy03man.mds.yandex.net",
  "proxy04man.mds.yandex.net",
  "proxy05man.mds.yandex.net",
  ] %}
{% endif %}

proxy_cache_path /var/cache/nginx/cache/idm levels=1:2 keys_zone=idm:100m max_size=1G inactive=10m loader_files=50 loader_threshold=100 loader_sleep=300000;

upstream s3-goose-idm {
    server 127.0.0.1:3377;
}

upstream s3-goose-private {
    server 127.0.0.1:3388;
}

upstream s3-goose-private-system {
    server 127.0.0.1:3399;
}

server {
    listen 127.0.0.1:443 ssl;
    listen [::1]:443 ssl;

    listen 5443 ssl;
    listen [::]:5443 ssl;

    listen 213.180.205.146:80;
    listen [2a02:6b8:0:3400::4:146]:80;
    listen 213.180.205.146:443 ssl;
    listen [2a02:6b8:0:3400::4:146]:443 ssl;

    server_name s3-idm.mdst.yandex.net s3-idm.mds.yandex.net;

    tskv_log /var/log/nginx/s3-tskv.log s3-access-log;

    ssl_certificate     /etc/yandex-certs/s3-idm.mds.yandex.net.pem;
    ssl_certificate_key /etc/yandex-certs/s3-idm.mds.yandex.net.key;
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers kEECDH+AESGCM+AES128:kEECDH+AES128:kRSA+AESGCM+AES128:kRSA+AES128:RC4-SHA:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2;
    #ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
    #ssl_ciphers TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-CHACHA20-POLY1305:kEECDH+AESGCM+AES128:kEECDH+AESGCM+AES256:kRSA+AESGCM+AES128:kEECDH+AES128:kRSA+AES128:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2:!RC4:!3DES:!DSS;
    ssl_session_cache    shared:S3_SSL_CACHE:128m;
    ssl_session_timeout  28h;

    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/nginx/ssl/certuml4.pem;

    ssl_client_certificate /etc/yandex-certs/allCAs.pem;
    ssl_verify_client optional;
    ssl_verify_depth 3;

    include s3/proxy_options.conf;

    request_id_from_header on;
    request_id_header_name X-Request-Id;

    location ^~ /roles {
        proxy_pass    http://s3-goose-idm;
    }

    location ^~ /credentials {
        proxy_pass    http://s3-goose-private;
    }

    location ^~ /resources {
        proxy_pass    http://s3-goose-private;
    }

    location ^~ /buckets/ {
        proxy_pass    http://s3-goose-private;
    }

    location ^~ /quotaManagement/ {
        proxy_pass    http://s3-goose-private;
    }

    {%- if grains["fqdn"] in idm_workers_group %}
    location ^~ /stats {
        proxy_buffering             on;
        proxy_cache_valid           200 6m;
        proxy_cache_key             "$request_method$uri$args";
        proxy_cache                 idm;
        proxy_cache_lock            on;
        proxy_cache_lock_timeout    15s;
        proxy_cache_use_stale       error timeout updating http_500 http_502 http_503 http_504;
        proxy_pass    http://s3-goose-private;
    }
    {% endif %}

    location ^~ /management/ {
        proxy_pass    http://s3-goose-private;
    }

    location ^~ /ping {
        proxy_pass    http://s3-goose-private-system;
    }
}
