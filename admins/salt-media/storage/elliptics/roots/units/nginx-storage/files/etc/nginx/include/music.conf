location ~* ^/get-mp3/[a-z0-9]+/(?<timestamp>[a-z0-9]+)/rmusic/(?<encrypted_stid>[a-zA-Z0-9_-]+)/(?<sign_path>[a-zA-Z0-9_-]+)(/(?<offset>[0-9]+))? {

    # MDS-8253:
    # if ($token_check_result) {
    #     return 400;        # actually something else
    #     add_header Access-Control-Allow-Origin "*";
    # }

    include include/music-settings.conf;

    auth_sign $http_host/rmusic/$encrypted_stid/$timestamp;
    # MDS-11061 offset argument for music:
    auth_sign_optional offset=$offset;
    auth_sign_signature $sign_path;
    auth_sign_expire $nonzero_range;
    auth_sign_hash sha256;
    auth_sign_token "{{ pillar['yav']['storage-auth_sign_token-music'] }}";
    auth_sign_decrypt decr encrypted_stid;

    access_by_lua '
        -- Get request arguments into lua dict args
        local args = ngx.req.get_uri_args()
        local dec_uri = ngx.var.decr
        local offset = ngx.var.offset
        if dec_uri ~= nil and dec_uri ~= "" then
            if offset ~= nil and offset ~= "" then
                dec_uri = dec_uri .. "?offset=" .. offset
            end
            ngx.exec(ngx.unescape_uri("/get-music-internal/" .. dec_uri), args)
        end
    ';
}

location ~* ^/rmusic/(?<encrypted_stid>[a-zA-Z0-9_-]+) {
    include include/music-settings.conf;

    # MDS-11061 offset argument for music:
    auth_sign_optional offset=$arg_offset;
    auth_sign_token "{{ pillar['yav']['storage-auth_sign_token-music'] }}";
    auth_sign_decrypt decr encrypted_stid;

    access_by_lua '
        -- Get request arguments into lua dict args
        local args = ngx.req.get_uri_args()
        local dec_uri = ngx.var.decr
        if dec_uri ~= nil and dec_uri ~= "" then
            ngx.exec(ngx.unescape_uri("/get-music-internal/" .. dec_uri), args)
        end
    ';
}

location /get-music-internal/ {
    internal;

    rewrite /get-music-internal/(.*) $1 break;

    include include/music-settings.conf;
    include include/mediastorage-settings.conf;
}
