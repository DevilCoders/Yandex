location ~* ^/r{{ ns_name }}/(?<encrypted_stid>[a-zA-Z0-9_-]+) {
    auth_sign_token "{{ token }}";
    auth_sign_decrypt decr encrypted_stid;

    proxy_set_header If-Match "*";
    more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";

    access_by_lua '

        -- Get request arguments into lua dict args
        local args = ngx.req.get_uri_args()
        local dec_uri = ngx.var.decr
        if dec_uri ~= nil and dec_uri ~= "" then
            ngx.exec(ngx.unescape_uri("/get-{{ ns_name }}-internal/" .. dec_uri), args)
        end
        ';
}

location /get-{{ ns_name }}-internal/ {
    internal;

    set $unistat_namespace "{{ ns_name }}";
    set $unistat_request_type "get";
    rewrite /get-{{ ns_name }}-internal/(.*) $1 break;

    proxy_set_header If-Match "*";
    more_set_headers -s '200 206 302' "Access-Control-Allow-Origin: *";

    include include/mediastorage-settings.conf;
}
