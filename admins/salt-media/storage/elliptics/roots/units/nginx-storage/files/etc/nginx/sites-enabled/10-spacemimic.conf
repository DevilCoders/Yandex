#proxy_cache_path /var/cache/nginx/cache/spacemimic levels=1:2 keys_zone=spacemimic:100m max_size=250G inactive=7d loader_files=50 loader_threshold=100 loader_sleep=300000;

upstream spacemimic {
    server 127.0.0.1:11000 max_fails=0;
    {%- if grains['yandex-environment'] == 'testing' %}
    server spacemimic.mdst.yandex.net:11000 backup;
    {% else %}
    server spacemimic.storage.yandex.net:11000 backup;
    {% endif %}
    keepalive 8;
}

lua_package_path '/usr/share/lua/5.1/?.lua;;';
lua_package_cpath '/usr/lib/x86_64-linux-gnu/lua/5.1/?.so;;';

server {
    listen 10000 reuseport;
    listen [::]:10000 reuseport;

    tskv_log /var/log/nginx/spacemimic.log mds-access-log-storages;
    error_log /var/log/nginx/error.log;

    proxy_buffering off;

    location /get/320.agodin {
        proxy_pass http://spacemimic;
    }

    location / {
        proxy_next_upstream error timeout http_502 http_500 http_503 http_504;
        proxy_pass http://spacemimic;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # https://st.yandex-team.ru/MDS-4809
    set $unistat_cluster_type "storage";
    {%- if grains['yandex-environment'] == 'testing' %}
    set $cloud_mimic_addr "2a02:6b8:0:3400:0:37f:0:3";
    {% else %}
    set $cloud_mimic_addr "2a02:6b8:0:3400::30f";
    {% endif %}
    header_filter_by_lua_block {
            increment_metric("stat_monitor_dmmm", 1)
    }
    log_by_lua_file /etc/nginx/include/metrics_storage.lua;
}
