{%- set config = vars -%}
upstream drooz {
    {% for item in config.drooz_v2.collector_hosts -%}
    server {{ item }}:{{ config.drooz_v2.drooz_port }} fail_timeout=10s;
    {% endfor %}
}

proxy_cache_path /var/cache/mastermind/nginx-cache levels=1 keys_zone=drooz:4096m max_size=1G inactive=1h loader_files=100 manager_files=100;

server {
    listen [::1]:8383 ipv6only=on;

    proxy_set_header If-Modified-Since $http_if_modified_since;
    proxy_set_header X-Request-Id $request_id;
    request_id_from_header on;
    request_id_length 16;

    location ~ ^/(get_storage_state_snapshot|get_config_remotes) {
        proxy_cache_valid 200 304 {{ config.proxy_cache }};
        proxy_cache_key $request_method$uri$http_if_modified_since;
        proxy_cache_min_uses 0;
        proxy_cache drooz;
        proxy_cache_use_stale updating;
        proxy_pass http://drooz;
    }
}
