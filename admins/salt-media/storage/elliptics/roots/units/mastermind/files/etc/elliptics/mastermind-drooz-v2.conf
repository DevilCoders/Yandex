{%- set config = vars -%}
{
    "http_app_profiles": {
        "port": {{ config.drooz_v2.http_port }}
    },

    "defaults": {{ config.drooz_v2.defaults | tojson() }},

    "http_handles": {
        "get_storage_state_snapshot": {
            "request": {
                "upstream": {
                    "hosts": "{{ config.drooz_v2.upstream_hosts }}",
                    "client_class": "{{ config.drooz_v2.upstream_client_class }}",
                    "handle": "get_storage_state_snapshot_v2",
                    "version": "v2",
                    "params": {
                        "gzip": true
                    },
                    "request_timeout": 60
                }
            },
            "response": {
                "success": {
                    "update_period": 10,
                    "stale_timeout": 3600
                }
            }
        },
        "get_config_remotes": {
            "request": {
                "upstream": {
                    "hosts": "{{ config.drooz_v2.upstream_hosts }}",
                    "client_class": "{{ config.drooz_v2.upstream_client_class }}",
                    "handle": "get_config_remotes",
                    "params": {
                        "format": "flatbuffers"
                    }
                }
            },
            "response": {
                "success": {
                    "update_period": 10,
                    "stale_timeout": 3600
                }
            }
        }
    },
    "subscribers": [
        {%- for host in config.collector.hosts %}
        "{{ host }}:{{ config.drooz_v2.grpc_port }}"{{ "," if not loop.last else "" }}
        {%- endfor %}
    ],

    "grpc_receiver": {
        "port": {{ config.drooz_v2.grpc_port }},
        "threads": 5
    },

    "solomon": {
        "tags": {
            "ctype": "{{ grains['yandex-environment'] }}",
            "federation": "{{ pillar['mds_federation'] }}"
        }
    }
}
