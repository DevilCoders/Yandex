{%- set env =  grains['yandex-environment'] -%}

upstream nscfg-server {
    server localhost:9534 max_fails=0;
}

upstream nscfg-server-ng {
    server unix:/var/run/nscfg-ng.sock max_fails=0;
}

{%- if env == 'testing' %}
upstream nscfg-server-ng-test {
    server unix:/var/run/nscfg-ng-test.sock max_fails=0;
}
{%- endif %}

proxy_cache_path /var/cache/nginx/proxy-cache/nscfg levels=1:2 keys_zone=nscfg:256m max_size=2G inactive=24h loader_files=100 manager_files=100;

server {
    listen 9532;
    listen [::]:9532 ipv6only=on;
    server_name nscfg.mdst.yandex.net nscfg.mds.yandex.net;
    request_id_from_header on;
    request_id_length 16;

    proxy_set_header X-Request-Id $request_id;
    proxy_set_header X-Https-Request yes;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    gzip                 on;
    gzip_buffers         64 16k;
    gzip_comp_level      7;
    gzip_disable         msie6;
    gzip_types
        application/json
        text/plain;

    location /all {
        proxy_cache_valid 200 60s;
        proxy_cache_key $request_method$uri$args;
        proxy_cache_min_uses 1;
        proxy_cache nscfg;
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_403 http_404 http_429;
        proxy_cache_lock on;
        proxy_cache_background_update off;
        proxy_pass http://nscfg-server;
    }

    location / {
        proxy_pass http://nscfg-server;
    }

    location /hostname {
        add_header "Content-Type" "text/plain";
        return 200 $hostname;
    }
}

server {
    listen 1443 ssl reuseport;
    listen [::]:1443 ipv6only=on ssl reuseport;
    server_name nscfg.mdst.yandex.net nscfg.mds.yandex.net;
    request_id_from_header on;
    request_id_length 16;

    ssl_certificate /etc/yandex-certs/nscfg.mds.yandex.net.pem;
    ssl_certificate_key /etc/yandex-certs/nscfg.mds.yandex.net.key;
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers kEECDH+AESGCM+AES128:kEECDH+AES128:kRSA+AESGCM+AES128:kRSA+AES128:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2;
    ssl_session_cache shared:SSLNSCFG:16m;
    ssl_session_timeout 28h;

    proxy_set_header X-Request-Id $request_id;
    proxy_set_header X-Https-Request yes;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    gzip                 on;
    gzip_buffers         64 16k;
    gzip_comp_level      7;
    gzip_disable         msie6;
    gzip_types
        application/json
        text/plain;

    location /v1/all-settings/ {
        # MDS-14155
        auth_sign $proxy_add_x_forwarded_for$uri;

{%- if env == 'production' %}
        auth_sign_token "{{ pillar['yav']['nscfg-all_settings_secret'] }}";
{%- elif env == 'testing' %}
        auth_sign_token "{{ pillar['yav']['nscfg-testing_all_settings_secret'] }}";
{%- endif %}

        auth_sign_signature $arg_sign;
        auth_sign_expire "7FFFFFFF"; 
        auth_sign_hash sha256;

        proxy_cache_valid 200 60s;
        proxy_cache_key $request_method$uri$arg_mds-old-style;
        proxy_cache_min_uses 1;
        proxy_cache nscfg;
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_403 http_404 http_429;
        proxy_cache_lock on;
        proxy_cache_background_update off;
        proxy_cache_lock_timeout 15s;
        proxy_connect_timeout 7s;
        proxy_read_timeout 7s;
        proxy_send_timeout 7s;
        proxy_pass http://nscfg-server-ng;
    }

    location /v1/ {
        proxy_cache off;
        proxy_pass http://nscfg-server-ng;
    }

    location /ping {
        proxy_cache off;
        proxy_pass http://nscfg-server-ng;
    }

    location /hostname {
        add_header "Content-Type" "text/plain";
        return 200 $hostname;
    }
}

{%- if env == 'testing' %}
proxy_cache_path /var/cache/nginx/proxy-cache/nscfg-test levels=1:2 keys_zone=nscfg-test:256m max_size=2G inactive=24h loader_files=100 manager_files=100;
server {
    listen 2443 ssl reuseport;
    listen [::]:2443 ipv6only=on ssl reuseport;
    server_name nscfg.mdst.yandex.net;
    request_id_from_header on;
    request_id_length 16;

    ssl_certificate /etc/yandex-certs/nscfg.mds.yandex.net.pem;
    ssl_certificate_key /etc/yandex-certs/nscfg.mds.yandex.net.key;
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers kEECDH+AESGCM+AES128:kEECDH+AES128:kRSA+AESGCM+AES128:kRSA+AES128:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2;
    ssl_session_cache shared:SSLNSCFG:16m;
    ssl_session_timeout 28h;

    proxy_set_header X-Request-Id $request_id;
    proxy_set_header X-Https-Request yes;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    gzip                 on;
    gzip_buffers         64 16k;
    gzip_comp_level      7;
    gzip_disable         msie6;
    gzip_types
        application/json
        text/plain;

    location /v1/all-settings/ {
        # MDS-14155
        auth_sign $proxy_add_x_forwarded_for$uri;
        auth_sign_token "{{ pillar['yav']['nscfg-testing_all_settings_secret'] }}";
        auth_sign_signature $arg_sign;
        auth_sign_expire "7FFFFFFF"; 
        auth_sign_hash sha256;

        proxy_cache_valid 200 60s;
        proxy_cache_key $request_method$uri$arg_mds-old-style;
        proxy_cache_min_uses 1;
        proxy_cache nscfg-test;
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_403 http_404 http_429;
        proxy_cache_lock on;
        proxy_cache_background_update off;
        proxy_cache_lock_timeout 15s;
        proxy_connect_timeout 7s;
        proxy_read_timeout 7s;
        proxy_send_timeout 7s;
        proxy_pass http://nscfg-server-ng-test;
    }

    location /v1/ {
        proxy_cache off;
        proxy_pass http://nscfg-server-ng-test;
    }

    location /ping {
        proxy_cache off;
        proxy_pass http://nscfg-server-ng-test;
    }

    location /hostname {
        add_header "Content-Type" "text/plain";
        return 200 $hostname;
    }
}
{%- endif %}
