{%- set config = vars -%}
{%- set prod =  ['prestable', 'production'] -%}
{
    "app_name": "mastermind2.26",

    "grpc": {
        "port": 9010,
        "thread_pool_size": 10,
        "maximum_concurrent_rpcs": 100
    },

    "inventory_grpc": {
        "port": 50051,
        "threads_num": 10
    },
    "monolith_worker": {
        "workers": 1,
        "provide_external_api": true,
        "groups_history_update_enabled": true,
        "lrc_groupset_statistics": {
            "updater_enabled": true
        }
    },

    "nodes_reload_period": 10,
    "storage_state_source": {
        "app": "mastermind-collector",
        "addresses": "localhost:50057",
        "verify": true,
        "ignore_empty_snapshot": {{ config.collector.ignore_empty_snapshot|lower }},
        "use_flatbuffers": true
    },

    "resizer": {
        "address": "{{ config.collector.resizer_addresses|lower }}",
        "timeout": 900
    },

    "state_builder_worker": {
        "http_port": 9015,
        "grpc": {
            "port": 9014
        },
        "enable_load_cache_update": {{ config.state_builder.enable_load_cache_update|lower }},
        "load_cache": {
            "enable": {{ config.state_builder.enable_load_cache_update|lower }}
        }
    },

    "forbidden_dht_groups": true,
    "forbidden_unmatched_group_total_space": true,
    "forbidden_ns_without_settings": true,
    "forbidden_dc_sharing_among_groups": true,
    "namespaces-mandatory-dcs": {
        "s3-yc-cold": ["sas", "vla", "myt"],
        "s3-yc-ringbuffer": ["sas", "vla", "myt"],
        "s3-yc-ice": ["sas", "vla", "myt"]
    },

    "disown_timeout": 180,
    "heartbeat_timeout": 180,

    "inventory": "yandex_mastermind.inventory",
    "inventory_config": {
        "federation_conductor_groups": {{ config.inventory.federation_conductor_groups | json }},
        "project": "elliptics",
        "project_cache": 43200,
        "groups_cache": 21600
    },

    "elliptics": {
        "nodes": [
            {%- for host in config.elliptics.nodes %}
            ["{{ host }}", 1025, 10]{{ "," if not loop.last else "" }}
            {%- endfor %}
        ],
        "wait_timeout": {{ config.elliptics.wait_timeout }},
        "dnet_log": "/var/log/mastermind/mastermind.log",
        "dnet_log_mask": 3,
        "net_thread_num": 32,
        "io_thread_num": 32,
        "nonblocking_io_thread_num": 32,
        "config_path_tpl": "/etc/elliptics/parsed/elliptics-node-{node_id}.parsed",
        "tls_support": 1,
        "cert_path": "/etc/elliptics/ssl/storage.crt",
        "key_path": "/etc/elliptics/ssl/storage.key",
        "ca_path": "/etc/elliptics/ssl"
    },

    "monitor": {
        "pool_size": 10,
        "connect_timeout": 5,
        "request_timeout": 5,
        "max_http_clients": 30
    },

    "unistat": {
        "port_start": 6000,
        "port_range": 10
    },

    "couple_build": {
        "default_group_total_space": "916G"
    },

    "all_federations_metadata": {
        "url": "{{ config.mongo.all_federations_mdb_url_template.format(user=config.mongo.mdb_user, password=config.mongo.mdb_password) }}",
        "options": {
            "max_pool_size": 100,
            "socketTimeoutMS": 15000,
            "connectTimeoutMS": 15000,
            "w": 2,
            "wtimeout": 15000
        },
        "groups": {
            "db": "{{ config.mongo.global_metadata_db_prefix }}_groups"
        },
        "external_storage": {
            "db": "{{ config.mongo.global_metadata_db_prefix }}_external_storage"
        }
    },
    "metadata": {
        "url": "{{ config.mongo.mdb_url_template.format(user=config.mongo.mdb_user, password=config.mongo.mdb_password) }}",
        "options": {
            "max_pool_size": 100,
            "socketTimeoutMS": 15000,
            "connectTimeoutMS": 15000,
            "w": 2,
            "wtimeout": 15000
        },
        "couples": {
            "db": "{{ config.mongo.metadata_db_prefix }}_couples"
        },
        "jobs": {
            "db": "{{ config.mongo.metadata_db_prefix }}_jobs"
        },
        "planner": {
            "db": "{{ config.mongo.metadata_db_prefix }}_planner"
        },
        "cache": {
            "db": "{{ config.mongo.metadata_db_prefix }}_cache"
        },
        "statistics": {
            "db": "{{ config.mongo.metadata_db_prefix }}_statistics"
        },
        "history": {
            "db": "{{ config.mongo.metadata_db_prefix }}_history"
        },
        "future_backends": {
            "db": "{{ config.mongo.metadata_db_prefix }}_future_backends"
        },
        "resources": {
            "db": "{{ config.mongo.metadata_db_prefix }}_resources"
        },
        "downtimes": {
            "db": "{{ config.mongo.metadata_db_prefix }}_downtimes"
        },
        "minions": {
            "db": "{{ config.mongo.metadata_db_prefix }}_minions"
        },
        "scheduler": {
            "db": "{{ config.mongo.metadata_db_prefix }}_scheduler"
        }
    },
    "jobs": {
        "enabled": false
    },
    "sync": {
        "class": "sync.kazoo_impl.ZkSyncManager",
        "host": "{{ config.zk.hosts }}",
        "lock_path_prefix": "{{ config.zk.lock_path_prefix }}",
        "timeout": {{ config.zk.timeout }}
    },
    "inventory_cache": {
        "hostname": {
            "cache_update_period": 600,
            "key_valid_time": 21600,
            "key_retry_time": 600,
            "path": "/var/tmp/mastermind.hostname.cache"
        },
        "hosttree": {
            "cache_update_period": 600,
            "key_valid_time": 21600,
            "key_retry_time": 600,
            "path": "/var/tmp/mastermind.hosttree.cache"
        },
        "ip_addresses": {
            "cache_update_period": 600,
            "key_valid_time": 1200,
            "key_retry_time": 600,
            "path": "/var/tmp/mastermind.ip_addresses.cache"
        }
    },
    "downtimes": {
        "downtimes_monitor_enabled": true
    },

    "storage": {
        "update_max_groups_count": false
    },
    "statistics": {
        "write_attempts": 3,
        "namespace_statistics": {
            "enabled": true,
            "collect_period": 300,
            "max_data_points": 500,
            "record_ttl": 31536000
        },
        "namespace_spacestamp": {
            "enabled": true,
            "lock": "namespace_spacestamp",
            "collect_period": 900,
            "dump_period": 3600,
            "record_ttl": 31536000
        },
        "namespace_removedspacestamp": {
            "enabled": true,
            "lock": "namespace_removedspacestamp",
            "collect_period": 900,
            "dump_period": 3600,
            "record_ttl": 31536000
        }
    },

    "prediction": {
        "update_period": 10800
    },

    "provide_storage_state_snapshot": true,
    "weight": {
        "calculated": true,
        "weight_manager_num_threads": 8,
        "resource_unit_disk_util": 0.05,
        "resource_unit_disk_write_rate": 5242880,
        "add_resource_units_relative": 0.15,
        "add_resource_units_absolute": 0.20,
        {% if config.env in prod -%}
        "min_units": 1,
        "add_units": 2,
        "net": {
            "write_rate_threshold_percentage": 0.5,
            "read_rate_threshold_percentage": 0.9,
            "max_read_rate_percentage": 0.95
        },
        "disk": {
            "disk_util_threshold": 0.4
        },
        "limits": {
            "fs": 700000,
            "host": 10000000,
            "weak_net_host": 1000000,
            "defragged_couple": {
                "namespaces": {
                    "disk": 0
                }
            },
            "host_per_gbit": 1000000,
            "enable_host_weight_limit_per_gbit": true
        },
        "dc_weight_coefficients": {
            "iva": 1.0,
            "sas": 1.0,
            "myt": 1.0,
            "vla": 1.0,
            "man": 1.0
        },
        "multiple_replication_factors_write": {
            "read_load_limits": {"2": 3.0},
            "namespaces_settings": [
                {
                    "ns": "mail",
                    "enable": true,
                    "x2_write_coef": 0.5
                },
                {
                    "ns": "avatars-disk",
                    "enable": true,
                    "x2_write_coef": 0.5
                }
            ]
        }
        {%- else -%}
        "min_units": 1,
        "add_units": 1,
        "net": {
            "write_rate_threshold_percentage": 0.5,
            "read_rate_threshold_percentage": 0.5
        },
        "disk": {
            "disk_util_threshold": 0.4
        },
        "limits": {
            "defragged_couple": {
                "default": 1
            }
        },
        "multiple_replication_factors_write": {
            "read_load_limits": {"2": 1.0},
            "namespaces_settings": [
                {
                    "ns": "avatars-MDSTODO-61-weights-improvements",
                    "enable": true,
                    "x2_write_coef": 1.0
                },
                {
                    "ns": "curiosity-karl-only",
                    "enable": true,
                    "x2_write_coef": 1.0
                }
            ]
        }
        {%- endif %}
    },

    "federation": {
        "fallback_federation_id": {{ config.federation }},
        "allowed_to_set_host_federations": {{ config.inventory.allowed_to_set_host_federations | json }}
    },

    "cache": {
        "group_path_prefix": "/srv/storage/cache/"
    },
    "collector": {
        "app_log":  "/var/log/mastermind/mastermind-collector.log",
        "app_log_mask": 1,
        "mongo_driver_version": {{ config.collector.mongo_driver_version }},
        "forbidden_dht_groups": true,
        "forbidden_unmatched_group_total_space": true,
        "forbidden_ns_without_settings": true,
        "forbidden_dc_sharing_among_groups": true,
        "disown_timeout": 180,
        "heartbeat_timeout": 180,
        "node_backend_stat_stale_timeout": 600,
        "http_timeout_ms": 30000,
        "http_connect_timeout_ms": 5000,
        "json_buffer": 419430400,
        "fb_buffer": 805306368,
        "inventory_app_name": "mastermind2.26-inventory",
        "inventory_worker_timeout": 24,
        "inventory": {
            "grpc_port": 50051,
            "timeout_ms": 60000,
            "retry_num": 3
        },
        "parallel_http_downloads": 16,
        "infrastructure_dc_cache_update_period": 1500,
        "max_storage_age": 900,
        "nodes_reload_period": 5,
        "lost_couple_support": {{ config.collector.lost_couple_support|lower }},

        "elliptics": {
            "dnet_log": "/var/log/mastermind/elliptics-collector.log",
            "access_log": "/var/log/mastermind/access-collector.log",
            "dnet_log_mask": 4,
            "nodes": [
                {%- for host in config.elliptics.nodes %}
                ["{{ host }}", 1025, 10]{{ "," if not loop.last else "" }}
                {%- endfor %}
            ],
            "wait_timeout": {{ config.elliptics.wait_timeout }},
            "net_thread_num": 32,
            "io_thread_num": 32,
            "nonblocking_io_thread_num": 32,
            "tls_support" : 1,
            "tls_cert_path": "/etc/elliptics/ssl/storage.crt",
            "tls_key_path": "/etc/elliptics/ssl/storage.key",
            "tls_ca_path": "/etc/elliptics/ssl/"
        },
        "reserved_space": 75161927680,
        "metadata": {
            "url": "{{ config.mongo.mdb_url_template.format(user=config.mongo.mdb_user_ro, password=config.mongo.mdb_password) }}{{ config.collector.mongo_tls }}&readPreference=primaryPreferred",
            "cert_path": "/usr/share/yandex-internal-root-ca/YandexInternalRootCA.crt",
            "options": {
                "connectTimeoutMS": 3000
            },
            "history": {
                "db": "{{ config.mongo.metadata_db_prefix }}_history"
            },
            "inventory": {
                "db": "{{ config.mongo.metadata_db_prefix }}_inventory"
            },
            "jobs": {
                "db": "{{ config.mongo.metadata_db_prefix }}_jobs"
            },
            "couples": {
                "db": "{{ config.mongo.metadata_db_prefix }}_couples"
            },
            "namespaces": {
                "db": "{{ config.mongo.metadata_db_prefix }}_namespaces"
            },
            "downtimes": {
                "db": "{{ config.mongo.metadata_db_prefix }}_downtimes"
            }
        },
        "karl": {
            "timeout_ms": 30000,
            "endpoints": [
                "{{ config.karl.url }}"
            ],
            "tls_support" : true,
            "tls_cert_path": "/etc/karl/ssl/karl.crt",
            "tls_key_path": "/etc/karl/ssl/karl.key",
            "tls_ca_paths": ["/etc/karl/ssl/ca.crt"]
        },
        "jobs": {
            "couple_defrag_job": {
                "reserved_space_coefficient": 1.0,
                "use_compact_defrag_method": {
                    "enable_for_all_namespaces": true,
                    "namespaces": []
                }
            }
        },
        "handystats": {
            "enable": true,
            "dump-interval": 500,
            "defaults": {
                "moving-interval": 60000,
                "tags": [],
                "rate-unit": "s"
            },
            "gauge": {
                "tags": ["histogram"]
            },
            "counter": {
                "tags": ["value"]
            },
            "timer": {
                "idle-timeout": 60000,
                "tags": ["moving-avg"]
            },
            "io.replies": {
                "tags": ["rate"]
            },
            "io.{input,output}.queue.size": {
                "tags": ["moving-avg"]
            },
            "pool.sys.*.active_threads": {
                "tags": ["moving-avg"]
            },
            "pool.sys.*.queue.size": {
                "tags": ["moving-avg"]
            },
            "*.warm_up.time": {
                "tags": ["value"]
            },
            "*.snapshot_age_sec": {
                "tags": ["value"]
            }
        },
        "nscfg": {
            "enable": true,
            "url": "{{ config.nscfg.url }}/all?include_drafts=1",
            "timeout_ms": 10000
        },
        "fallback_federation_id": {{ config.federation }},

        "node_stats" : {
            "use_grpc": {{ config.collector.node_stats.use_grpc|lower }},
            "grpc_port": {{ config.collector.node_stats.grpc_port }},
            "tls_support": {{ config.collector.node_stats.tls_support|lower }},
            "timeout_ms": 30000,
            "thread_num": 8,
            "tls_cert_path": "/etc/elliptics/ssl/storage.crt",
            "tls_key_path": "/etc/elliptics/ssl/storage.key",
            "tls_ca_paths": ["/etc/elliptics/ssl/RootStorageCA.crt"]
        },

        "groups_meta" : {
            "use_grpc": {{ config.collector.groups_meta.use_grpc|lower }},
            "grpc_port": 7819,
            "tls_support": true,
            "timeout_ms": 30000,
            "thread_num": 8,
            "tls_cert_path": "/etc/elliptics/ssl/storage.crt",
            "tls_key_path": "/etc/elliptics/ssl/storage.key",
            "tls_ca_paths": ["/etc/elliptics/ssl/RootStorageCA.crt"]
        }
    },

    "external_api": {
        "port": 6785,
        "convert_space": {
            "s3_abc_to_ns_mapping": {
                "2":    {"namespace": "s3-default"},
                "318":  {"namespace": "s3-default"},
                "407":  {"namespace": "s3-default"},
                "2173": {"namespace": "s3-default"},
                "3463": {"namespace": "s3-default"},
                "5909": {"namespace": "s3-default"},
                "1558": {"namespace": "s3-default-smart"},
                "1358": {"namespace": "s3-default-smart"},
                "94":   {"namespace": "s3-default-cold"},
                "102":  {"namespace": "s3-default-cold"},
                "105":  {"namespace": "s3-ringbuffer"},
                "675":  {"namespace": "s3-ringbuffer"},
                "188":  {"namespace": "s3-default-cold"},
                "315":  {"namespace": "s3-default-cold"},
                "469":  {"namespace": "s3-ringbuffer"},
                "622":  {"namespace": "s3-default-cold"},
                "700":  {"namespace": "s3-ringbuffer"},
                "737":  {"namespace": "s3-default-cold"},
                "741":  {"namespace": "s3-default-cold"},
                "961":  {"namespace": "s3-default-cold"},
                "969":  {"namespace": "s3-default-cold"},
                "1068": {"namespace": "s3-default-cold"},
                "1170": {"namespace": "s3-default-cold"},
                "1265": {"namespace": "s3-default-cold"},
                "1332": {"namespace": "s3-default-cold"},
                "1334": {"namespace": "s3-default-cold"},
                "1373": {"namespace": "s3-default-cold"},
                "2660": {"namespace": "s3-default-cold"},
                "1487": {"namespace": "s3-default-cold"},
                "1488": {"namespace": "s3-ringbuffer"},
                "1666": {"namespace": "s3-default-cold"},
                "1891": {"namespace": "s3-default-cold"},
                "1949": {"namespace": "s3-default-cold"},
                "1971": {"namespace": "s3-satellite-factory"},
                "2026": {"namespace": "s3-default-cold"},
                "2541": {"namespace": "s3-ringbuffer"},
                "3940": {"namespace": "s3-default-cold"},
                "5807": {"namespace": "s3-default-cold"},
                "1984": {"namespace": "s3-panoramas"},
                "1986": {"namespace": "s3-panoramas-backoffice"},
                "4090": {"namespace": "s3-panoramas-backoffice"},
                "4947": {"namespace": "s3-panoramas-backoffice"},
                "4948": {"namespace": "s3-panoramas-backoffice"},
                "4949": {"namespace": "s3-panoramas-backoffice"},
                "5134": {"namespace": "s3-panoramas-backoffice"},
                "5135": {"namespace": "s3-panoramas-backoffice"},
                "7727": {"namespace": "s3-panoramas-backoffice"},
                "7728": {"namespace": "s3-panoramas-backoffice"},
                "7729": {"namespace": "s3-panoramas-backoffice"},
                "7730": {"namespace": "s3-panoramas-backoffice"},
                "7731": {"namespace": "s3-panoramas-backoffice"},
                "7732": {"namespace": "s3-panoramas-backoffice"},
                "7733": {"namespace": "s3-panoramas-backoffice"},
                "7734": {"namespace": "s3-panoramas-backoffice"}
            },
            "hardcoded": {
                "disk": 2.01,
                "mail": 1.98
            },
            "default": {
                "s3-api": 3,
                "mds": 2,
                "avatars": 4.2857142857
            },
            "hardcoded_dc_share": {
                "disk": {
                    "sas": 0.67,
                    "vla": 0.67,
                    "man": 0.67
                },
                "mail": {
                    "sas": 0.66,
                    "vla": 0.66,
                    "man": 0.66
                },
                "s3-yc": {
                    "sas": 1,
                    "vla": 1,
                    "myt": 1
                }
            },
            "default_dc_share": {
                "s3-api": {
                    "sas": 1,
                    "vla": 1,
                    "man": 1
                },
                "mds": {
                    "sas": 0.6666666667,
                    "vla": 0.6666666667,
                    "man": 0.6666666667
                },
                "avatars": {
                    "sas": 1.4285714285,
                    "vla": 1.4285714285,
                    "man": 1.4285714285
                }
            }
        }
    },

    "logging": {
        "loggers": {
            "mm.state_builder.weights": {
                "level": "INFO"
            }
        }
    },

    "nscfg_server": {
        "use": true,
        "url": "{{ config.nscfg.url }}"
    }
}
