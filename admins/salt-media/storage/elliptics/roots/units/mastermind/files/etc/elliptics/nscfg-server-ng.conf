{%- set env =  grains['yandex-environment'] -%}
{%- set prod =  ['prestable', 'production'] -%}
{%- if env in prod -%}
{%- set mongo_password = pillar['yav']['nscfg-mongo_password'] -%}
{%- set mongo_url = 'mongodb://nscfg-ng:{mongo_password}@vla-0oq7ns487qhlgen4.db.yandex.net:27018,sas-1as4yyt3xn2td9l0.db.yandex.net:27018,vla-8eygzoacj54e1lg0.db.yandex.net:27018/?replicaSet=rs01&authSource=mastermind_namespaces' -%}
{%- set zookeeper_url = 'zk01vla.mds.yandex.net:2181,zk01myt.mds.yandex.net:2181,zk01sas.mds.yandex.net:2181' -%}
{%- set metadata_db_prefix = 'mastermind' -%}
{%- set internal_auth_token = pillar['yav']['nscfg-internal_auth_token'] -%}
{%- else -%}
{%- set mongo_password = pillar['yav']['nscfg-testing_mongo_password'] -%}
{%- set mongo_url = 'mongodb://nscfg-ng:{mongo_password}@vla-yb2ipalyrt1tot3o.db.yandex.net:27018,sas-uvrctumr87ldflov.db.yandex.net:27018,vla-y8tst5zlv5qtte3m.db.yandex.net:27018/?replicaSet=rs01&authSource=mastermind_test_namespaces' -%}
{%- set zookeeper_url = 'zk01man.mdst.yandex.net:2181,zk01myt.mdst.yandex.net:2181,zk01sas.mdst.yandex.net:2181' -%}
{%- set metadata_db_prefix = 'mastermind_test' -%}
{%- set internal_auth_token = pillar['yav']['nscfg-testing_internal_auth_token'] -%}
{%- endif -%}
{%- set tvm_client_id = 2023326 -%}
{%- set tvm_secret = pillar['yav']['nscfg-tvm_secret'] -%}
{%- set allowed_tvm_ids = '[2023362]' -%}
{%- set admins = '["aikch", "jonny-k", "izhidkov", "arstotzkan", "kanst9", "kdmitriy", "hotosho", "shindo", "agodin", "mishik", "aleks5d"]' -%}
{
    "metadata": {
        "url": "{{ mongo_url.format(mongo_password=mongo_password) }}",
        "options": {
            "maxPoolSize": 100,
            "socketTimeoutMS": 10000,
            "connectTimeoutMS": 10000,
            "w": 2,
            "wtimeout": 10000
        },
        "namespaces": {
            "db": "{{ metadata_db_prefix}}_namespaces",
            "settings_collection": "nscfg_ng_settings",
            "meta_collection": "nscfg_ng_meta",
            "orders_collection": "nscfg_ng_orders"
        }
    },
    "zookeeper": {
        "hosts": "{{ zookeeper_url }}",
        "lock_path_prefix": "/nscfg/locks/",
        "options": {
            "timeout": 3,
            "command_retry": {
                "max_tries": 10,
                "max_jitter": 0.0,
                "delay": 0.2,
                "backoff": 1
            }
        },
        "lock_acquire_timeout": 3
    },
    "unix_socket": "/var/run/nscfg-ng.sock",
    "unix_socket_permissions": "666",
    "settings_schema_path": "/etc/nscfg/settings_schema.json",
    "ui_schema_path": "/etc/nscfg/ui_schema.json",
    "mds_doc_path": "/etc/nscfg/mds_doc.yml",
    "avatars_doc_path": "/etc/nscfg/avatars_doc.yml",
    "auth": {
        "tvm": {
            "enable": true,
            "self_id": {{ tvm_client_id }},
            "secret": "{{ tvm_secret }}",
            "abc_api_id": 2012190,
            "allowed_users_ids": {{ allowed_tvm_ids }}
        },
        "internal_auth": {
            "enable": true,
            "token": "{{ internal_auth_token }}",
            "allowed_ips": ["::1", "0.0.0.0"]
        },
        "admins": {{ admins }},
        "required_user_abc_roles_codes": ["mds_manager"]
    },
    "yav": {
        "environment": "production",
        "oauth_token": "{{ pillar['yav']['nscfg-robot-yav-oauth'] }}",
        "cache_path": "/var/cache/nscfg-server-ng/yav_cache",
        "secret_roles": [
            {"role": "OWNER", "abc_id": 32013, "abc_scope": "secrets_management"}
        ]
    },
    "ns_info_links_html_markup": "<a class=\"link link_theme_normal\" href=\"{link_template}\">{link_text}</a>",
    "ns_info_links":[
        {
            "description": "Dispencer link",
            "link_template": "https://dispenser.yandex-team.ru/db/projects/{abc_slug}",
            "link_text": "dispenser"
        },
        {
            "description": "Version in testing",
            "link_template": "https://yasm.yandex-team.ru/template/panel/avatars_mds/dashboard=nscfg;ns={ns_name};ctype=testing/",
            "link_text": "version graph for testing"
        },
        {
            "description": "Version in prestable",
            "link_template": "https://yasm.yandex-team.ru/template/panel/avatars_mds/dashboard=nscfg;ns={ns_name};ctype=prestable/",
            "link_text": "version graph for prestable"
        },
        {
            "description": "Version in production",
            "link_template": "https://yasm.yandex-team.ru/template/panel/avatars_mds/dashboard=nscfg;ns={ns_name};ctype=production/",
            "link_text": "version graph for production"
        },
        {
            "description": "Overall dashboard for testing",
            "link_template": "https://yasm.yandex-team.ru/template/panel/avatars_mds/dashboard=short;ns={ns_name};ctype=testing/",
            "link_text": "yasm dashboard for testing"
        },
        {
            "description": "Overall dashboard for production",
            "link_template": "https://yasm.yandex-team.ru/template/panel/avatars_mds/dashboard=short;ns={ns_name};ctype=prestable,production/",
            "link_text": "yasm dashboard for production"
        },
        {
            "description": "Quota and space dashboard for testing",
            "link_template": "https://yasm.yandex-team.ru/template/panel/avatars_mds/dashboard=space;ns={ns_name};ctype=testing/",
            "link_text": "space dashboard for testing"
        },
        {
            "description": "Quota and space dashboard for production",
            "link_template": "https://yasm.yandex-team.ru/template/panel/avatars_mds/dashboard=space;ns={ns_name};ctype=prestable,production/",
            "link_text": "space dashboard for production"
        },
        {
            "description": "Access logs in CHV for testing",
            "link_template": "https://avatars-test.chv.yandex-team.ru/projects/{ns_name}",
            "link_text": "chv testing"
        },
        {
            "description": "Access logs in CHV for production",
            "link_template": "https://avatars.chv.yandex-team.ru/projects/{ns_name}",
            "link_text": "chv production"
        },
        {
            "description": "Documentation",
            "link_template": "https://wiki.yandex-team.ru/mds/avatars",
            "link_text": "wiki"
        },
        {
            "description": "Support chat",
            "link_template": "https://t.me/joinchat/Bbsak0DREDckUOGhK-m3aw",
            "link_text": "telegram"
        },
        {
            "description": "Emergency chat",
            "link_template": "https://t.me/joinchat/Lz2_8w1qRw7-PDRGLP3b3w",
            "link_text": "telegram"
        }
    ],
    "logging": {
        "version": 1,
        "disable_existing_loggers": false,
        "formatters": {
            "accesslog": {
                "format": "[%(asctime)s.%(msecs)03d] %(trace_id)s %(levelname)s %(remote_addr)s \"%(message)s\" %(status)s %(elapsed_time).3f",
                "datefmt": "%Y-%m-%d %H:%M:%S",
                "converter": "time.gtime"
            },
            "default": {
                "format": "[%(asctime)s.%(msecs)03d] %(levelname)s %(name)s: %(message)s",
                "datefmt": "%Y-%m-%d %H:%M:%S",
                "converter": "time.gtime"
            },
            "requests": {
                "format": "[%(asctime)s.%(msecs)03d] %(levelname)s %(name)s:%(trace_id)s: %(message)s",
                "datefmt": "%Y-%m-%d %H:%M:%S",
                "converter": "time.gtime"
            }
        },
        "handlers": {
            "accesslog_file": {
                "class": "logging.handlers.WatchedFileHandler",
                "formatter": "accesslog",
                "filename": "/var/log/nscfg-server-ng/access.log"
            },
            "defaultlog_file": {
                 "class": "logging.handlers.WatchedFileHandler",
                 "formatter": "default",
                 "filename": "/var/log/nscfg-server-ng/server.log"
            },
            "nscfglog_file": {
                 "class": "logging.handlers.WatchedFileHandler",
                 "formatter": "requests",
                 "filename": "/var/log/nscfg-server-ng/server.log"
            }
        },
        "root": {
            "level": "INFO",
            "handlers": ["defaultlog_file"]
        },
        "loggers": {
            "tornado.access": {
                "level": "INFO",
                "handlers": ["accesslog_file"],
                "propagate": false
            },
            "nscfg_server": {
                "level": "INFO",
                "handlers": ["nscfglog_file"],
                "propagate": false
            }
        }
    }
}
