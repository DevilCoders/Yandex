{%- set env = grains['yandex-environment'] -%}
map $request_uri $prj {
    default 'rbtorrent_other';
    "~/remove" "rbtorrent_remove";
    "~/(announce)(_[a-z_]+)?" "rbtorrent_$1$2";
    "~/(skybone)(_[a-z_]+)?" "rbtorrent_$1$2";
    "~/(s3|mds)_to_torrent/.+" "rbtorrent_announce_$1";
}

upstream rbtorrent_local {
    server {{upstream_local}};
}

upstream rbtorrent {
{% if env == 'production' %}{% for s in upstream %}    server {{s}};
{% endfor %}{% else %}    server {{upstream_local}};{% endif %}
}

proxy_cache_path /var/cache/nginx/rbtorrent levels=1:2 keys_zone=rbtorrent:10m max_size=300M;

server {
    listen 80;
    listen [::]:80;
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name {{ server_name }};

    ssl_certificate     /etc/yandex-certs/{{server_name}}.pem;
    ssl_certificate_key /etc/yandex-certs/{{server_name}}.key;
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers kEECDH+AESGCM+AES128:kEECDH+AES128:kRSA+AESGCM+AES128:kRSA+AES128:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2;
    ssl_session_cache    shared:RBTORRENT_SSL_CACHE:10m;
    ssl_session_timeout  1h;

    client_max_body_size 32m;

    request_id_from_header on;
    request_id_header_name X-Request-Id;
    request_id_length 16;

    location /favicon.ico {return 200;}

    location / {
        proxy_pass http://rbtorrent;
        proxy_set_header X-Request-Id    $request_id;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_cache			rbtorrent;
        proxy_cache_key			$uri$args;
        proxy_cache_valid		200 1s;
        proxy_cache_methods		GET;
        proxy_cache_lock		on;
        proxy_cache_lock_age		1200s;
        proxy_cache_lock_timeout	1200s;
        proxy_read_timeout		1200s;
        log_by_lua_file include/base-metrics.lua;
    }
    location /ping {
        proxy_pass http://rbtorrent_local;
        proxy_set_header X-Request-Id    $request_id;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_read_timeout 1s;
    }
    location ~ ^/(skybone_add_resource|skybone_remove_resource) {
        proxy_pass http://rbtorrent_local;
        proxy_set_header X-Request-Id    $request_id;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_read_timeout              1200s;
        log_by_lua_file include/base-metrics.lua;
    }
}
