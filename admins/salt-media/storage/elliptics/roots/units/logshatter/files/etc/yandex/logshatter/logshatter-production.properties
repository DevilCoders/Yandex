{% set dc = grains['conductor']['root_datacenter'] -%}
{% set zookeeper = pillar.get('logshatter_zookeper') -%}
{% set mongo = pillar.get('logshatter_mongo') -%}
{% set max_partitions = pillar.get('logshatter_max_partitions', 100)|int -%}
{% set read_threads = pillar.get('logshatter_read_threads', 42)|int -%}
{% set parse_threads = pillar.get('logshatter_parse_threads', 15)|int -%}
{% set max_output_threads = pillar.get('logshatter_max_output_threads', 8 )| int -%}

logshatter.logbroker.api.new=true
logshatter.logbroker.tvm.logbroker.client-id={{ salt.pillar.get('logshatter:tvm:client_ids:logbroker') }}
logshatter.logbroker.tvm.logshatter.client-id={{ salt.pillar.get('logshatter:tvm:client_ids:logshatter') }}
logshatter.logbroker.tvm.logshatter.secret={{ salt.pillar.get('logshatter:tvm:secret') }}

logshatter.default-source=

logshatter.clickhouse.user={{ salt.pillar.get('logshatter:clickhouse:user') }}
logshatter.clickhouse.passwd={{ salt.pillar.get('logshatter:clickhouse:password') }}
logshatter.clickhouse.db=cocaine_logs
logshatter.clickhouse.native-format=true
#logshatter.clickhouse.native-format=false

logshatter.queue-size.mb=32768

logshatter.output.batch-size=1000000
logshatter.output.min-thread-count=1
logshatter.output.max-thread-count={{ max_output_threads }}

#ClickHouse
#logshatter.clickhouse.host=clickhouse01h.ape.yandex.net,clickhouse02h.ape.yandex.net,clickhouse03h.ape.yandex.net,clickhouse04h.ape.yandex.net,clickhouse05h.ape.yandex.net
logshatter.clickhouse.slbHost=clickhouse.ape.yandex.net
logshatter.clickhouse.host=clickhouse.ape.yandex.net
logshatter.clickhouse.cluster=cocaine_logs
logshatter.clickhouse.replicated=true
logshatter.http_properties.clickhouse-compress=true

#Logbroker
logshatter.logbroker.client=cocaine-logshatter
logshatter.logbroker.host=http://logbroker.yandex.net:8999/
logshatter.logbroker.dataCenters=iva,sas,vla,vlx,kafka-bs
logshatter.logbroker.api.cluster-to-host=iva=iva.logbroker.yandex.net,sas=sas.logbroker.yandex.net,vla=vla.logbroker.yandex.net,vlx=vlx.logbroker.yandex.net,kafka-bs=lbkx.logbroker.yandex.net

logshatter.logbroker.read-threads={{ read_threads}}
logshatter.parse.thread-count={{ parse_threads }}
logshatter.logbroker.max-acquired-partitions={{ max_partitions }}

#logshatter.zookeeper.quorum=logshatter01h.ape.yandex.net:2181,logshatter02h.ape.yandex.net:2181,logshatter03h.ape.yandex.net:2181,logshatter04h.ape.yandex.net:2181
logshatter.zookeeper.quorum={{ zookeeper | join(',') }}

logshatter.mongo.main-url=mongodb://{{ mongo | join(',') }}
logshatter.mongo.health-url=mongodb://{{ mongo | join(',') }}
logshatter.mongo.configs-url=mongodb://{{ mongo | join(',') }}
logshatter.mongo.configs-db=logshatter

log.dir=/var/log/logshatter
environmentJvmArgs=-Xmx96g -Xms96g
logshatter.data-rotation.delete-obsolete-partitions-automatically=true

logshatter.output.min-line-count-to-output-immediately=${logshatter.output.batch-size}
logshatter.output.min-data-age-seconds-to-output-immediately=30
