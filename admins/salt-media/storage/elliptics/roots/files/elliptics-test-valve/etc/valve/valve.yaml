{% set zk_flock_hosts = salt['conductor']['groups2hosts']('ape-zk-discovery')  | map('regex_replace', '$', ':2181') %}
logging:
  level: info
  sinks:
    - "logrotate:///var/log/valve/valve.log"

zk: &zk
  prefix: /valve-tst/run
  hosts: {{ zk_flock_hosts | list }}

discovery:
  zk: *zk
  weight: {{salt['cmd.shell']('weight.sh')}}

election:
  zk: *zk

tls: &tls
  key_path: /etc/nginx/ssl/key.valve.yandex.net.pem
  cert_path: /etc/nginx/ssl/cert.valve.yandex.net.pem

server:
  grpc:
    addr: ":7735"
    tls: *tls
  http:
    addr: ":7736"

worker:
  mode: dry-run-packfw
  timeout: 30m
  hbf_url: "http://iva-test-hbf1.yndx.net"
  hbf_max_retries: 3
  hbf_timeout: 33s
  job_batch_size: 2000
  topka:
    url: https://packfw.tst.net.yandex-team.ru
    oauth: {{ pillar['valve_oauth']['valve_oauth'] }}
  racktables:
    url: https://racktables.yandex-team.ru
  filter:
    type: all
    filters:
      - type: regex
        expr: ^.*storage.*$
      - type: probability
        probability: 0.9
  fw_types: ["hbf", "slb"]

storage:
  mode: ro
  pg_conn_string: "
  host=c-mdbl13ive2okbaqcjkpd.rw.db.yandex.net port=6432
  dbname=valve
  user=valve
  password={{ pillar['valve_pg']['valve_pg'] }}
  sslmode=verify-full
"
monitoring:
  port: 14080
  authorization:
    type: basic
    passwords:
      {{ pillar['valve_password']['test'] }}

