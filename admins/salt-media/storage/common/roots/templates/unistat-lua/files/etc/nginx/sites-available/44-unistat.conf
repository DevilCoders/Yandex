lua_shared_dict numeric_metrics 16M;
lua_shared_dict histogram_names 16M;
lua_shared_dict histogram_values 16M;

lua_shared_dict ext_numeric_metrics 16M;
lua_shared_dict ext_histogram_names 16M;
lua_shared_dict ext_histogram_values 16M;

lua_shared_dict namespaces 1M;
lua_shared_dict s3buckets 256M;

init_worker_by_lua_file /etc/nginx/include/worker.lua;

server {
    listen 127.0.0.1:4444;
    listen [::1]:4444;

    location = /unistat {
        content_by_lua_block {
            ngx.say(cjson.encode(get_yasm_metrics()))
            increment_metric("stat_monitor_dmmm", 1)
        }
        log_by_lua_block {
            increment_metric("stat_system_dmmm", 1)
        }
    }

    location = /s3_unistat {
        content_by_lua_block {
            ngx.say(cjson.encode(get_yasm_metrics(true)))
            increment_metric("s3mds_stat_monitor_dmmm", 1, true)
        }
        log_by_lua_block {
            increment_metric("s3mds_stat_system_dmmm", 1, true)
        }
    }


    location = /unistat_flush {
        content_by_lua_block {
            flush(true, true)

            ngx.shared.namespaces:flush_all()
            ngx.shared.s3buckets:flush_all()
        }
    }

    location = /unistat_flush_default {
        content_by_lua_block {
            flush(true, false)

            ngx.shared.namespaces:flush_all()
        }
    }
    location = /unistat_flush_ext {
        content_by_lua_block {
            flush(false, true)

            ngx.shared.s3buckets:flush_all()
        }
    }
}
