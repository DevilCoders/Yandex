{%- set cgroup = grains['conductor']['group'] -%}
{% if 'elliptics' in cgroup %}
{% set porto_concurrency = 1 %}
{% set porto_spawn_timeout_sec = 10 %}
{% else %}
{% set porto_concurrency = 5 %}
{% set porto_spawn_timeout_sec = 0 %}
{% endif %}

{
    "version": 2,
    "logger": {
        "level": "debug",
        "output": "/dev/stdout"
    },
    "endpoints": ["0.0.0.0:29042"],
    "debugserver": "127.0.0.1:8000",
    "mtn": {
        "enable": true,
        "allocbuffer": 6,
        "url": "http://ip-broker.qloud.yandex.net/api/endpoint",
        "headers": {
          "Authorization": "OAuth {{ pillar['yav']['ipbroker_oauth_token'] }}"
        }
    },
    "isolate": {
        {% if cgroup == 'elliptics-cloud' or cgroup == 'elliptics-test-cloud' or cgroup == 'elliptics-test-collector' or cgroup == 'elliptics-collector' or cgroup == 'elliptics-cloud-prestable' or cgroup == 'elliptics-collector-prestable' %}
        "process": {
            "type": "process",
            "args": {
                "spool": "/var/spool/cocaine",
                "locator": "localhost:10071"
                }
            },
        {% endif %}
        "porto": {
            "type": "porto",
            "args": {
                "concurrency": {{ porto_concurrency }},
                "spawn_timeout_sec": {{ porto_spawn_timeout_sec }},
                {% if 'elliptics' in cgroup and 'storage' in cgroup %}
                "meta_name": "cocaine",
                "meta_prop": {
                    "io_limit": "fs w: 1024000; fs r: 101024000;",
                    "io_ops_limit": "fs w: 10; fs r: 1000;",
                    "io_weight": "0.1"
                },
                {% endif %}
                "layers": "/place/cocaine-isolate-daemon",
                "cleanupenabled": true,
                "weakenabled": false,
                "setimguri": true,
                "defaultulimits": "core: unlimited unlimited",
                "journal": "/place/cocaine-isolate-daemon/portojournal.jrnl",
                "containers": "/place/cocaine-isolate-daemon",
                "registryauth": {
                    "registry.yandex.net": "OAuth {{ pillar['yav']['registry_oauth_token'] }}"
                },
                "download_helper_cmd": "/usr/local/bin/sky",
                "download_helper_fallback": true
            }
        }
    }
}

