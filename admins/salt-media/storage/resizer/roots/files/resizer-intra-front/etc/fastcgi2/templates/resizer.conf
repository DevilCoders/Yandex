<?xml version="1.0" ?>
<fastcgi xmlns:xi="http://www.w3.org/2001/XInclude">
  <ubic>
    <user>www-data</user>
    <ld_preload>/usr/lib/x86_64-linux-gnu/libjemalloc.so.1</ld_preload>
    <ulimits>
      <rlimit_nofile>65536</rlimit_nofile>
      <rlimit_core>unlimited</rlimit_core>
      <rlimit_stack>8388608</rlimit_stack>
      <rlimit_memlock>unlimited</rlimit_memlock>
    </ulimits>
    <extended_check>yes</extended_check>
    <extended_check_url>/ping</extended_check_url>
    <extended_check_port>3080</extended_check_port>
  </ubic>
  <pools>
    <!-- Это ресайзер детка, а это значит, что каждый тред занимается вычислением, очень любит CPU и лучше не мешать ему, переключением csw, ибо переключение csw при большОй нагрузке - это грех, за который приложение платит производительностью и
    временами ответов. Гораздо проще небольшому кол-ву тредов обработать нагрузку быстрее (за счет свободных CPU), чем распределить тысячи тредов по разным процам и ожидать пока эти самые треды отработают. В случае ресайзера - нельзя увеличить колл-во
    тредов больше чем 256 (лучше меньше), ибо характер нагрузки не предусматривание долгие таймауты клиента by agodin@ -->
    <pool name="main" threads="128" queue="2048"/>
    <pool name="disk" threads="128" queue="4096"/>
    <pool name="mail" threads="128" queue="2048"/>
    <pool name="genurl" threads="128" queue="512"/>
    <!-- !! do not use dedicated pool for monitoring !! -->
    <!-- <pool name="ping" threads="10" queue="10"/> -->
  </pools>
  <handlers>
    <!-- ping-alive -->
    <!-- <handler pool="ping" url="/ping-alive(/|$).*"> <component name="ping-alive"/> </handler> -->
    <handler pool="genurl" url="/genurl.*">
      <component name="resizer"/>
    </handler>
    <handler pool="disk">
      <param name="url">http://storage.mail.yandex.net.*</param>
      <component name="resizer"/>
    </handler>
    <handler pool="mail" url="/mailservice.*">
      <component name="resizer"/>
    </handler>
    <handler pool="main">
      <component name="resizer"/>
    </handler>
  </handlers>
  <components>
    <component name="resizer" type="resizer:resizer">
      <logger>daemon-logger</logger>
      <max-age>604800</max-age>
      <cache>
        <dnet>
          <log>
            <path>/var/log/elliptics/resizer-elliptics.log</path>
            <mask>error</mask>
          </log>
          <cfg-flags>12</cfg-flags>
          <timeouts>
            <wait>1</wait>
            <check>3</check>
          </timeouts>
          <base-port>1025</base-port>
          <success-copies-num>any</success-copies-num>
          <die-limit>1</die-limit>
          <groups>
            <thumbnails>1</thumbnails>
            <origs>2</origs>
          </groups>
          <xi:include href="/etc/fastcgi2/common/resizer_dnet.xml"/>
          <addresses-family>10</addresses-family>
        </dnet>
      </cache>
      <resizer>
        <curl-max-redirects-count>5</curl-max-redirects-count>
        <old-sign-method>no</old-sign-method>
        <remote-image-timeout>5</remote-image-timeout>
        <expare-time>604800</expare-time>
        <cache-file-max-size>262144</cache-file-max-size>
        <xi:include href="/etc/fastcgi2/secrets/main.secret.xml"/>
        <watermarks>
          <watermark name="disk" gravity="north-west">/var/lib/yandex/resizer/disk_facebook.png</watermark>
          <watermark name="disk-center" gravity="center">/var/lib/yandex/resizer/disk_facebook.png</watermark>
        </watermarks>
        <clear-args-params>
          <host hostname="storage.mail.yandex.net">
            <arg>sign</arg>
            <arg>ts</arg>
          </host>
          <host hostname="storage.stm.yandex.net">
            <arg>sign</arg>
            <arg>ts</arg>
          </host>
        </clear-args-params>
        <curl-connect-timeout>5000</curl-connect-timeout>
        <use-cache-for-origs>yes</use-cache-for-origs>
        <!--<zora-host>zora.yandex.net</zora-host>-->
        <zora-port>8166</zora-port>
        <zora-bypass-list>
          <use>yes</use>
          <bypass-list-filename>/var/tmp/zora_bypass.json</bypass-list-filename>
          <bypass-list-url>http://storage.mds.yandex.net:80/get-music/142642/zora_bypass.json</bypass-list-url>
          <update-period>300</update-period>
        </zora-bypass-list>
      </resizer>
      <blacklist>
        <local-cache-filename>/var/tmp/blacklist.json</local-cache-filename>
        <!--<remote-cache-url>http://storage.mds.yandex.net:80/get-music/33123/blacklist.json</remote-cache-url>-->
        <update-period>300</update-period>
      </blacklist>
    </component>
    <component name="daemon-logger" type="logger:logger">
      <request-specific-ident>on</request-specific-ident>
      <level>INFO</level>
      <control-uri>/log</control-uri>
      <ident>fastcgi-resizer</ident>
    </component>
  </components>
  <modules>
    <module name="resizer" path="/usr/lib/fastcgi/fastcgi-resizer.so"/>
    <module name="logger" path="/usr/lib/fastcgi2/fastcgi2-syslog.so"/>
  </modules>
  <daemon>
    <logger component="daemon-logger"/>
    <endpoint>
      <backlog>1024</backlog>
      <socket>/var/run/fastcgi2/resizer.sock</socket>
      <threads>256</threads>
    </endpoint>
    <pidfile>/var/run/fastcgi2/resizer.pid</pidfile>
    <monitor_port>20012</monitor_port>
  </daemon>
</fastcgi>
