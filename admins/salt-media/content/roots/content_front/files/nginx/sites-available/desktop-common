client_max_body_size 15M;
proxy_read_timeout 3900ms;
proxy_connect_timeout 500ms;
large_client_header_buffers 4 16k;

include sites-available/ping;
include sites-available/desktop-proxy-export;

include sites-available/aab-proxy;

include sites-available/desktop-block;

# see https://st.yandex-team.ru/TVFRONT-737
rewrite ^/bower_components/romochka/blocks-common/i-social/closer/i-social__closer.html /blocks-common/i-social/closer/i-social__closer.html permanent;
location /blocks-common/i-social/closer/i-social__closer.html {
    root $root;
}

# https://st.yandex-team.ru/TVFRONT-73
location = /robots.txt {
    rewrite ^/.* /robots/robots.$tld.txt last;
}

location /robots/ {
    root $root;
}

# TVFRONT-6648: Sitemap set upstream path(defined in pillar/tv/front.sls)
set $proxy_sitemap_path {{pillar['front']['sitemap_path']}};

location = /sitemap.xml {
    # clear X-Upstream-Host to prevent proxy-pass to wrong location
    proxy_set_header X-Upstream-Host "";
    proxy_pass $proxy_sitemap_path/sitemap.desktop.$tld.xml;
}

location ~* ^/sitemap\. {
    # clear X-Upstream-Host to prevent proxy-pass to wrong location
    proxy_set_header X-Upstream-Host "";
    proxy_pass $proxy_sitemap_path$request_uri;
}

# https://st.yandex-team.ru/TVFRONT-157
location /google8a673bafbd7cf210.html {
    root $root;
}

# https://st.yandex-team.ru/TVFRONT-735
rewrite ^/(\d+/)?channels/?$ https://$host permanent;
rewrite ^/(\d+/)?recommendation/?$ https://$host permanent;

# https://st.yandex-team.ru/TVFRONT-1985
rewrite ^/(\d+/)?tune/?$ https://$host permanent;
rewrite ^/(\d+/)?providers/?$ https://$host permanent;

location /tv-message-fast/  {
    proxy_pass http://avatars-fast.yandex.net/;
}

location /tv-message-mds/  {
    proxy_pass https://avatars.mds.yandex.net/get-direct/;
}

# 404 https://wiki.yandex-team.ru/morda/404
location @404portal {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Yandex-NotFound-Project "tv";
    proxy_pass http://any.yandex.ru;
}

error_page 404 @404portal;

location @500portal {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-YandexError-Project "tv";
    proxy_pass http://any.yandex.ru;
}

error_page 500 501 502 503 504 = @500portal;

rewrite ^/(.*)/$ https://$host/$1 permanent;

# all old desktop urls
location /ajax {
    include sites-available/aab-proxy-check;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Request-Id $request_id;
    proxy_set_header Host $http_host;
    proxy_set_header X-NginX-Proxy true;

    proxy_pass http://unix:/tmp/$socket_name.socket:$request_uri;

    proxy_intercept_errors on;
    proxy_redirect off;

    #add_header Strict-Transport-Security "max-age=31536000";
}

location /ajax/i-tv-region {
    return 404;
}

include sites-available/desktop-proxy-qloud;
