# redirect from www.* to *
# https://st.yandex-team.ru/EXTV-4106
# https://st.yandex-team.ru/TVFRONT-1919

# Тестирование: echo 'www.m.beta.tv.yandex.ru' | perl -ne 'print "1 $1\n2 $2\n3 $3\n4 $4\n" if /REGEXP/'
# Ex.: echo 'www.m.ixax.dev1.tv.yandex.ru' | perl -ne 'print "sub: $+{sub}\ntld: $+{tld}\npathname: $1\n" if /^www\.(?<sub>m\.(?<user>\w+)\.dev[\d]+\.tv)\.yandex\.(?<tld>ru|ua|by|kz|com|com\.tr)$/'

server {
    include listen;

    server_name ~^www\.(?<sub>m\.tv)\.yandex\.(?<tld>ru|ua|by|kz|com|com\.tr|uz)$; # production
    server_name ~^www\.(?<sub>m\.(?:beta|testing|load)\.tv)\.yandex\.(?<tld>ru|ua|by|kz|com|com\.tr|uz)$; # testing | beta | load
    server_name ~^www\.(?<sub>m\.(?<user>\w+)\.dev[\d]+\.tv)\.yandex\.(?<tld>ru|ua|by|kz|com|com\.tr|uz)$; # dev
    server_name ~^www\.(?<sub>m\.(?<branch>.+)\.unstable\.tv)\.yandex\.(ru|ua|by|kz|com|com\.tr|uz)$; # unstable

#    include sites-available/touch-ssl_certificate;

    rewrite ^/(.*) https://$sub.yandex.$tld/$1 permanent;
}
