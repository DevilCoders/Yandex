import os
import sys
if '.' not in sys.path:
    sys.path.append('.')
import logging
import multiprocessing

import hbf
import hbfapp.gunicorn_app
from hbfapp.gunicorn_app import *

# gunicorn options
proc_name = "hbf"

bind = ["[::]:9082", "[::]:9081"]
workers = len(os.sched_getaffinity(0)) + 3

# local options
local_settings.fast_workers_count = 3
local_settings.fast_workers_port = 9082
local_settings.loglevel = logging.INFO
local_settings.error_log_path = "/var/log/hbf/hbf-error.log"

{%- if grains['yandex-environment'] == 'prestable' %}
local_settings.statsd_tags = {"service": "prestable"}
local_settings.fwdata_rt_url = "https://firewall.yandex-team.ru/api/v1/snapshots/data?type=hbf"
local_settings.notify_topka_url = "https://firewall.yandex-team.ru/api/v1/snapshots/deploy_notify"
local_settings.auth = {}
local_settings.fw_deploy_dcname = ""
local_settings.drills_rt_url = "https://firewall.yandex-team.ru/api/v1/trainings/export"

{%- elif 'validator' in grains['conductor']['group'] and grains['yandex-environment'] == 'testing' %}
local_settings.statsd_tags = {"service": "testing"}
local_settings.fwdata_rt_url = "https://packfw.tst.net.yandex-team.ru/api/v1/snapshots/data?type=hbf"
local_settings.notify_topka_url = "https://packfw.tst.net.yandex-team.ru/api/v1/snapshots/deploy_notify"
local_settings.auth = {}
local_settings.fw_deploy_dcname = ""
local_settings.drills_rt_url = "https://packfw.tst.net.yandex-team.ru/api/v1/trainings/export"

{%- elif 'validator' in grains['conductor']['group'] and grains['yandex-environment'] == 'production' %}
local_settings.statsd_tags = {"service": "fw_validator_ins"}
local_settings.fwdata_rt_url = "https://firewall.yandex-team.ru/api/v1/snapshots/data?type=hbf&dc=validator"
local_settings.fw_deploy_dcname = ""
local_settings.drills_rt_url = ""

{%- elif grains['yandex-environment'] == 'testing' %}
local_settings.statsd_tags = {"service": "testing"}
local_settings.fwdata_rt_url = "https://packfw.tst.net.yandex-team.ru/api/v1/snapshots/data?type=hbf"
local_settings.notify_topka_url = "https://packfw.tst.net.yandex-team.ru/api/v1/snapshots/deploy_notify"
local_settings.auth = {}
local_settings.fw_deploy_dcname = ""
local_settings.drills_rt_url = "https://packfw.tst.net.yandex-team.ru/api/v1/trainings/export"

{%- else %}
local_settings.statsd_tags = {"service": "{{dc}}_ins"}
local_settings.fwdata_rt_url = "https://firewall.yandex-team.ru/api/v1/snapshots/data?type=hbf&dc={{dc}}"
local_settings.fw_deploy_dcname = "{{dc|upper}}"
local_settings.drills_rt_url = "https://firewall.yandex-team.ru/api/v1/trainings/export"
local_settings.auth = {}
local_settings.notify_topka_url = "https://firewall.yandex-team.ru/api/v1/snapshots/deploy_notify"
{%- endif %}

