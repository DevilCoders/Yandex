{%- set services = ["aggregator", "aggregator_logbroker", "aggregator_logbroker_reader", "aggregator_app",
                    "invapi", "webhooker", "syslog_result" ]  %}
storages:
  - name: metrics_storage
    plugin: fs
    config:
      directory: /var/lib/yandex/unified_agent/storage/metrics
      max_partition_size: 1500mb

routes:
{%- for service in services %}
  - input:
      id: input_{{ service }}
      plugin: metrics_pull
      config:
        format:
          from_content_type: {}
        url: http://localhost:12345/metrics/{{ service }}
        service: {{ service }}
        poll_period: 15s
        metric_name_label: sensor
        headers:
          accept: application/x-solomon-spack
      flow_control:
        inflight:
          limit: 10mb
          limit_messages: 1000
          action: drop
        new_sessions_rate_limit: 25
    channel:
      channel_ref:
        name: solomon_output
{%- endfor %}

channels:
  - name: solomon_output
    channel:
      pipe:
        - storage_ref:
            name: metrics_storage
      output:
        plugin: metrics_pull
        config:
          port: 11003
          shard: "by_service"
          read_limit_messages: 100000
