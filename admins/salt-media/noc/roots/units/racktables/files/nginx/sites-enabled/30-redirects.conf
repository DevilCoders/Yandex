# vim: set ft=nginx:

map $http_host $target_host {
	"racktables.yandex.net"    "racktables.yandex-team.ru";
	"ro.racktables.yandex.net" "ro.racktables.yandex-team.ru";
	default "ro.racktables.yandex-team.ru";
}

server
{
    listen 80;
    listen [::]:80;
	server_name racktables.yandex.net ro.racktables.yandex.net;

	location / {
		return 302 https://$target_host$request_uri;
	}
}
server {
    listen 80;
    listen [::]:80;
    server_name racktables.yandex-team.ru ro.racktables.yandex-team.ru prestable.test.racktables.yandex-team.ru ro.prestable.test.racktables.yandex-team.ru;

    location /export/slb-check.php {
        root /www/racktables;
        add_header Access-Control-Allow-Origin $cors_allowed_origin;
        add_header "Vary" "Origin";
        add_header Access-Control-Max-Age 600;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, HEAD';
        add_header X-RT-Server $hostname always;
        add_header X-RT-RW $hostname always;
        fastcgi_pass rt_fpm;
        #proxy_pass https://[2a02:6b8:b010:31::100]; # debug
    }
    location / {
        return 302 https://$http_host$request_uri;
    }
}
