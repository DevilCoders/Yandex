# vim: set ft=nginx:

# the size depends on the number of servers in upstream {}:
lua_shared_dict healthcheck 1m;
lua_socket_log_errors off;

# сокет для мониторинга
server {
    # listen unix:/var/run/nginx_status.sock;
    server_name "#";
    location = /status {
        stub_status on;
        access_log off;
    }
}
server {
    listen 80;
    listen [::]:80;
    server_name localhost;
    location /server_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        deny all;
    }

    location = /hc-status {
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        deny all;

        default_type text/plain;
        content_by_lua_block {
            local hc = require "healthcheck"
            ngx.say("Nginx Worker PID: ", ngx.worker.pid())
            ngx.print(hc.status_page())
        }
    }

    location / {
        return 444;
    }
}

