lua_shared_dict numeric_metrics 32M;
lua_shared_dict histogram_names 32M;
lua_shared_dict histogram_values 32M;

lua_shared_dict solomon_numeric_metrics 128M;
lua_shared_dict solomon_histogram_names 128M;
lua_shared_dict solomon_histogram_values 128M;

tskv_log_format suleyman-tskv-log 'request_id=$request_id args=$args http_y_service=$http_y_service range=$http_range bytes_received=$request_length bytes_sent=$bytes_sent content_length=$http_content_length request_time=$request_time';

server {
    listen [::1]:4446 reuseport;
    listen [::]:4446 ipv6only=on reuseport;

    access_log off;
    tskv_log /var/log/nginx/suleyman.log suleyman-tskv-log;

    location = /solomon {

        content_by_lua_block {
            ngx.header.content_type = 'application/json'
            ngx.say(cjson.encode(get_solomon_pure_metrics()))

            tags = {}
            tags.name = 'lua_stat'
            tags.type = 'monitor'
            increment_solomon_metric(tags, 1)

        }
        log_by_lua_block {
            tags = {}
            tags.name = 'lua_stat'
            tags.type = 'system'
            increment_solomon_metric(tags, 1)
            flush_metrics()
        }

    }

    location = /solomon_flush {
        content_by_lua_block {
            ngx.shared.numeric_metrics:flush_all()
            ngx.shared.histogram_names:flush_all()
            ngx.shared.histogram_values:flush_all()

            ngx.shared.solomon_numeric_metrics:flush_all()
            ngx.shared.solomon_histogram_names:flush_all()
            ngx.shared.solomon_histogram_values:flush_all()
        }
    }
}
