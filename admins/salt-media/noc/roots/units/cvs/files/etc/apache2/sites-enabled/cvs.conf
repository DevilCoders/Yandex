#ServerName "cvs.yandex-team.ru"
#LDAPTrustedGlobalCert CA_BASE64 "/etc/apache2/keys/cvs/cvs.yandex-team.ru.pem"

<VirtualHost *:80>
        ServerName cvs.yandex-team.ru
        ServerAlias tree.yandex.ru cvs.yandex.ru cvs-test.net.yandex.net
        UseCanonicalName Off
        Header always set X-CVS-Server: {{grains["fqdn"]}}
{% if grains['yandex-environment'] == 'testing' %}
        Redirect permanent / https://cvs-test.net.yandex.net/
{% else %}
        Redirect permanent / https://cvs.yandex-team.ru/
{% endif %}
</VirtualHost>

<VirtualHost *:443>
        ServerName cvs.yandex-team.ru
        ServerAlias tree.yandex.ru cvs.yandex.ru cvs-test.net.yandex.net
        UseCanonicalName Off

        ServerAdmin cvs-svn@yandex-team.ru

        ErrorLog "/var/log/apache2/cvs-error.log"
        LogFormat "%h %l %u %t \"%r\" %>s %b %D"
        TransferLog "/var/log/apache2/cvs-access.log" 

        CustomLog "/var/log/apache2/cvs-ssl-request.log" \
          "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"
        CustomLog "|/usr/bin/logger -p local2.info -t apache2_cvs" common

        SSLEngine on
	SSLProtocol +TLSv1 +TLSv1.1 +TLSv1.2 -SSLv3
        # slayer, 13.05.2013, disabling SSLInsecureRenegotiation
#        SSLInsecureRenegotiation off
#        SSLCompression on
{% if grains['yandex-environment'] == 'testing' %}
        SSLCertificateFile "/etc/apache2/ssl/cvs-test.net.yandex.net.pem"
        SSLCertificateKeyFile "/etc/apache2/ssl/cvs-test.net.yandex.net.key"
        SSLCertificateChainFile "/etc/apache2/ssl/cvs-test.net.yandex.net.pem"
{% else %}
        SSLCertificateFile "/etc/apache2/ssl/tree.yandex.ru.pem"
        SSLCertificateKeyFile "/etc/apache2/ssl/tree.yandex.ru.key"
        SSLCertificateChainFile "/etc/apache2/ssl/tree.yandex.ru.pem"
{% endif %}
#        SSLCACertificateFile "/etc/ssl/certs/yandexCAs.pem"

        Header always set X-CVS-Server:  {{grains["fqdn"]}}

        DocumentRoot "/var/www/cvs/data"
        ScriptAlias /cgi-bin/ "/var/www/cvs/cgi-bin/"

        <DirectoryMatch  "/*/CVS">
                Require all denied
        </DirectoryMatch>

        Alias /icons/ "/var/www/cvs/icons/"

        SuexecUserGroup cvsweb cvsweb

        <Directory "/var/www/cvs/data">
                AllowOverride None
                Options FollowSymLinks
#                Require all granted
        </Directory>
        <Directory "/var/www/cvs/">
                # Options ExecCGI Indexes FollowSymLinks
                AuthName "CVS: enter your domain password"
                AuthType Basic
                AuthLDAPURL "ldap://ldap-dev.yandex.net/dc=yandex,dc=net?uid" TLS
                AuthLDAPGroupAttribute memberUid
                AuthLDAPGroupAttributeIsDN off
                AuthBasicProvider ldap
                Require valid-user
        </Directory>

</VirtualHost>

