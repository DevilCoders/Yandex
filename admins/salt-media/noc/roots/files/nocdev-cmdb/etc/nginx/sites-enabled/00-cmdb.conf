resolver [::1];
variables_hash_max_size 2048;

upstream cmdb {
    server localhost:8088;
}

server {
    listen 80 reuseport;
    listen [::]:80 reuseport;
    listen 443 ssl reuseport;
    listen [::]:443 ssl reuseport;

    server_name {{ pillar["cmdb_domain"] }};

    ssl_certificate     /etc/nginx/ssl/{{ pillar["cmdb_domain"] }}.pem;
    ssl_certificate_key /etc/nginx/ssl/{{ pillar["cmdb_domain"] }}.key;

    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers kEECDH+AESGCM+AES128:TLS-CHACHA20-POLY1305-SHA256:kEECDH+AES128:kRSA+AESGCM+AES128:kRSA+AES128:!DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2:!SSLv3;
    ssl_session_cache    shared:SSL:64m;
    ssl_session_timeout  28h;

    add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload" always;
    add_header X-Host $hostname always;

    log_by_lua_file /etc/nginx/lua/solomon-metrics.lua;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_pass http://cmdb;
    }
}
