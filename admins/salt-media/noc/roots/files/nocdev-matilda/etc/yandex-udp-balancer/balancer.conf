{%- set fake_src = '95.108.254.95' %}
{%- set matilda_hosts = salt.conductor.groups2hosts('nocdev-matilda') %}
status_port: 8080
zk_servers:
{%- for host in salt.conductor.groups2hosts('nocdev-zk') %}
    - {{ host }}:2181
{%- endfor %}
servers:
  - port: 6343
    duplicator:
      - balancer:
          algorithm: 'rr'
          backends:
              {%- for host in matilda_hosts %}
              - addr: '{{host}}:6344'
                weight: {{ 100 if host == grains['fqdn'] else 10 }}
                fake_src_ipv4_addr: '{{fake_src}}'
                check_url: '{{host}}:8890/ping'
                resolve_only_ipv6: true
              {%- endfor %}
      - backend:
          addr: 'myt-flow1.yndx.net:6343'
          preserve_src_addr: true
          fake_src_ipv4_addr: '95.108.254.95'
          resolve_only_ipv6: true
  - port: 2055
    duplicator:
      - backend:
          addr: 'lamia.yndx.net:5001'
          preserve_src_addr: true
          fake_src_ipv4_addr: {{fake_src}}
          resolve_only_ipv6: true
      - backend:
          addr: 'mar-nflow1.yndx.net:5001'
          preserve_src_addr: true
          fake_src_ipv4_addr: {{fake_src}}
          resolve_only_ipv6: true
      - balancer:
          algorithm: 'rh'
          ipfix: true
          backends:
              {%- for host in matilda_hosts %}
              - addr: '{{host}}:2056'
                uuid: '{{host}}_2055'
                weight: {{ 100 if host == grains['fqdn'] else 10 }}
                fake_src_ipv4_addr: '{{fake_src}}'
                check_url: '{{host}}:8891/ping'
                resolve_only_ipv6: true
              {%- endfor %}
  - port: 2054
    duplicator:
      - backend:
          addr: 'lamia.yndx.net:5001'
          preserve_src_addr: true
          fake_src_ipv4_addr: '{{fake_src}}'
          resolve_only_ipv6: true
      - backend:
          addr: 'mar-nflow1.yndx.net:5001'
          preserve_src_addr: true
          fake_src_ipv4_addr: '{{fake_src}}'
          resolve_only_ipv6: true
      - balancer:
          algorithm: 'rh'
          ipfix: true
          backends:
              {%- for host in matilda_hosts %}
              - addr: '{{host}}:2056'
                uuid: '{{host}}_2054'
                weight: {{ 100 if host == grains['fqdn'] else 10 }}
                fake_src_ipv4_addr: '{{fake_src}}'
                check_url: '{{host}}:8891/ping'
                resolve_only_ipv6: true
              {%- endfor %}
  - port: 162
    duplicator:
      - backend:
          addr: 'noc-myt.yandex.net:162'
          preserve_src_addr: true
          fake_src_ipv4_addr: '{{fake_src}}'
          resolve_only_ipv6: true
      - backend:
          addr: 'noc-sas.yandex.net:162'
          preserve_src_addr: true
          fake_src_ipv4_addr: '{{fake_src}}'
          resolve_only_ipv6: true
  - port: 514
    duplicator:
      - backend:
          addr: 'noc-syslog.yandex.net:514'
          preserve_src_addr: false
          resolve_only_ipv6: true
      - backend:
          addr: 'noc-sas.yandex.net:514'
          preserve_src_addr: false
          resolve_only_ipv6: true
      - backend:
          addr: 'noc-myt.yandex.net:514'
          preserve_src_addr: false
          resolve_only_ipv6: true
