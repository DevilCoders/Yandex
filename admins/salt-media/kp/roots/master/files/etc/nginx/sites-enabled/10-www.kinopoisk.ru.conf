server {
    include listen;
    include listen_ssl;

    server_name bo.kp.yandex.net bo.tst.kp.yandex.net;

    access_log /var/log/nginx/www.kinopoisk.ru-access.log main;
    log_not_found off; # too much 404 for images =| do not log 404 in error.log

    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Client-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #proxy_set_header X-Geo-Country $geo;


    location = /images/spacer.gif { empty_gif; }
    location = /images/spacer.jpg { empty_gif; }
    location = /images/favicon.ico {
        root /home/www/kinopoisk.ru/;
    }

    location = /robots.txt {
        root /home/www/kinopoisk.ru/;
        expires 10d;
    }

    # KP-417
    location = /api/yandex/reviews.xml.zip {
        root /home/www/kinopoisk.ru/;
    }

    location @imhandler {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Client-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Request-Id $request_id;
        proxy_set_header X-Request-URI /handler_im.php;
        proxy_intercept_errors off;
        rewrite ^/im/(.*+)$ /web/app.php/handler_im.php?im=$1 break; # !!! CADMIN-4630 when nginx will replace apache2+fastcgi
        proxy_pass http://127.0.0.1:8080;
{%- if grains['yandex-environment'] != "production" %}
        error_page 404 @get_from_production;
    }

    #crutch to get static content from production
    location @get_from_production {
        proxy_set_header Host st.kp.yandex.net;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Client-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Request-Id $request_id;
        proxy_set_header X-Request-URI $request_uri;
        proxy_pass https://st.kp.yandex.net;

        proxy_store on;
        proxy_store_access user:rw group:rw all:r;
        proxy_temp_path /home/www/static.kinopoisk.ru/.tmp;
        root /home/www/static.kinopoisk.ru/;
{%- endif %}
    }

    location /im {
        root /home/www/static.kinopoisk.ru;
        error_page 404 = @imhandler;
        expires 30d;
    }

    location /images/ {
        root         /home/www/kinopoisk.ru/;
        expires      30d;
        location /images/blog_kp/ { expires off; }
        location /images/sm_film/ { expires 3d;  }
{%- if grains['yandex-environment'] != "production" %}
        error_page 404 @get_from_production;
{%- endif %}
    }

    location /js/ {
        root /home/www/kinopoisk.ru/;
        expires 30d;
    }

    location /board/ {
        rewrite ^/board/(.*) http://forum.kinopoisk.ru/$1 permanent;
    }

    location /shab/ {
        root /home/www/static.kinopoisk.ru/;
        expires 1d;
        location /shab/chart/ { expires off; }
        location /shab/chart_data/ { expires off; }
    }

    location / {
        return 404;
    }

    location ~* ^/(.*/)?\.(hg|svn|git|mc|ht.*)/ {
        deny all;
    }

    location ~* \.(wma|avi|wmv|flv|swf|mov|mpg|mov)$ {
        rewrite ^(.*) http://trailers.kinopoisk.ru$1 permanent;
    }
}
