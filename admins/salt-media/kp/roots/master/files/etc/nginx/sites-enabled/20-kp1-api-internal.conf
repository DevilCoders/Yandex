{%- set yaenv = grains['yandex-environment'] -%}
{%- set kp1apiinternal = 'kp1-api-internal.tst.kp.yandex.net' -%}
{%- set logtype = 'kinopoisk-tskv-backend-log' -%}

{%- if yaenv in ['production', 'prestable'] -%}
    {%- set kp1apiinternal = 'kp1-api-internal.kp.yandex.net' -%}
{%- endif -%}

{%- if yaenv in ['development'] -%}
    {%- set logtype = 'kinopoisk-tskv-front-log' -%}
{%- endif -%}

{% if salt["grains.get"]("conductor:group") in ["kp-master", "kp-test-master"] %}
    {%- set logtype = 'kp-master-log' -%}
{%- endif -%}

upstream kp1-api-internal {
  keepalive 16;
  server {{ kp1apiinternal }}:443;
}

server {
  listen 9494;
  listen [::]:9494;

  keepalive_requests 1000;
  keepalive_timeout 120 60;

  tskv_log /var/log/nginx/kp1-api-internal-access.log {{ logtype }};

  location / {
    proxy_pass             https://kp1-api-internal;
    proxy_read_timeout     300ms;
    proxy_connect_timeout  200ms;

    proxy_http_version 1.1;

    proxy_set_header Host {{ kp1apiinternal }};
    proxy_set_header Connection "";
  }
}
