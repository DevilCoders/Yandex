upstream upstream_auth_app {
    server {{ pillar.hosts.auth_app }}:443;
    keepalive 16;
}

server {
    include listen;
    server_name bo.kinopoisk.ru bo.tst.kinopoisk.ru *.bo.dev.kinopoisk.ru;
    access_log /var/log/nginx/http-access.log main;

    location / {
        rewrite ^(.*)$ https://$http_host$1 permanent;
    }
}

server {
    include listen_ssl_bo;

    server_name bo.kinopoisk.ru bo.tst.kinopoisk.ru *.bo.dev.kinopoisk.ru;

    access_log /var/log/nginx/bo.kinopoisk.ru-access.log main;

    proxy_intercept_errors on;
    error_page 403 =403 /error.403.html;

    proxy_next_upstream error timeout invalid_header;
    proxy_read_timeout 3600;

    include include/auth-app-fallback.conf;
    include include/auth-app-location.conf;

{%- if grains['yandex-environment'] != "production" %}
    # crutch to get static content from production in testing only
    location @get_from_production {
        proxy_set_header Host bo.kinopoisk.ru;
        include include/proxy-headers.conf;
        proxy_pass https://bo.kinopoisk.ru;

        proxy_store on;
        proxy_store_access user:rw group:rw all:r;
        proxy_temp_path /home/www/static.kinopoisk.ru/.tmp;
        root /home/www/static.kinopoisk.ru/;
    }

    location /trailers/ {
        root /home/www/kinopoisk.ru;
    }
{%- endif %}

    location = /error.403.html {
        root /usr/share/kinopoisk-source-stub/stub/errors/;
    }

    # KP-6698, KP-6387
    location /web/app.php {
{%- if grains['yandex-environment'] == "production" %}
        location ~* /internal-api/idm {
            deny all;
        }
{%- endif %}

        include include/auth-app.conf;

        proxy_set_header Host $http_host;
        include include/proxy-headers.conf;
        proxy_pass http://127.0.0.1:8080;
    }

    # CADMIN-4201
    location /web/internal_api.php {

        include include/auth-app.conf;

        proxy_set_header Host $http_host;
        include include/proxy-headers.conf;
        proxy_pass http://127.0.0.1:8080;
    }

    location ~* ^/bo2?/.*\.(png|jpg|gif|js|css|html)$ {
        root /home/www/kinopoisk.ru;
    }

    location ~ ^/(handler_|bo2?/)([^.]*)(\.php)?$ {
        rewrite (.*) /web/app.php$1 last; # !!! CADMIN-4630 when nginx will replace apache2+fastcgi
    }

    # CADMIN-4201
    location /internal-api/ {
        rewrite (.*) /web/app.php$1 last;
    }

    location ~* \.(xml|js|swf|css|gif|jpg|html)$ {
        root /home/www/kinopoisk.ru;
{%- if grains['yandex-environment'] != "production" %}
        error_page 404 @get_from_production;
{%- endif %}
    }

    location / {
        rewrite ^(.*)$ https://{{ pillar.domains.kp_web }}$1 permanent;
    }

}
