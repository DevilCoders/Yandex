### KPDUTY-2313
map "$request_uri:$ssl_client_verify:$ssl_client_i_dn:$ssl_client_s_dn" $check_cert_idm {
        "~^/internal-api/idm/.*:.*:.*:.*$" "0";
        "~^.*:SUCCESS:CN=YandexInternalCA,DC=ld,DC=yandex,DC=ru:emailAddress=pki@yandex-team\.ru,CN=idm\.yandex-team\.ru,OU=ITO,O=Yandex LLC,L=Moscow,ST=Moscow,C=RU$" "0";
        default "1";
}
###

server {
    include listen_ssl_idm;

    server_name bo.kinopoisk.ru bo.tst.kinopoisk.ru;

    location / {
        ### KPDUTY-2313
        if ($check_cert_idm) {
            return 403;
        }
        # Если все проверки прошли успешно, то дальше делаем что-нибудь полезное
        ###
        proxy_set_header Host bo.kinopoisk.ru;
        proxy_set_header X-Real-IP $proxy_add_x_forwarded_for;
        proxy_set_header X-Client-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Request-Id $request_id;
        proxy_set_header X-Request-URI $request_uri;
        proxy_set_header X-SSL-Subject $ssl_client_s_dn;
        proxy_set_header X-SSL-Issuer $ssl_client_i_dn;

        rewrite (.*) /web/app.php$1 break;
        proxy_pass http://127.0.0.1:8080;
    }
}
