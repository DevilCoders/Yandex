{%- set yaenv = grains['yandex-environment'] -%}
{%- set musicapi = 'api.music.yandex.net' -%}
{%- set logtype = 'kinopoisk-tskv-backend-log' -%}

{%- if yaenv in ['development'] -%}
    {%- set logtype = 'kinopoisk-tskv-front-log' -%}
{%- endif -%}

upstream music-api {
  keepalive 200;

  server {{ musicapi }}:443;
}

server {
  listen 9595;
  listen [::]:9595;

  keepalive_requests 1000;
  keepalive_timeout 120 60;

  tskv_log /var/log/nginx/music-api-access.log {{ logtype }};

  location / {
    proxy_pass             https://music-api;
    proxy_read_timeout     300ms;
    proxy_connect_timeout  200ms;

    proxy_http_version 1.1;

    proxy_set_header Host {{ musicapi }};
    proxy_set_header Connection "";
  }
}
