{%- set yaenv = grains['yandex-environment'] -%}

{%- set kp1mediaapi = 'kp1-media-api.tst.kp.yandex.net' -%}
{%- set logtype = 'kinopoisk-tskv-backend-log' -%}

{%- if yaenv in ['stress'] -%}
    {%- set kp1mediaapi = 'kp1-media-api.stress.kp.yandex.net' -%}
{%- endif -%}

{%- if yaenv in ['production', 'prestable'] -%}
    {%- set kp1mediaapi = 'kp1-media-api.kp.yandex.net' -%}
{%- endif -%}

{%- if yaenv in ['development'] -%}
    {%- set logtype = 'kinopoisk-tskv-front-log' -%}
{%- endif -%}

upstream kp1-media-api {
  keepalive 16;
  server {{ kp1mediaapi }}:443;
}

server {
  listen 9999;
  listen [::]:9999;

  keepalive_requests 1000;
  keepalive_timeout 120 60;

  tskv_log /var/log/nginx/kp1-media-api-access.log {{ logtype }};

  location / {
    proxy_pass             https://kp1-media-api;
    proxy_read_timeout     1500ms;
    proxy_connect_timeout  200ms;

    proxy_http_version 1.1;

    proxy_set_header Host {{ kp1mediaapi }};
    proxy_set_header Connection "";
  }
}
