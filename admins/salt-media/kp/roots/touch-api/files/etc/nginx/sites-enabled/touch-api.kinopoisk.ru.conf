{% set yaenv = grains['yandex-environment'] -%}

{# old kinopoisk 'defaults' #}
{% set fastcgi_read_timeout = "60s" -%}
{% set fastcgi_send_timeout = "60s" -%}
{% set fastcgi_connect_timeout = "60s" -%}

{# CADMIN-6144 #}
{% if salt["grains.get"]("conductor:group") in ["kp-touch-api", "kp-prestable-touch-api", "kp-test-touch-api", "kp-load-touch-api"] %}
{% set fastcgi_read_timeout = "15s" -%}
{% set fastcgi_send_timeout = "15s" -%}
{% set fastcgi_connect_timeout = "1s" -%}
{% endif -%}
#fastcgi_cache_path      /var/cache/nginx/touch levels=2:2 keys_zone=touch:1m max_size=100m;

{# CADMIN-6281 #}
map $request $phpfpm_socket {
    ~/web/1.0.0/getKPTop /run/php5-fpm-slow.sock;
    default /run/php5-fpm.sock;
}

server {
    include listen_ssl;

    server_name {{ servername }};

    access_log /var/log/nginx/touch-api.kinopoisk.ru-access.log main;
    error_log /var/log/nginx/touch-api.kinopoisk.ru-error.log;

    root /home/www/touch-api.kinopoisk.ru/ext;

    index index.html index.php;

    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;

    # fastcgi_cache           touch;
    # fastcgi_cache_bypass    $cookie_session_id;   # skip if logged in
    # fastcgi_cache_key       $request_uri;
    # fastcgi_cache_lock      on;
    # fastcgi_cache_lock_age  2s;
    # fastcgi_cache_use_stale timeout updating;
    # fastcgi_cache_valid     any 10m;

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        set $path_info $fastcgi_path_info;

        include fastcgi_params;

        fastcgi_read_timeout {{ fastcgi_read_timeout }};
        fastcgi_send_timeout {{ fastcgi_send_timeout }};
        fastcgi_connect_timeout {{ fastcgi_connect_timeout }};

        fastcgi_param PATH_INFO $path_info;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_index index.php;
        fastcgi_pass unix:$phpfpm_socket;
    }

    location ~ ^/web/1.0.0/(.*) {
        rewrite /web/1.0.0/(.*) /web/1.0.0/index.php?method=$1 last;
    }

    location / {
        rewrite /(.*) /web/1.0.0/$1 last;
    }

    location ~ /\. {
        deny all;
    }

    location = /ping {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "Pong\n";
    }

}

