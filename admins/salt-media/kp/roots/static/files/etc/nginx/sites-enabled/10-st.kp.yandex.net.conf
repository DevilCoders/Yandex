{%- set is_testing = grains["yandex-environment"] == "testing" %}
include include/global-maps.conf;

server {
    include listen;

    recursive_error_pages on;

    server_name ~^(st\d*(-(im|test))?|www)\.((tst|prestable)\.)?(kinopoisk\.ru|kp\.yandex\.net)$;

    root /home/www/kinopoisk.ru;

    add_header Access-Control-Allow-Origin *;
    proxy_intercept_errors on;

    set $l7_host "${http_x_forwarded_proto}://${host}";

    location @logo_file {
        expires off;
        return 302 /images/logo.png;
    }

    error_page 418 = @logo_file;

    if ($bad_referer_redirect) {
        return 418;
    }

    location ~* ^/(.*/)?\.(hg|svn|git|mc|ht.*)/ {
        deny all;
    }

    location ~* ^(.*)\.php$ {
        deny all;
    }

    location /js/charts_swf/amcharts_key.txt {
        deny all;
    }

    location / {
        try_files $uri @fetch_s3;
    }

    location ~* \.(eot|ttf|woff|woff2)$ {
        try_files $uri @fetch_s3;
    }

    location /js {
        try_files $uri @fetch_s3;
    }

    location ~* \.(js|css)$ {
        expires 1M;
        try_files $uri @fetch_s3;
    }

    location  /images/ {
        location = /images/spacer.gif { empty_gif; }
        location = /images/spacer.jpg { empty_gif; }

        # CADMIN-8401
        location ~* ^/images/(?<iphone_uri>\S+)/iphone_(?<img_param>\d+)(?<extention>\.\S+) {
            if ( $args ~ width ) {
                rewrite ^ ${l7_host}/images/$iphone_uri/iphone${arg_width}_$img_param$extention? permanent;
            }
            if ( $args ~ height ) {
                rewrite ^ ${l7_host}/images/$iphone_uri/iphone${arg_height}z_$img_param$extention? permanent;
            }
            try_files $uri @fetch_s3;
        }

        # CADMIN-6598, KPDUTY-1749
        location ~* ^/images/(article|events|news|interview|partner|podcast|game|video)/ {
            try_files $uri @api_redirect;
        }

        # CADMIN-8401, CADMIN-9007
        location ~* ^/images/film_iphone/iphone(\d+) {
            try_files $uri @api_redirect_without_404;
        }

        # CADMIN-8432, CADMIN-9007
        location ~* ^/images/(film|sm_film|film_original)/[0-9]+.jpg {
            try_files $uri @api_redirect_without_404;
        }

        # CADMIN-9007
        location /images/film_big {
            try_files $uri @api_redirect_without_404;
        }

        # CADMIN-9007
        location ~* ^/images/(sm_)?actor(_original|_big)?/[0-9]+\.jpg {
            try_files $uri @api_redirect_without_404;
        }

        # CADMIN-9007
        location ~* ^/images/actor_iphone/iphone(6|12|18|36)0_[0-9]+\.jpg {
            try_files $uri @api_redirect_without_404;
        }

        try_files $uri @fetch_s3;
    }

    # KP-4839
    location ~* ^/images/(\S*)main_(\S*)\.jpg$ {
        proxy_intercept_errors on;
        error_page 404 = @main_jpg_rewrite;
        try_files $uri @fetch_s3_main_jpg_rewrite;
    }
    location @main_jpg_rewrite {
        rewrite ^/images/(\S*)main_(\S*).jpg$ ${l7_host}/images/$1sm_$2.jpg;
    }
    # /KP-4839
    location  /images/bnnr {
        try_files $uri @fetch_s3;
    }

    location ~* ^/images/(logonew2.gif|tlogo.png)$ {
        try_files $uri @fetch_s3;
    }

    location /im/big {
        try_files $uri @fetch_s3;
    }

    location /im/ {
        try_files $uri @fetch_s3;
    }

    location /images/guess_kadr_qs {
        rewrite ^/images/guess_kadr_qs/1704/(\S*) ${l7_host}/images/guess_kadr_qs/960/$1 break;
        rewrite ^/images/guess_kadr_qs/1136/(\S*) ${l7_host}/images/guess_kadr_qs/960/$1 break;
        rewrite ^/images/guess_kadr_qs/1024/(\S*) ${l7_host}/images/guess_kadr_qs/960/$1 break;
        rewrite ^/images/guess_kadr_qs/640/(\S*) ${l7_host}/images/guess_kadr_qs/960/$1 break;

        try_files $uri @fetch_s3_w_404;
    }

    location ~* ^/images/kinobr/(?<n1>\d+)(?<t>\.\S+) {
        if ( $args ~ width ) {
            rewrite ^ ${l7_host}/images/kinobr/$arg_width/$n1$t? redirect;
        }
        try_files $uri @fetch_s3;
    }

    location ~* ^/images/iphone_awards/(?<n1>\S+)(?<t>\.\S+) {
        if ( $args ~ width ) {
            rewrite ^ ${l7_host}/images/iphone_awards/$arg_width/$n1$t? redirect;
        }
        try_files $uri @fetch_s3;
    }

    location ~* ^/images/users.*get- {
        rewrite ^.*/sm_/get-(\S*)$ https://{{ pillar.hosts.avatars }}/get-$1/46x73 last;
        rewrite ^.*/box_/get-(\S*)$ https://{{ pillar.hosts.avatars }}/get-$1/60x60 last;
        rewrite ^.*/bsm_/get-(\S*)$ https://{{ pillar.hosts.avatars }}/get-$1/46x73_bw last;
        rewrite ^.*/get-(\S*)$ https://{{ pillar.hosts.avatars }}/get-$1/120x190 last;
        try_files $uri @fetch_s3;
    }

    location /level {
        return 404;
    }

    # KPDUTY-1821, KPDUTY-1822, KPDUTY-1854, KPDUTY-2305, KPDUTY-2310
    location ~* ^/rss/(news|news_ya|setka|dzen_posts|comment|premiere|trailer_new_film)\.rss$ {
        proxy_intercept_errors on;
        recursive_error_pages on;
        error_page 404 = @rss_fallback;
        error_page 302 = @rss_proxypass;

        # KPDUTY-1824: rewrite header frm S3
        proxy_hide_header Content-Type;
        add_header Content-Type "application/rss+xml; charset=UTF-8";

        rewrite ^/rss/news_ya\.rss$ /export/rss/yandex/news.rss break;
        rewrite ^/rss/(news|setka)\.rss$ /export/rss/setka/posts.rss break;
        rewrite ^/rss/dzen_posts\.rss$ /export/rss/dzen/posts.rss break;
        rewrite ^/rss/comment\.rss$ /export/rss/yandex/comment.rss break;
        rewrite ^/rss/premiere\.rss$ /export/rss/yandex/premiere.rss break;
        rewrite ^/rss/trailer_new_film\.rss$ /export/rss/dzen/trailers.rss break;

        proxy_set_header Host "{{ pillar.hosts.s3_kinopoisk }}";
        proxy_pass http://upstream_s3_kinopoisk;
    }

    # CADMIN-3454, KPDUTY-2305
    location ~* ^/rss/(\S*)+\.rss$ {
        proxy_intercept_errors on;
        recursive_error_pages on;
        error_page 404 = @rss_fallback;

        try_files $uri =404;
    }
    location @rss_proxypass {
        internal;
        set $saved_redirect_location '$upstream_http_location';
        proxy_pass $saved_redirect_location;
    }
    location @rss_fallback {
        internal;
        proxy_intercept_errors on;
        recursive_error_pages on;
        root  /home/www/kinopoisk.ru;
        error_page 404 = @rss_fallback_master;
        if ( $args ~* (\S*)file=kinopoisk%2F(\S*) )
        {
            set $fallback_uri "/rss/$2.rss";
            set $args "";
            rewrite ^(\S*)$ $fallback_uri break;
        }
        try_files $uri =404;
    }
    location @rss_fallback_master {
        internal;
        include include/keepalive.conf;
        proxy_pass http://upstream_bo;
    }

    # KP-5418, CADMIN-6399
    location /sitemaps {
        try_files $uri @fetch_s3;
    }

    location /b/ {
        rewrite ^/b/(\S*)$  ${l7_host}/images/bnnr/brand/$1 permanent;
    }

    location /images/images/ {
        rewrite ^/images/images/(\S*)$ ${l7_host}/images/$1 last;
    }

    location /images/kadr_events/ {
        rewrite ^/images/kadr_events/(\S*)$ ${l7_host}/images/kadr/$1 last;
    }

    # CADMIN-6598
    location @api_redirect {
        include include/keepalive.conf;
        set $new_uri $uri;
        rewrite (.*) /redirects/static-image?image_url=$1 break;
        proxy_set_header Host "{{ pillar.domains.kp_api_internal }}";
        expires 10m;
        proxy_pass https://upstream_kp1-internal-api;
        error_page 404 = @local_fs;
    }

    # CADMIN-9007
    location @api_redirect_without_404 {
        include include/keepalive.conf;
        set $new_uri $uri;
        rewrite (.*) /redirects/static-image?image_url=$1 break;
        proxy_set_header Host "{{ pillar.domains.kp_api_internal }}";
        expires 10m;
        proxy_pass https://upstream_kp1-internal-api;
        error_page 404 https://st.kp.yandex.net/images/no-poster.gif;
    }

    # CADMIN-6598
    location @local_fs {
        rewrite (.*) $new_uri? break;
        try_files $uri @fetch_s3;
    }

    location @fetch_s3 {
        internal;
        include include/keepalive.conf;
        proxy_set_header Host "{{ pillar.hosts.s3_static }}";

        # Disallow any encodings exept gzip and deflate. This fixes cache
        # inconsistancy bug (reproducable in safary, chrome/firefox detects
        # encoding type automatically).
        proxy_set_header Accept-Encoding  gzip,deflate;

        proxy_pass http://upstream_s3;
        error_page 404 = @fetch_bo;
    }

    location @fetch_s3_main_jpg_rewrite {
        internal;
        include include/keepalive.conf;
        proxy_set_header Host "{{ pillar.hosts.s3_static }}";
        proxy_pass http://upstream_s3;
        error_page 404 = @main_jpg_rewrite;
    }

    location @fetch_s3_w_404 {
        internal;
        include include/keepalive.conf;
        proxy_set_header Host "{{ pillar.hosts.s3_static }}";
        proxy_pass http://upstream_s3;
    }

    location @fetch_bo {
        internal;
        include include/keepalive.conf;
        proxy_set_header Host {{ 'bo.tst.kp.yandex.net' if is_testing else 'bo.kp.yandex.net' }};
        proxy_pass http://upstream_bo;
        error_page 404 https://st.kp.yandex.net/images/no-poster.gif;
    }

    location /mobile {
        rewrite /mobile/(.*) /$1 break;
        include include/keepalive.conf;
        proxy_set_header Host "{{ pillar.hosts.s3_mobile_promo }}";
        proxy_pass http://upstream_s3_mobile;
    }

    location ~ ^/google-feed-(production|staging|dev)\.json$ {
        auth_basic "google feed";
        auth_basic_user_file /etc/nginx/.htpasswd;
        include include/keepalive.conf;
        proxy_set_header Host "{{ pillar.hosts.s3_static }}";
        proxy_pass http://upstream_s3;
    }

    location ~ \.htpasswd {
        deny all;
    }

    # balancer check
    location /ping {
        add_header Content-Type text/plain;
        return 200 'pong\n';
    }
}
