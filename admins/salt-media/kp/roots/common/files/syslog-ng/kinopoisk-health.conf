# CADMIN-3401: send log events via udp to kino-kp1-health service

filter f_kinopoisk_health {
    message("^kinopoisk_health");
};

# send into log as usual
destination d_kinopoisk_health_log {
    file("/var/log/php/kinopoisk-health.log"
        create_dirs(yes)
        dir_owner(www-data)
        dir_group(www-data)
        dir_perm(0755)
        owner(www-data)
        group(www-data)
        perm(0644)
        mark_freq (0)
    );
};

log {
    source(s_all);
    filter(f_kinopoisk_health);
    destination(d_kinopoisk_health_log);
};

# send via udp clear json only
template t_kinopoisk_health_udp {
    template("$MSGONLY\n");
    template_escape(no);
};

rewrite r_kinopoisk_health_json {
    subst('.*?\s\{\"', '{"', value("MESSAGE") flags("utf8" "global"));
};

destination d_kinopoisk_health_udp {
    udp6("::1" port (5000) template(t_kinopoisk_health_udp));
};

log {
    source(s_all);
    filter(f_kinopoisk_health);
    rewrite(r_kinopoisk_health_json);
    destination(d_kinopoisk_health_udp);
    flags(final);
};
