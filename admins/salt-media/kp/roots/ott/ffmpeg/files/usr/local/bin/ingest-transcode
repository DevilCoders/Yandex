#! /bin/sh

for f in *.mov *.mp4 *.ts *.m2ts *.mxf *.avi *vob *.mpg; do mkdir -p DONE;
ffmpeg -ss 00:05:00 -t 30 -i "$f" -map 0:v -vcodec h264 -profile:v high -preset slow -level 5.1 -pix_fmt yuv420p -crf 15 -y temp.mp4;
cdresult=$(ffmpeg -i temp.mp4 -vf cropdetect=24:2:0 -f null - 2>&1 | awk '/crop/ { print $NF }' | tail -1);

ffmpeg -ss 00:05:00 -t 30 -i "$f" -map 0:v -vcodec h264 -preset slow -profile:v high -level 5.1 -pix_fmt yuv420p -crf 15 -vf "$cdresult" -map 0:a -acodec aac -ar 48000 -ab 256K -ac 2 -clev 1.414 -slev .5 -metadata:s:v:0 language=rus -metadata:s:a:0 language=rus -map_metadata -1 -map_chapters -1 DONE/test_"${f%.*}".mp4;

ffmpeg -i "$f" -map 0:v -vcodec h264 -preset slow -profile:v high -level 5.1 -pix_fmt yuv420p -crf 15 -vf "$cdresult" -map 0:a -acodec aac -ar 48000 -ab 256K -ac 2 -clev 1.414 -slev .5 -metadata:s:v:0 language=rus -metadata:s:a:0 language=rus -metadata:s:a:1 language=eng -map_metadata -1 -map_chapters -1 DONE/"${f%.*}".mp4; rm temp.mp4; done
