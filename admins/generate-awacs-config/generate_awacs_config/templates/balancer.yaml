# this file is autogenerated with generate-awacs-config
# please update the original config.yaml rather than this file

auth:
  staff:
    owners:
      logins:
      {%- for user in admins['users'] %}
        - {{ user }}
      {%- endfor %}
      groups:
      {%- for group in admins['groups'] %}
        - {{ group }}
      {%- endfor %}
config_transport:
  nanny_static_file:
    service_id: {{ service }}
---
instance_macro:
  maxconn: {{ connection.max }}
  sections:
    admin:
      ips: [127.0.0.1, '::1']
      ports: [{{ port }}]
      modules:
        - http: {}
        - admin: {}
    stats_storage:
      ips: [127.0.0.4]
      ports: [{{ port }}]
      modules:
        - report:
            uuid: 'service_total'
            ranges: 'default'
            just_storage: true
        - http: {}
        - errordocument:
            status: 204
    {%- if listen['http'] %}
    http_section:
      ips: ['*']
      ports: [{{ listen['http'] }}]
      local_ips: [local_v4_addr, local_v6_addr]
      local_ports: [{{ port }}]
      extended_http_macro:
        port: {{ port }}
        report_uuid: 'http'
        modules:
          - headers:
              create:
                X-Yandex-HTTP: yes
                X-Yandex-L7: yes
              create_func:
                X-Start-Time: starttime
                X-Forwarded-For-Y: realip
                X-Source-Port-Y: realport
                X-Forwarded-For: realip
                X-Scheme: scheme
              create_func_weak:
                X-Request-Id: reqid
          - response_headers:
              create_weak:
                X-XSS-Protection: '1; mode=block'
                X-Content-Type-Options: 'nosniff'
          - log_headers:
              name_re: 'X-Request-Id'
          - regexp:
              include_upstreams:
                filter:
                  id_prefix_in:
                    - http_
                    - slbping
                    - default
                    - awacs-balancer-health-check
                order:
                  label:
                    name: order
    {%- set port = port + 1 %}
    {%- endif %}
    {%- if listen['https'] %}
    https_section:
      ips: ['*']
      ports: [{{ listen['https'] }}]
      local_ips: [local_v4_addr, local_v6_addr]
      local_ports: [{{ port }}]
      extended_http_macro:
        port: {{ port }}
        report_uuid: 'https'
        enable_ssl: true
        ssl_sni_contexts:
          {%- for sni_item in sni %}
          {%- if sni_item is string %}
          {{ sni_item }}:
            servername_regexp: '{{ sni_item }}'
          {%- else %}
          {%- for name, regex in sni_item.items() %}
          {{ name }}:
            servername_regexp: '{{ regex }}'
          {%- endfor %}
          {%- endif %}
          {%- endfor %}
          {{ default_cert|default(name) }}:
            servername_regexp: default
        modules:
          - headers:
              create:
                X-Yandex-HTTPS: yes
                X-Yandex-L7: yes
              create_func:
                X-Start-Time: starttime
                X-Request-Id: reqid
                X-Forwarded-For-Y: realip
                X-Source-Port-Y: realport
                X-Forwarded-For: realip
                X-Scheme: scheme
          - response_headers:
              create:
                Strict-Transport-Security: 'max-age=31536000'
              create_weak:
                X-XSS-Protection: '1; mode=block'
                X-Content-Type-Options: 'nosniff'
          - regexp:
              include_upstreams:
                filter:
                  id_prefix_in:
                    - https_
                    - slbping
                    - default
                    - awacs-balancer-health-check
                order:
                  label:
                    name: order
    {%- endif %}
