Итак, вы решили запустить сервис в Облаке, и поэтому готовитесь к продуктовому комитету, или же просто новый сотрудник, который ротировался из большого Я в Облако. В этом разделе я собрал некоторые темы и подводные камни, на которые натыкались ваши предшественники. Все в рандомном порядке и добавляется по мере появления.

## Культура отношения к пользовательским данным

В Облаке есть особая культура отношения к пользовательским данным, которая выражается в том, что данные пользователя всегда принадлежат пользователю и только ему.

Мы не заглядываем в пользовательские данные (условно, внутрь виртуальных машин) без явного разрешения пользователя это сделать. Более того, мы разрабатываем сервисы, которые позволяют пользователю следить за нами и за тем, как мы работаем с его данными. Только такой подход устраивает серьезных клиентов. Это мы постоянно слышим от них.

{% note alert %}

Представим ситуацию, что сервис начинает логгировать токены или секреты пользователя. С точки зрения Облака и контракта с пользователем это критичный инцидент ИБ, который мы обязаны не просто расследовать asap, но еще сообщить об этом пользователю в течение 24 часов с момента обнаружения такого события.

{% endnote %}

## Я 10 лет писал код прямо в продакшне, почему в Облаке нельзя также?

Так делать нельзя и отчасти это перекликается с предыдущим пунктом. В Облаке мы последовательно движемся к тому, чтобы не иметь доступ в продакшн сервиса, то есть в ту среду, в которой обрабатываются пользовательские данные. Это надо принять как продуктовое требование и исходя из него дизайнить свой сервис.

Во многом бизнес и обязательства наших клиентов перед их пользователями зависит от нас и мы хотим максимально обезопасить пользовательские данные от нас самих же.

## Private Cloud vs Public Cloud

В большом Я инфраструктура концептуально более близка к Private Cloud модели, то есть изоляция местами была намеренно расслаблена в угоду производительности. В Private Cloud все клиенты в целом считаются более-менее доверенными по отношению друг к другу и, поэтому, в этой модели не требуется строгой изоляции, так как сторонние недоверенные пользователи просто не допускаются к использованию ресурсов Private Cloud.

Примеры расслабленной изоляции в инфраструктуре:

* porto контейнеры - используется одно ядро и из каждого контейнера есть поверхность атаки на ядро, также нет полной изоляции для некоторых типов ресурсов (например, изоляция по iops в дисковой подсистеме);
* MTN - multi-tenant IPv6 network - все живут в плоской IPv6 сети без виртуализации и практически без изоляции по vlan/vrf сегментам, а правила firewall работают на каждом хосте в виде распределенного host based firewall;
* на уровне приложений часто можно встретить отсутствующую модель доступов, то есть аутентификацию без авторизации либо же широкий доступ на чтение.

Облако же, за счет исполнения недоверенного кода потенциально любых внешних клиентов, требует более серьезного подхода к изоляции - все API должны иметь аутентификацию и авторизацию, нельзя использовать одну плоскую сеть - в Облаке используется виртуальная сеть для каждого клиента, в качестве диска используется NBS (Network Block Storage) с изоляцией по iops, а вместо контейнеров используется полноценная аппаратно ускоренная виртуализация (удивительно, но даже в serverless functions каждая функция - оптимизированная микро-виртуальная машина).

## Oncall и дежурная смена

В Облаке есть процесс дежурств по сервису, так называемый oncall. В каждый момент времени у сервиса есть основной дежурный (primary или prim), а также back-up дежурный (называем его просто back). Эта пара должна отвечать на призывы в чате дежурных, отвечать на звонки и выполнять указания Incident Manager (IM). IM обычно один из старших сотрудников Облака, который в конечном итоге отвечает за то, чтобы в случае инцидента Облако было приведено в работоспособное состояние. При планировании запуска нового сервиса обязательно надо учесть этот момент и аллокацию ресурсов на этот процесс.

{% note alert %}

Если вы пытаетесь запустить сервис командой из двух человек, то либо у вас будет два вечных дежурных, либо вы не сможете обеспечивать нужный SLA и ваш сервис никогда не выйдет из режима Preview, то есть не начнет зарабатывать деньги.

{% endnote %}

## Важные процессы безопасности

Отчасти этот пункт перекликается с Oncall. Представим ситуацию, что у нас обнаруживается опасная уязвимость наподобие [log4shell](https://ru.wikipedia.org/wiki/Log4Shell). Ваш дежурный должен быть доступен и должен быть готов сделать hotfix в сервисе, быстро протестировать и выкатить изменения в продакшн. В Облаке мы не просто исправляем уязвимости, мы также пишем различные [Security Advisories](https://cloud.yandex.com/docs/overview/security-bulletins/) для того, чтобы пользователи были уверены в безопасности их данных в наших сервисах. При этом такие публикации мы делаем очень быстро.

## Private API, Public API, Terraform и CLI

При планировании разработки сервиса необходимо учесть, что внутри сервисы Облака взаимодействуют при помощи gRPC API, спека которого централизована и находится в репозитории cloud-go.

Также сервис, кроме веб-интерфейса, должен заложить ресурсы на разработку публичного API - Public API, провайдера Terraform, а также предоставить пользователям работу через наш публичный CLI.

{% note tip %}

Для многих пользователей отсутствие сервиса или части функциональности сервиса в Terraform делает сам сервис или эту функциональность недоступной, так как многие пользователи используют Terraform как основной интерфейс управления ресурсами Облака.

{% endnote %}

## Слой совместимости с AWS API

Планируя в сервисе слой совместимости с AWS API, следует обязательно запланировать реализацию обычного gRPC API. AWS API следует рассматривать именно как слой совместимости, потому что наша ресурсная модель сильно отличается от ресурсной модели и подходов AWS.

{% note tip %}

В качестве примера можно привести случай нашего Object Storage, в котором долгое время нельзя было полистить buckets программными средствами, так как gRPC API не был реализован, а модель AWS ничего не знает про нашу модель cloud-ов и folder-ов.

{% endnote %}

Также при создании слоя совместимости с AWS API необходимо учесть продвинутые сценарии, такие как [STS](https://docs.aws.amazon.com/STS/latest/APIReference/welcome.html).

## Открытый стандарт vs собственное решение

В Облаке мы стараемся следовать открытым стандартам взаимодействия систем для максимального упрощения interoperability. Мы стараемся не пилить внутренние API, если уже есть стандартизованный протокол работы, который поддерживается разными внешними системами. В качестве примера можно привести поддержку стандартов [SAML](https://ru.wikipedia.org/wiki/SAML), [OpenID Connect](https://openid.net/connect/), [OAuth2](https://ru.wikipedia.org/wiki/OAuth), [SCIM](http://www.simplecloud.info/) в IAM.

{% note tip %}

В общем случае, rule of thumb - в любых обстоятельствах лучше предпочитать открытый стандарт, чем свое собственное API для пользователей.

{% endnote %}

## Compliance и аудиты по стандартам безопасности

В Облаке [довольно много Compliance](https://cloud.yandex.ru/security), то есть выполнения требований разных стандартов ИБ, так как это является прямым требованием клиентов. Часто в разных индустриях есть типы данных (например, карточные или персональные), обработка и хранение которых регулируется строгими правилами. Это может быть закон, например 152-фз, или же может быть регулятор - Центральный Банк или ФСТЭК, или же сложившаяся в индустрии практика, например, требование платежных систем по внедрению PCI DSS.

В общем, Облако обязано регулярно проходить разные виды аудитов и подтверждать то, что информационная безопасность в Облаке работает и все контроли на месте. Нельзя просто получить сертификат и успокоиться, это будет регулярный процесс, который будет отнимать ресурсы команды. Если вы запускаете сервис в Облаке, то стоит готовиться к тому, что придется соблюдать требования стандартов безопасности, создавать и постоянно обновлять внутреннюю документацию, регламенты и процедуры.

В плане аудитов мы движемся к тому, что у нас будут аудиты за период. Сейчас аудитор приходит раз в год, ну или раз в квартал если это внутренний аудит, и проверяет срез текущих активностей. Мы движемся к тому (да и в целом уже пришли), что аудиты будут проходить по схеме "дай мне все тикеты за последние 6 мес, а я выберу 20 процентов рандомных и посмотрю, как выполнялись процессы". Результаты такого аудита оформляются в виде отчета и нет никакой возможности исправить недостатки при таком подходе. Аудиты за период используются в комплайенсе по SOX (когда начинаем зарабатывать много денег и влиять на финансовые результаты компании), а также SOC 1,2 Type 2 (де-факто стандарт в USA).

В качестве вывода - аудиты и комплайенс надо принять просто как бизнес-требование.

## Использование внутренних сервисов

Одно из важных свойств Облака - selfhosting. Облако должно быть замкнутым, то есть должно полагаться только на те сервисы, которые есть в Облаке (например, для хранения секретов надо использовать Lockbox или Secret Service, и нельзя использовать YAV). Это позволяет достичь клонируемости и переносимости Облака в новые регионы, а также автоматизировать развертывание Облака.

{% note alert %}

Отказ от использования сервисов вне периметра Облака также необходим для прохождения сертификаций по информационной безопасности. В основе дизайна наших compliance активностей тот факт, что Облако не должно затаскивать в scope всю остальную инфраструктуру Яндекса.

{% endnote %}

## Битбакет, использование Аркадии и требования PCI DSS

Код Облака живет в основном в [битбакете](https://bb.yandex-team.ru/projects/CLOUD), и по большей своей части сосредоточен в двух "монорепозиториях": cloud-go и cloud-java. Для этих репозиториев установлен обязательный пре-коммитный код ревью, и эти настройки регулярно проверяются нашим внутренним аудитом.

{% note info %}

Облако сертифицировано по стандарту PCI DSS, который требует, чтобы любые изменения в продакшне были проревьювлены человеком, который прошел курс по безопасной разработке и знает что такое OWASP Top 10.

{% endnote %}

В Облаке есть несколько сервисов, код которых находится в Аркадии. Для того, чтобы удовлетворять требованиям PCI DSS, для кода этих сервисов должен использоваться сервис [PCI Express](https://a.yandex-team.ru/arc/trunk/arcadia/repo/pciexpress/readme.md), а также должен быть отключен [Sticky Ship](https://docs.yandex-team.ru/arcanum/pr/verdicts#sticky-ship).

Сервис PCI Express позволяет автоматизировать проверку того, что все шипнутые изменения были проревьювлены человеком, который прошел обучение безопасной разработке. Эта же политика касается и всех зависимостей сервисов, которые находятся в scope PCI DSS сертификации (примерно все сервисы Облака).

## Сборочный цех

Сборка релизов в Облаке должна проходить в доверенной среде, сертифицированной по PCI DSS. В Облаке этой доверенной средой является ["Сборочный Цех"](https://wiki.yandex-team.ru/cloud/devel/assembly-workshop/). Если вы разрабатываетесь в Аркадии, то использовать аркадийный CI можно только для запуска покоммитных билдов и прогона тестов. Для релизных сборок использование Сборочного Цеха - обязательно.

{% note info %}

Некоторые проекты Яндекса, которые должны соответствовать PCI DSS, также контрабандой заехали в Сборочный Цех (не является руководством к действию).

{% endnote %}

## Доступ в продакшн среду

В Облаке доступ в продакшн среду осуществляется через сервис Бастион - по сути набор ssh jump хостов, которые записывают ssh сессию.

Это необходимо для того, чтобы пройти аудиты безопасности, а также для того, чтобы эффективно расследовать инциденты, связанные с утечками данных из нашего продакшна.

Для защиты ключей доступа используются аппаратные ключи Yubikey.
