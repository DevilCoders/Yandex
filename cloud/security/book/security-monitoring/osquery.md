## Мониторинг при помощи osquery

Для мониторинга безопасности в Облаке используется [osquery](https://github.com/osquery/osquery), который должен работать

* на каждой виртуальной машине,
* на каждой compute node,
* на всех других железных хостах,
* на ноутбуках и рабочих станциях.

{% note alert %}

Наличие osquery является обязательным требованием, запрещается отключать osquery.

{% endnote %}

## Производительность osquery

Osquery расходует ресурсы системы, поэтому мы настроили watchdog, а также сделали cgroup, которая ограничивает потребление системных ресурсов. Тем не менее, многих проблем с производительностью можно избежать следуя best practices.

### Отдельный volume

NBS имеет лимиты на iops, которые применяются к каждому диску отдельно. Для того, чтобы osquery не конфликтовал за IO с приложением и системой, рекомендуется создать отдельный volume под логи osquery.

### Уменьшить количество старт-стопов процессов

Каждый старт-стоп процесса создает запись в системе аудита ядра, которая дальше передает эту информацию osquery. Таким образом, частые старт-стопы процессов излишне нагружают систему и создают лишний шум в osquery, который собирает все эти логи.

Пример:

* [постоянные старты процессов в monrun](https://bb.yandex-team.ru/projects/CLOUD/repos/ycinfra-packages/browse/yc-hw-watcher-hooks/files/ycinfra.py#1054
)
