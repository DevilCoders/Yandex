## IAM Sync Configs

В этом разделе описывается что такое iam sync configs и то, как и по каким принципам мы управляем доступами к ситемным ресурсам в Облаке.

**IAM Sync Configs** (или просто iam sync) - это набор yaml файлов, которые описывают конфигурацию доступов пользователей к определенному набору ресурсов в Облаке (например, к системным ресурсам), а также дополнительные настройки пользователей (например, настройки синхронизации ключей со стаффа oslogin).

**Контейнер ресурсов** - одна из сущностей ресурсной модели Облака, которая используется для группировки ресурсов Облака. В настоящий момент в Облаке есть следующие контейнеры ресурсов - `root` (включает в себя все ресурсы Облака), организациия, `cloud`, `folder`. Также есть желание между организациями и `cloud`-ами добавить `resource unit`-ы для группировки `cloud`-ов.

**Примитивные роли** - роли наподобие `admin`, `editor` или `viewer`, которые действуют на все ресурсы всех сервисов в контейнере ресурсов.

**Сервисные роли** - роли, которые действуют только в рамках одного сервиса. Например, `storage.configViewer`.

{% note alert %}

IAM Sync управляет только теми доступами, о которых он знает. Если доступ был выдан каким-либо образом в обход IAM sync (например, в IAM Sync описан доступ на cloud, а руками в консоли выдали доступ на folder), то IAM Sync ничего не будет делать с таким доступом. Поэтому в процессе пересмотра доступов необходимо в первую очередь ориентироваться на access bindings в IAM, а не на IAM Sync. IAM Sync лишь приближение к source of truth, однако не является им.

{% endnote %}

## Субъекты в IAM Sync

В настоящий момент IAM Sync может предоставлять доступ только следующим субъектам:

* ABC сервис с указанием scope-а или кода роли;
* Пользователь Облака (внешний Паспорт);
* Пользователь IAM;
* Сервисный аккаунт IAM;
* Группа в IAM (в будущем, пока не имплементировано);

Доступ может быть предоставлен только пользователям служебной федерации Облака или же системным сервисным аккаунтам.

{% note alert %}

Все новые (например, после 2022-03-01) системные сервисные аккаунты должны иметь well known id.

{% endnote %}

## Персональные доступы

Персональные доступы сотрудникам или внешним консультантам предоставляются только временно и только на короткое время (не более двух недель). Следует избегать предоставления персональных доступов и использовать либо ABC сервис с указанием scope или кода роли, либо группы IAM.

Персональные доступы разрешены только если субъектом доступа (тот, кто получает доступ) является системный сервисный аккаунт.

## Доступы сервисных аккаунтов

Системные сервисные аккаунты не могут иметь примитивные роли на `root`. Для системных сервисных аккаунтов, которые должны получать доступ на `root` нужно предварительно создать специальную внутреннюю роль, которая будет включать в себя минимально необходимый для работы набор пермиссий.

Системные сервисные аккаунты могут иметь примитивные роли только на служебные облака сервисов и только для целей:

* целей сборки и выкладки сервиса (сервисный аккаунт для процессов CI/CD);
* для целей запуска end-to-end тестов (когда надо создать большое количество ресурсов, а после их удалить и необходимо постоянно проделывать такие операции);

## Указание причины предоставления доступа

В yaml файле с доступом должен быть комментарий в тикете, из которого можно понять зачем нужен этот доступ. Для Облака обязательны процессы регулярного пересмотра доступов и если не указывать причину, то такой доступ рискует быть отозванным в первую очередь при следующем пересмотре.

## Права для oncall команды сервиса

В каждом сервисе есть oncall, который может получить роль `<service>.onCall` для своего сервиса. Роль `<service>.onCall` должна обладать следующими свойствами:

* должна предоставлять доступ к метаданным, то есть информации о пользовательских ресурсах в сервисе и смежных сервисах, если такое необходимо;
* должна предоставлять доступ к технической информации о работе сервиса, то есть может включать в себя внутренние пермиссии, недоступные внешним пользователям;
* может иметь возможность совершения модифицирующих операций в сервисе, которые не затрагивают пользовательские ресурсы (например, менять технические параметры сервиса или же увеличивать квоту пользователя в сервисе);
* не должна предоставлять никаких прав на просмотр или модификацию пользовательских данных, то есть данных, которые пользователь загрузил в Облако или сгенерировал в Облаке.

## Права для команды сервиса

Команда сервиса, которая не выполняет фунцию oncall, может получить роль `<service>.support`, которая должна обладать следующими свойствами:

* давать возможность посмотреть информацию о пользовательских ресурсах в сервисе, однако не давать возможности смотреть пользовательские данные;
* давать возможность посмотреть дополнительную техническую информацию о работе сервиса, которая необходима команде для разбора проблем в работе сервиса.

## Права на модифицирующие операции

Команда сериса не должна может получить постоянные права на проведение модифицирующих операций над ресурсами пользователей в своем сервисе.

Для проведения модифицирующих операций в рамках дежурства или поддержки необходимо

* создать специальный сервисный аккаунт с well known id,
* дать этому сервисному аккаунту права на модифицирующие операции - специальная роль, котрая должна называться `<service>.onCallAdmin`;
* дать дежурным сервиса право имперсонироваться в этот сервисный аккаунт через роль `iam.tokenCreator` на этот системный сервисный аккаунт;

Далее проводить модифицирующие операции необходимо только от имени этого системного сервисного аккаунта.

{% note alert %}

Проведение модифицирующей операции от учетной записи сотрудника Облака является инцидентом информационной безопасности.

Для проведения модифицирующих операций необходимо использовать процесс [CLOUDOPS](https://wiki.yandex-team.ru/cloud/regulations/adhoc/).

{% endnote %}

## Права для смежных подразделений Яндекса

IAM-Sync регулирует также права смежных подразделений Яндекса, например Такси или Яндекс Банка. Назначение прав таким подразделениям регулируются отдельной политикой, применимой только к этим подразделениям. Права таких подразделений должны кросс-чекать коллеги из security@.

{% note alert %}

Запрещается выдавать доступ смежным подразделениям Яндекса в системную ораганизацию Облака.

{% endnote %}
