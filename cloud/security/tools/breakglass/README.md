## Breakglass for SSH in YCloud (ver 1.1)

Короткая инструкция чтобы ускорить выпуск и использование софтовых сертификатов для ssh-breakglass.

{% cut "Гайд по внесению изменений" %}

Если у вас есть желание непоправимо улучшить эту инструкцию, убедитесь что ваши изменения общеприменимы для любого дежурного облака:
* не зависят от конкретного ноутбука;
* не зависят от фазы луны;
* не добавляют новых "если" предполагающих мыслительные действия;
* желательно используют только облачный туллинг;

Также имейте в виду - `yav` это временное решение, поэтому не закладывайтесь на него сильнее чем уже сейчас.

И помните - эта инструкция не для того чтобы думать и дебажить, для этого есть [полная инструкция](https://wiki.yandex-team.ru/cloud/security/security-duty/session-soft-cert/)
Эта инструкция призвана выпилить все неоднозначности из полной инструкции в угоду простоте и полной воспроизводимости у любого дежурного.

{% endcut %}

Пререквизиты:
1. Для пользователей windows все пререквизиты должны быть в wsl 1.0. Действия также выполняются в wsl 1.0.
2. Наличие [pssh](https://wiki.yandex-team.ru/cloud/yubikey/#2.psshrekomenduem).
   Зависимости pssh по ссылке одним абзацем выше.
3. Прямо сейчас - наличие [yav cli](https://vault-api.passport.yandex.net/docs/#cli).
   `pip install yandex-passport-vault-client -i https://pypi.yandex-team.ru/simple --user`
4. Какой-либо ssh-agent с ключом со стаффа, чтобы использовать `yav`.
5. Живая аркадия или зеркало для скриптов [breakglass_get.sh](https://a.yandex-team.ru/arcadia/cloud/security/tools/breakglass/breakglass_get.sh) и [breakglass_issue.sh](https://a.yandex-team.ru/arcadia/cloud/security/tools/breakglass/breakglass_issue.sh):
   https://a.yandex-team.ru/arcadia/cloud/security/tools/breakglass/


### Заказ и использование серта (для дежурных сервисов)
1. Завести CLOUDINC.
2. Попросить у `/duty security` - "breakglass-ключ для ssh".
  1. Тут у вас есть пара минут чтобы проверить наличие пререквизитов.
3. Получить ссылку на yav.
4. Скачать ключи и положить (желательно в отдельный) ssh-agent:
   `./breakglass_get.sh CLOUDINC-XXX sec-XXXXX`

### Выпуск серта (для дежурных Security)
Инструкция для `/duty security`, находится рядом с основной чтобы держать обе инструкции консистентными.
1. Запросить CLOUD или CLOUDINC-тикет.
2. Yav по умолчанию достает rsa-ключи из ssh агента для авторизации, поэтому выполняем: `ssh-add`
2. Сгенерировать и залить ключи:
   `./breakglass_issue.sh CLOUDINC-XXX staff_login` (в случае ошибки `error: No keys in the SSH Agent.` выполнить `ssh-add`)
3. Удостовериться что всё сгенерировалось и !!залилось на yav!!
4. Удалить локальный ключ:
   `rm "/path/to/session-soft"`
5. Отдать uuid секрета в того кто запросил.

6. Если процесс генерации зафейлился по нерешаемой причине, то ищем в yav полугодовой ключ и шарим его.
   https://yav.yandex-team.ru/?tags=yav_breakglass
7. Записываем в CLOUDDUTY и в CLOUDINC-тикет AI - отозвать и поротировать полугодовой ключ.
8. Отзываем старый и генерирует новый полугодовой ключ когда проблемы с crt разрешиться.

9. В случае глобального факапа, права на Администрирование breakglass ключа в yav также выдаётся `/duty IM` и дальше IM расшаривает доступы на команды.
