# Terraform config for YC Search
## Install Terraform
Best way to install terraform is to install [tfswitch](https://tfswitch.warrensbox.com/Install/).
To switch terraform to required version inside the terraform configuration folder:

    cloud/search/deploy/terraform/envs/yc-prod $ tfswitch
    Reading required version from terraform file, constraint: 0.13.5
    Matched version: 0.13.5
    Switched terraform to version "0.13.5"

## Usage
In order to use this config you need to provide vars.
The best way is to generate them.

    cd envs/yc-prod
    ./generate-secret-vars.sh

To initialize terraform config you need to provide keys to S3.

### S3 setup
- Install [direnv](https://direnv.net/)
- `.envrc` was generated by `./generate-secret-vars.sh` script.

### Run plan
#### Prerequisites
To use environment variables from .envrc install and run terraform under https://direnv.net/
#### Run
To run plan you need initialized terraform:

    terraform init
To see changes:

    terraform plan
To apply changes:

    terraform plan -out out
    terraform apply "out"


## Deploy new yc search component version
1. Update version in `envs/yc-prod/yc_search_versions.tf` file
2. Run `terraform plan -out out`
3. Check diff (there should be only bood_disk image_id changes)
4. Run `terraform apply out`
5. Watch your services at [console](https://console.cloud.yandex.ru/folders/b1gnek8fpi8pqaf42pg6/compute?section=instance-groups)
6. Enjoy!
