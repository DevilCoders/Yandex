{
    "builders": [
      {
        "type":      "yandex",
        "folder_id": "{{user `folder_id`}}",
        "service_account_key_file": "{{ user `service_account_key_file`}}",
        "zone":      "{{ user `zone`}}",
        "image_name":        "yc-search-2if-{{isotime | clean_resource_name}}",
        "image_family":      "yc-search-base-1804",
        "image_description": "YC Search base image",
        "source_image_family": "ubuntu-1804-lts",
        "subnet_id":           "{{ user `subnet_id`}}",
        "use_ipv6":            true,
        "use_internal_ip":     "{{ user `use_internal_ip`}}",
        "disk_size_gb":        "{{ user `disk_size_gb`}}",
        "disk_type":           "network-hdd",
        "instance_mem_gb":     4,
        "ssh_username":        "ubuntu"
      }
    ],
    "provisioners": [
      {
        "type": "shell",
        "environment_vars": ["DEBIAN_FRONTEND=noninteractive"],
        "inline": [
          "echo 'updating APT'",
          "echo 'deb http://mdb-bionic.dist.yandex.ru/mdb-bionic-secure stable/all/\ndeb http://mdb-bionic.dist.yandex.ru/mdb-bionic-secure stable/$(ARCH)/' | sudo tee /etc/apt/sources.list.d/mdb-bionic-secure.list",
          "echo '-----BEGIN PGP PUBLIC KEY BLOCK-----\nVersion: GnuPG v1\n\n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\nNAwjtc3xqQhs6e8yrlDAtw==\n=Zrbu\n-----END PGP PUBLIC KEY BLOCK-----' | sudo apt-key add",
          "sudo apt-get update -y",
          "sudo apt-get install yandex-archive-keyring",
          "sudo apt-get install -y tmux vim htop atop sysstat make unzip screen",
          "sudo apt-get install -y python3.8 python3-pip",
          "sudo apt-get install -y curl strace lsof less inetutils-ping net-tools gawk jq",
          "sudo apt-get install -y bzip2 rsync yandex-selfdns-client config-caching-dns"
        ]
      },
      {
          "type": "file",
          "source": "../../../authorized_keys",
          "destination": "/home/ubuntu/.ssh/authorized_keys"
      },
      {
        "type": "file",
        "source": "./bootstrap-base-1804.sh",
        "destination": "/tmp/bootstrap-base-1804.sh"
      },
      {
        "type": "shell",
        "inline": [
          "chmod +x /tmp/bootstrap-base-1804.sh",
          "sudo bash /tmp/bootstrap-base-1804.sh"
        ]
      }
    ],
    "post-processors": [
      {
          "type": "manifest",
          "output": "{{ pwd }}/yandex-builder-manifest.json",
          "strip_path": true
      },
      [
          {
              "name": "export_to_s3",
              "type": "yandex-export",
              "use_ipv6": true,
              "folder_id": "{{ user `folder_id` }}",
              "endpoint": "{{ user `endpoint` }}",
              "subnet_id": "{{ user `subnet_id` }}",
              "zone": "{{ user `zone` }}",
              "service_account_id": "{{ user `service_account_id` }}",
              "service_account_key_file": "{{ user `service_account_key_file`}}",
              "paths": [
                  "s3://yc-search-build-artifacts/compute-images/yc-search/yc-search-2if-base-{{ timestamp }}.qcow2"
              ],
              "keep_input_artifact": false
          },
          {
              "type": "manifest",
              "output": "{{ pwd }}/yandex-export-manifest.json",
              "strip_path": true
          }
      ]
  ]
}
