---
- name: Set OS distribution dependent variables
  include_vars: "{{ env }}_secrets.yml"

- name: Register yandex deb reps
  become: true
  blockinfile:
    path: /etc/apt/sources.list.d/yandex.list
    create: yes
    block: |
      deb http://common.dist.yandex.ru/common stable/all/
      deb http://common.dist.yandex.ru/common stable/amd64/
    owner: root
    group: root
    mode: '0644'
  register: yandex_reps

- name: Add yandex dist key
  become: yes
  apt_key:
    data: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----

        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
        zNicZHfu680ocsUdJKoQqA==
        =m3IH
        -----END PGP PUBLIC KEY BLOCK-----
    id: 7FCD11186050CD1A
  register: aptkey

- name: Update apt cache
  become: yes
  apt:
      update_cache: yes
  when: aptkey.changed or yandex_reps.changed

- name: Install yandex keyring
  become: true
  apt:
    pkg:
    - yandex-archive-keyring
  register: keyring

- name: Update apt cache after yandex-archive-keyring
  become: yes
  apt:
      update_cache: yes
  when: keyring.changed

- name: Install packages
  become: true
  apt:
    update_cache: yes
    cache_valid_time: 84600 #One day
    state: present
    pkg:
    - yandex-arc-launcher
    - devscripts
    - debhelper
    - mc

- name: Ensure unzip is installed.
  become: true
  package: name=unzip state=present

- name: Create packer dir
  become: true
  vars:
    packer_bin_path: /opt/yandex-packer
  file:
    path: "{{packer_bin_path}}"
    state: directory
    mode: '0755'

- name: Download and unarchive Packer.
  become: true
  vars:
    packer_version: "1.6.6"
    packer_arch: "amd64"
    packer_bin_path: /opt/yandex-packer
  unarchive:
    src: https://releases.hashicorp.com/packer/{{ packer_version }}/packer_{{ packer_version }}_linux_{{ packer_arch }}.zip
    dest: "{{ packer_bin_path }}"
    remote_src: true
    creates: "{{ packer_bin_path }}/packer"

- name: Register packer in PATH
  become: true
  lineinfile:
      path: /etc/bash.bashrc
      line: 'export PATH="$PATH:/opt/yandex-packer/"'
      regexp: '.+PATH:/opt/yandex-packer/.*'

- name: Set arc token
  lineinfile:
      path: /home/ubuntu/.arc/token
      create: true
      line: '{{ arcadia_oauth }}'
      regexp: ^.+$
      state: present
      mode: '0600'

- name: Set ya token
  lineinfile:
      path: /home/ubuntu/.ya_token
      create: true
      line: '{{ ya_token }}'
      regexp: ^.+$
      state: present
      mode: '0600'

- name: Create yatool symlink
  become: true
  file:
      src: /home/ubuntu/arc/arcadia/ya
      dest: /usr/local/bin/ya
      state: link
      force: yes
      follow: no

- name: Correct python version selected
  alternatives:
      name: python
      path: /usr/bin/python3
      link: /usr/bin/python
  become: true
