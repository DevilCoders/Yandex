#!/bin/sh


# summary of how this script can be called:
# * <postinst> `configure' <most-recently-configured-version>
# * <old-postinst> `abort-upgrade' <new version>
# * <conflictor's-postinst> `abort-remove' `in-favour' <package> <new-version>
# * <postinst> `abort-remove'
# * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#   <failed-install-package> <version> `removing'
#   <conflicting-package> <version>
#
# for details, see dh_installdeb(1) or http://www.debian.org/doc/debian-policy/

set -e

# MANUAL ADD instead of Automatically added by dh_yc_service
adduser --system --group --disabled-password --disabled-login \
        --home "/var/run/yc-snapshot" --no-create-home --quiet --force-badname \
        "yc-snapshot"
sudo usermod -aG docker yc-snapshot

case "$1" in
        configure)
                mkdir -p "/etc/yc/snapshot"
                chown root:"yc-snapshot" "/etc/yc/snapshot"
                chmod 550 "/etc/yc/snapshot"
                ;;
esac
# End MANUAL ADD instead of automatically added section

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

# clean previous images
systemctl stop yc-snapshot
for CONTAINER_ID in $(docker ps -qa -f label=a.yandex-team.ru/cloud/compute/snapshot/qemu); do
    docker rm --force $CONTAINER_ID
done
docker rmi --force snapshot_qemu_nbd

# import docker image
docker load -i /usr/share/yc-snapshot/snapshot-qemu-nbd-docker-image.tar

# need for arcadia
#DEBHELPER#

case "$1" in
    configure)
        usermod --append --groups disk yc-snapshot
        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        ;;

    *)
        echo "postinst called with unknown argument '$1'" >&2
        exit 1
        ;;
esac

# autostart if yc-snapshot enabled
systemctl show yc-snapshot | grep -q UnitFileState=enabled && systemctl start yc-snapshot

exit 0

