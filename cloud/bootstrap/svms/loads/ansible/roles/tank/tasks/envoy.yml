- name: Install Envoy
  package:
    name: getenvoy-envoy
    state: latest

- name: Ensures /etc/envoy dir exists
  file: path=/etc/envoy state=directory owner=root group=root

- name: Start envoy script
  copy:
    src=files/start-envoy.sh
    dest=/usr/local/bin/start-envoy.sh
    mode=0755
    owner=root
    group=root

- name: Restart script
  copy:
    src=files/hot-restart-envoy
    dest=/usr/local/sbin/hot-restart-envoy
    mode=0755
    owner=root
    group=root

- name: Replace Envoy config
  template: 
    src={{ item.src }}
    dest={{ item.dest }}
  with_items:
    - {src: "templates/envoy.service", dest: "/etc/systemd/system/envoy.service"}
    - {src: "templates/envoy.yaml", dest: "/etc/envoy/envoy.yaml"}
  notify:
    - Envoy reload

