apiVersion: v1
kind: ConfigMap
metadata:
  name: compute-infrapod-configmap
  namespace: compute
data:
  # capture log files from a volume mapped to /var/log/push-client
  push-client.yaml: |
    topic: yandexcloud-test--df-log

    network:
      advice: my
      master-addr: logbroker.yandex.net

      proto: pq
      master-port: 2135
      tvm-client-id: 2001289
      tvm-server-id: 2001059
      tvm-secret-file: /var/lib/push-client/tvm.secret

    logger:
      mode: stderr
      telemetry_interval: -1
      remote: 0
      level: 6

    watcher:
      state: /var/lib/push-client/state

    files:
      - name: /var/log/push-client/*

  solomon-agent.conf: |
      Logger {
          LogTo: STDERR
          Level: INFO
      }

      Python2 {
          IgnorePycFiles: true
      }

      HttpServer {
          BindPort: 8282
          MaxConnections: 100
          OutputBufferSize: 256
          MaxQueueSize: 200
          ThreadPoolName: "Io"
      }

      Storage {
          Limit: {
              Total: "2GiB"
              ShardDefault: "100MiB"
          }
      }

      ConfigLoader {
          Static {

          }
      }

      ManagementServer {
          BindAddress: "::"
          BindPort: 8283
          ThreadPoolName: "Io"
      }

      ThreadPoolProvider {
        ThreadPools: [
          {
            Name: "Io"
            Threads: 4
          },
          {
            Name: "Default"
            Threads: 8
          }
        ]
      }

  juggler-client.conf: |
      [client]
      check_bundles=cloud_infra_prod
      config_url=http://juggler-api.search.yandex.net
      targets=AUTO
      log_level=0
      checks_discover_dirs=/etc/monrun
      instance_port=31580

---
apiVersion: datadoghq.com/v1alpha1
kind: ExtendedDaemonSet
metadata:
  name: compute-infrapod
  namespace: compute
spec:
  strategy:
    canary:
      replicas: 1
  template:
    metadata:
      labels:
        name: compute-infrapod
    spec:
      nodeSelector:
        compute-node: "1"
      hostNetwork: true
      initContainers:
      - name: compute-node-push-client-init
        image: cr.yandex/yc-bootstrap/ubuntu:xenial-20210114-2.0
        command: ['bash', '-c', 'chown -R 10000:10000 /var/lib/push-client/state']
        volumeMounts:
          - name: node-push-client-state
            mountPath: /var/lib/push-client/state
      - name: compute-serialproxy-push-client-init
        image: cr.yandex/yc-bootstrap/ubuntu:xenial-20210114-2.0
        command: ['bash', '-c', 'chown -R 10000:10000 /var/lib/push-client/state']
        volumeMounts:
          - name: serialproxy-push-client-state
            mountPath: /var/lib/push-client/state
      - name: compute-metadata-push-client-init
        image: cr.yandex/yc-bootstrap/ubuntu:xenial-20210114-2.0
        command: ['bash', '-c', 'chown -R 10000:10000 /var/lib/push-client/state']
        volumeMounts:
          - name: metadata-push-client-state
            mountPath: /var/lib/push-client/state

      containers:
      - name: compute-node-push-client
        image: cr.yandex/yc-bootstrap/push-client@sha256:0648e76a4aad1cf75e09aa446d63ddf2b0bfec7ceaa01f4d2f9eb9f03773e9d5
        securityContext:
          runAsUser: 10000
          runAsGroup: 10000
          allowPrivilegeEscalation: false
        volumeMounts:
          - name: push-client-secret
            mountPath: /var/lib/push-client/tvm.secret
            readOnly: true
          - name: push-client-config
            mountPath: /etc/yandex/statbox-push-client
            readOnly: true
          - name: node-push-client-state
            mountPath: /var/lib/push-client/state
          - name: node-push-client-logs
            mountPath: /var/log/push-client/
            readOnly: true
      - name: compute-serialproxy-push-client
        image: cr.yandex/yc-bootstrap/push-client@sha256:0648e76a4aad1cf75e09aa446d63ddf2b0bfec7ceaa01f4d2f9eb9f03773e9d5
        securityContext:
          runAsUser: 10000
          runAsGroup: 10000
          allowPrivilegeEscalation: false
        volumeMounts:
          - name: push-client-secret
            mountPath: /var/lib/push-client/tvm.secret
            readOnly: true
          - name: push-client-config
            mountPath: /etc/yandex/statbox-push-client
            readOnly: true
          - name: serialproxy-push-client-state
            mountPath: /var/lib/push-client/state
          - name: serialproxy-push-client-logs
            mountPath: /var/log/push-client/
            readOnly: true
      - name: compute-metadata-push-client
        image: cr.yandex/yc-bootstrap/push-client@sha256:0648e76a4aad1cf75e09aa446d63ddf2b0bfec7ceaa01f4d2f9eb9f03773e9d5
        securityContext:
          runAsUser: 10000
          runAsGroup: 10000
          allowPrivilegeEscalation: false
        volumeMounts:
          - name: push-client-secret
            mountPath: /var/lib/push-client/tvm.secret
            readOnly: true
          - name: push-client-config
            mountPath: /etc/yandex/statbox-push-client
            readOnly: true
          - name: metadata-push-client-state
            mountPath: /var/lib/push-client/state
          - name: metadata-push-client-logs
            mountPath: /var/log/push-client/
            readOnly: true

      - name: compute-solomon-agent
        image: cr.yandex/yc-bootstrap/solomon-agent@sha256:0b3e8adfe6dafdb843a2764555420a9b2b31f14fdc1d2c67a19278276720facc
        volumeMounts:
          - name: solomon-agent-config
            mountPath: /etc/yandex/solomon-agent
      - name: compute-juggler-client
        image: cr.yandex/yc-bootstrap/juggler-client@sha256:3dbee74341e223f743acfab52534238bb8618ae698f1dc08b8a6ef15d80a9f20
        volumeMounts:
          - name: juggler-client-config
            mountPath: /etc/juggler
      volumes:
      # for push-client
      #   common secret for push-client
      - name: push-client-secret
        hostPath:
          type: File
          path: /usr/share/yc-secrets/3b7c9527-1522-11ea-bda9-a8a77dca4466/tvm.secret/1/tvm.secret
      #  common config for push-client
      - name: push-client-config
        configMap:
          name: compute-infrapod-configmap
          items:
          - key: "push-client.yaml"
            path: "push-client.yaml"
      #   push-client for node
      - name: node-push-client-state
        hostPath:
          type: DirectoryOrCreate
          path: /var/lib/compute/push-client/node
      - name: node-push-client-logs
        hostPath:
          type: DirectoryOrCreate
          path: /var/log/compute/node/
      #   push-client for serialproxy
      - name: serialproxy-push-client-state
        hostPath:
          type: DirectoryOrCreate
          path: /var/lib/compute/push-client/serialproxy
      - name: serialproxy-push-client-logs
        hostPath:
          type: DirectoryOrCreate
          path: /var/log/compute/serialproxy/
      #   push-client for metadata
      - name: metadata-push-client-state
        hostPath:
          type: DirectoryOrCreate
          path: /var/lib/compute/push-client/metadata
      - name: metadata-push-client-logs
        hostPath:
          type: DirectoryOrCreate
          path: /var/log/compute/metadata/

       # common solomon agent for pod
      - name: solomon-agent-config
        configMap:
          name: compute-infrapod-configmap
          items:
            - key: "solomon-agent.conf"
              path: "agent.conf"
      # common juggler client for pod
      - name: juggler-client-config
        configMap:
          name: compute-infrapod-configmap
          items:
            - key: "juggler-client.conf"
              path: "client.conf"
