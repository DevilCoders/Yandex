{
    "description": "This partial pipeline updates namespaces in one selected stand and called from top-level pipelines. It MUST not be executed manually",
    "appConfig": {},
    "application": "kten-namespaces",
    "id": "799aff4d-8c84-4dae-8c10-8844efa2ebec",
    "index": 1,
    "keepWaitingPipelines": false,
    "limitConcurrent": true,
    "name": "apply-az(HW&SVM)",
    "parameterConfig": [
        {
            "default": "",
            "description": "CLOUD-XXXXXX",
            "hasOptions": false,
            "label": "Existing release ticket",
            "name": "releaseTicket",
            "options": [
                {
                    "value": ""
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "",
            "description": "",
            "hasOptions": true,
            "label": "Stand",
            "name": "stand",
            "options": [
                {
                    "value": "testing"
                },
                {
                    "value": "preprod"
                },
                {
                    "value": "prod"
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "",
            "description": "",
            "hasOptions": true,
            "label": "AZ",
            "name": "az",
            "options": [
                {
                    "value": "a"
                },
                {
                    "value": "b"
                },
                {
                    "value": "c"
                }
            ],
            "pinned": true,
            "required": true
        }
    ],
    "spelEvaluator": "v4",
    "stages": [
        {
            "failOnFailedExpressions": true,
            "name": "Configure context",
            "refId": "1",
            "requisiteStageRefIds": [],
            "type": "evaluateVariables",
            "variables": [
                {
                    "key": "stand",
                    "value": "${parameters.stand}"
                },
                {
                    "key": "infraEnvironmentID",
                    "value": "${parameters.stand == \"testing\" ? 6083 : parameters.stand == \"preprod\" ? 6084 : parameters.stand == \"prod\" ? 6085 : FAIL }"
                },
                {
                    "key": "releaseTicket",
                    "value": "${parameters.releaseTicket}"
                },
                {
                    "key": "az",
                    "value": "${parameters.az}"
                },
                {
                    "key": "dc",
                    "value": "${parameters.az == \"a\" ? \"vla\" : parameters.az == \"b\" ? \"sas\" : parameters.az == \"c\" ? \"myt\" : FAIL }"
                },
                {
                    "key": "triggerUserLogin",
                    "value": "${trigger.user.replace(\"@yandex-team.ru\", \"\")}"
                },
                {
                    "key": "spinnakerExecutionURL",
                    "value": "https://spinnaker.cloud.yandex.net/#/applications/kten-namespaces/executions/${execution.Id}"
                }
            ]
        },
        {
            "description": "Started by: ${triggerUserLogin} Execution: ${spinnakerExecutionURL}",
            "environmentId": "${infraEnvironmentID}",
            "eventType": "maintenance",
            "myt": "${dc == \"myt\"}",
            "name": "Create Infra event",
            "refId": "10",
            "requisiteStageRefIds": [
                "1"
            ],
            "sas": "${dc == \"sas\"}",
            "serviceId": 4012,
            "severity": "major",
            "tickets": "${releaseTicket}",
            "title": "Release",
            "type": "createInfraEvent",
            "vla": "${dc == \"vla\"}"
        },
        {
            "account": "kten-${stand}-${az}-admin-ns",
            "cloudProvider": "kubernetes",
            "completeOtherBranchesThenFail": false,
            "continuePipeline": true,
            "failPipeline": false,
            "manifestArtifact": {
                "artifactAccount": "bb.yandex-team.ru",
                "name": "${stand}/ru-central1-${az}/manifests/namespaces/namespaces/namespaces/templates/namespaces.yaml",
                "reference": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/${stand}/ru-central1-${az}/manifests/namespaces/namespaces/namespaces/templates/namespaces.yaml",
                "type": "bitbucket/file"
            },
            "moniker": {
                "app": "kten-namespaces"
            },
            "name": "Apply namespaces in HW cluster",
            "namespaceOverride": "default",
            "refId": "20",
            "requisiteStageRefIds": [
                "10"
            ],
            "skipExpressionEvaluation": false,
            "source": "artifact",
            "stageTimeoutMs": 600000,
            "trafficManagement": {
                "enabled": false,
                "options": {
                    "enableTraffic": false,
                    "services": []
                }
            },
            "type": "deployManifest"
        },
        {
            "account": "kten-${stand}-${az}-svm-admin-ns",
            "cloudProvider": "kubernetes",
            "completeOtherBranchesThenFail": false,
            "continuePipeline": true,
            "failPipeline": false,
            "manifestArtifact": {
                "artifactAccount": "bb.yandex-team.ru",
                "name": "${stand}/ru-central1-${az}-svm/manifests/namespaces/namespaces/namespaces/templates/namespaces.yaml",
                "reference": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/${stand}/ru-central1-${az}-svm/manifests/namespaces/namespaces/namespaces/templates/namespaces.yaml",
                "type": "bitbucket/file"
            },
            "moniker": {
                "app": "kten-namespaces"
            },
            "name": "Apply namespaces in SVM cluster",
            "namespaceOverride": "default",
            "refId": "30",
            "requisiteStageRefIds": [
                "10"
            ],
            "skipExpressionEvaluation": false,
            "source": "artifact",
            "trafficManagement": {
                "enabled": false,
                "options": {
                    "enableTraffic": false
                }
            },
            "type": "deployManifest"
        },
        {
            "name": "Close Infra event",
            "refId": "50",
            "requisiteStageRefIds": [
                "20",
                "30"
            ],
            "type": "closeInfraEvent"
        },
        {
            "name": "Check Success",
            "preconditions": [
                {
                    "context": {
                        "stageName": "Apply namespaces in HW cluster",
                        "stageStatus": "SUCCEEDED"
                    },
                    "failPipeline": true,
                    "type": "stageStatus"
                },
                {
                    "context": {
                        "stageName": "Apply namespaces in SVM cluster",
                        "stageStatus": "SUCCEEDED"
                    },
                    "failPipeline": true,
                    "type": "stageStatus"
                }
            ],
            "refId": "100",
            "requisiteStageRefIds": [
                "50"
            ],
            "type": "checkPreconditions"
        }
    ],
    "triggers": []
}
