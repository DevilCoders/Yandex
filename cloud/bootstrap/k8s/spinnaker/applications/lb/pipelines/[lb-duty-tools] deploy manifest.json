{
    "application": "lb",
    "id": "312d7dc5-4e8c-486e-acc2-e23e8dc7b39c",
    "index": 1,
    "keepWaitingPipelines": false,
    "limitConcurrent": true,
    "name": "[lb-duty-tools] deploy manifest",
    "parameterConfig": [
        {
            "default": "",
            "description": "",
            "hasOptions": false,
            "label": "Release ticket ID",
            "name": "ticket",
            "options": [
                {
                    "value": ""
                }
            ],
            "pinned": false,
            "required": true
        },
        {
            "default": "",
            "description": "",
            "hasOptions": true,
            "label": "",
            "name": "installation",
            "options": [
                {
                    "value": "testing"
                },
                {
                    "value": "preprod"
                },
                {
                    "value": "prod"
                }
            ],
            "pinned": false,
            "required": true
        },
        {
            "default": "",
            "description": "",
            "hasOptions": true,
            "label": "",
            "name": "az",
            "options": [
                {
                    "value": "a"
                },
                {
                    "value": "b"
                },
                {
                    "value": "c"
                }
            ],
            "pinned": false,
            "required": true
        }
    ],
    "spelEvaluator": "v4",
    "stages": [
        {
            "description": "Triggered by: ${trigger.user} for ${ticket}. Execution: https://spinnaker.cloud.yandex.net/#/applications/lb/executions/${trigger.executionId}",
            "environmentId": "${installation_parameters[parameters.installation].infra.envId}",
            "eventType": "maintenance",
            "myt": "${active_zones[parameters.az].myt}",
            "name": "Create Infra event",
            "refId": "4",
            "requisiteStageRefIds": [
                "6"
            ],
            "sas": "${active_zones[parameters.az].sas}",
            "serviceId": "${installation_parameters[parameters.installation].infra.serviceId}",
            "severity": "major",
            "tickets": "${parameters.ticket}",
            "title": "k8s deploy ${parameters.installation} ${parameters.az}",
            "type": "createInfraEvent",
            "vla": "${active_zones[parameters.az].vla}"
        },
        {
            "name": "Close Infra event",
            "refId": "5",
            "requisiteStageRefIds": [
                "7"
            ],
            "type": "closeInfraEvent"
        },
        {
            "failOnFailedExpressions": true,
            "name": "Initial Variables",
            "refId": "6",
            "requisiteStageRefIds": [],
            "type": "evaluateVariables",
            "variables": [
                {
                    "key": "ticket",
                    "value": "${parameters.ticket}"
                },
                {
                    "key": "installation_parameters",
                    "value": {
                        "preprod": {
                            "infra": {
                                "envId": 6057,
                                "serviceId": 4007
                            }
                        },
                        "prod": {
                            "infra": {
                                "envId": 6056,
                                "serviceId": 4007
                            }
                        },
                        "testing": {
                            "infra": {
                                "envId": 6058,
                                "serviceId": 4007
                            }
                        }
                    }
                },
                {
                    "key": "active_zones",
                    "value": {
                        "a": {
                            "myt": false,
                            "sas": false,
                            "vla": true
                        },
                        "b": {
                            "myt": false,
                            "sas": true,
                            "vla": false
                        },
                        "c": {
                            "myt": true,
                            "sas": false,
                            "vla": false
                        }
                    }
                },
                {
                    "key": "deploy_parameters",
                    "value": {
                        "preprod": {
                            "a": {
                                "account": "kten_preprod-svm-a_cgw",
                                "manifest": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/preprod/ru-central1-a-svm/manifests/cgw/load-balancer-go-duty-tools/templates/dutytools.yaml"
                            },
                            "b": {
                                "account": "kten_preprod-svm-b_cgw",
                                "manifest": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/preprod/ru-central1-b-svm/manifests/cgw/load-balancer-go-duty-tools/templates/dutytools.yaml"
                            },
                            "c": {
                                "account": "kten_preprod-svm-c_cgw",
                                "manifest": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/preprod/ru-central1-c-svm/manifests/cgw/load-balancer-go-duty-tools/templates/dutytools.yaml"
                            }
                        },
                        "prod": {
                            "a": {
                                "account": "kten_prod-svm-a_cgw",
                                "manifest": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/prod/ru-central1-a-svm/manifests/cgw/load-balancer-go-duty-tools/templates/dutytools.yaml"
                            },
                            "b": {
                                "account": "kten_prod-svm-b_cgw",
                                "manifest": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/prod/ru-central1-b-svm/manifests/cgw/load-balancer-go-duty-tools/templates/dutytools.yaml"
                            },
                            "c": {
                                "account": "kten_prod-svm-c_cgw",
                                "manifest": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/prod/ru-central1-c-svm/manifests/cgw/load-balancer-go-duty-tools/templates/dutytools.yaml"
                            }
                        },
                        "testing": {
                            "a": {
                                "account": "kten_testing-svm-a_cgw",
                                "manifest": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/testing/ru-central1-a-svm/manifests/cgw/load-balancer-go-duty-tools/templates/dutytools.yaml"
                            },
                            "b": {
                                "account": "kten_testing-svm-b_cgw",
                                "manifest": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/testing/ru-central1-b-svm/manifests/cgw/load-balancer-go-duty-tools/templates/dutytools.yaml"
                            },
                            "c": {
                                "account": "kten_testing-svm-c_cgw",
                                "manifest": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/testing/ru-central1-c-svm/manifests/cgw/load-balancer-go-duty-tools/templates/dutytools.yaml"
                            }
                        }
                    }
                }
            ]
        },
        {
            "account": "${deploy_parameters[parameters.installation][parameters.az].account}",
            "cloudProvider": "kubernetes",
            "completeOtherBranchesThenFail": false,
            "continuePipeline": true,
            "failPipeline": false,
            "manifestArtifact": {
                "artifactAccount": "bb.yandex-team.ru",
                "id": "d2e43d2d-4e67-4171-baf3-d63f031c28c9",
                "reference": "${deploy_parameters[parameters.installation][parameters.az].manifest}",
                "type": "bitbucket/file"
            },
            "moniker": {
                "app": "lb"
            },
            "name": "Deploy (Manifest)",
            "refId": "7",
            "requisiteStageRefIds": [
                "4"
            ],
            "skipExpressionEvaluation": false,
            "source": "artifact",
            "trafficManagement": {
                "enabled": false,
                "options": {
                    "enableTraffic": false,
                    "services": []
                }
            },
            "type": "deployManifest"
        },
        {
            "name": "Check Success",
            "preconditions": [
                {
                    "context": {
                        "stageName": "Deploy (Manifest)",
                        "stageStatus": "SUCCEEDED"
                    },
                    "failPipeline": true,
                    "type": "stageStatus"
                }
            ],
            "refId": "8",
            "requisiteStageRefIds": [
                "5"
            ],
            "type": "checkPreconditions"
        }
    ],
    "triggers": []
}
