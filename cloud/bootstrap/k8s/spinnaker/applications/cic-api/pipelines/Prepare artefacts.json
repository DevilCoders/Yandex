{
    "appConfig": {},
    "application": "cic-api",
    "id": "a927b724-66af-40ba-b91e-adbd742e5cde",
    "index": 3,
    "keepWaitingPipelines": false,
    "limitConcurrent": true,
    "name": "Prepare artefacts",
    "parameterConfig": [
        {
            "default": "",
            "description": "Build from https://teamcity.aw.cloud.yandex.net/viewType.html?buildTypeId=CiC_API_ConfigPlane_Helm\u0026branch_Helm=%3Cdefault%3E\u0026tab=buildTypeStatusDiv",
            "hasOptions": false,
            "label": "Helm build vesion",
            "name": "helmVersion",
            "options": [
                {
                    "value": ""
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "vpc-api",
            "description": "",
            "hasOptions": false,
            "label": "Kubernetes namespace",
            "name": "k8sNamespace",
            "options": [
                {
                    "value": ""
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "",
            "description": "",
            "hasOptions": true,
            "label": "vpc-api, cic-api",
            "name": "k8sServiceName",
            "options": [
                {
                    "value": "vpc-api"
                },
                {
                    "value": "cic-api"
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "",
            "description": "User login to review PR",
            "hasOptions": false,
            "label": "",
            "name": "triggerUserLogin",
            "options": [
                {
                    "value": ""
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "",
            "description": "",
            "hasOptions": true,
            "label": "Deployment cluster name",
            "name": "clusterName",
            "options": [
                {
                    "value": "TESTING"
                },
                {
                    "value": "PREPROD"
                },
                {
                    "value": "PROD"
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "",
            "description": "",
            "hasOptions": false,
            "label": "Execution Markdown Link",
            "name": "spinnakerExecutionMD",
            "options": [
                {
                    "value": ""
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "",
            "description": "",
            "hasOptions": false,
            "label": "Startrek release ticket ID",
            "name": "ticket",
            "options": [
                {
                    "value": ""
                }
            ],
            "pinned": true,
            "required": true
        }
    ],
    "spelEvaluator": "v4",
    "stages": [
        {
            "actions": [
                {
                    "actionId": "cab37f31-ec40-4717-b3d2-51341c07e67c",
                    "actionName": "Create branch",
                    "actionType": "createBranch",
                    "bitbucketProfile": "bb.yandex-team.ru",
                    "branchName": "${branchName}",
                    "project": "cloud",
                    "repo": "k8s-deploy",
                    "startPoint": "master"
                },
                {
                    "actionId": "422128fa-324f-4233-85a9-b146dff4d20f",
                    "actionName": "Bump VLA",
                    "actionType": "editFile",
                    "bitbucketProfile": "bb.yandex-team.ru",
                    "branch": "${branchName}",
                    "changes": [
                        {
                            "changeType": "regexReplace",
                            "expression": "version: (.+)",
                            "replacement": "version: ${parameters.helmVersion}"
                        }
                    ],
                    "commitMessage": "Bump helm version for ${parameters.clusterName} VLA (ru-central1-a)",
                    "filePath": "${parameters.clusterName.toLowerCase()}/ru-central1-a-svm/helmfiles/${parameters.k8sNamespace}/${parameters.k8sServiceName}/helmfile.yaml",
                    "project": "cloud",
                    "repo": "k8s-deploy"
                },
                {
                    "actionId": "6d1ff86d-94d2-43bb-a8eb-d4402b79776a",
                    "actionName": "Bump SAS",
                    "actionType": "editFile",
                    "bitbucketProfile": "bb.yandex-team.ru",
                    "branch": "${branchName}",
                    "changes": [
                        {
                            "changeType": "regexReplace",
                            "expression": "version: (.+)",
                            "replacement": "version: ${parameters.helmVersion}"
                        }
                    ],
                    "commitMessage": "Bump helm version for ${parameters.clusterName} SAS (ru-central1-b)",
                    "filePath": "${parameters.clusterName.toLowerCase()}/ru-central1-b-svm/helmfiles/${parameters.k8sNamespace}/${parameters.k8sServiceName}/helmfile.yaml",
                    "project": "cloud",
                    "repo": "k8s-deploy"
                },
                {
                    "actionId": "da6fa679-15c9-44f1-8f9a-cf13b251ec3d",
                    "actionName": "Bump MYT",
                    "actionType": "editFile",
                    "bitbucketProfile": "bb.yandex-team.ru",
                    "branch": "${branchName}",
                    "changes": [
                        {
                            "changeType": "regexReplace",
                            "expression": "version: (.+)",
                            "replacement": "version: ${parameters.helmVersion}"
                        }
                    ],
                    "commitMessage": "Bump helm version for ${parameters.clusterName} MYT (ru-central1-c)",
                    "filePath": "${parameters.clusterName.toLowerCase()}/ru-central1-c-svm/helmfiles/${parameters.k8sNamespace}/${parameters.k8sServiceName}/helmfile.yaml",
                    "project": "cloud",
                    "repo": "k8s-deploy"
                },
                {
                    "actionId": "e13cf689-406c-4fc2-95ba-0572504b3f2b",
                    "actionName": "Create PR",
                    "actionType": "createPullRequest",
                    "bitbucketProfile": "bb.yandex-team.ru",
                    "description": "Automatic bump ${parameters.k8sServiceName} helm version for ${parameters.clusterName} to ${parameters.helmVersion} via Spinnaker execution: ${parameters.spinnakerExecutionMD}",
                    "findExisting": true,
                    "fromRef": "${branchName}",
                    "outputVariable": "bitbucketPR",
                    "project": "cloud",
                    "repo": "k8s-deploy",
                    "reviewers": [
                        "${parameters.triggerUserLogin}"
                    ],
                    "title": "Bump ${parameters.k8sServiceName} ${parameters.clusterName} to ${parameters.helmVersion}",
                    "toRef": "master"
                }
            ],
            "name": "Bump helm version",
            "refId": "5",
            "requisiteStageRefIds": [
                "9"
            ],
            "type": "bitbucket"
        },
        {
            "attempts": 3,
            "buildConfigurationId": "ConfigPlane_GenerateK8sManifests",
            "buildParameters": [],
            "logicalBranchName": "${branchName}",
            "name": "Generate manifests",
            "refId": "7",
            "requisiteStageRefIds": [
                "5"
            ],
            "tcProfile": "aw",
            "type": "teamcityBuild"
        },
        {
            "actions": [
                {
                    "actionId": "405835ea-eeaa-4305-b6c1-2afb69981e11",
                    "actionName": "Wait for PR merge",
                    "actionType": "waitPullRequest",
                    "source": "priorAction",
                    "sourceActionId": "e13cf689-406c-4fc2-95ba-0572504b3f2b"
                }
            ],
            "name": "Wait PR merge",
            "refId": "8",
            "requisiteStageRefIds": [
                "7"
            ],
            "type": "bitbucket"
        },
        {
            "failOnFailedExpressions": true,
            "name": "Branch name",
            "refId": "9",
            "requisiteStageRefIds": [],
            "type": "evaluateVariables",
            "variables": [
                {
                    "key": "branchName",
                    "value": "release-${parameters.ticket}-${parameters.clusterName.toLowerCase()}"
                }
            ]
        }
    ],
    "triggers": []
}
