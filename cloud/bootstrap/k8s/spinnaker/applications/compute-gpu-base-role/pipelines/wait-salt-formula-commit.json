{
    "appConfig": {},
    "application": "compute-gpu-base-role",
    "id": "337bb120-3577-4b0d-81d3-a8fc2e731fb4",
    "index": 4,
    "keepWaitingPipelines": false,
    "limitConcurrent": true,
    "name": "wait-salt-formula-commit",
    "parameterConfig": [
        {
            "default": "",
            "description": "",
            "hasOptions": false,
            "label": "",
            "name": "saltBranchLastCommit",
            "options": [
                {
                    "value": ""
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "",
            "description": "",
            "hasOptions": false,
            "label": "",
            "name": "saltFormulaVersion",
            "options": [
                {
                    "value": ""
                }
            ],
            "pinned": true,
            "required": false
        }
    ],
    "spelEvaluator": "v4",
    "stages": [
        {
            "buildConfigurationId": "Cloud_Compute_Packages_Gpu_GetSaltFormulaForHeadGpu",
            "buildParameters": [
                {
                    "key": "env.CHECK_COMMIT",
                    "value": "${saltBranchLastCommit}"
                }
            ],
            "name": "[check-salt-formula] Get Latest Version #1",
            "parseArtifacts": [
                {
                    "artifactPath": "version.json",
                    "outputVariable": "saltFormulaVersionArtifactFromTC"
                }
            ],
            "queueAtTop": true,
            "refId": "1",
            "requisiteStageRefIds": [
                "3"
            ],
            "tcProfile": "yandex",
            "type": "teamcityBuild"
        },
        {
            "failOnFailedExpressions": true,
            "name": "[check-salt-formula] Parse Json Version #1",
            "refId": "2",
            "requisiteStageRefIds": [
                "1"
            ],
            "type": "evaluateVariables",
            "variables": [
                {
                    "key": "saltFormulaVersion",
                    "value": "${saltFormulaVersionArtifactFromTC[\"version\"]}"
                },
                {
                    "key": "containsCommit",
                    "value": "${saltFormulaVersionArtifactFromTC[\"contains_commit\"]}"
                }
            ]
        },
        {
            "failOnFailedExpressions": true,
            "name": "[check-salt-formula] Configure Context",
            "refId": "3",
            "requisiteStageRefIds": [],
            "type": "evaluateVariables",
            "variables": [
                {
                    "key": "saltBranchLastCommit",
                    "value": "${parameters.saltBranchLastCommit}"
                }
            ]
        },
        {
            "name": "[check-salt-formula] Wait before retry #1",
            "refId": "4",
            "requisiteStageRefIds": [
                "15"
            ],
            "skipWaitText": "Skipped timeout",
            "type": "wait",
            "waitTime": 10
        },
        {
            "name": "[check-salt-formula] Complete pipelie #1",
            "preconditions": [
                {
                    "context": {
                        "expression": "#toBoolean(containsCommit) == true",
                        "failureMessage": "Completed"
                    },
                    "failPipeline": false,
                    "type": "expression"
                }
            ],
            "refId": "5",
            "requisiteStageRefIds": [
                "2"
            ],
            "stageEnabled": {
                "expression": "#toBoolean(containsCommit) == true",
                "type": "expression"
            },
            "type": "checkPreconditions"
        },
        {
            "buildConfigurationId": "Cloud_Compute_Packages_Gpu_GetSaltFormulaForHeadGpu",
            "buildParameters": [
                {
                    "key": "env.CHECK_COMMIT",
                    "value": "${saltBranchLastCommit}"
                }
            ],
            "name": "[check-salt-formula] Get Latest Version #2",
            "parseArtifacts": [
                {
                    "artifactPath": "version.json",
                    "outputVariable": "saltFormulaVersionArtifactFromTC"
                }
            ],
            "queueAtTop": true,
            "refId": "7",
            "requisiteStageRefIds": [
                "4"
            ],
            "tcProfile": "yandex",
            "type": "teamcityBuild"
        },
        {
            "name": "[check-salt-formula] Wait before retry #2",
            "refId": "8",
            "requisiteStageRefIds": [
                "16"
            ],
            "skipWaitText": "Skipped timeout",
            "type": "wait",
            "waitTime": 20
        },
        {
            "name": "[check-salt-formula] Complete pipelie #2",
            "preconditions": [
                {
                    "context": {
                        "expression": "#toBoolean(containsCommit) == true",
                        "failureMessage": "Completed"
                    },
                    "failPipeline": false,
                    "type": "expression"
                }
            ],
            "refId": "9",
            "requisiteStageRefIds": [
                "14"
            ],
            "stageEnabled": {
                "expression": "#toBoolean(containsCommit) == true",
                "type": "expression"
            },
            "type": "checkPreconditions"
        },
        {
            "buildConfigurationId": "Cloud_Compute_Packages_Gpu_GetSaltFormulaForHeadGpu",
            "buildParameters": [
                {
                    "key": "env.CHECK_COMMIT",
                    "value": "${saltBranchLastCommit}"
                }
            ],
            "name": "[check-salt-formula] Get Latest  Version #3",
            "parseArtifacts": [
                {
                    "artifactPath": "version.json",
                    "outputVariable": "saltFormulaVersionArtifactFromTC"
                }
            ],
            "queueAtTop": true,
            "refId": "10",
            "requisiteStageRefIds": [
                "8"
            ],
            "tcProfile": "yandex",
            "type": "teamcityBuild"
        },
        {
            "failOnFailedExpressions": true,
            "name": "[check-salt-formula] Parse Json Version #3",
            "refId": "11",
            "requisiteStageRefIds": [
                "10"
            ],
            "type": "evaluateVariables",
            "variables": [
                {
                    "key": "saltFormulaVersion",
                    "value": "${saltFormulaVersionArtifactFromTC[\"version\"]}"
                },
                {
                    "key": "containsCommit",
                    "value": "${saltFormulaVersionArtifactFromTC[\"contains_commit\"]}"
                }
            ]
        },
        {
            "completeOtherBranchesThenFail": false,
            "continuePipeline": true,
            "failPipeline": false,
            "name": "[check-salt-formula] Fail pipeline #3",
            "preconditions": [
                {
                    "context": {
                        "expression": "${#toBoolean(parameters.containsCommit)} == true",
                        "failureMessage": "Failed to get version contains commit ${saltBranchLastCommit}"
                    },
                    "failPipeline": true,
                    "type": "expression"
                }
            ],
            "refId": "12",
            "requisiteStageRefIds": [
                "11"
            ],
            "stageEnabled": {
                "expression": "#toBoolean(containsCommit) != true",
                "type": "expression"
            },
            "type": "checkPreconditions"
        },
        {
            "name": "[check-salt-formula] Complete pipeline #3",
            "preconditions": [
                {
                    "context": {
                        "expression": "#toBoolean(containsCommit) == true",
                        "failureMessage": "Completed"
                    },
                    "failPipeline": false,
                    "type": "expression"
                }
            ],
            "refId": "13",
            "requisiteStageRefIds": [
                "11"
            ],
            "stageEnabled": {
                "expression": "#toBoolean(containsCommit) == true",
                "type": "expression"
            },
            "type": "checkPreconditions"
        },
        {
            "failOnFailedExpressions": true,
            "name": "[check-salt-formula] Parse Json Version #2",
            "refId": "14",
            "requisiteStageRefIds": [
                "7"
            ],
            "type": "evaluateVariables",
            "variables": [
                {
                    "key": "saltFormulaVersion",
                    "value": "${saltFormulaVersionArtifactFromTC[\"version\"]}"
                },
                {
                    "key": "containsCommit",
                    "value": "${saltFormulaVersionArtifactFromTC[\"contains_commit\"]}"
                }
            ]
        },
        {
            "name": "[check-salt-formula] Is completed #1",
            "preconditions": [
                {
                    "context": {
                        "expression": "#toBoolean(containsCommit) != true",
                        "failureMessage": "Check completed"
                    },
                    "failPipeline": false,
                    "type": "expression"
                }
            ],
            "refId": "15",
            "requisiteStageRefIds": [
                "2"
            ],
            "type": "checkPreconditions"
        },
        {
            "name": "[check-salt-formula] Is completed #2",
            "preconditions": [
                {
                    "context": {
                        "expression": "#toBoolean(containsCommit) != true",
                        "failureMessage": "Check completed"
                    },
                    "failPipeline": false,
                    "type": "expression"
                }
            ],
            "refId": "16",
            "requisiteStageRefIds": [
                "14"
            ],
            "type": "checkPreconditions"
        }
    ],
    "triggers": []
}
