{
    "application": "compute-api",
    "id": "603a4b06-8535-4cc3-8e56-6ecd6749ace8",
    "index": 2,
    "keepWaitingPipelines": false,
    "limitConcurrent": true,
    "name": "deploy-service-on-stand",
    "parameterConfig": [
        {
            "default": "",
            "description": "Startrek ticket ID",
            "hasOptions": false,
            "label": "",
            "name": "releaseTicket",
            "options": [
                {
                    "value": ""
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "",
            "description": "AZ one-letter name",
            "hasOptions": true,
            "label": "",
            "name": "az",
            "options": [
                {
                    "value": "a"
                },
                {
                    "value": "b"
                },
                {
                    "value": "c"
                }
            ],
            "pinned": true,
            "required": true
        },
        {
            "default": "",
            "description": "Stand name",
            "hasOptions": true,
            "label": "",
            "name": "stand",
            "options": [
                {
                    "value": "testing"
                },
                {
                    "value": "preprod"
                },
                {
                    "value": "prod"
                }
            ],
            "pinned": true,
            "required": true
        }
    ],
    "spelEvaluator": "v4",
    "stages": [
        {
            "account": "kten_${stand}-${az}-svm_compute-api",
            "cloudProvider": "kubernetes",
            "manifestArtifact": {
                "artifactAccount": "bb.yandex-team.ru",
                "id": "79d9556d-ded0-4bb2-8439-16c803ab40e7",
                "reference": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/${stand}/ru-central1-${az}-svm/manifests/compute/compute-api/templates/compute-head.yaml",
                "type": "bitbucket/file"
            },
            "moniker": {
                "app": "compute-api"
            },
            "name": "Deploy k8s - compute-head",
            "namespaceOverride": "",
            "refId": "1",
            "requisiteStageRefIds": [
                "3"
            ],
            "skipExpressionEvaluation": true,
            "source": "artifact",
            "trafficManagement": {
                "enabled": false,
                "options": {
                    "enableTraffic": false,
                    "services": []
                }
            },
            "type": "deployManifest"
        },
        {
            "failOnFailedExpressions": true,
            "name": "Configure context",
            "refId": "2",
            "requisiteStageRefIds": [],
            "type": "evaluateVariables",
            "variables": [
                {
                    "key": "az",
                    "value": "${parameters.az}"
                },
                {
                    "key": "dc",
                    "value": "${parameters.az == \"a\" ? \"vla\" : parameters.az == \"b\" ? \"sas\" : parameters.az == \"c\" ? \"myt\" : FAIL }"
                },
                {
                    "key": "stand",
                    "value": "${parameters.stand}"
                },
                {
                    "key": "releaseTicket",
                    "value": "${parameters.releaseTicket}"
                },
                {
                    "key": "spinnakerExecutionURL",
                    "value": "https://spinnaker.cloud.yandex.net/#/applications/salt-operator/executions/${execution.Id}"
                },
                {
                    "key": "spinnakerExecutionMD",
                    "value": "[${execution.Id}](https://spinnaker.cloud.yandex.net/#/applications/salt-operator/executions/${execution.Id})"
                },
                {
                    "key": "today",
                    "value": "${new java.text.SimpleDateFormat(\"dd.MM.yyyy\").format(new java.util.Date())}"
                },
                {
                    "key": "triggerUserLogin",
                    "value": "${trigger.user.replace(\"@yandex-team.ru\", \"\")}"
                },
                {
                    "key": "infraEnvironmentID",
                    "value": "${parameters.stand == \"testing\" ? 409 : parameters.stand == \"preprod\" ? 370 : parameters.stand == \"prod\" ? 369 : FAIL }"
                },
                {
                    "key": "namespace",
                    "value": "compute-api"
                }
            ]
        },
        {
            "description": "Started by: ${triggerUserLogin} Execution: ${spinnakerExecutionURL}",
            "environmentId": "${infraEnvironmentID}",
            "eventType": "maintenance",
            "myt": "${dc == \"myt\"}",
            "name": "Create Infra event",
            "refId": "3",
            "requisiteStageRefIds": [
                "2"
            ],
            "sas": "${dc == \"sas\"}",
            "serviceId": "283",
            "severity": "major",
            "tickets": "${releaseTicket}",
            "title": "Release",
            "type": "createInfraEvent",
            "vla": "${dc == \"vla\"}"
        },
        {
            "account": "kten_${stand}-${az}-svm_compute-api",
            "cloudProvider": "kubernetes",
            "manifestArtifact": {
                "artifactAccount": "bb.yandex-team.ru",
                "id": "79d9556d-ded0-4bb2-8439-16c803ab40e7",
                "reference": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/${stand}/ru-central1-${az}-svm/manifests/compute/compute-api/templates/compute-tasks.yaml",
                "type": "bitbucket/file"
            },
            "moniker": {
                "app": "compute-api"
            },
            "name": "Deploy k8s - compute-tasks",
            "namespaceOverride": "",
            "refId": "4",
            "requisiteStageRefIds": [
                "3"
            ],
            "skipExpressionEvaluation": true,
            "source": "artifact",
            "trafficManagement": {
                "enabled": false,
                "options": {
                    "enableTraffic": false,
                    "services": []
                }
            },
            "type": "deployManifest"
        },
        {
            "account": "kten_${stand}-${az}-svm_compute-api",
            "cloudProvider": "kubernetes",
            "manifestArtifact": {
                "artifactAccount": "bb.yandex-team.ru",
                "id": "79d9556d-ded0-4bb2-8439-16c803ab40e7",
                "reference": "https://bb.yandex-team.ru/projects/CLOUD/repos/k8s-deploy/raw/${stand}/ru-central1-${az}-svm/manifests/compute/scheduler/templates/scheduler.yaml",
                "type": "bitbucket/file"
            },
            "moniker": {
                "app": "compute-api"
            },
            "name": "Deploy k8s - scheduler",
            "namespaceOverride": "",
            "refId": "5",
            "requisiteStageRefIds": [
                "3"
            ],
            "skipExpressionEvaluation": true,
            "source": "artifact",
            "trafficManagement": {
                "enabled": false,
                "options": {
                    "enableTraffic": false,
                    "services": []
                }
            },
            "type": "deployManifest"
        },
        {
            "name": "Close Infra event",
            "refId": "6",
            "requisiteStageRefIds": [
                "1",
                "4",
                "5"
            ],
            "type": "closeInfraEvent"
        },
        {
            "name": "Check Preconditions",
            "preconditions": [
                {
                    "context": {
                        "stageName": "Deploy k8s - compute-head",
                        "stageStatus": "SUCCEEDED"
                    },
                    "failPipeline": true,
                    "type": "stageStatus"
                },
                {
                    "context": {
                        "stageName": "Deploy k8s - compute-tasks",
                        "stageStatus": "SUCCEEDED"
                    },
                    "failPipeline": true,
                    "type": "stageStatus"
                },
                {
                    "context": {
                        "stageName": "Deploy k8s - scheduler",
                        "stageStatus": "SUCCEEDED"
                    },
                    "failPipeline": true,
                    "type": "stageStatus"
                }
            ],
            "refId": "7",
            "requisiteStageRefIds": [
                "6"
            ],
            "type": "checkPreconditions"
        },
        {
            "application": "compute-api",
            "failPipeline": true,
            "name": "Notify author",
            "pipeline": "288b49b6-0c37-4733-a329-e4fae22701a7",
            "pipelineParameters": {
                "message": "Deployment ${namespace} on ${stand} zone ${dc.toUpperCase()} has been finished."
            },
            "refId": "8",
            "requisiteStageRefIds": [
                "6"
            ],
            "type": "pipeline",
            "waitForCompletion": true
        }
    ],
    "triggers": []
}
