USE %YT_CLUSTER%;

INSERT INTO `%TMP_TABLE_PATH%` WITH TRUNCATE 
SELECT MAX_BY(new_lead.lead_id, new_lead.created) AS mkto_lead_id, MAX_BY(new_lead.marketo_id, new_lead.created) AS mkto_id, dwh_id FROM `//home/cloud_analytics/import/marketo/new_lead` AS new_lead
LEFT ONLY JOIN `//home/cloud_analytics/leads/dyn_table` AS dyn_table
ON dyn_table.mkto_lead_id = new_lead.lead_id
WHERE new_lead.lead_dwh_id IS NOT NULL
GROUP BY new_lead.lead_dwh_id AS dwh_id
ORDER BY dwh_id;
