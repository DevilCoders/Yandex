title: All gateways duty (AI, MDB, API)
uid: WpCkQ1HZk
refresh: 3m
id: 226721

tags: [ 'ycp', 'ycp-gateway', 'ycp-router', 'ycp-duty', 'ycp-drilldown' ]

variables:
  ui:
    cluster: { values: [prod, preprod] }
    # rateUnit: { values: [1, 60], titles:[rps, rpm] }
    gw_type:
      multi: true
      values: [api, ai, mdb]
      titles: [API, AI, MDB]
    router_type:
      multi: true
      values: [api-router, dpl01, cpl]
      titles: [api-router, dpl01-router, cpl-router]
  replacement:
    !include ../include/errors.yaml

graphDefaults: { width: 6, height: 4, datasource: 'Solomon Cloud' }
queryDefaults: { dropNan: true, labels: 'project=platform, host!=cluster' }

rows:

  - title: $gw_type Gateway ( $cluster )
    queryDefaults: { labels: 'cluster=cloud_${cluster}_${gw_type}-gateway, service=api_gateway_ma' }
    uiRepeat: gw_type
    drilldowns:
      - subUid: gw_dd_hosts_WpCkQ1HZk
        ui:
          cluster: cluster
          gw_type:
            values: [api, ai, mdb]
            titles: [API, AI, MDB]
          host:
            multi: true
            values: [ '*-myt01', '*-sas01',  '*-vla01', '*-myt02', '*-sas02', '*-vla02' ]
            titles: [ 'Host myt01', 'Host sas01',  'Host vla01', 'Host myt02', 'Host sas02', 'Host vla02' ]
        uiRepeat: host
        labels: 'host=$host'

    panels:

      - type: graph
        templates:
          - { name: rps, rate: ui }
          - { name: patchSelect, before: last, add: { asap: [] } }
        title: 'Gateway $rateUnit ($cluster)'
        display: { legend: false, fill: 0 }
        yAxes: [ { min: 0, decimals: 1 } ]
        queries:
          - params: { labels: 'name=grpc_server_request_total, system=*, grpc_type=*, grpc_service=yandex.cloud.*, grpc_method!=all' }

      - type: graph
        title: 'Gateway and envoy errors ($cluster)'
        display: { fill: 0 }
        yAxes: [ { min: 0, decimals: 1 } ]
        queryDefaults: { defaultTimeWindow: '15s' }
        queries:
          - params: { labels: 'name=grpc_server_response_total, grpc_code=@c5xx, system=*, grpc_type=*, grpc_service=yandex.cloud, grpc_method!=all, upstream_error=true' }
            groupByTime: { max: 'default' }
            select: { diff: [], drop_below: "0", group_lines: [sum], alias: gw upstream 5xx }
          - params: { labels: 'name=grpc_server_response_total, grpc_code=@c5xx, system=*, grpc_type=*, grpc_service=yandex.cloud, grpc_method!=all, upstream_error=false' }
            groupByTime: { max: 'default' }
            select: { diff: [], drop_below: "0", group_lines: [sum], alias: gw 5xx }
          - params: { labels: 'name=envoy_http_frontend_v4_tls_downstream_rq_5xx|envoy_http_frontend_v6_tls_downstream_rq_5xx|envoy_http_frontend_v4_plain_downstream_rq_5xx|envoy_http_frontend_v6_plain_downstream_rq_5xx, service=api_envoy_ma, host!=cluster' }
            groupByTime: { max: 'default' }
            select: { diff: [], drop_below: "0", group_lines: [sum], alias: "envoy front 5xx" }
          - params: { labels: 'name=envoy_cluster_*_upstream_rq_503, service=api_envoy_ma, host!=cluster' }
            groupByTime: { max: 'default' }
            select: { diff: [], drop_below: "0", group_lines: [sum], alias: "envoy upstream 503" }

      - type: graph
        # templates: { groupLines: true, name: percentile, format: solomon }
        title: 'Gateway response duration ($cluster)'
        templates:
          - { name: patchSelect, before: last, add: { asap: [] } }
        display: { fill: 0 }
        yAxes: [ { min: 0, decimals: 1 } ]
        queryDefaults: { labels: 'name=grpc_server_response_duration_seconds, system=*, grpc_type=*, grpc_service=yandex.cloud, bin=*' }
        queries:
          - groupByTime: { max: 'default' }
            select: { non_negative_derivative: [], group_by_labels: ["sum", "bin"], histogram_percentile: ["95", "bin"], alias: "p95" }
          - groupByTime: { max: 'default' }
            select: { non_negative_derivative: [], group_by_labels: ["sum", "bin"], histogram_percentile: ["99", "bin"], alias: "p99" }

      - type: graph
        title: '$gw_type Gateway LA1 ($cluster)'
        templates:
          - { name: patchSelect, before: last, add: { asap: [] } }
        display: { fill: 0 }
        yAxes: [ { min: 0, decimals: 1 } ]
        queryDefaults: { labels: 'name=node_load1, service=node-exporter_ma, host!=cluster' }
        queries:
          - select: { percentile_group_lines: "50", alias: "la1 p50" }
            groupByTime: { max: 'default' }
          - select: { percentile_group_lines: "95", alias: "la1 p95" }
            groupByTime: { max: 'default' }
          - select: { percentile_group_lines: "99", alias: "la1 p99" }
            groupByTime: { max: 'default' }

      - type: graph
        title: 'Envoy upstreams $rateUnit ($cluster)'
        templates:
          - { name: patchSelect, before: last, add: { asap: [] } }
        display: { legend: false, fill: 0 }
        yAxes: [ { min: 0, decimals: 1 } ]
        queries:
          - params: { labels: 'service=api_envoy_ma, name=envoy_cluster_*_upstream_rq_total' }
            groupByTime: { max: 'default' }
            select: { non_negative_derivative: [], group_by_labels: [sum, name], math: "* $rateUnit" }

      - type: graph
        title: 'Envoy upstreams 503 ($cluster)'
        display: { legend: false, fill: 0 }
        yAxes: [ { min: 0, decimals: 1 } ]
        queryDefaults: { defaultTimeWindow: '15s' }
        queries:
          - params: { labels: 'service=api_envoy_ma, name=envoy_cluster_*_upstream_rq_503' }
            groupByTime: { max: 'default' }
            select: { diff: [], drop_below: "0", group_by_labels: [sum, name] }

      - type: graph
        title: 'Envoy upstreams duration ($cluster)'
        templates:
          - { name: patchSelect, before: last, add: { asap: [] } }
        display: { legend: false, fill: 0 }
        yAxes: [ { format: ms, min: 0, decimals: 1 } ]
        queries:
          - params: { labels: 'service=api_envoy_ma, name=envoy_cluster*_upstream_rq_time, quantile=0.99' }
            groupByTime: { last: 'default' }
            select: { group_by_labels: [max, name] }

  - title: $router_type ( $cluster )
    uiRepeat: router_type
    drilldowns:
      - subUid: router_dd_hosts_WpCkQ1HZk
        ui:
          cluster: cluster
          router_type:
            values: [api-router, dpl01, cpl]
            titles: [api-router, dpl01-router, cpl-router]
          host:
            multi: true
            values: [ '*-myt01', '*-sas01',  '*-vla01', '*-myt02', '*-sas02', '*-vla02' ]
            titles: [ 'Host myt01', 'Host sas01',  'Host vla01', 'Host myt02', 'Host sas02', 'Host vla02' ]
        uiRepeat: host
        labels: 'host=$host'
    queryDefaults: { labels: 'cluster=cloud_${cluster}_${router_type}, service=api_envoy_ma' }

    panels:
      - type: graph
        title: 'Router $rateUnit ($cluster)'
        templates:
          - { name: rps, rate: ui }
          - { name: patchSelect, before: last, add: { asap: [] } }
        queries:
          - params: { labels: 'name=envoy_http_frontend_v4_plain_downstream_rq_total|envoy_http_frontend_v6_plain_downstream_rq_total|envoy_http_frontend_v4_tls_downstream_rq_total|envoy_http_frontend_v6_tls_downstream_rq_total' }

      - type: graph
        title: 'errors ($cluster)'
        display: { legend: false, fill: 0 }
        yAxes: [ { min: 0, decimals: 1 } ]
        queryDefaults: { defaultTimeWindow: '15s' }
        queries:
          - params: { labels: 'name=name=envoy_http_frontend_v4_plain_downstream_rq_5xx|envoy_http_frontend_v6_plain_downstream_rq_5xx|envoy_http_frontend_v4_tls_downstream_rq_5xx|envoy_http_frontend_v6_tls_downstream_rq_5xx' }
            groupByTime: { max: 'default' }
            select: { diff: [], drop_below: "0", group_lines: [sum], alias: 5xx }
          - params: { labels: 'name=name=envoy_http_frontend_v4_plain_downstream_rq_503|envoy_http_frontend_v6_plain_downstream_rq_503|envoy_http_frontend_v4_tls_downstream_rq_503|envoy_http_frontend_v6_tls_downstream_rq_503' }
            groupByTime: { max: 'default' }
            select: { diff: [], drop_below: "0", group_lines: [sum], alias: "503" }

      - type: graph
        title: 'duration ($cluster)'
        templates:
          - { name: patchSelect, before: last, add: { asap: [] } }
        display: { legend: false, fill: 0 }
        yAxes: [ { format: ms, min: 0, decimals: 1 } ]
        queryDefaults: { labels: 'name=envoy_http_frontend_v4_plain_downstream_rq_time|envoy_http_frontend_v4_tls_downstream_rq_time|envoy_http_frontend_v6_plain_downstream_rq_time|envoy_http_frontend_v6_tls_downstream_rq_time' }
        queries:
          - params: { labels: 'quantile=0.5' }
            groupByTime: { last: 'default' }
            select: { group_lines: [max], alias: p50 }
          - params: { labels: 'quantile=0.9' }
            groupByTime: { last: 'default' }
            select: { group_lines: [max], alias: p90 }
          - params: { labels: 'quantile=0.99' }
            groupByTime: { last: 'default' }
            select: { group_lines: [max], alias: p99 }

      - type: graph
        title: '$router_type Router LA1 ($cluster)'
        templates:
          - { name: patchSelect, before: last, add: { asap: [] } }
        display: { legend: false, fill: 0 }
        yAxes: [ { min: 0, decimals: 1 } ]
        queryDefaults: { labels: 'name=node_load1, service=node-exporter_ma, host!=cluster' }
        queries:
          - select: { percentile_group_lines: "50", alias: "la1 p50" }
            groupByTime: { max: 'default' }
          - select: { percentile_group_lines: "95", alias: "la1 p95" }
            groupByTime: { max: 'default' }
          - select: { percentile_group_lines: "99", alias: "la1 p99" }
            groupByTime: { max: 'default' }

      - type: graph
        title: 'Router upstreams $rateUnit ($cluster)'
        templates:
          - { name: patchSelect, before: last, add: { asap: [] } }
        display: { legend: false, fill: 0 }
        yAxes: [ { min: 0, decimals: 1 } ]
        queries:
          - params: { labels: 'name=envoy_cluster_*_upstream_rq_total' }
            groupByTime: { max: 'default' }
            select: { non_negative_derivative: [], group_by_labels: [sum, name], math: "* $rateUnit" }

      - type: graph
        title: 'upstreams 503 ($cluster)'
        display: { legend: false, fill: 0 }
        yAxes: [ { min: 0, decimals: 1 } ]
        queryDefaults: { defaultTimeWindow: '15s' }
        queries:
          - params: { labels: 'name=envoy_cluster_*_external_upstream_rq_503' }
            groupByTime: { max: 'default' }
            select: { diff: [], drop_below: "0", group_by_labels: [sum, name] }

      - type: graph
        title: 'upstreams duration ($cluster)'
        templates:
          - { name: patchSelect, before: last, add: { asap: [] } }
        display: { legend: false, fill: 0 }
        yAxes: [ { format: ms, min: 0, decimals: 1 } ]
        queries:
          - params: { labels: 'name=envoy_cluster*external_upstream_rq_time, quantile=0.99' }
            groupByTime: { last: 'default' }
            select: { group_by_labels: [max, name] }
