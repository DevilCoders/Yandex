uid: yc-kms-api
refresh: 1m
title: YC KMS API

tags: [ 'yc-kms', 'yc-kms-api' ]

variables:
  ui:
    datasource: { values: [ 'Solomon Cloud', 'Solomon Cloud Preprod' ] }
    project:
      values: [ 'kms', 'aoelnudsaq38ftolajvs' ]
      titles: [ 'Solomon Cloud', 'Solomon Cloud Preprod' ]
    cluster: { values: [prod, preprod, testing, gpn] }
  replacement:
    !include ../include/errors.yaml
  repeat:
    data_method: { values: [ Decrypt, Encrypt, ReEncrypt, GenerateDataKey ] }
    control_method: { values: [ Create, Get, List, ListVersions, Update, Delete, SetPrimaryVersion, ScheduleVersionDestruction, CancelVersionDestruction, Rotate ] }

links:
  - { title: 'L3 kms.yandex', url: 'https://grafana.yandex-team.ru/d/rQPhsZcWk/l3-vs-kms-yandex' }
  - { title: 'Dashboards', tags: ['yc-kms'] }

graphDefaults: { datasource: '${datasource}', width: 8, height: 6 }
queryDefaults: { labels: 'project=${project}, cluster=${cluster}, service=service' }

rows:
  - title: Data Plane API
    drilldowns:
      - uid: yc-kms-api-host-data
        tags: [ 'yc-kms', 'yc-kms-host' ]
        ui:
          datasource: datasource
          project: project
          cluster: cluster
        uiQuery:
          host:
            labels: 'host=kms-data-*'
            multi: true
        uiRepeat: host
        labels: 'host=$host'

    queryDefaults: { labels: 'project=${project}, cluster=${cluster}, service=service, host=kms-data-*, app=kms-data-plane_server' }
    panels:
      - type: graph
        repeat: data_method
        templates: { name: rps, rate: rps }
        title: '@data_method rps ($cluster)'
        queries:
          - params: { labels: 'sensor=grpc_requests, meter_type=count, method=kms.v1.SymmetricCryptoService/@data_method' }

      - type: graph
        repeat: data_method
        templates: { name: percentile, format: solomon, groupLines: true, sensor: rate }
        title: '@data_method response duration ($cluster)'
        queries:
          - params: { labels: 'sensor=grpc_durations, method=kms.v1.SymmetricCryptoService/@data_method' }
        yAxes: [{ min: 0 }]

  - title: Control Plane API
    drilldowns:
      - uid: yc-kms-api-host-control
        tags: [ 'yc-kms', 'yc-kms-host' ]
        ui:
          datasource: datasource
          project: project
          cluster: cluster
        uiQuery:
          host:
            labels: 'host=kms-control-*'
            multi: true
        uiRepeat: host
        labels: 'host=$host'

    queryDefaults: { labels: 'project=${project}, cluster=${cluster}, service=service, host=kms-control-*, kms-control-plane_server' }
    panels:

      - type: graph
        repeat: control_method
        templates: { name: rps, rate: rps }
        title: '@control_method rps ($cluster)'
        queries:
          - params: { labels: 'sensor=grpc_requests, meter_type=count, method=kms.v1.SymmetricKeyService/@control_method' }

      - type: graph
        repeat: control_method
        templates: { name: percentile, format: solomon, groupLines: true, sensor: rate }
        title: '@control_method response duration ($cluster)'
        queries:
          - params: { labels: 'sensor=grpc_durations, method=kms.v1.SymmetricKeyService/@control_method' }
        yAxes: [{ min: 0 }]
