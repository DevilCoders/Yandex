uid: yc-kms
refresh: 1m
title: YC KMS Basics

tags: [ 'yc-kms' ]

variables:
  ui:
    datasource: { values: [ 'Solomon Cloud', 'Solomon Cloud Preprod' ] }
    project:
      values: [ 'kms', 'aoelnudsaq38ftolajvs' ]
      titles: [ 'Solomon Cloud', 'Solomon Cloud Preprod' ]
    cluster: { values: [prod, preprod, testing, gpn] }
  replacement:
    !include ../include/errors.yaml

links:
  - { title: 'Dashboards', tags: ['yc-kms'] }
  - { title: 'SLA Dashboard', url: 'https://grafana.yandex-team.ru/d/yc-kms-sla' }

graphDefaults: { datasource: '${datasource}', width: 8, height: 6 }
queryDefaults: { labels: 'project=${project}, cluster=${cluster}, service=service' }

rows:
  - title: Data Plane API
    drilldowns:
      - uid: yc-kms-host-data
        tags: [ 'yc-kms', 'yc-kms-host' ]
        ui:
          datasource: datasource
          project: project
          cluster: cluster
        uiQuery:
          host:
            labels: 'host=kms-data-*'
            multi: true
        uiRepeat: host
        labels: 'host=$host'

    queryDefaults: { labels: 'project=${project}, cluster=${cluster}, service=service, host=kms-data-*, app=kms-data-plane_server' }
    panels:
      - type: graph
        templates: { name: rps, rate: rps }
        title: 'API rps ($cluster)'
        queries:
          - params: { labels: 'sensor=grpc_requests, meter_type=count' }

      - type: graph
        templates: { name: errors, sensor: rate }
        title: 'API 4xx errors ($cluster)'
        queryDefaults: { defaultTimeWindow: '15s' }
        queries:
          - params: { labels: 'sensor=grpc_statuses, status=@4xx' }
        draw: [{ alias: '4xx', color: '#147' }]
        yAxes: [{ min: 0 }]

      - type: graph
        templates: { name: errors, sensor: rate }
        title: 'API 5xx errors ($cluster)'
        queryDefaults: { defaultTimeWindow: '15s' }
        queries:
          - params: { labels: 'sensor=grpc_statuses, status=@503' }
          - params: { labels: 'sensor=grpc_statuses, status=@5xx' }
        draw: [{ alias: '503', color: '#da7' }, { alias: '5xx', color: '#b20' }]
        yAxes: [{ min: 0 }]

      - type: graph
        templates: { name: percentile, format: solomon, groupLines: true, sensor: rate }
        title: 'API response duration ($cluster)'
        queries:
          - params: { labels: 'sensor=grpc_durations' }
        yAxes: [{ min: 0 }]

  - title: Data Plane API External Monitoring
    drilldowns:
      - uid: yc-kms-host-monitoring
        tags: [ 'yc-kms', 'yc-kms-host' ]
        ui:
          datasource: datasource
          project: project
          cluster: cluster
        uiQuery:
          host:
            labels: 'host=kms-monitoring-*'
            multi: true
        uiRepeat: host
        labels: 'host=$host'

    queryDefaults: { labels: 'project=${project}, cluster=${cluster}, service=service, host=kms-monitoring-*' }
    panels:
      - type: graph
        templates: { name: errors, sensor: rate }
        title: 'Data plane monitoring error statuses ($cluster)'
        queryDefaults: { defaultTimeWindow: '15s' }
        queries:
          - params: { labels: 'sensor=cryptoMonitoringErrorStatuses, status=400|401|404|409|429|499' }
          - params: { labels: 'sensor=cryptoMonitoringErrorStatuses, status=503' }
          - params: { labels: 'sensor=cryptoMonitoringErrorStatuses, status=500|501|504' }
        draw: [{ alias: '4xx', color: '#147' }, { alias: '503', color: '#da7' }, { alias: '5xx', color: '#b20' }]

      - type: graph
        templates: { name: errors, sensor: rate }
        title: 'Data plane monitoring errors ($cluster)'
        queryDefaults: { defaultTimeWindow: '15s' }
        queries:
          - params: { labels: 'sensor=cryptoMonitoringCryptoErrors' }
          - params: { labels: 'sensor=cryptoMonitoringUnknownErrors' }
        draw: [{ alias: 'cryptoErrors', color: '#b20' }, { alias: 'unknownErrors', color: '#da7' }]

      - type: graph
        templates: { name: percentile, format: solomon, groupLines: true, sensor: rate }
        title: 'Data plane public response duration ($cluster)'
        queries:
          - params: { labels: 'sensor=cryptoMonitoringDurations' }
        yAxes: [{ min: 0 }]

  - title: Control Plane API
    drilldowns:
      - uid: yc-kms-host-control
        tags: [ 'yc-kms', 'yc-kms-host' ]
        ui:
          datasource: datasource
          project: project
          cluster: cluster
        uiQuery:
          host:
            labels: 'host=kms-control-*'
            multi: true
        uiRepeat: host
        labels: 'host=$host'

    queryDefaults: { labels: 'project=${project}, cluster=${cluster}, service=service, host=kms-control-*, app=kms-control-plane_server' }
    panels:
      - type: graph
        templates: { name: rps, rate: rps }
        title: 'API rps ($cluster)'
        queries:
          - params: { labels: 'sensor=grpc_requests, meter_type=count' }

      - type: graph
        templates: { name: errors, sensor: rate }
        title: 'API 4xx errors ($cluster)'
        queryDefaults: { defaultTimeWindow: '15s' }
        queries:
          - params: { labels: 'sensor=grpc_statuses, status=@4xx' }
        draw: [{ alias: '4xx', color: '#147', at: right }]
        yAxes: [{ min: 0 }]

      - type: graph
        templates: { name: errors, sensor: rate }
        title: 'API 5xx errors ($cluster)'
        queryDefaults: { defaultTimeWindow: '15s' }
        queries:
          - params: { labels: 'sensor=grpc_statuses, status=@503' }
          - params: { labels: 'sensor=grpc_statuses, status=@5xx' }
        draw: [{ alias: '503', color: '#da7' }, { alias: '5xx', color: '#b20' }]
        yAxes: [{ min: 0 }]

      - type: graph
        templates: { name: percentile, format: solomon, groupLines: true, sensor: rate }
        title: 'API response duration ($cluster)'
        queries:
          - params: { labels: 'sensor=grpc_durations' }
        yAxes: [{ min: 0 }]
