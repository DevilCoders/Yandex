uid: trail-service-val-by-type
refresh: 1m
title: Audit Trails Event Validation by Event Type

tags:
  - yc-trails
  - yc-audit-trails

links:
  - { title: 'Events by Service', url: 'https://grafana.yandex-team.ru/d/trail-service-validation' }
  - { title: 'Dashboards', tags: [yc-trails] }

variables:
  ui:
    !include include/_datasources.yaml
    !include include/_projects.yaml
    host:
      multi: true
      hidden: true
      values:
        - 'prp-*'
  uiQuery:
    service:
      inheritLabels: false
      labels: 'project=${project}, cluster=trail, service=service, host=${host}'
      label: 'eventService'
      regex: '^.*$'
    eventType:
      inheritLabels: false
      labels: 'project=${project}, cluster=trail, service=service, host=${host}, eventService=${service}'
      multi: true
      label: 'eventType'
      regex: '^.*$'
  replacement:
    !include ../include/errors.yaml

graphDefaults:
  datasource: ${datasource}
  width: 6
  height: 6

queryDefaults:
  dropNan: false
  labels: 'project=${project}, cluster=trail, service=service, host=${host}, eventService=${service}, eventType=${eventType}'
  defaultTimeWindow: $__interval

rows:
  - title: $eventType
    uiRepeat: eventType
    panels:
      - type: graph
        title: Total $eventType
        queries:
          - params: { labels: 'sensor=eventDistributorSuccess' }
            select: { group_by_labels: [sum, sensor], integrate_fn: [ ], diff: [], drop_below: '0', alias: 'success' }
          - params: { labels: 'sensor=eventDistributorUnparsed' }
            select: { group_by_labels: [sum, sensor], integrate_fn: [ ], diff: [], drop_below: '0', alias: 'unparsed' }
          - params: { labels: 'sensor=eventDistributorUnparsed, validationErrorType=UNPARSED|NOT_REGISTERED|BAD_EVENT_METADATA|BAD_EVENT_TYPE|BAD_CREATED_AT|BAD_CLOUD_ID' }
            select: { group_by_labels: [sum, sensor], integrate_fn: [ ], diff: [], drop_below: '0', alias: 'critical' }
        draw:
          - { color: '#3e3', alias: 'success' }
          - { color: '#ee3', alias: 'unparsed' }
          - { color: '#f66', alias: 'critical' }
        display: { stack: false }
        yAxes: [ { min: 0 } ]
      - type: graph
        title: Critical $eventType
        display: { empty: false, stack: true }
        yAxes: [ { min: 0 } ]
        queries:
          - params: { labels: 'sensor=eventDistributorUnparsed, validationErrorType=UNPARSED|NOT_REGISTERED|BAD_EVENT_METADATA|BAD_EVENT_TYPE|BAD_CREATED_AT|BAD_CLOUD_ID' }
            select: { group_by_labels: [sum, validationErrorType], integrate_fn: [ ], diff: [], drop_below: '0', alias: '{{validationErrorType}}' }
      - type: graph
        title: Unparsed $eventType
        display: { empty: false, stack: true }
        yAxes: [ { min: 0 } ]
        queries:
          - params: { labels: 'sensor=eventDistributorUnparsed' }
            select: { group_by_labels: [sum, validationErrorType], integrate_fn: [ ], diff: [], drop_below: '0', alias: '{{validationErrorType}}' }
      - type: graph
        title: Latency $eventType
        templates: { name: percentile, groupLines: true, format: solomon, sensor: raw }
        queries:
          - params: { labels: 'sensor=statisticsCollectorEventsLatency' }
        yAxes: [ { min: 0, format: s } ]
