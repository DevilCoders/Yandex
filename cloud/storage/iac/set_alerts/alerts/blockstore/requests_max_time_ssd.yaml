definitions:
  - &alert_id "{{.ID}}_nbs_requests_max_time_ssd"
  - &alert_name "{{.Name}}[SSD] NBS Requests Max Time"
  - &alert_window_secs 600
  - &alert_annotations_tag "yc-{{.Cluster}}-nbs-solomon"
  - &alert_annotations_host "{{`{{labels.host}}`}}.{{.HostDomain}}"
  - &alert_annotations_service "solomon_alert_nbs_requests_max_time_ssd"
  - &alert_juggler_description "(doc: https://nda.ya.ru/t/_4HhEe6b5FnjVS)"
alerts:
  - id: *alert_id
    name: *alert_name
    description: *alert_juggler_description
    window_secs: *alert_window_secs
    group_by_labels:
      - host
    channels:
      - id: juggler
    annotations:
      tags: *alert_annotations_tag
      host: *alert_annotations_host
      service: *alert_annotations_service
      juggler_description: *alert_juggler_description
    clusters:
      - preprod
      - prod_vla
      - prod_sas
      - prod_myt
      - israel
    expression:
      program: |-
        let ssd_r = {
        project='{{.SolomonProjectID}}',
        cluster='{{.SolomonCluster}}',
        service='server',
        request='ReadBlocks',
        type='ssd', sensor='MaxTime',
        host='{{.Hosts}}'
        };
        let ssd_w = {
        project='{{.SolomonProjectID}}',
        cluster='{{.SolomonCluster}}',
        service='server',
        request='WriteBlocks',
        type='ssd',
        sensor='MaxTime',
        host='{{.Hosts}}'
        };
        let ssd_z = {
        project='{{.SolomonProjectID}}',
        cluster='{{.SolomonCluster}}',
        service='server',
        request='ZeroBlocks',
        type='ssd',
        sensor='MaxTime',
        host='{{.Hosts}}'
        };

        let reassign_count = integrate_fn(group_lines('sum', {
          project="{{.SolomonProjectID}}",
          cluster="{{.SolomonCluster}}",
          service="server",
          host="{{.Hosts}}",
          sensor="AppCriticalEvents/ReassignTablet"
        }));

        let reassign_count_before = integrate_fn(group_lines('sum', shift({
          project="{{.SolomonProjectID}}",
          cluster="{{.SolomonCluster}}",
          service="server",
          host="{{.Hosts}}",
          sensor="AppCriticalEvents/ReassignTablet"
        }, -10m)));
        let reassign_count_after = integrate_fn(group_lines('sum', shift({
          project="{{.SolomonProjectID}}",
          cluster="{{.SolomonCluster}}",
          service="server",
          host="{{.Hosts}}",
          sensor="AppCriticalEvents/ReassignTablet"
        }, 10m)));

        no_data_if(
        count(ssd_r) == 0 ||
        count(ssd_w) == 0 ||
        count(ssd_z) == 0);

        let total_reassign_count = max(reassign_count) + max(reassign_count_before) + max(reassign_count_after);

        let reassign_gauge_ssd = total_reassign_count > 0 ? 36.0 : 1;

        let last_ssd_r = last(ssd_r);
        let last_ssd_w = last(ssd_w);
        let last_ssd_z = last(ssd_z);

        let ssd_threshold = 5000000 * reassign_gauge_ssd;

        alarm_if(
        (avg(ssd_r) >= ssd_threshold && last_ssd_r >= ssd_threshold) ||
        (avg(ssd_w) >= ssd_threshold && last_ssd_w >= ssd_threshold) ||
        (avg(ssd_z) >= ssd_threshold && last_ssd_z >= ssd_threshold));

        warn_if(
        (avg(ssd_r) >= ssd_threshold && last_ssd_r < ssd_threshold) ||
        (avg(ssd_w) >= ssd_threshold && last_ssd_w < ssd_threshold) ||
        (avg(ssd_z) >= ssd_threshold && last_ssd_z < ssd_threshold));
