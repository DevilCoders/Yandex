== Что это

Здесь лежат терраформ-рецепты и конфиги для разворачивания.

На верхнем уровне папки соответствуют стендам — проду и препроду. В них лежат описания ресурсов, которые надо развернуть на этом стенде. Чтобы код не дублировался,
мы используем терраформ-модули с описанием частых кейсов. Они лежат в папке `modules/`.

Подробнее о модулях в терраформе и их использовании можно почитать в документации: https://www.terraform.io/docs/modules/index.html.

== Стейты

Терраформ оперирует понятиями стейт и план выполнения. Стейт — это большой JSON-файл, в котором написано, какие ресурсы уже созданы на стенде.
План выполнения — это последовательность операций, которая приводит текущий стейт к желаемому, то есть к тому, который описан в конфигурации в одной из стендовых папок этого репозитория.

Стейт не хранится в репозитории, потому что сам терраформ не рекомендует так делать — ведь может так оказаться, что два человека ведут разработку одновременно и выполняют у себя на
компьютерах `terraform apply`. При этом стейт меняется, но другой разработчик об этом не узнает, пока первый не закоммитит своё изменение.

Поэтому мы храним все стейты в облачном S3. В стейте могут быть чувствительные данные (например, пароли от баз данных), поэтому [https://console.cloud.yandex.ru/folders/yc.gore.service-folder/storage/bucket/gore-terraform-states](бакет) и файлы в нём не доступны без аутенфикации.
Чтобы терраформ получил доступ к бакету, создан специальный [https://console.cloud.yandex.ru/folders/yc.gore.service-folder/service-account/ajela84fi2bofjeh8cg7](сервисный аккаунт), а для него сгенерирован статический ключ доступа для S3. Данные этого ключа лежат в Vault и доступны всем сотрудникам GoRe [https://yav.yandex-team.ru/secret/sec-01ek2mms17rpvzk7ce37qqdysv](тут).

== Пререквизиты

1. Установите terraform с официального сайта: https://www.terraform.io/downloads.html

1. Установите ycp: https://wiki.yandex-team.ru/cloud/devel/platform-team/dev/ycp/

1. Установите ycp-провайдер для терраформа: https://wiki.yandex-team.ru/cloud/devel/terraform-ycp/

== Как запустить

1. Посмотрите данные статического ключа для доступа терраформа к S3 в Vault: https://yav.yandex-team.ru/secret/sec-01ek2mms17rpvzk7ce37qqdysv. Укажите `AWS_ACCESS_KEY_ID` и `AWS_SECRET_ACCESS_KEY` в переменных окружения следующим образом:

```
export AWS_ACCESS_KEY_ID=...
export AWS_SECRET_ACCESS_KEY=...
```

1. Если в коде также используется провайдер `yandex` (наряду с `ycp`), то понадобится ещё иамный-токен, выпущенный от лица федеративного пользователя. Его можно получить на с помощью yc iam create-token. При запуске изнутри виртуалки с привязанным сервисным аккаунтом этот токен можно не указывать (см. https://www.terraform.io/docs/providers/yandex/index.html). Токен будет запрошен командами `terraform plan` и `terraform apply`.

Также этот токен можно передать через параметры командной строки, файл .tfvars или переменные окружения. Подробнее читайте на в документации терраформа: https://www.terraform.io/docs/configuration/variables.html#assigning-values-to-root-module-variables.

1. Зайдите в папку нужного вам стенда. Например, в `preprod/`.

1. Выполните `terraform init`. Эту команду достаточно выполнить в самом начале работы с репозиторием, чтобы инициализировать терраформ в папке. Однако так же надо вызывать `terraform init` при каждом использовании
нового модуля.

1. Выполните `terraform plan`, чтобы получить план выполнения.

1. Выполните `terraform apply`, чтобы план исполнился. Чтобы быть уверенным, что исполнится ровно тот план, что был сгенерирован на предыдущем шаге, можно воспользоваться командами `terraform plan -out plan.json` и `terraform apply plan.json`.


== Секреты

Доставка секретов на машины осуществляется через метаданные. Но чтобы не спалить секреты в репозитории, мы шифруем их ключом, хранящимся в KMS.

Для зашифровки секрета выполните команду:

```
yc --profile [default|prod|preprod|...] kms symmetric-crypto encrypt --folder-id yc.gore.service-cloud --id abjre30cfopij37qmig4 --plaintext-file <file-with-secret> --ciphertext-file <output-file>
```

`abjre30cfopij37qmig4` — это айди секрета в продовом KMS. В препроде нужно использовать `e10sft1073crue4pd2vq`.

При старте виртуальные машины возьмут зашифрованные секреты из метаданных и расшифруют их походом в KMS от имени сервисного аккаунта `gore-sa`, который должен быть прикреплён к каждой виртуальной машине.

**Примечание.** Ключи и сервисный аккаунт тоже создаются в этих терраформ-конфигах. Если будет необходимость создать новые ключи, то надо будет перешифровать все секреты и пересоздать все виртуальные машины.

Аналогично в терраформе создаётся Container Registry для докер-образов: https://console.cloud.yandex.ru/folders/yc.gore.service-folder/container-registry/crp1m3ip7sn09t6912j9. Реестр есть только в проде,
поэтому для препродных терраформ-конфигов его айди хранится в `var.registry_id`.

== Дополнительно

Облака и фолдеры создаются в этапе `provision-default-resources` в ((https://bb.yandex-team.ru/projects/CLOUD/repos/bootstrap-templates/browse bootstrap-templates)), а вот создавать там инстансы не рекомендуется.
