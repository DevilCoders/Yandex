{
  "variables":
  {
    "endpoint": "{{env `YC_ENDPOINT`}}",
    "service_account_key_file": "{{env `YC_BUILD_SERVICE_ACCOUNT_SECRET`}}",
    "mkt_s3_access_key": "{{env `YC_MKT_DISTR_S3_ACCESS_KEY`}}",
    "mkt_s3_secret_key": "{{env `YC_MKT_DISTR_S3_SECRET_KEY`}}",

    "name": "windows-2019-dc",
    "source_image_name": "windows-2019-dc-qemu",
    "source_image_folder_id": "{{env `YC_DIRTY_IMAGES_FOLDER_ID`}}",
    "image_description": "One image to rule them all, one image to find them, one image to bring them all and in the darkness bind them.",
    
    "folder_id": "{{env `YC_BUILD_FOLDER_ID`}}",
    "zone": "{{env `YC_ZONE`}}",
    "subnet_id": "{{env `YC_BUILD_SUBNET`}}",

    "username": "Administrator",
    "generated_password": "{{ split uuid \"-\" 4 }}P@s$!1"
  },
  "builders":
  [
    {
      "type": "yandex",
      "name": "{{user `name`}}",
      "endpoint": "{{user `endpoint`}}",
      "service_account_key_file": "{{user `service_account_key_file`}}",

      "source_image_name": "{{user `source_image_name`}}",
      "source_image_folder_id": "{{user `source_image_folder_id`}}",

      "image_name": "{{build_name}}-base-v{{isotime \"20060102\"}}",
      "image_family": "{{build_name}}-gvlk",
      "image_description": "{{user `image_description`}}",

      "folder_id": "{{user `folder_id`}}",
      "instance_name": "{{build_name}}-v{{isotime \"20060102\"}}",
      "metadata": { "user-data": "net user Administrator \"{{user `generated_password`}}\"" },
      "platform_id": "standard-v2",
      "instance_cores": "4",
      "instance_mem_gb": "8",
      "disk_size_gb": 50,
      "disk_type": "network-ssd",
      "zone": "{{user `zone`}}",
      "subnet_id": "{{user `subnet_id`}}",
      "use_internal_ip": "true",
      "use_ipv4_nat": true,

      "communicator": "winrm",
      "winrm_username": "{{user `username`}}",
      "winrm_password": "{{user `generated_password`}}",
      "winrm_use_ssl": "true",
      "winrm_insecure": "true",
      "winrm_use_ntlm": "true"
    }
  ],
  "provisioners":
  [
    { "type": "shell-local", "inline": ["echo \"pwd is {{ user `generated_password` }}\""] },
    {
      "type": "powershell",
      "elevated_user": "Administrator",
      "elevated_password": "{{user `generated_password`}}",
      "environment_vars": [
        "AWS_ACCESS_KEY_ID={{user `mkt_s3_access_key`}}",
        "AWS_SECRET_ACCESS_KEY={{user `mkt_s3_secret_key`}}"
      ],
      "script": "ensure-bootstrapped.ps1"
    },
    { "type": "windows-restart", "restart_timeout": "30m" },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-smb1.ps1" ] },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-nla.ps1" ] },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-eth.ps1" ] },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-icmp.ps1" ] },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-rdp.ps1" ] },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-rtu.ps1" ] },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-serialconsole.ps1" ] },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-powerplan.ps1" ] },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-shutdownwithoutlogon.ps1" ] },
    {
      "type": "powershell",
      "elevated_user": "Administrator",
      "elevated_password": "{{user `generated_password`}}",
      "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-updated.ps1" ]
    },
    { "type": "windows-restart", "restart_timeout": "60m" },
    {
      "type": "powershell",
      "elevated_user": "Administrator",
      "elevated_password": "{{user `generated_password`}}",
      "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-updated.ps1" ]
    },
    { "type": "windows-restart", "restart_timeout": "60m" },
    {
      "type": "powershell",
      "elevated_user": "Administrator",
      "elevated_password": "{{user `generated_password`}}",
      "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-updated.ps1" ]
    },
    { "type": "windows-restart", "restart_timeout": "60m" },
    {
      "type": "powershell",
      "elevated_user": "Administrator",
      "elevated_password": "{{user `generated_password`}}",
      "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-updated.ps1" ]
    },
    { "type": "windows-restart", "restart_timeout": "60m" },
    {
      "type": "powershell",
      "elevated_user": "Administrator",
      "elevated_password": "{{user `generated_password`}}",
      "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-updated.ps1" ]
    },
    { "type": "windows-restart", "restart_timeout": "60m" },
    {
      "type": "powershell",
      "elevated_user": "Administrator",
      "elevated_password": "{{user `generated_password`}}",
      "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-updated.ps1" ]
    },
    { "type": "windows-restart", "restart_timeout": "60m" },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-ngen.ps1" ] },
    { "type": "powershell", "inline": [ "& c:\\bootstrap\\windows-scripts\\ensure-cleanup.ps1" ] },
    { "type": "powershell", "inline": [ "Stop-Computer -Force" ] },
    { "type": "shell-local", "pause_before": "5m", "inline": ["echo \"some time to shutdown :-(\""] }
  ],
  "post-processors": [
    {
      "type": "manifest",
      "output": "{{ pwd }}/manifest.json",
      "strip_path": true
    }
  ]
}
