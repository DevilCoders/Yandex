---
- hosts: localhost
  gather_facts: false
  pre_tasks:
    - juggler_facts: jserver_api={{ jserver_api }}
  vars:
    - env: "preprod"
    - telegramLogin: "YcBillingDutyPreprod"
    - api_limits: "{{ off_check_limits }}"
    - queue_limits: "{{ off_check_limits }}"
    - balancer: "mkt.private-api.cloud-preprod.yandex.net"
    - default_limits: "{{ off_check_limits }}"
    - default_limits_99perc_crit: "{{ off_check_limits }}"
    - default_limits_logic_and:
      - {day_end: 7, day_start: 1, time_end: 23, time_start: 0, aggregator: 'more_than_limit_is_crit', aggregator_kwargs: {percent: '101'}}
  roles:
    - role: api
      vars:
        children: CGROUP%cloud-marketplace-preprod-api
        host: "yc-marketplace-api-{{ env }}"
        tags: ['{{ common_tag }}', '{{ common_tag }}-{{ env }}', '{{ common_tag }}-api']

    - role: queue
      vars:
        children: CGROUP%cloud-marketplace-preprod-queue
        host: "yc-marketplace-queue-{{ env }}"
        tags: ['{{ common_tag }}', '{{ common_tag }}-{{ env }}', '{{ common_tag }}-queue']

  post_tasks:
    - juggler_cleanup:
      tags: [ 'yc-marketplace' ]
