---
- hosts: localhost
  gather_facts: false
  pre_tasks:
    - juggler_facts: jserver_api={{ jserver_api }}
  vars:
    - env: "prod"
    - telegramLogin: "YcMarkeplaceProdMonitoring"
    - api_limits:
      - { warn: '20%', crit: '50%', day_start: 1, day_end: 7, time_start: 0, time_end: 23 }
    - queue_limits:
      - { warn: '0', crit: '60%', day_start: 1, day_end: 6, time_start: 11, time_end: 21 }
      - { warn: '0', crit: '100%', day_start: 1, day_end: 6, time_start: 21, time_end: 11 }
      - { warn: '0', crit: '100%', day_start: 7, day_end: 7, time_start: 0, time_end: 23 }
    - balancer: "mkt.private-api.cloud.yandex.net"
    - default_limits: "{{ off_check_limits }}"
    - default_limits_99perc_crit: "{{ off_check_limits }}"
    - default_limits_logic_and:
      - {day_end: 7, day_start: 1, time_end: 23, time_start: 0, aggregator: 'more_than_limit_is_crit', aggregator_kwargs: {percent: '101'}}
  roles:
    - role: api
      vars:
        children: CGROUP%cloud-marketplace-prod-api
        host: "yc-marketplace-api-{{ env }}"
        tags: ['{{ common_tag }}', '{{ common_tag }}-{{ env }}', '{{ common_tag }}-api']

    - role: balancer
      vars:
        host: "{{ balancer }}"
        tags: ['{{ common_tag }}', '{{ common_tag }}-{{ env }}', '{{ common_tag }}-balancer']

    - role: queue
      vars:
        children: CGROUP%cloud-marketplace-prod-queue
        host: "yc-marketplace-queue-{{ env }}"
        tags: ['{{ common_tag }}', '{{ common_tag }}-{{ env }}', '{{ common_tag }}-queue']

  post_tasks:
    - juggler_cleanup:
      tags: [ 'yc-marketplace' ]
