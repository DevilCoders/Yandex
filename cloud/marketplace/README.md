### YC Marketplace

#### Contain
Внутри лежит апи, кли, коммон, миграции, очередь и маркетплейсный бутстрап.
Сборка всего и вся описана в /packages и собирается через ya package.

На маке докер образы не собирать - не заведуться потом.

#### Local test
##### Unit test
```ya make -t cloud/marketplace```

Локально счекаутит маркетплейс и запустит юниттесты (апи, миграции, коммон, очередь)

##### Func test
```make ydb```
```ya make -ttt cloud/marketplace/functests --test-stderr```

Локально счекаутит всё необходимое и запустит интеграционные тесты
Необходимо иметь следующие переменные в env: FUNC_TEST_OAUTH_TOKEN
Необходимы дырки до балансера иама на препроде и ydb на yc-testing2


#### PR Check

На каждуй ПР запускаются все юнит тесты. Фанктесты запускаться будут когда научимся доставлять на агенты то, что необходимо для локального прогона. Результаты теста попадают в yc-mkt-test

#### Build

1. Обновить код маркетплейса в аркадии (например какую-нибудь модельку)
2. Запустить шедулер ,который пересоберёт очередь и апи (https://sandbox.yandex-team.ru/scheduler/15646/view) - все версии будут видны в результатах
3. Перетащить контейнер из registry.yandex.net в облачный docker registry (sandbox это не умеет)
4. Новые версии прописать в пиллар
5. Запустить шедулер (https://sandbox.yandex-team.ru/scheduler/15411/view) и получить версию

#### Deploy

Можно использлвать если бутстрап уже создан, создание бутстрапа будет написано отдельно

1. Смотрим в https://wiki.yandex-team.ru/cloud/devel/Marketplace/Roster/
2. Выбираем ip у машины mkt-bootstrap в правильном окружении
3. Делаем ssh -l yndx.cloud.mkt {этот ip}
4. ``sudo -s``
5. ``apt-get update && apt-get install yc-mkt-bootstrap={version, см деплой}``
6. ``cd /utils/Bootstrap``
7. ``./bootstrap.sh prepare``
8. [Optional] создание машин по спепке: ``./bootstrap.sh deploy``
9. ``./bootstrap.sh roster``
10. [Optional] Если нужны новые миграции: оставляем только одну секцию с одной апи машиной в ``../salt/roster``, выполняем следующий шаг, заходим на машину из ростера, выполняем ``docker exec -it marketplace /yc-marketplace-cli migrate``. Проверяем что миграции прошли и возвращаемся к предыдущему шагу.
11. ``./bootstrap.sh state``

TODO сделать ``./bootstrap.sh migrate``
P.S. если миграция сложная, то на машине, где будет проходить миграция стоит держать выключенным nginx
P.P.S после обновления состава кластера необходимо поправить айпишники в соломоне

#### Bootstrap
##### Create image
Надо фабрикой собрать продукт/образ mktbase

##### Create bootstrap
По идее на произвольный ubuntu 16.04 в нашей сети (оверлей v6 смотрящий в Яндекс) достаточно привезти yc-mkt-bootstrap и секреты из секдиста (их надо положить в пилары, подсказка как это делать есть в бутстрапном скрипте)
