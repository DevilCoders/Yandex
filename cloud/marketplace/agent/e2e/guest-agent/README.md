# YAGA e2e tests

Тесты _yet another guest agent'a_ проводятся пока вручную, на локальной машине разработчика. Позже будем автоматизировать эту историю либо в аркадийном CI, либо в AW, либо и там и там, не суть важно.

## Чтобы запустить тесты необходимо:

Обязательно нужно установить на машину **terraform**, используемый пакетик **terratest**, по сути автоматизирует использование **.exe**'шника.

### Заполнить конфиг

```yaml
token: t1.sUp3rs3cR3tt0k3n
cloud_id: b1gjqooocloudidoooiqakp
folder_id: b1g6fooofolderidooovdk
instance_pwd: QWErty123qweqweqwe
```

### Собрать бинарник

В зависимости от того, где будет лежать артефакт сборки агента, к нему необходимо указать путь через конфиг, по-умолчанию это `agent.exe`

```yaml
src_path: c:\windows\temp\agent.exe
```

По-умолчанию бинарник будет скопирован на тестируемый инстанс по пути `c:\temp\agent.exe`, это также можно переопределить через конфиг.

```yaml
dst_path: c:\temp\agent.exe
```

### Запустить

```bash
go test -timeout 60m
```

Сами тесты длятся от 15m (увы пакетик с winrm не полностью имплементирует протокол), поэтому необходимо указать больший **timeout** при запуске теста. Можно также задать конфиг через переменные среды.

### Или воспользоваться make

Для билда, тестов и очистки

```bash
make
```

Также можно каждый шаг запустить отдельно

```bash
make build
make test
make clean
```

P.S. **make** можно запустить и на **windows**, нужно установить сам **make**, например через **chocolatey**.

## Описание

Ресурсы в облаке для тестов создаются с использованием [terratest](https://terratest.gruntwork.io/). (его также можно использовать для создания образов через packer). В поддиректории `terraform` лежит рецепт с достаточной конфигурацией для теста. Для rdp в создаваемой SG есть разрешающая запись, можно будет при необходимости присоединиться через **pwsh** или **rdp**. После создания **e2e** машинки в **SetupSuite** и копировании агента на инстанс, в **SetupTest**, перед проведением теста он запускается, а в **TeardownTest** останавливается его процесс и чистятся реестр и поля в **metadata** инстанса.

Тестов всего три:

* проверка создания пользователя
* проверка сброса пароля существующего пользователя
* проверка что два одинаковых запроса не приведут к изменению пользователя

В пакете собрано несколько сущностей, для простоты описания тестов:

* **instance** хранит **cloudSdk** клиента и является упрощённой обёрткой над **sdk** для нескольких функций
* **windowsInstance** то же, что и предыдущее, но реализует несколько _windows-specific_ методов, включает в себя **instance**
* **winrm** хранит конфиг для подключения к **WinRM Service Endpoint**'у и реализует helper-функции для управления **windows** через **cmd/powershell**
* **encryptionKey** реализует шифрование/дешифрование пароля, просто более простой интерфейс кмк
* **userChange{request,response}** структурки повторяют формат ответов и запросов на изменения **windows user**'ов
