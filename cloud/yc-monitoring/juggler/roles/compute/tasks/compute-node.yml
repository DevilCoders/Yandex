---
- name: 'juggler_check : compute-node phone (24x7) + telegram checks'
  juggler_check: ''
  args: "{{ default_check | hash_merge(item, default_timed_limits_unreach_force_ok) }}"
  with_items:
    - service: compute-node
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node
            type: wiki
    - service: push-client-billing
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/push-client-billing
            type: wiki

- name: 'juggler_check : compute-node phone (daytime) + telegram checks (events produced by Compute Node service)'
  juggler_check: ''
  args: "{{ default_check_notify_daytime | hash_merge(item, default_timed_limits_unreach_skip_nodata_ok) }}"  # nodata_ok is temporary: python node doesn't report this event
  with_items:
    - service: compute-node-disks
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-disks
            type: wiki
    - service: compute-node-nbs
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-nbs
            type: wiki
    - service: instance-controller
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/instance-controller
            type: wiki

- name: 'juggler_check : compute-node phone (daytime) + telegram checks (nodata ok)'
  juggler_check: ''
  args: "{{ default_check_notify_daytime | hash_merge(item, default_timed_limits_nodata_ok) }}"
  with_items:
    - service: compute-node-compute-api-errors
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-compute-api-errors
            type: wiki
    - service: compute-node-hanging-tasks
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-hanging-tasks
            type: wiki

- name: 'juggler_check : compute-node phone (24x7) + telegram checks (nodata ok)'
  juggler_check: ''
  args: "{{ default_check | hash_merge(item, default_timed_limits_nodata_ok) }}"
  with_items:
    - service: compute-node-token-agent
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-token-agent
            type: wiki

- name: 'juggler_check : compute-node telegram-only checks'
  juggler_check: ''
  # FIXME(simonov-d): change to default_timed_limits_unreach_force_ok when go compute-node is deployed everywhere.
  args: "{{ default_check_with_only_telegram_notification | hash_merge(item, default_timed_limits_nodata_ok) }}"
  with_items:
    - service: compute-node-accounting-errors
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-accounting-errors
            type: wiki
    - service: compute-node-failed-tasks
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-failed-tasks
            type: wiki
    - service: compute-node-logging
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-logging
            type: wiki
    - service: compute-node-task-processing-errors
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-task-processing-errors
            type: wiki
    - service: compute-underlay-ipv6
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-underlay-ipv6
            type: wiki
    - service: solomon-agent
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/solomon-agent
            type: wiki
    # FIXME(xpahos): gpu-gpud check is temporary telegram-only. phone
    #                   call is required for gpu-gpud.
    - service: gpu-gpud
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/gpu-gpud
            type: wiki

    # FIXME(zasimov-a): gpu-servicevm check is temporary telegram-only. phone
    #                   call is required for gpu-servicevm.
    - service: gpu-servicevm
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/gpu-servicevm
            type: wiki
    # FIXME(zasimov-a): gpu-servicevm-monitoring check is temporary telegram-only. phone
    #                   call is required for gpu-servicevm-monitoring.
    - service: gpu-servicevm-monitoring
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/gpu-servicevm-monitoring
            type: wiki
    # FIXME(zasimov-a): gpu-fdkeeper-nvswitch check is temporary telegram-only. phone
    #                   call is required for gpu-fdkeeper-nvswitch.
    - service: gpu-fdkeeper-nvswitch
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/gpu-fdkeeper-nvswitch
            type: wiki
    # FIXME(xpahos): gpu-hostchecker check is temporary telegram-only. phone
    #                   call is required for gpu-hostchecker.
    - service: gpu-hostchecker
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/gpu-hostchecker
            type: wiki
    # FIXME(xpahos): gpu-hostchecker-service check is temporary telegram-only. phone
    #                   call is required for gpu-hostchecker-service.
    - service: gpu-hostchecker-service
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/gpu-hostchecker-service
            type: wiki
    - service: nvidia-vgpu-mgr
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/nvidia-vgpu-mgr
            type: wiki
    - service: compute-node-go-converter
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-go-converter
            type: wiki
    - service: certificates-validity-compute
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/certificates-validity-compute
            type: wiki

- name: 'juggler_check: compute-node-solomon-fetch-status'
  juggler_check: ''
  args: "{{ silent_check | hash_merge(item, default_timed_limits_nodata_ok) }}"
  with_items:
      - service: compute-node-solomon-fetch-status
        children:
            - EVENTS%(host=yc_compute_solomon_{{ env }}-*)&(tag=yc-compute-node-team)
        meta:
            urls:
                - title: "[?] Инструкция по алерту"
                  url: https://docs.yandex-team.ru/yc-monitoring/shared/solomon-fetch-status
                  type: wiki

- name: 'juggler_check: compute-node-solomon-push-status'
  juggler_check: ''
  args: "{{ default_check_with_only_telegram_notification | hash_merge(item, default_timed_limits_nodata_ok) }}"
  with_items:
    - service: compute-node-solomon-push-status
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/shared/solomon-push-status
            type: wiki
  when: env not in ["testing"] # push disabled in these envs

- name: 'juggler_check: compute-node-solomon-agent-bytes-evicted'
  juggler_check: ''
  args: "{{ silent_check | hash_merge(item, default_timed_limits_nodata_ok) }}"
  with_items:
      - service: solomon-agent-bytes-evicted
        meta:
            urls:
                - title: "[?] Инструкция по алерту"
                  url: https://docs.yandex-team.ru/yc-monitoring/shared/solomon-agent-bytes-evicted
                  type: wiki

- name: 'juggler_check: compute-node-solomon-quotas'
  juggler_check: ''
  args: "{{ default_check_with_only_telegram_notification | hash_merge(item, default_timed_limits) }}"
  with_items:
    - service: compute-node-solomon-quotas
      refresh_time: 60
      ttl: 180
      children:
        - host: "vpc-infra-{{ env }}"
          service: yandexcloud_cloud_{{ env }}_compute_compute-solomon-quotas
          type: HOST
        - host: "vpc-infra-{{ env }}"
          service: yandexcloud_cloud_{{ env }}_compute_compute_node-solomon-quotas
          type: HOST
        - host: "vpc-infra-{{ env }}"
          service: yandexcloud_cloud_{{ env }}_compute_gpu_servicevm-solomon-quotas
          type: HOST
        - host: "vpc-infra-{{ env }}"
          service: yandexcloud_cloud_{{ env }}_compute_gpu_gpud-solomon-quotas
          type: HOST
        - host: "vpc-infra-{{ env }}"
          service: yandexcloud_cloud_{{ env }}_compute_solomon_agent-solomon-quotas
          type: HOST
        - host: "vpc-infra-{{ env }}"
          service: yandexcloud_cloud_{{ env }}_scheduler_resources-solomon-quotas
          type: HOST
        - host: "vpc-infra-{{ env }}"
          service: yandexcloud_cloud_{{ env }}_compute_health_compute_health-solomon-quotas
          type: HOST
        - host: "vpc-infra-{{ env }}"
          service: yandexcloud_cloud_{{ env }}_compute_health_sys_scheduler-solomon-quotas
          type: HOST
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/shared/solomon-quotas
            type: wiki

- name: 'juggler_check : compute node by tag alerts'
  juggler_check: ''
  args: "{{ default_check_with_only_telegram_notification | hash_merge(item, default_timed_limits_unreach_force_ok) | hash_merge(item, {'timed_more_than_limit_is_problem': {'nodata_mode': 'force_ok'} }) }}"
  vars:
    flap: null
    children:
      - host: '(tag={% if env not in juggler_env_to_salt_env_correction_mapping %}{{ env }}{% else %}{{ juggler_env_to_salt_env_correction_mapping[env] }}{% endif %})&(service={{ item["service"] }})&(tag=compute-team-reason)'
        service: all
        type: EVENTS
        instance: all
    # Override notification parameters to notify even in testing
    telegram_chat_id: ComputeNodeDuty
    notification_methods: "{{ default_telegram_notification }}"
    telegram_notification: "{{ default_telegram_notification }}"
  with_items:
    - service: instance-crash
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/instance-crashed
            type: wiki
    - service: instance-error
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/instance-crashed
            type: wiki
    - service: instance-freeze-time
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/instance-freeze-time
            type: wiki

- name: 'juggler_check: compute-node-licensed-pool-limits'
  juggler_check: ''
  args: "{{ default_check_with_only_telegram_notification | hash_merge(item, default_timed_limits_nodata_ok) }}"
  with_items:
      - service: compute-node-licensed-pool-limits
        children:
            - host: "tag=licensed_pool_limits & tag=Solomon"
              service: compute-node-licensed-pool-limits
              type: EVENTS
        meta:
            urls:
                - title: "[?] Инструкция по алерту"
                  url: https://docs.yandex-team.ru/yc-monitoring/compute-node/compute-node-licensed-pool-limits
                  type: wiki
  when: env == "prod"
