---
- name: 'juggler_check : compute node by tag alerts'
  juggler_check: ''
  args: "{{ default_check_with_only_telegram_notification | hash_merge(item, default_timed_limits_unreach_force_ok) | hash_merge(item, {'timed_more_than_limit_is_problem': {'nodata_mode': 'force_ok'} }) }}"
  tags: ["compute", "core"]
  vars:
    check_tags: ["yc-core", "yc-core-event"]
    flap: null
    children:
      - host: '(tag={% if env not in juggler_env_to_salt_env_correction_mapping %}{{ env }}{% else %}{{ juggler_env_to_salt_env_correction_mapping[env] }}{% endif %})&(service={{ item["service"] }})&(tag=core-team-reason)'
        service: all
        type: EVENTS
        instance: all
    # Override notification parameters to notify even in testing
    notification_methods: "{{ default_telegram_notification }}"
    telegram_notification: "{{ default_telegram_notification }}"
  with_items:
    - service: instance-crash
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/core/instance-crashed
            type: wiki
    - service: instance-error
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/core/instance-crashed
            type: wiki

- name: 'juggler_check : compute node by tag alerts'
  juggler_check: ''
  args: "{{ silent_check | hash_merge(item, default_timed_limits_unreach_force_ok) | hash_merge(item, {'timed_more_than_limit_is_problem': {'nodata_mode': 'force_ok'} }) }}"
  tags: ["compute", "core"]
  vars:
    check_tags: ["yc-core", "yc-core-event"]
    flap: null
    children:
      - host: '(tag={% if env not in juggler_env_to_salt_env_correction_mapping %}{{ env }}{% else %}{{ juggler_env_to_salt_env_correction_mapping[env] }}{% endif %})&(service={{ item["service"] }})&(tag=core-team-reason)'
        service: all
        type: EVENTS
        instance: all
  with_items:
    - service: instance-freeze-time
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/compute-node/instance-freeze-time
            type: wiki

- name: 'juggler_check : core telegram-only checks'
  juggler_check: ''
  args: "{{ default_check_with_only_telegram_notification | hash_merge(item, default_timed_limits_nodata_ok) }}"
  tags: ["compute", "core"]
  vars:
    check_tags: ["yc-core", "yc-core-status"]
  with_items:
    - service: instance-memory
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/core/instance-memory
            type: wiki

- name: 'juggler_check : core checks'
  juggler_check: ''
  args: "{{ default_check_with_only_telegram_notification | hash_merge(item, default_timed_limits_unreach_force_ok) | hash_merge(item, {'timed_more_than_limit_is_problem': {'nodata_mode': 'force_ok'} }) }}"
  tags: ["core"]
  vars:
    check_tags: ["yc-core", "yc-core-status"]
    flap: null
    # Override notification parameters to notify even in testing
    notification_methods: "{{ default_telegram_notification }}"
    telegram_notification: "{{ default_telegram_notification }}"
  with_items:
    - service: vhost-net-ownership
      meta:
        urls:
          - title: "[?] Инструкция по алерту"
            url: https://docs.yandex-team.ru/yc-monitoring/core/vhost-net-ownership
            type: wiki
