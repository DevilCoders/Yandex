[Алерт в Juggler](https://juggler.yandex-team.ru/aggregate_checks/?query=service%3Dinstance-freeze-time)

## instance-freeze-time

Сигнализирует о длительном freeze time (время, в течение которого приостанавливается эмуляция CPU) инстансов во время миграции.

## Подробности

За freeze time принимается время `$end - $start`, где `$start` – время QMP-события `STOP`, а `$end` – время завершения выполнения QMP-команды `cont`. Это довольно точная оценка, но она предполагает синхронизированное время между нодами.

Помимо общего времени замеряется также время в основных точках процесса миграции. Эти замеры суммируются по командам (Core/Compute), и если время превышает заданный порог (захардкожен в коде), генерируется алерт для конкретной команды. На данный момент детализация собирается только для межнодной миграции – для локальной существует только суммарное время.

Алерт выглядит следующим образом:
```
[fdcj4rj046m4rl71kk1a] Instance freeze time during migration (375ms):

Core (106ms):
* Migration completion: 46ms
* Hypervisor queries: 60ms

Compute (269ms):
* Post migration state sending: 6ms
* Allocation switching: 207ms
* NBS remounting: 52ms
* Other: 4ms
```

**Текущие ограничения:**
* Алерт генерируют только Go-ноды
* Python-ноды не посылают Go-нодам детализацию, так что при миграции Python → Go часть метрик будет нулевой или заниженной (но общему времени можно верить всегда).

## Диагностика

В деталях проверки есть основные метрики – дальше уже можно идти в логи и пытаться понять причину:
* `Migration completion` – время от `{"event": "STOP"}` до  `{"event": "MIGRATION", "data": {"status": "completed"}}` на source-гипервизоре.
* `Hypervisor queries` – время, затраченное на общение по QMP.
* `Post migration state sending` – пересылка Compute'ного стейта на target-ноду (флаги, serial port output).
* `Allocation switching` – переключение аллокаций через Compute API.
* `NBS remounting` – перемонтирование NBS-дисков ro → rw.
* `Other` – общее время минус все остальные метрики. По идее может быть отрицательным, т. к. некоторые метрики могут пересекаться во времени, и этого довольно сложно избежать.
