[Алерт в Juggler](https://juggler.yandex-team.ru/aggregate_checks/?query=service%3Dcompute-node-disks)

## compute-node-disks

Сигнализирует об ошибках затирки локальных NVMe-дисков.

## Подробности

Если у ноды не получается затереть диск, то она:
* не пытается больше затирать этот диск (во-первых, как правило, это бессмысленно, во-вторых - чтобы ретраями не протереть дырку в SSD)
* перестает сообщать о его существовании шедулеру
* репортит его в Juggler-проверку

Статус дисков хранится в:
1. `/var/lib/yc/compute-node/local_disks.json` – текущее состояние с точки зрения Compute Node.
2. `state.json` инстанса – текущее состояние с точки зрения инстанса.

– поэтому нельзя править один файл в отрыве от другого.

При этом починка дисков зачастую происходит без переналивки, но какого-либо тулинга по возврату дисков в ноду у нас пока нет (см. [CLOUD-99862](https://st.yandex-team.ru/CLOUD-99862)).

Как вернуть диск в ноду после починки:
1. `systemctl stop yc-compute-node`
2. Убеждаемся, что диск не заассайнен: `grep -r $device /var/lib/yc/compute-node/instances`, где `$device` - что-нибудь вроде `/dev/nvme3n11`
3. Удаляем диск из `/var/lib/yc/compute-node/local_disks.json` (у него должен быть статус `error`)
4. `systemctl start yc-compute-node`
5. Смотрим как диск переходит в `erased`/`ready` в `/var/lib/yc/compute-node/local_disks.json` 

Если же диск заассайнен на инстанс, то необходимо синхронизировать его статус со статусом диска в инстансе (`state.json` → `local_disks.json`):
* `unknown` → `unknown`
* `erasing` → `erasing`
* `ready` → `ready` (предполагаем, что диск, введенный Инфрой, затерт)
* `error` → `unknown`

## Диагностика

В деталях проверки будет список дисков вместе с текстом ошибки.

Раньше мы затирали диски стандартным/одобреным/безопасным способом с помощью утилиты `nvme`, но впоследствии были вынуждены от нее отказаться ([CLOUD-93157](https://st.yandex-team.ru/CLOUD-93157)) и перейти на ручную затирку нолями. На данный момент тут нет какого-то опыта, поэтому нужно исходить из конкретного текста ошибки.

В случае проблем с диском необходимо обратиться к `/duty infra`.