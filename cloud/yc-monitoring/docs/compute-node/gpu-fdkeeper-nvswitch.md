[Алерт в Juggler](https://juggler.yandex-team.ru/aggregate_checks/?query=service%3Dgpu-fdkeeper-nvswitch)

## gpu-fdkeeper-nvswitch

Проверяет, что в сервисе `FDKeeper` присутствует набор дескрипторов с именем
`yc-gpu-nvswitch`.  Набор дескрипторов `yc-gpu-nvswitch` создается сервисом
`yc-gpu-servicevm` и должен присутствовать всегда.

## Подробности

В случае падения сервиса `yc-gpu-servicev` VFIO-дескрипторы NVswitch'ей
остаются во владении сервиса FDKeeper, поэтому сброс NVswitch'ей не происходит
и пользовательских виртуальных машинах не нарушается связность через NVLINK.

## Диагностика

Первым делом нужно вывести узел из планировщика, пока не расберемся с проблемой.

Проверить, запущен ли сервис `yc-gpu-fdkeeper`.

1. Если сервис запущен, то проблема с набором дескрипторов
 `yc-gpu-nvswitch`. Скорее всего проблема с `yc-gpu-servicevm` сервисов,
 потому что именно он регистрирует набор дескрипторов `yc-gpu-nvswitch`.

2. Если сервис не запущен, то проверить состояние сервиса
`yc-gpu-servicevm`. Если `yc-gpu-servicevm` запущен и функционирует нормально,
то произошел сбой в FDKeeper.

## Восстановление после сбоя

### На узле нет пользовательских виртуальных машин с GPU

Если на узле нет пользовательских машин с GPU, то нужно рестартовать `yc-gpu-servicevm`

    sudo systemctl stop yc-gpu-servicevm yc-gpu-fdkeeper
    sudo systemctl start yc-gpu-servicevm

### На узле есть пользовательские виртуальные машины с GPU

#### Сервис yc-gpu-servicevm запущен

Если на узле есть пользовательские машины с GPU и сервис `yc-gpu-servicevm`
функционирует, то следует запустить `yc-gpu-fdkeeper` и выполнить трансфер
файловых дескрипторов из работающего процесса `yc-gpu-servicevm` (как это
сделать - будеть описано позже, пока эта функциональность не поддерживается,
но будет поддерживаться).

#### Сервис yc-gpu-servicevm остановлен

Нужно перейти к процедуре восстановления как после краша сервисной виртуальной
машины.
