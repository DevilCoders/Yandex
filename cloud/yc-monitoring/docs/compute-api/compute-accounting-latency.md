[Алерт в Solomon](https://solomon.yandex-team.ru/admin/projects/yandexcloud/alerts?text=alert+on+compute+accounting+la), [Алерт в Juggler](https://juggler.yandex-team.ru/aggregate_checks/?query=service%3Dcompute-accounting-*)

## Описание
Мониторинг тасок, собирающих биллинговые метрики по дискам/снапшотам и образам.

## Подробности
На головах работают таски, собирающие метрики по дискам, снапшотам и образам. Таски ("диспетчеры") просыпаются с некоторым периодом, запускают одну (или несколько) подтасок ("воркеров"), дожидаются их завершения и снова засыпают. Мониторинг загорается, если превышается порог отставания последнего успешно обработанного интервала времени от текущего момента. 

## Диагностика
- Посмотреть на соответствующий типу таски (images|snapshots|disks) график *Latency* на [дашборде](https://grafana.yandex-team.ru/d/W9J0voqWk/cloud-compute-accounting-status?orgId=1&var-cluster=preprod&var-objects=All)
- Проверить сами таски-диспетчеры: `sudo yc-compute-tasksctl acct list`
- Если таски зависли - остановить их: `sudo yc-compute-tasksctl tasks stop <id>`
- Если нет запущенных тасок нужного типа - запустить их:  `sudo yc-compute-tasksctl acct start [images|snapshots|disks`
    - Запустятся таски только указанных типов. Если тип не указан, запустятся все поддерживаемые. Если таска уже запущена, она останется без изменений, новая запускаться не будет.
- Посмотреть конфиг запуска тасок: `sudo yc-compute-tasksctl acct config [images|snapshots|disks]`
    - Показываются основные параметры запуска тасок: период, время жизни изменений в БД, длина интервалов, по границе которых будут "резаться" метрики (сейчас по требованиям биллинга - по границам часа).

### Примечания
- Все команды могут принимать тип (или типы) биллинговой таски в качестве параметра. По умолчанию, если параметр не обязателен и не указан, берутся все поддерживаемые типы главных тасок ("диспетчеров"). Также можно указывать и таски-"воркеры": image-worker, snapshot-worker, disk-worker. При этом нужно учитывать, что таски-"диспетчеры" "многоразовые" и их существует по одной каждого типа; таски-"воркеры" "одноразовые" и их может быть очень много завершенных.
- Биллинговые таски на данные момент складывают логи в файл `/var/lib/yc/compute-tasks/accounting/<type>.log-<number>` , где `type` - тип таски, `number` - номер "шарда" (если поддержано и сконфигурировано шардирование таблицы и таски). Отсюда логи запираются push-client'ом и отправляются в логброкер.

## Ссылки
- [Дашборд в Графане](https://grafana.yandex-team.ru/d/W9J0voqWk/cloud-compute-accounting-status?orgId=1&var-cluster=preprod&var-objects=All)