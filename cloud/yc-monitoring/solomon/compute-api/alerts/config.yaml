api_path: /alerts/
entities:

  compute_failed_operations:
    template: compute_failed_operations.j2
    exclude: {env: [hw.*lab]}

  compute_accounting_latency:
    template: compute_accounting_latency.j2
    exclude: {env: [hw.*lab]}

  compute_hanging_operations:
    template: compute_hanging_operations.j2
    exclude: {env: [hw.*lab]}

  compute_hanging_tasks:
    template: compute_hanging_tasks.j2
    exclude: {env: [hw.*lab]}

  # compute tasks GC

  compute_removed_disks_gc:
    template: compute_system_gc.j2
    exclude: {env: [hw.*lab]}
    context:
      sensor: removed_disks_age
      warn: 26
      alarm: 170
      name: "Alert on removed disks"
      service: compute-removed-disks-age
      details: "Removed disks are not cleaned up"
      description: "Время самого старого диска в корзине"

  compute_completed_tasks_gc:
    template: compute_system_gc.j2
    exclude: {env: [hw.*lab]}
    context:
      sensor: completed_tasks_age
      warn: 340
      alarm: 505
      name: "Alert on completed tasks"
      service: compute-completed-tasks-age
      details: "Completed tasks are not cleaned up"
      description: "Время хранения завершенных тасок в таблице"

  compute_completed_operations_gc:
    template: compute_system_gc.j2
    exclude: {env: [hw.*lab]}
    context:
      sensor: completed_operations_age
      warn: 340
      alarm: 505
      name: "Alert on completed operations"
      service: compute-completed-operations-age
      details: "Completed operations are not cleaned up"
      description: "Время хранения завершенных операций в таблице"

  compute_completed_idempotence_tokens_gc:
    template: compute_system_gc.j2
    exclude: {env: [hw.*lab]}
    context:
      sensor: completed_idempotence_tokens_age
      warn: 3
      alarm: 50
      name: "Alert on completed idempotence tokens"
      service: compute-idempotence-tokens-age
      details: "Idempotence tokens are not cleaned up"
      description: "Время хранения токена идемпотентности в таблице"

  # common alerts

  compute_logbroker_messages_read:
    template: ../../common/alerts/logbroker/messages_read.j2
    context: &logbroker_defaults
      # Common parameters
      team: Compute
      windowSecs: 1800
      host: yc_compute_logbroker_{{ env }}
      account: yc.compute.cloud
      topic_path: yc.compute.cloud/logs/journald/topic
      notification_channels:
        {% if env in ["prod", "preprod"] %}
        - compute_api_duty_telegram
        - juggler
        {% endif %}
      # Tunable parameters
      service: topic-journald-messages-read
      alarm_limit: 100
      warn_limit: 500
    exclude: {env: [hw.*lab, testing]}

  compute_logbroker_messages_written:
    template: ../../common/alerts/logbroker/messages_written.j2
    context:
      <<: *logbroker_defaults
      service: topic-journald-messages-written
      alarm_limit: 100
      warn_limit: 500
    exclude: {env: [hw.*lab, testing]}

  compute_logbroker_partition_max_write_quota_used:
    template: ../../common/alerts/logbroker/partition_max_write_quota_used.j2
    context:
      <<: *logbroker_defaults
      service: topic-journald-partition-max-write-quota-used
      alarm_limit: 100
      warn_limit: 95
      state: MUTED
    exclude: {env: [hw.*lab, testing]}

  compute_logbroker_partition_write_quota_wait:
    template: ../../common/alerts/logbroker/partition_write_quota_wait.j2
    context:
      <<: *logbroker_defaults
      service: topic-journald-partition-write-quota-wait
      alarm_limit: 60
      warn_limit: 30
      state: MUTED
    exclude: {env: [hw.*lab, testing]}

  compute_logbroker_topic_write_quota_wait:
    template: ../../common/alerts/logbroker/topic_write_quota_wait.j2
    context:
      <<: *logbroker_defaults
      service: topic-journald-topic-write-quota-wait
      alarm_limit: 10000
      warn_limit: 5000
      state: MUTED
    exclude: {env: [hw.*lab, testing]}

  compute_logbroker_read_time_lag:
    template: ../../common/alerts/logbroker/read_time_lag.j2
    context:
      <<: *logbroker_defaults
      service: topic-journald-read-time-lag
      alarm_limit: 1800000
      warn_limit: 600000
    exclude: {env: [hw.*lab, testing]}

  compute_logbroker_time_since_last_read:
    template: ../../common/alerts/logbroker/time_since_last_read.j2
    context:
      <<: *logbroker_defaults
      service: topic-journald-time-since-last-read
      alarm_limit: 1800000
      warn_limit: 600000
    exclude: {env: [hw.*lab, testing]}

  # compute API alerts

  compute_api_latency:
    template: compute_api_latency.j2
    exclude: {env: [hw.*lab]}

  compute_api_errors:
    template: compute_api_errors.j2
    exclude: {env: [hw.*lab]}

  compute_api_errors_with_details:
    template: compute_api_errors_with_details.j2
    exclude: {env: [hw.*lab]}
    context:
      min_error_count: 10
      warn: 5
      alarm: 20

  compute_api_token:
    template: compute_api_token.j2
    exclude: {env: [hw.*lab]}

  compute_api_private_latency:
    template: compute_api_private_latency.j2
    exclude: {env: [hw.*lab]}

  compute_api_private_errors:
    template: compute_api_private_errors.j2
    exclude: {env: [hw.*lab]}

  compute_api_private_warnings:
    template: compute_api_private_warnings.j2
    exclude: {env: [hw.*lab]}

  # compute metadata alerts

  compute_metadata_latency:
    template: compute_metadata_latency.j2
    exclude: {env: [hw.*lab]}

  compute_metadata_errors:
    template: compute_metadata_errors.j2
    exclude: {env: [hw.*lab]}

  compute_metadata_token_agent:
    template: compute_metadata_token_agent.j2
    exclude: {env: [hw.*lab]}

  compute_metadata_token_service:
    template: compute_metadata_token_service.j2
    exclude: {env: [hw.*lab]}

  # compute tasks alerts

  compute_pending_tasks:
    template: compute_pending_tasks.j2
    exclude: {env: [hw.*lab]}

  compute_failed_tasks:
    template: compute_failed_tasks.j2
    exclude: {env: [hw.*lab]}

  compute_tasks_token:
    template: compute_tasks_token.j2
    exclude: {env: [hw.*lab]}

  # compute index task alerts

  compute_instance_index_task:
    template: compute_index_tasks.j2
    exclude: {env: [hw.*lab, testing]}
    context:
      task: search-index-instances
      alarm_hours: 36
      warn_hours: 24
      service: compute-search-index-instances

  compute_disk_index_task:
    template: compute_index_tasks.j2
    exclude: {env: [hw.*lab, testing]}
    context:
      task: search-index-disks
      alarm_hours: 36
      warn_hours: 24
      service: compute-search-index-disks

  # compute disk events

  compute_disk_events:
    template: compute_disk_events.j2
    exclude: {env: [hw.*lab, testing]}
    context:
      warn_hours: 1
      alarm_hours: 2
      service: compute-disk-events
      name: "Alert on disk-events reader"
      details: "Reader of disk events broken"
      description: "См. https://wiki.yandex-team.ru/cloud/compute/alerts-manuals/#alertalertondisk-eventsreader для инструкций"

  # compute api solomon fetch status

  compute_solomon_fetch_status:
    template: ../../common/alerts/compute/solomon_fetch_status.j2
    exclude: {env: [hw.*lab]}
    context:
      warn: 5
      alarm: 10
      service_name: "compute-api"
      tags: "yc-compute-api-team"
      repeatNotifySecs: 3600
      shards:
        compute: ["compute_metadata"]
        head: ["compute_head", "compute_tasks", "solomon_agent", "sys"]
        {% for az in zones_by_env[ env ] %}
        compute_{{ az.prefix }}: ["internals" ]
        {% endfor %}

  compute_api_solomon_agent_bytes_evicted:
    template: ../../common/alerts/compute/solomon_agent_bytes_evicted.j2
    exclude: {env: [hw.*-lab]}
    context:
      service_name: "compute-api"
      units: ["head"]
      alarm: 0
      tags: ["yc-compute-api-team"]

  # compute tasks internal client alerts
  compute_internal_nbs_client:
    template: compute_internal_nbs_client.j2
    exclude: {env: [hw.*lab, testing]}
    context:
      min_error_count: 10
      warn: 50
      alarm: 100

  compute_head_memory:
    template: compute_service_memory.j2
    exclude: {env: [hw.*lab]}
    context:
      service_name: head
      warn: 2
      alarm: 3

  compute_tasks_memory:
    template: compute_service_memory.j2
    exclude: {env: [hw.*lab]}
    context:
      service_name: tasks
      warn: 2
      alarm: 3
