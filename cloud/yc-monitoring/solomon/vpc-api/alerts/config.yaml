{% macro vpc_api_dashboard_url() -%}
    {{ solomon_endpoint }}/?project={{ project_id }}&dashboard=vpc_api_logbroker_{{ env }}
{%- endmacro %}

{% macro wiki_url(service) -%}
    https://wiki.yandex-team.ru/cloud/devel/sdn/duty/juggler/#{{ service }}
{%- endmacro %}

menu: "[ConfigPlane] Alerts"
menu_type: admin
api_path: /alerts/
tags: ["cfg"]

entities:
  # По умолчанию не создаем алерты для HW-LAB, чтобы не тратить
  # время на их синхронизацию и не перегружать интерфейс
  # Solomon лишними алертами.
  allocator_resources:
    template: allocator_resources.j2
    exclude:
      env: &hw_labs [hw.*lab]
  vpc_api_errors:
    template: vpc_api_errors.j2
    exclude:
      env: *hw_labs
  vpc_api_contrail_errors:
    template: vpc_api_contrail_errors.j2
    exclude:
      env: *hw_labs
  vpc_api_failed_tasks:
    template: vpc_api_failed_tasks.j2
    exclude:
      env: *hw_labs
  vpc_api_interrupted_tasks:
    template: vpc_api_interrupted_tasks.j2
    exclude:
      env: *hw_labs
  vpc_api_periodic_task_failed:
    template: vpc_api_periodic_task_failed.j2
    exclude:
      env: *hw_labs
  vpc_api_ready_tasks:
    template: vpc_api_ready_tasks.j2
    context:
      alarm_limit:
        prod: 500
        preprod: 100
        default: 50
      warn_limit:
        prod: 100
        preprod: 50
        default: 30
    exclude:
      env: *hw_labs
  vpc_api_many_retries_tasks:
    template: vpc_api_many_retries_tasks.j2
    exclude:
      env: *hw_labs
  vpc_api_not_processing_tasks:
    template: vpc_api_not_processing_tasks.j2
    exclude:
      env: *hw_labs
  vpc_api_error_in_logs:
    template: vpc_api_messages_in_logs.j2
    context:
      level: error
      alarm_limit:
        prod: 0.2
        preprod: 0.2
        default: 0.2
      warn_limit:
        prod: 0.1
        preprod: 0.1
        default: 0.1
    exclude:
      env: *hw_labs
  vpc_api_long_duration_tasks:
   template: vpc_api_long_duration_tasks.j2
   exclude:
     env: *hw_labs
  vpc_api_long_duration_ops:
   template: vpc_api_long_duration_ops.j2
   exclude:
     env: *hw_labs
  vpc_api_contrail_dead_endpoints:
    template: vpc_api_contrail_dead_endpoints.j2
    exclude:
      env: *hw_labs
  vpc_api_gc_timings:
    template: vpc_api_gc_timings.j2
    exclude:
      env: *hw_labs
    context:
      alarm_limit:
        prod: 1.5
        preprod: 1.4
        testing: 2.5
        israel: 1.5
      warn_limit:
        prod: 1.0
        preprod: 1.0
        testing: 2.0
        israel: 1.0

  # Logbroker
  vpc_api_logbroker_quota_consumed:
    template: ../../common/alerts/logbroker/quota_consumed.j2
    context: &logbroker_defaults
      # -- Common parameters
      team: VPC API
      host: cloud_{{env}}_vpc-api_solomon
      account: yc.vpc.api
      topic_path: yc.vpc.api/vpc/{% if env == 'preprod' %}pre-prod{% else %}{{ env }}{% endif %}/api/yc-vpc-config-plane-*-log
      quoter:
        prod: "/global/b1gvcqr959dbmi1jltep/etn03iai600jur7pipla/PersQueue/System/Quoters/yc.vpc.api"
        preprod: "/pre-prod_global/aoeb66ftj1tbt1b2eimn/cc8035oc71oh9um52mv3/PersQueue/System/Quoters/yc.vpc.api"
      notification_channels:
        {% if solomon in ["main",] %}
        - vpc-api-juggler
        - vpc_cfg_telegram
        {% else %}
        - vpc-api-juggler
        {% endif %}
      dashboard_url: {{ vpc_api_dashboard_url() }}
      wiki_url: https://wiki.yandex-team.ru/cloud/devel/sdn/duty/juggler/
      # -- Common parameters
      alarm_limit:
        prod: 1800    # real limit: 2000 (LBREQUESTS-1101)
        preprod: 180   # real limit: 200 (LBREQUESTS-1222)
      warn_limit:
        prod: 1500
        preprod: 150
    exclude: {env:  &with_prod_preprod [hw.*lab, testing, israel]}

  vpc_api_logbroker_messages_read:
    template: ../../common/alerts/logbroker/messages_read.j2
    context:
      <<: *logbroker_defaults
      # limits in messages/sec
      alarm_limit:
        prod: 1
        preprod: 0.5
      warn_limit:
        prod: 3
        preprod: 1
    exclude: {env: *with_prod_preprod}

  vpc_api_logbroker_messages_written:
    template: ../../common/alerts/logbroker/messages_written.j2
    context:
      <<: *logbroker_defaults
      # limits in messages/sec
      alarm_limit:
        prod: 1
        preprod: 0.5
      warn_limit:
        prod: 3
        preprod: 1
    exclude: {env: *with_prod_preprod}

  vpc_api_logbroker_partition_max_write_quota_used:
    template: ../../common/alerts/logbroker/partition_max_write_quota_used.j2
    context:
      <<: *logbroker_defaults
      # percent/minute
      alarm_limit: 90
      warn_limit: 80
    exclude: {env: *with_prod_preprod}

  vpc_api_logbroker_partition_write_quota_wait:
    template: ../../common/alerts/logbroker/partition_write_quota_wait.j2
    context:
      <<: *logbroker_defaults
      # milliseconds
      alarm_limit: 60
      warn_limit: 30
    exclude: {env: *with_prod_preprod}

  vpc_api_logbroker_topic_write_quota_wait:
    template: ../../common/alerts/logbroker/topic_write_quota_wait.j2
    context:
      <<: *logbroker_defaults
      # milliseconds
      alarm_limit: 10000
      warn_limit: 5000
    exclude: {env: *with_prod_preprod}

  vpc_api_logbroker_read_time_lag:
    template: ../../common/alerts/logbroker/read_time_lag.j2
    context:
      <<: *logbroker_defaults
      # milliseconds
      alarm_limit: 100000
      warn_limit: 60000
    exclude: {env: *with_prod_preprod}

  vpc_api_logbroker_time_since_last_read:
    template: ../../common/alerts/logbroker/time_since_last_read.j2
    context:
      <<: *logbroker_defaults
      # milliseconds
      alarm_limit: 500000
      warn_limit: 300000
    exclude: {env: *with_prod_preprod}

  vpc_api_grpc_latency_read:
    template: vpc_api_grpc_latency.j2
    context:
      type: read
      alarm_limit:
        prod: 4.0
        preprod: 5.0
        testing: 1.0
        israel: 1.0
      warn_limit:
        prod: 3.0
        preprod: 2.0
        testing: 0.5
        israel: 0.5
  vpc_api_grpc_latency_write:
    template: vpc_api_grpc_latency.j2
    context:
      type: write
      alarm_limit:
        prod: 25.0
        preprod: 10.0
        testing: 5.0
        israel: 5.0
      warn_limit:
        prod: 10.0
        preprod: 5.0
        testing: 3.0
        israel: 3.0
  # NB: эти алерты живут там же, где L7 platform - в cloud-соломоне для PROD, PREPROD
  vpc_api_l7_errors:
    template: vpc_api_l7_errors.j2
    tags: [l7]
    exclude:
      solomon:
        - main
      # эти алерты заводим только в PROD, PREPROD - там, где есть L7-балансер
      env: &with_l7_balancer [hw.*lab, testing, israel]
  vpc_api_l7_panic_mode:
    template: vpc_api_l7_panic_mode.j2
    tags: [l7]
    exclude:
      solomon:
        - main
      env: *with_l7_balancer
  # NB: эти алерты живут там же, где YC Search - в cloud-соломоне для PROD, в cloud-preprod для PREPROD
  vpc_api_unparsed_search_docs_vpc:
    template: vpc_api_unparsed_search_docs.j2
    tags: [yc-search]
    exclude:
      solomon:
        - main
      env: *with_prod_preprod
    context:
      service_name: vpc
  vpc_api_unparsed_search_docs_ylb:
    template: vpc_api_unparsed_search_docs.j2
    tags: [yc-search]
    exclude:
      solomon:
        - main
      env: *with_prod_preprod
    context:
      service_name: ylb
