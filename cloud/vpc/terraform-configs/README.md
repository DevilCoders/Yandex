## Что это

Здесь лежат терраформ-рецепты и конфиги для разворачивания.

На верхнем уровне папки соответствуют стендам — проду, препроду, тестингу и так далее. В них лежат описания ресурсов, которые надо развернуть на этом стенде. Чтобы код не дублировался,
мы используем терраформ-модули с описанием частых кейсов. Они лежат в папке `modules/`.

Подробнее о модулях в терраформе и их использовании можно почитать в документации: https://www.terraform.io/docs/modules/index.html.

**Важно.** Используйте терраформ версии 0.13 или новее. На момент обновления инструкции актуальная версия — 0.15.4, для неё всё работает.
**Важно.** Для генерации `{provider,backend,variables}.tf` мы используем terragrunt. Не пытайтесь написать эти файлы руками, terragrunt их перезапишет.

## Стейты

Терраформ оперирует понятиями стейт и план выполнения. Стейт — это большой JSON-файл, в котором написано, какие ресурсы уже созданы на стенде.
План выполнения — это последовательность операций, которая приводит текущий стейт к желаемому, то есть к тому, который описан в конфигурации в одной из стендовых папок этого репозитория.

Стейт не хранится в репозитории, потому что сам терраформ не рекомендует так делать — ведь может так оказаться, что два человека ведут разработку одновременно и выполняют у себя на
компьютерах `terragrunt apply`. При этом стейт меняется, но другой разработчик об этом не узнает, пока первый не закоммитит своё изменение.

Поэтому мы храним все стейты в облачном S3. В стейте могут быть чувствительные данные (например, пароли от баз данных), поэтому [бакет](https://console.cloud.yandex.ru/folders/b1gg0k11ikpvfr3a81o1/storage/bucket/vpc-terraform-states) и файлы в нём не доступны без аутенфикации. Чтобы терраформ получил доступ к бакету, создан специальный [сервисный аккаунт](https://console.cloud.yandex.ru/folders/b1gg0k11ikpvfr3a81o1/service-account/aje50qt40tcp93adm5t9), а для него сгенерирован статический ключ доступа для S3. Данные этого ключа лежат в Vault и доступны всем сотрудникам YC VPC [тут](https://yav.yandex-team.ru/secret/sec-01eeg2ztgqakgs2m6xd96xhhrd).

## Пререквизиты

1. Установите terraform с официального сайта: https://www.terraform.io/downloads.html. Проверено на версии 0.15.4.

1. Установите terragrunt: https://terragrunt.gruntwork.io/docs/getting-started/install/. Проверено на версии 0.29.7.

1. Установите ycp: https://wiki.yandex-team.ru/cloud/devel/platform-team/dev/ycp/.
Настройте в нём федеративную аутентификацию для необходимых вам профилей. По умолчанию это: `prod`, `preprod`, `testing`.
Для другого стенда, название профиля можно посмотреть в файле `stand.tfvars` нужного вам стенда.

1. Установите skm: https://wiki.yandex-team.ru/cloud/devel/platform-team/infra/skm/
Он необходим, только если в рецептах, которые вы собираетесь применить есть стейты с `skm`. Например, [`modules/monitoring/mr_prober`](modules/monitoring/mr_prober).

1. Для некоторых (почти всех) модулей требуется питон с модулем `yaml`. Его можно установить через `pip install pyyaml`.

## Как запустить

1. Посмотрите данные статического ключа для доступа терраформа к S3 в Vault: https://yav.yandex-team.ru/secret/sec-01eeg2ztgqakgs2m6xd96xhhrd. Укажите `KEY_ID` и `ACCESS_KEY` в переменных окружения следующим образом:

```
export AWS_ACCESS_KEY_ID=...
export AWS_SECRET_ACCESS_KEY=...
```
или выполните:
```
source ./awskeys.sh # должна быть установлена утилилта ya, она есть в корне аркадии
```

1. Для шифрования секретов с помощью `skm` и походов в кондуктор нужно определить токен

```
export TF_VAR_yandex_team_token=...
```

Взять токен нужно здесь: https://oauth.yandex-team.ru/authorize?response_type=token&client_id=18cc5e70bf92483796e21aecc67589ee.
Он даст доступ к YaV, кондуктору, ABC и стаффу.

**Лайфхак:** поместите все три `export`-а в файлик `credentials.sh` и перед работой с терраформом вызывайте `source credentials.sh`. Токены действительны год, поэтому менять их часто не придётся.

1. Зайдите в папку нужного вам стенда и нужного приложения. Например, `preprod/mr_prober`.

1. Выполните `terragrunt init -upgrade`.
Эту команду нужно вызывать при использовании нового модуля или провайдера, при обновлении терраформа, переходе на новую версию провайдера и других миграциях.
Для нового провайдера рекомендуется сохранить кэш сразу для `linux` и `darwin`, выполнив: `terraform providers lock -platform=darwin_amd64 -platform=linux_amd64` -
это упростит жизнь коллегам с ОС отличающейся от вашей.

1. Выполните `terragrunt plan`, чтобы получить план выполнения.

1. Выполните `terragrunt apply`, чтобы план исполнился. Чтобы быть уверенным, что исполнится ровно тот план, что был сгенерирован на предыдущем шаге, можно воспользоваться командами `terragrunt plan -out plan.json` и `terragrunt apply plan.tfplan`.

## Работа с секретами

Секреты доставляются в виртуальные машины с помощью `skm`.
Для этого нужно сгенерировать ключ (ресурс типа `yandex_kms_symmetric_key`), выдать на него права сервисному аккаунту виртуалки и собрать конфиг по инструкции `skm`. Для примера см. [`modules/monitoring/mr_prober/api_secrets.yaml`](modules/monitoring/mr_prober/api_secrets.yaml). Ключ описывается в [`modules/monitoring/mr_prober/kms.tf`](modules/monitoring/mr_prober/kms.tf).

Скрипт [generate.py](modules/shared/skm/generate.py) самостоятельно получает iam-токен через `ycp` и добавляет его в env перед вызовом `skm`.

Если вдруг `terragrunt` падает на стейтах с `skm`, то самый быстрый способ понять причину - ~~внимательно прочитать сообщение об ошибке~~ добавить ключ `--debug` к запуску `skm` в скрипте [modules/shared/skm/generate.py](modules/shared/skm/generate.py).
Будет показан подробный вывод всех вызовов `skm`.

## Дополнительно

Облака, фолдеры и сети часто создаются в этапе `provision-default-resources` в [bootstrap-templates](https://bb.yandex-team.ru/projects/CLOUD/repos/bootstrap-templates/browse), а вот создавать там инстансы не рекомендуется.
