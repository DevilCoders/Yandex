`issue-certs.py` выписывает сертификаты в облачном сертификаторе (YC CRT), перерабатывает их в необходимый для секрета формат, помещает в secret service и выдаёт конфигурацию секретов для пилларов в соли или deploy-secrets в bootstrap.

Чтобы выписать группу секретов (Secret Group), нужно задать в конфиге config.yaml две группы параметров:
* Cluster описывает список хостов, сгруппированных по базовым ролям (для серверных сертификатов) и по группе и подгруппе клиентов
* Secret Group выбирает хосты по базовым ролям и клиенты по группе, а также список секретов которые нужно выписать. На один cluster могут выписываться множество secret group.
Кроме этого в `config.yaml` записываются некоторые глобальные параметры, в частности ABC-группы которым может принадлежать секрет, если необходимо выписывать секрет для других сервисов-ABC-групп, лучше завести отдельный `config.yaml`.

`issue-certs` идемпотентен: при перезапуске он использует уже выписанные сертификаты, и уже сохранённые секреты в Secret Service (но может дописывать в них)

#### Известные проблемы

[https://st.yandex-team.ru/CLOUD-70460](CLOUD-70460). С точки зрения Secret Service существовал секрет с двумя файлами, у разных файлов были разные версии — первая и вторая. `yc-issue-cert` в сгенерированных пилларах прописал у обоих файлов вторую версию, что вызвало проблемы при релизе.

#### Подготовка окружения

Для работы yc-issue-certs необходимо:
* [Установить yc-secret-cli](https://wiki.yandex-team.ru/cloud/infra/secret-service/cli/)
* [Получить OAuth токен для YC CRT](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=577125be67bb4415ab1d781d19434545) и пробросить его как переменную окружения `YC_CRT_TOKEN`
* Собрать yc-issue-certs:
```
arcadia/cloud/vpc/sdn-misc/issue-certs$ ya make -j4
```

Для выписывания сертификатов, использующих JKS (для Cassandra), потребуются также установленные openssl и JDK.

#### Запуск yc-issue-certs

```
./src/yc-issue-certs [-h] [--debug] [-c CONFIG] [--reissue] [--revoke]
                     [-o VAR=VAL[,VAR=VAL]] [--save DIRECTORY] [-f FORMAT]
                     CLUSTER GROUP
```

Здесь:
* `--debug` включает режим отладочного логирования
* `-c CONFIG` выбирает конфиг (по-умолчанию: config.yaml)
* `--save DIRECTORY` сохраняет секреты в директорию вместо загрузки в Secret Service
* `--reissue` и `--revoke` перевыписывают и отзывают старый сертификат в YC CRT. **Не рекомендуются**, так как процесс перевыпуска пока не отработан
* `-f FORMAT` задаёт формат, в котором генерируется результируещее описание выписанных секретов:
    * `salt` (по-умолчанию) для получения секретов через salt и записи в пиллары
    * `bootstrap` для bootstrap-templates и привоза через deploy-secrets
* `-o VAR=VAL` задаёт дополнительные параметры секретов, например для секретов которые генерируются не из сертификатов
* `CLUSTER` и `GROUP` соответственно задают кластер и группу секретов (ключи в словаре в конфигах).

Например:
```
./issue-certs.py -o password-file-path=/tmp/cassandra-passwd.txt cloudvm oct-head
```

#### Описание кластера

* `bootstrap_stand` задаёт имя стенда в bootstrap (`stand_name`), которое используется как инфикс в имени группы самим bootstrap. Для dev-окружений используется имя `dev`.
* `secret_profile` задаёт профиль из конфига yc-secret-service который будет использоваться для сохранения секретов: `testing`, `prod` и `pre-prod`;
* `prefix` задаёт префикс в имени секретов который будет добавляться при сохранении
* `is_cloudvm` специальный флаг для кластера CloudVM;
* `zone_id` задаёт дополнительный фильтр по зоне для bootstrap-templates;
* `scope` задаёт имя scope для per-cluster секретов: например имя кластера oct или зоны.
* `hosts` задаёт списки хостов (hostname), сгруппированные по базовым ролям. На каждый hostname будет выписан индивидуальный сертификат.

Например:
```
bootstrap_stand: dev
secret_profile: testing
prefix: cloudvm_oct
is_cloudvm: True
zone_id: ru-lab1-b
hosts:
  oct-head:
    - oct-head1.cloud-lab.yandex.net
clients:
  oct-clients:
    head:
    - head-oct-client.cloud-lab.yandex.net
```

При назначении секретов на группы bootstrap, имена hostgroup в Secret Service групп будут сгенерированы как `bootstrap_base-role_{bootstrap_stand}_{base_role}`.

**Замечание**: `issue-certs` не поддерживает сертификаты, выписанные на множество хостов и wildcard-сертификаты.

**Замечание**: Некоторые секреты, такие как `oct-cassandra-truststore` генерирует секрет из всех хостов кластера, выбранных по `secret_group`. Так как сейчас `issue-certs.py` не поддерживает выбор хостов по зоне, необходимо дробить кластера, например: `vla@prod`, `sas@prod` и т.д.

#### Описание группы секретов

* `base_roles` (в виде списка ролей) или `client_group` задают фильтр по которому надо выбирать хосты из кластера, на которые будут выписываться сертификаты
* `secrets` задаёт список выписываемых секретов:
    * `type` задаёт класс, который будет выписывать секрет;
    * `scope` задаёт как будет выписываться секрет: на каждый хост индивидуально (`HOST`) или на все хосты в secret group (`ROLE`). В данный момент не имеет большого смысла, так как это зависит от реализации класса, выписывающего секрет.

Например:
```
base_roles:
- oct-head
secrets:
- type: oct-cloud-ca
  scope: ROLE
- type: contrail-api-pem
  scope: HOST
```

**Замечание**: В данный момент многие опции секретов (такие, как Unix-группа/пользователь владельца) "захардкожены" в классе, выписывающем секрет.

#### Поддерживаемые типы секретов

##### contrail-api-pem и contrail-api-v6-pem

PEM-файл для contrail-api.

##### oct-cloud-ca

CA, которым подписан сертификаты Cassandra (по сути `YandexCloudInternalIntermediateCA`), которому доверяет Contrail.
Также используется для доступа из Contrail в RabbitMQ.

##### oct-cassandra-truststore

JKS для всех инстансов кластера Cassandra содержащий доверенные сертификаты кластера. Содержит не CA, а сертификаты выписанные хостам.

##### oct-cassandra-keystore

JKS для одного инстанса Cassandra, содержащий сертификат и приватный ключ.

##### oct-database-secrets

Файл с паролем и пользователем cassandra. Требует опцию `password-file-path` для задания пароля - файл содержит только строку с паролем - остальная часть секретного конфига генерится классом секрета.

##### oct-client-*

Секреты для клиенской аутентификации в contrail-api. Привозят pem на группу базовых ролей, соответствующую сертификату. Не поддерживают больше одного hostname на подгруппу.

###### oct-client-head

Требует подгруппы head в oct-clients.

###### oct-client-vpc-api

Требует подгруппы vpc-api в oct-clients.

###### oct-client-e2e

Требует подгруппы e2e в oct-clients.

###### oct-client-provision

Требует подгруппы provision в oct-clients.

#### Конфигурация прав в secret service

При добавлении секретов в secret service, yc-issue-certs также уставляет на них права используя команду grant в соответствие с маппингом базовой роли, для которой предназначается секрет в список групп в соответствии с опцией `base_role_abc_groups`

Также утилита назначает их на hostgroup, но только на те, которые разрешены в списке `allowed_base_roles`. В случае если у выписывающего нет прав на некоторые базовые роли (а они есть у смежной команды), необходимо выдать права на эти секреты смежной команде используя `base_role_abc_groups`, а в `allowed_base_roles` эти роли не указывать. При этом yc-issue-certs вместо выполнения yc-secret-cli, выдаст необходимые команды для назначения.
