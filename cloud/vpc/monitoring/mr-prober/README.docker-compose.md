## Mr. Prober docker-compose

На текущий момент в docker-compose.yaml описана следующая конфигурация:

- `db` - база данных PostgreSQL. Используется образ `postgres`. База по умолчанию доступна на порту 5432.
- `minio` - файловое хранилище на базе MinIO. Используется образ `quay.io/minio/minio`. Консоль по умолчанию доступна по
  адресу [http://localhost:9001/](http://localhost:9001/). Логин: `minio123`, пароль: `minio123`.
- `api` - образ собирается из `./api/Dockerfile`. Консоль по умолчанию доступна по
  адресу [http://localhost:8080/](http://localhost:8080/)
- `agent` - образ собирается из `./agent/Dockerfile`.
- `db-init` - образ собирается из `./api/Dockerfile`. Применяет все необходимые миграции в базе данных и завершается.
- `minio-init` - используется образ `minio/mc`. Создает базовые объекты в S3:
    - создает сервисный аккаунт с ключом указанным в переменных `S3_ACCESS_KEY_ID`, `S3_SECRET_ACCESS_KEY`
    - создает необходимые бакеты

### Переменные окружения

docker-compose умеет самостоятельно подставлять переменные, описанные в shell-стиле в docker-compose.yaml. Файл .env
вычитывается автоматически при наличии. Таким образом часть переменных в docker-compose.yaml, при необходимости, можно
переопределить.

### docker volumes

Чтобы при остановке\рестарте контейнеров с базой данных и S3 данные не терялись, для них настроены volume. Так же volume
используются при запуске остальных контейнеров (api, agent, db-init) для проброса всей корневой директории, таким образом
при изменении кода достаточно лишь перезапустить контейнер, без необходимости пересобирать образ. Однако для корректной
работы volume внутри FUSE необходимо произвести настройки arc, описанные [тут](tools/synchronize/README.md).

### Шпаргалка

- `docker-compose up -d` - запустит все контейнеры
- `docker-compose up` - запустит все контейнеры и перенаправит их вывод в консоль
- `docker-compose up api` - запустит контейнер с api, а также контейнеры с базой данных и файловым хранилищем, т.к. api
  от них зависит. Однако перенаправит вывод только контейнера с api
- `docker-compose up db-init` - так в уже запущенной базе данных можно прокатить новые миграции
- `docker-compose restart api` - перезапустит контейнер с api
- `docker-compose down` - остановит все контейнеры
- `docker-compose down -v` - остановит все контейнеры и удалит volumes для db и minio

Более подробную документацию по остановке и запуску контейнеров можно найти
в [официальной документации](https://docs.docker.com/compose/reference/).

