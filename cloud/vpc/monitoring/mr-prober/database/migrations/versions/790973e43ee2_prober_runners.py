"""Prober runners

Revision ID: 790973e43ee2
Revises: 9851c1dd3095
Create Date: 2021-07-02 10:35:06.118723

"""
from alembic import op
from sqlalchemy import Column, Integer, String, Text, ForeignKeyConstraint, PrimaryKeyConstraint, \
    Table, MetaData, select, Enum

from sqlalchemy.dialects import postgresql

import settings

# revision identifiers, used by Alembic.

revision = '790973e43ee2'
down_revision = '9851c1dd3095'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    prober_runners_table = op.create_table('prober_runners',
        Column('id', Integer(), nullable=False),
        Column('type', Enum('BASH', name='proberrunnertype'), nullable=True),
        Column('prober_id', Integer(), nullable=True),
        Column('command', Text(), nullable=False),
        ForeignKeyConstraint(['prober_id'], ['probers.id'], ),
        PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###
    connection = op.get_bind()

    # Copy current probers contents as bash prober runners
    probers_table = Table(
        "probers",
        MetaData(),
        Column("id", Integer, primary_key=True),
        Column("content", Text, nullable=False)
    )
    probers = connection.execute(select([
        probers_table.c.id,
        probers_table.c.content,
    ])).fetchall()
    for prober_id, prober_content in probers:
        connection.execute(prober_runners_table.insert().values(
            type="BASH",
            prober_id=prober_id,
            command=prober_content,
        ))


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('prober_runners')
    # ### end Alembic commands ###
