"""changed cluster recipe file filed type

Revision ID: a804a6f49127
Revises: 4b5cb431d104
Create Date: 2021-06-22 17:32:03.564051

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
from sqlalchemy import text

import settings

revision = 'a804a6f49127'
down_revision = '4b5cb431d104'
branch_labels = None
depends_on = None


def upgrade():
    if settings.is_postgresql:
        query = r"""ALTER TABLE cluster_recipe_files ALTER COLUMN content TYPE BYTEA USING REPLACE(content, '\', '\\')::bytea;"""
        connection = op.get_bind()
        connection.execute(text(query))

    else:
        # ### commands auto generated by Alembic - please adjust! ###
        with op.batch_alter_table('cluster_recipe_files', schema=None) as batch_op:
            batch_op.alter_column('content',
                   existing_type=sa.TEXT(),
                   type_=sa.LargeBinary(),
                   existing_nullable=True)

        # ### end Alembic commands ###


def downgrade():
    if settings.is_postgresql:
        query = r"""ALTER TABLE cluster_recipe_files ALTER COLUMN content TYPE TEXT USING convert_from(content, 'utf-8');"""
        connection = op.get_bind()
        connection.execute(text(query))

    else:
        # ### commands auto generated by Alembic - please adjust! ###
        with op.batch_alter_table('cluster_recipe_files', schema=None) as batch_op:
            batch_op.alter_column('content',
                   existing_type=sa.LargeBinary(),
                   type_=sa.TEXT(),
                   existing_nullable=True)

        # ### end Alembic commands ###
