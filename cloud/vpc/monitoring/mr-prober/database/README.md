# Работа с базой данных

Используем SQLAlchemy, модели описаны в `database/models.py`.

Основные модели:

1. `ClusterRecipe` — терраформ-рецепт кластера. Скорее всего, рецепт содержит в себе какие-то переменные, которые нужно
   определить перед выполнением рецепта.
2. `ClusterRecipeFile` — файл терраформ-рецепта.
3. `Cluster` — конкретный кластер. Из одного рецепта может быть создано несколько кластеров с разными значениями
   переменных (`ClusterVariable`).
4. `Prober` — пробер, код, который будет регулярно запускаться в кластере с определёнными настройками.
5. `ProberFile` — файл с исходным кодом пробера. Доставляется на виртуальные машины в кластере.
6. `ProberConfig` — настройки пробера для конкретного списка хостов (`.hosts_re`), конкретного кластера (`.cluster_id`)
   или для всех хостов во всех кластерах. В конфиге указывается, включен ли пробер вообще, как часто его надо
   запускать, какие логи отгружать в S3 и так далее.
7. `ProberVariable` и `ProberMatrixVariable` — переменные для запуска пробера в заданном конфиге


# Миграции

Чтобы создать новую миграцию после обновления моделей, в папке `mr-prober` выполните:

```bash
PYTHONPATH=. alembic revision -m "<Migration name>" --autogenerate
```

Чтобы применить миграции, в той же папке выполните

```bash
PYTHONPATH=. alembic upgrade head
```

Подробный туториал по alembic — на [их сайте](https://alembic.sqlalchemy.org/en/latest/tutorial.html).
