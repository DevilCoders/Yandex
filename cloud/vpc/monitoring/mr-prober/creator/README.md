## Creator

`Creator` — сервис в системе активного мониторинга Mr. Prober.

Его задача — поддерживать кластеры для мониторинга в актуальном состоянии. Для этого он берёт конфигурацию кластеров из
базы данных и регулярно выполняет `terraform init`, `terraform plan` и `terraform apply`. 
Кроме терраформ-рецепта у каждого кластера есть набор переменных, которые будут подставлены в терраформ-рецепт. 
Несколько кластеров могут быть созданы из одного рецепта, но с разными наборами переменных.

Логи каждого запуска `terraform apply` загружаются в Object Storage aka S3.
Логи также загрузятся, если попытка задеплоить кластер упала на этапе `terraform plan`. 

В терраформ-рецептах могут быть использованы только определённые
провайдеры, причём зафиксированных версий. Они перечислены
в [files/terraform_providers.tf](files/terraform_providers.tf.json).

Чтобы работали провайдеров `yandex` и `ycp` у каждого кластера должны быть
определены переменные `ycp_profile` и `yc_endpoint`. Они должны быть определены,
даже если соответствующий провайдер не используется в рецепте
(но тогда их значение может быть любым).

Для работы провайдера `ycp` также требуется авторизованный ключ
сервисного аккаунта, от имени которого Creator будем создавать все
объекты. Он передаётся в переменной окружения `MR_PROBER_SA_AUTHORIZED_KEY`.

Для работы провайдера `yandex` по аналогичным причинам нужно либо 
передать переменную окружения `YC_TOKEN`, либо запускать Creator на виртуальной
машине облака с привязанными сервисным аккаунтом. 

Для работы провайдера `ytr` с кондуктором (которой стоит избегать
в пользу EDS) нужна переменная окружения `CONDUCTOR_TOKEN`.

## Локальная сборка докер-образа

Собирать образ надо из корневой папки `mr-prober`.

```bash
docker build . -t cr.yandex/crpni6s1s1aujltb5vv7/creator -f creator/Dockerfile
```

## Локальный запуск

Для запуска надо определить минимум две переменные окружения: 
`AWS_ACCESS_KEY_ID` и `AWS_SECRET_ACCESS_KEY`.
Про остальные переменные окружения, которые могут понадобиться, например,
для работы конкретных терраформ-провайдеров, смотрите выше.

`AWS_ACCESS_KEY_ID` и `AWS_SECRET_ACCESS_KEY` же терраформ-бэкендом `s3` и 
нужны для доступа к [бакету с терраформ-стейтами](https://console.cloud.yandex.ru/folders/yc.vpc.mr-prober/storage/bucket/mr-prober-cluster-states). 
В будущем здесь будут использоваться статический ключ сервисного аккаунта `mr-prober-sa`
(см. `settings.MR_PROBER_SA_AUTHORIZED_KEY`).

Для локальной разработки можно пользоваться своими ключами. 
Подробнее о них — в разделе «Работа с Object Storage» корневого [README.md](../README.md).

**Собственно, запуск**

Вместо `<...>` укажите значения секретов для доступа к Yandex Object Storage aka S3 (см. выше).

```bash
docker run -e AWS_ACCESS_KEY_ID=<...> -e AWS_SECRET_ACCESS_KEY=<...> -it cr.yandex/crpni6s1s1aujltb5vv7/creator
```

## Запуск в virtualenv

```bash
export AWS_ACCESS_KEY_ID=...
export AWS_SECRET_ACCESS_KEY=...
PYTHONPATH=. python creator/main.py
```
