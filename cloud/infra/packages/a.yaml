service: ycinfra
title: YC Infra Packages
arcanum:
    review:
        ignore_self_ship: false
        min_approvers_count: 2

anchors:
  sandbox-runtime: &sandbox-runtime
    sandbox:
      notifications:
        - statuses:
            - SUCCESS
            - FAILURE
            - EXCEPTION
            - EXPIRED
            - NO_RES
            - TIMEOUT
          transport: email
          recipients:
            - staerist
            - dnagovitsin
            - farstone
            - 09esmirnov
            - nautim
            - thence
            - stetsyuk

ci:
  secret: sec-01fzdkac3eyq08d06xarervsgv

  runtime:
    sandbox-owner: YC_INFRA

  actions:
    # yc-infra-lib package
    build-yc-infra-lib-pkg:
      title: Build yc-infra-lib package
      description: Build yc-infra-lib package
      flow: build-package-flow
      flow-vars:
        publish: false
        pkg_json: cloud/infra/packages/lib/yc-infra-lib.pkg.json
      triggers:
        - on: pr
          filters:
            - sub-paths:
                - 'lib/**'

    publish-yc-infra-lib-pkg:
      title: Build yc-infra-lib package and publish
      description: Build yc-infra-lib package and upload it to dist
      runtime: *sandbox-runtime
      flow: build-package-flow
      flow-vars:
        publish: true
        pkg_json: cloud/infra/packages/lib/yc-infra-lib.pkg.json
      triggers:
        - on: commit
          filters:
            - sub-paths:
                - 'lib/**'

    # yc-hw-watcher-hooks package
    build-yc-hw-watcher-hooks-pkg:
      title: Build yc-hw-watcher-hooks package
      description: Build yc-hw-watcher-hooks package
      flow: build-package-flow
      flow-vars:
        publish: false
        pkg_json: cloud/infra/packages/hw-watcher-hooks/yc-hw-watcher-hooks.pkg.json
      triggers:
        - on: pr
          filters:
            - sub-paths:
                - 'hw-watcher-hooks/**'
                - 'lib/**'

    publish-yc-hw-watcher-hooks-pkg:
      title: Build yc-hw-watcher-hooks package and publish
      description: Build yc-hw-watcher-hooks package and upload it to dist
      runtime: *sandbox-runtime
      flow: build-package-flow
      flow-vars:
        publish: true
        pkg_json: cloud/infra/packages/hw-watcher-hooks/yc-hw-watcher-hooks.pkg.json
      triggers:
        - on: commit
          filters:
            - sub-paths:
                - 'hw-watcher-hooks/**'
                - 'lib/**'

    # yc-infra-juggler-hw-checks package
    build-yc-infra-juggler-hw-checks-pkg:
      title: Build yc-infra-juggler-hw-checks package
      description: Build yc-infra-juggler-hw-checks package
      flow: build-package-flow
      flow-vars:
        publish: false
        pkg_json: cloud/infra/packages/monitoring/yc-infra-juggler-hw-checks.pkg.json
      triggers:
        - on: pr
          filters:
            - sub-paths:
                - 'monitoring/**'
                - 'monitoring/checks/**'
                - 'monitoring/configs/**'
                - 'monitoring/lib/**'
                - 'monitoring/manifests/**'
                - 'lib/**'

    publish-yc-infra-juggler-hw-checks-pkg:
      title: Build yc-infra-juggler-hw-checks package and publish
      description: Build yc-infra-juggler-hw-checks package and publish
      runtime: *sandbox-runtime
      flow: build-package-flow
      flow-vars:
        publish: true
        pkg_json: cloud/infra/packages/monitoring/yc-infra-juggler-hw-checks.pkg.json
      triggers:
        - on: commit
          filters:
            - sub-paths:
                - 'monitoring/**'
                - 'monitoring/checks/**'
                - 'monitoring/configs/**'
                - 'monitoring/lib/**'
                - 'monitoring/manifests/**'
                - 'lib/**'

    # yc-infra-juggler-svm-checks package
    build-yc-infra-juggler-svm-checks-pkg:
      title: Build yc-infra-juggler-svm-checks package
      description: Build yc-infra-juggler-svm-checks package
      flow: build-package-flow
      flow-vars:
        publish: false
        pkg_json: cloud/infra/packages/monitoring/yc-infra-juggler-svm-checks.pkg.json
      triggers:
        - on: pr
          filters:
            - sub-paths:
                - 'monitoring/**'
                - 'monitoring/checks/**'
                - 'monitoring/configs/**'
                - 'monitoring/lib/**'
                - 'monitoring/manifests/**'

    publish-yc-infra-juggler-svm-checks-pkg:
      title: Build yc-infra-juggler-svm-checks package and publish
      description: Build yc-infra-juggler-svm-checks package and publish
      runtime: *sandbox-runtime
      flow: build-package-flow
      flow-vars:
        publish: true
        pkg_json: cloud/infra/packages/monitoring/yc-infra-juggler-svm-checks.pkg.json
      triggers:
        - on: commit
          filters:
            - sub-paths:
                - 'monitoring/**'
                - 'monitoring/checks/**'
                - 'monitoring/configs/**'
                - 'monitoring/lib/**'
                - 'monitoring/manifests/**'

    # yc-setup-configs package
    build-yc-setup-configs-pkg:
      title: Build yc-setup-configs package
      description: Build yc-setup-configs package
      flow: build-package-flow
      flow-vars:
        publish: false
        pkg_json: cloud/infra/packages/yc-setup-configs/yc-setup-configs.pkg.json
      triggers:
        - on: pr
          filters:
            - sub-paths:
                - 'yc-setup-configs/**'
                - 'yc-setup-customisation/**'
                - 'lib/**'

    publish-setup-configs:
      title: Build yc-setup-configs and publish
      description: Build yc-setup-configs package and upload it to dist
      runtime: *sandbox-runtime
      flow: build-package-flow
      flow-vars:
        publish: true
        pkg_json: cloud/infra/packages/yc-setup-configs/yc-setup-configs.pkg.json
      triggers:
        - on: commit
          filters:
            - sub-paths:
                - 'yc-setup-configs/**'
                - 'yc-setup-customisation/**'
                - 'lib/**'

    # yc-setup-customisation package
    build-yc-setup-customisation-pkg:
      title: Build yc-setup-customisation package
      description: Build yc-setup-customisation package
      flow: build-package-flow
      flow-vars:
        publish: false
        pkg_json: cloud/infra/packages/yc-setup-customisation/yc-setup-customisation.pkg.json
      triggers:
        - on: pr
          filters:
            - sub-paths:
                - 'yc-setup-configs/**'
                - 'yc-setup-customisation/**'
                - 'lib/**'

    publish-setup-customisation:
      title: Build yc-setup-customisation and publish
      description: Build yc-setup-customisation package and upload it to dist
      runtime: *sandbox-runtime
      flow: build-package-flow
      flow-vars:
        publish: true
        pkg_json: cloud/infra/packages/yc-setup-customisation/yc-setup-customisation.pkg.json
      triggers:
        - on: commit
          filters:
            - sub-paths:
                - 'yc-setup-configs/**'
                - 'yc-setup-customisation/**'
                - 'lib/**'

  flows:
    build-package-flow:
      title: Build YC infra package
      jobs:
        build:
          title: Build package
          description: Build package in Sandbox and upload it to dist
          task: common/arcadia/ya_package_2
          input:
            packages: "${flow-vars.pkg_json}"
            build_type: release
            package_type: debian
            package_ttl: "${not_null(flow-vars.publish, false) && '550' || '5'}"
            build_logs_ttl: "${not_null(flow-vars.publish, false) && '550' || '5'}"
            build_output_ttl: "${not_null(flow-vars.publish, false) && '550' || '5'}"
            publish_package: "${not_null(flow-vars.publish, false)}"
            publish_to: yandex-cloud
            ya_yt_store: false
            yt_store: false
            debian_distribution: testing
            resource_type: YA_PACKAGE
            custom_version: "0.2-${context.target_revision.number}${not_null(flow-vars.publish, false) && '.release' || '.custom'}"
