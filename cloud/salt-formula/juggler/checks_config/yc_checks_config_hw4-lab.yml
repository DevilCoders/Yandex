---
- hosts: localhost
  gather_facts: false
  pre_tasks:
    - juggler_facts:  jserver_api={{ jserver_api }}
      tags:
        - always
  vars:
    - env: "hw4-lab"
    - flap: { stable: 360, critical: 1080 }
    - default_notification_methods: []
    - default_tags: "{{ check_tags }} + ['{{ common_tag }}', '{{ common_tag }}-{{ env }}']"
    # Disable TG even if check explicitly requests it in task specification
    - telegram_notification: []
    - kiki_children:
        - CGROUP%cloud_hw4-lab_kikimr_global
        - CGROUP%cloud_hw4-lab_kikimr_az
  roles:
    - role: head
      vars:
        children:
          - CGROUP%cloud_hw4-lab_head
        host: "yc_common_head_{{ env }}"
        check_tags: ['{{ common_tag }}-head']
        role: head
        unreachable_host: "yc_common_head_{{ env }}"

    - role: seed
      vars:
        children:
          - CGROUP%cloud_hw4-lab_seed
        host: "yc_common_seed_{{ env }}"
        check_tags: ['{{ common_tag }}-seed']
        role: seed
        unreachable_host: "yc_infra_seed_{{ env }}"

    - role: compute
      vars:
        children:
          - CGROUP%cloud_hw4-lab_compute
        host: "yc_common_compute_{{ env }}"
        check_tags: ['{{ common_tag }}-compute']
        unreachable_host: "yc_infra_compute_{{ env }}"
        # NOTE(k-zaitsev): Only show warning if all hosts are yellow (skipped the tests)
        e2e_behind_lock_limits:
            - {crit: '0', day_end: 7, day_start: 1, time_end: 23, time_start: 0, warn: '99.99%'}
        network_limits: "{{ default_limits }}"

    - role: oct_head
      vars:
        children:
          - CGROUP%cloud_hw4-lab_oct
        host: "yc_network_oct_head_{{ env }}"
        check_tags: ['{{ common_tag }}-network', '{{ common_tag }}-oct', '{{ common_tag }}-oct-head']

    - role: cloudgate
      vars:
        children:
          - CGROUP%cloud_hw4-lab_cloudgate
        host: "yc_network_cloudgate_{{ env }}"
        check_tags: ['{{ common_tag }}-cloudgate']

    - role: iam
      vars:
        children:
          - CGROUP%cloud_hw4-lab_seed
        host: "yc_common_iam_{{ env }}"
        check_tags: ['{{ common_tag }}-iam']
        unreachable_host: "yc_common_iam_{{ env }}"

    - role: bootstrap
      vars:
        children:
          - CGROUP%cloud_hw4-lab
        host: "yc_bootstrap_{{ env }}"
        tags: ['{{ common_tag }}-bootstrap']
        unreachable_host: "yc_bootstrap_{{ env }}"
