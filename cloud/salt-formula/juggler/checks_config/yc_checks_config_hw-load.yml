---
- hosts: localhost
  gather_facts: false
  pre_tasks:
      - juggler_facts:  jserver_api={{ jserver_api }}
        tags:
          - always
  vars:
    - env: "dev"
    - flap: { stable: 360, critical: 1080 }
    - default_notification_methods: []
    - default_tags: "{{ check_tags }} + ['{{ common_tag }}', '{{ common_tag }}-{{ env }}']"
    - default_limits:
      - {crit: '100%', day_end: 5, day_start: 1, time_end: 18, time_start: 10, warn: '0'}
      - {crit: '100%', day_end: 5, day_start: 1, time_end: 10, time_start: 18, warn: '0'}
      - {crit: '100%', day_end: 7, day_start: 5, time_end: 23, time_start: 0, warn: '0'}
    - default_limits_20perc_crit:
      - {crit: '100%', day_end: 5, day_start: 1, time_end: 18, time_start: 10, warn: '0'}
      - {crit: '100%', day_end: 5, day_start: 1, time_end: 10, time_start: 18, warn: '0'}
      - {crit: '100%', day_end: 7, day_start: 5, time_end: 23, time_start: 0, warn: '0'}
    - default_limits_50perc_crit:
      - {crit: '100%', day_end: 5, day_start: 1, time_end: 18, time_start: 10, warn: '0'}
      - {crit: '100%', day_end: 5, day_start: 1, time_end: 10, time_start: 18, warn: '0'}
      - {crit: '100%', day_end: 7, day_start: 5, time_end: 23, time_start: 0, warn: '0'}
    - default_limits_99perc_crit:
      - {crit: '100%', day_end: 5, day_start: 1, "time_end": 18, "time_start": 10, warn: '0'}
      - {crit: '100%', day_end: 5, day_start: 1, time_end: 10, time_start: 18, warn: '0'}
      - {crit: '100%', day_end: 7, day_start: 5, time_end: 23, time_start: 0, warn: '0'}
    - default_limits_logic_and:
      - {day_end: 5, day_start: 1, time_end: 18, time_start: 10, aggregator: 'logic_and'}
      - {day_end: 5, day_start: 1, time_end: 10, time_start: 18, aggregator: 'more_than_limit_is_crit', aggregator_kwargs: {percent: '101'}}
      - {day_end: 7, day_start: 5, time_end: 23, time_start: 0, aggregator: 'more_than_limit_is_crit', aggregator_kwargs: {percent: '101'}}
    - kiki_children:
      - CGROUP%cloud_hw-load-lab_kikimr_global
      - CGROUP%cloud_hw-load-lab_kikimr_hw-load-a
      - CGROUP%cloud_hw-load-lab_kikimr_hw-load-b
      - CGROUP%cloud_hw-load-lab_kikimr_hw-load-c
  roles:
    - role: head
      vars:
        children:
          - CGROUP%cloud_hw-load-lab_head
        host: "yc_common_head_{{ env }}"
        role: head
        check_tags: ['{{ common_tag }}-head']
        unreachable_host: "yc_common_head_{{ env }}"

    - role: snapshot
      vars:
        children:
          - CGROUP%cloud_hw-load-lab_head
        host: "yc_common_snapshot_{{ env }}"
        check_tags: ['{{ common_tag }}-snapshot']
        role: snapshot
        unreachable_host: "yc_common_snapshot_{{ env }}"

    - role: seed
      vars:
        children:
          - CGROUP%cloud_hw-load-lab_seed
        host: "yc_infra_seed_{{ env }}"
        check_tags: ['{{ common_tag }}-seed']
        role: seed
        unreachable_host: "yc_infra_seed_{{ env }}"

    - role: compute
      vars:
        children:
          - CGROUP%cloud_hw-load-lab_compute
        host: "yc_common_compute_{{ env }}"
        unreachable_host: "yc_infra_compute_{{ env }}"
        # NOTE(k-zaitsev): Only show warning if all hosts are yellow (skipped the tests)
        e2e_behind_lock_limits:
          - {crit: '0', day_end: 7, day_start: 1, time_end: 23, time_start: 0, warn: '99.99%'}
        network_limits: "{{ default_limits }}"

    - role: oct_head
      vars:
        children:
          - CGROUP%cloud_hw-load-lab_oct
        check_tags: ['{{ common_tag }}-network', '{{ common_tag }}-oct', '{{ common_tag }}-oct-head']
        host: "yc_network_oct_head_{{ env }}"


    - role: cloudgate
      vars:
        children:
          - CGROUP%cloud_hw-load-lab_cloudgate
        host: "yc_network_cloudgate_{{ env }}"
        check_tags: ['{{ common_tag }}-cloudgate']

    - role: iam
      vars:
        children:
          - CGROUP%cloud_hw-load-lab_seed
        host: "yc_common_iam_{{ env }}"
        check_tags: ['{{ common_tag }}-iam']
        unreachable_host: "yc_common_iam_{{ env }}"
