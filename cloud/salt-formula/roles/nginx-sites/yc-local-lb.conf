{% set hostname = grains['nodename'] %}
{%- set host_roles = grains['cluster_map']['hosts'][hostname]['roles'] -%}
{%- set upstream_ports = {
        'kikimr':                         8765,
        'compute':                        9000,
        'public_api':                       80,
        'public_api_ssl':                  443,
        'snapshot':                       7628,
        'identity_public':                4336,
        'identity_private':               2637,
        'identity_private_tls':          14336,
        'access_service_grpc':            4286,
        'resource_manager_grpc':          7376,
} -%}

{%- if 'seed' in host_roles or 'head' in host_roles -%}
  {% do upstream_ports.update({'billing_private':6465}) %}
{%- endif -%}

{%- if 'billing' in host_roles -%}
  {% do upstream_ports.update({'billing_private': 6465, 'billing_kikimr_grpc': 2135}) %}
{%- endif -%}

{%- include 'nginx/generate_local_lb_conf.sls' -%}
