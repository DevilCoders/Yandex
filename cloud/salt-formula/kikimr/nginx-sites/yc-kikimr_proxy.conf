upstream backend-kikimr-viewer {
    server [::1]:8765;
}

upstream backend-nbs-viewer {
    server [::1]:8766;
}

server {
    listen                      {{ grains['nodename'] }}:8765 ssl;
    server_name                 "~^(?<fqdn>.*)$";
    keepalive_timeout           120;

    ssl_certificate             /etc/nginx/ssl/{{ pillar['secrets']['api']['cert'] }};
    ssl_certificate_key         /etc/nginx/ssl/{{ pillar['secrets']['api']['key'] }};

    ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers   on;
    ssl_session_cache           shared:SSL:64m;
    ssl_session_timeout         28h;

    ssl_ciphers kEECDH+AESGCM+AES128:kEECDH+AES128:kRSA+AESGCM+AES128:kRSA+AES128:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2;

    access_log /var/log/nginx/yc-kikimr_proxy_access.log log_debug;
    error_log /var/log/nginx/yc-kikimr_proxy_error.log;

    location / {
        proxy_pass http://backend-kikimr-viewer;
        include proxy_params;
        proxy_read_timeout 86400;
        # Original request URI must be provided for signature verifying
        proxy_set_header X-Original-Uri $request_uri;
    }
}

server {
    listen                      {{ grains['nodename'] }}:8766 ssl;
    server_name                 "~^(?<fqdn>.*)$";
    keepalive_timeout           120;

    ssl_certificate             /etc/nginx/ssl/{{ pillar['secrets']['api']['cert'] }};
    ssl_certificate_key         /etc/nginx/ssl/{{ pillar['secrets']['api']['key'] }};

    ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers   on;
    ssl_session_cache           shared:SSL:64m;
    ssl_session_timeout         28h;

    ssl_ciphers kEECDH+AESGCM+AES128:kEECDH+AES128:kRSA+AESGCM+AES128:kRSA+AES128:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2;

    access_log /var/log/nginx/yc-kikimr_proxy_access.log log_debug;
    error_log /var/log/nginx/yc-kikimr_proxy_error.log;

    location / {
        proxy_pass http://backend-nbs-viewer;
        include proxy_params;
        proxy_read_timeout 86400;
        # Original request URI must be provided for signature verifying
        proxy_set_header X-Original-Uri $request_uri;
    }
}

server {
    listen                      {{ grains['nodename'] }}:8768;
    server_name                 "~^(?<fqdn>.*)$";
    keepalive_timeout           120;

    access_log /var/log/nginx/yc-kikimr_proxy_access.log log_debug;
    error_log /var/log/nginx/yc-kikimr_proxy_error.log;

   location /counters {
        proxy_pass http://backend-kikimr-viewer/counters;
        include proxy_params;
        proxy_read_timeout 86400;
        # Original request URI must be provided for signature verifying
        proxy_set_header X-Original-Uri $request_uri;
   }
}
