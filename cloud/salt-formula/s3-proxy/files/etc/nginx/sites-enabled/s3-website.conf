upstream s3-website {
    server [::]:6667;
}

include s3-arc/blacklist_referer.conf;

server {
    listen 80 default_server;
    listen [::]:80 default_server;

    listen 443 ssl;
    listen [::]:443 ssl;

    server_name website.yandexcloud.net *.website.yandexcloud.net *.website.{{ grains['cluster_map']['public_zone'] }} website.{{ grains['cluster_map']['public_zone'] }};

    include s3-arc/proxy_options.conf;

    underscores_in_headers on;

    location / {
        if ($bad_referer) {
            return 402;
        }

        proxy_pass    http://s3-website;
        include s3-arc/error_page_503.conf;
        log_by_lua_file /etc/nginx/s3-lua/s3-solomon-metrics.lua;
    }

    location @error503 {
        return 503;
        log_by_lua_file /etc/nginx/s3-lua/s3-solomon-metrics.lua;
    }

    location ~ /system/ping/?$ {
        proxy_pass    http://s3-arc-system;
        log_by_lua_block {
            service_tags = {}
            service_tags.request_stat_type = "system"
            increment_solomon_metric(service_tags, 1)
        }
    }

    location /ping {
        rewrite /ping /system/ping last;
        log_by_lua_block {
            service_tags = {}
            service_tags.request_stat_type = "system"
            increment_solomon_metric(service_tags, 1)
        }
    }
}
