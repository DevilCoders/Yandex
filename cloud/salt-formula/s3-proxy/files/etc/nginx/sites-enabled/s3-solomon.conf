lua_shared_dict numeric_metrics 32M;
lua_shared_dict histogram_names 32M;
lua_shared_dict histogram_values 32M;

lua_shared_dict solomon_numeric_metrics 32M;
lua_shared_dict solomon_histogram_names 32M;
lua_shared_dict solomon_histogram_values 32M;

lua_shared_dict solomon_client_numeric_metrics 32M;

lua_package_path '/usr/share/lua/5.1/?.lua;;';
lua_package_cpath '/usr/lib/x86_64-linux-gnu/lua/5.1/?.so;;';

init_worker_by_lua_file /etc/nginx/s3-lua/worker.lua;

server {
    listen [::1]:4446;
    listen [::]:4446 ipv6only=on;

    location = /solomon {

        content_by_lua_block {
            ngx.header.content_type = 'application/json'
            ngx.say(cjson.encode(get_solomon_metrics()))

            tags = {}
            tags.lua_stat = "monitor"
            increment_solomon_metric(tags, 1)

        }
        log_by_lua_block {
            tags = {}
            tags.lua_stat = "system"
            increment_solomon_metric(tags, 1)
        }

    }

    location = /solomon_flush {
        content_by_lua_block {
            ngx.shared.numeric_metrics:flush_all()
            ngx.shared.histogram_names:flush_all()
            ngx.shared.histogram_values:flush_all()

            ngx.shared.solomon_numeric_metrics:flush_all()
            ngx.shared.solomon_histogram_names:flush_all()
            ngx.shared.solomon_histogram_values:flush_all()
        }
    }
}

server {
    listen [::1]:4447;
    listen [::]:4447 ipv6only=on;

    location = /solomon {
        more_set_headers 'Content-Type: application/json';
        return 200 "{}";

    }
}

server {
    listen [::1]:4448;
    listen [::]:4448 ipv6only=on;

    location = /solomon {

        content_by_lua_block {
            ngx.header.content_type = 'application/json'
            ngx.say(cjson.encode(get_solomon_client_metrics()))

            tags = {}
            tags.lua_stat = "monitor"
            increment_solomon_metric(tags, 1)

        }
        log_by_lua_block {
            tags = {}
            tags.lua_stat = "system"
            increment_solomon_metric(tags, 1)
        }

    }

    location = /solomon_flush {
        content_by_lua_block {
            ngx.shared.solomon_client_numeric_metrics:flush_all()
        }
    }

}
