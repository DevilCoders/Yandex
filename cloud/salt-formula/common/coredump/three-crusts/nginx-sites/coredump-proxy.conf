{% set environment = grains['cluster_map']['environment'] -%}
{% set domain = 'svc.cloud-preprod.yandex.net' if environment != 'prod' else 'svc.cloud.yandex.net' -%}
{% set cores_reals = [
    'cores-vla1.' + domain,
    'cores-sas1.' + domain,
    'cores-myt1.' + domain,
] -%}

upstream cores {
{%- for real in cores_reals %}
    server {{ real }};
{%- endfor %}
}

server {
    listen 31337;

    location / {
        proxy_pass http://cores;
    }
}
