client_max_body_size    16m;
client_body_buffer_size    128k;

client_header_buffer_size    4k;
large_client_header_buffers    8 32k;

log_format    debug '$time_local {"remote_addr":"$remote_addr", "status":"$status", "request":"$request", "body":"$request_body"}';


server {
    listen        80;
    listen        [::]:80;

    listen		443 ssl http2;
    listen		[::]:443 ssl http2;

    ssl_certificate             /etc/nginx/ssl/cert.pem;
    ssl_certificate_key         /etc/nginx/ssl/key.pem;

    ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers   on;
    ssl_session_cache           shared:SSL:64m;
    ssl_session_timeout         28h;

    ssl_ciphers kEECDH+AESGCM+AES128:kEECDH+AES128:kRSA+AESGCM+AES128:kRSA+AES128:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2;
    # enable HSTS later. !!! remember about local scripts: some of them uses localhost:80 !!!
    # add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";

    location / {
        proxy_pass    http://localhost:9998;
        proxy_redirect    off;
    }

    ##
    ## admin UI
    ##
    root /Berkanavt/solomon/frontend-admin/;
    location /admin {
        # cache only .js and .css files in browser
        etag off;
        if ($request_uri ~* '(?:js|css)$') {
            expires max;
        }
        try_files $uri /admin/index.html =404;
    }

    ##
    ## Solomon API v2.0
    ## (separate section to bypass external authenticator)
    ##
    location ~ ^/api/(v2|internal).*$ {
        proxy_set_header Host               $host;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Retpath          $http_host;

        proxy_buffers               4 32k;
        proxy_buffer_size           4k;
        proxy_busy_buffers_size     64k;
        proxy_temp_file_write_size  64k;

        proxy_pass        http://localhost:9998;
        proxy_redirect    off;
    }
}
