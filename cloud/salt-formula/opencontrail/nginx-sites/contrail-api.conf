{%- from 'opencontrail/map.jinja' import oct_conf_servers -%}

upstream contrailapi {
    # Allow client to stick requests to same oct head by passing X-Request-ID HTTP header, see: CLOUD-20918.
    # Acts like $http_x_request_id == '' if X-Request-ID is not provided.
    hash $http_x_request_id consistent;

    {%- for server in oct_conf_servers %}
    server {{ grains['cluster_map']['hosts'][server]['ipv4']['addr'] }}:8082;
    {%- endfor %}
}

server {
    listen 127.0.0.1:8082;

    access_log /var/log/nginx/contrail-api_short.log log_for_robot;
    access_log /var/log/nginx/contrail-api_access.log contrail_log_debug;
    error_log /var/log/nginx/contrail-api_error.log;

    location / {
        proxy_pass http://contrailapi;
        include proxy_params;
        proxy_read_timeout 30;
    }
}
