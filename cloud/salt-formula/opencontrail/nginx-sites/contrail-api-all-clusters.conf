{%- from 'opencontrail/map.jinja' import all_oct_clusters -%}
{% for oct_cluster_id, oct_cluster in all_oct_clusters | dictsort %}

{%- set oct_conf_servers = (oct_cluster.roles.get('oct_conf', []) + oct_cluster.roles.get('oct_head', [])) | unique -%}

upstream contrailapi-{{ oct_cluster_id }} {
    # Allow client to stick requests to same oct head by passing X-Request-ID HTTP header, see: CLOUD-20918.
    # Acts like $http_x_request_id == '' if X-Request-ID is not provided.
    hash $http_x_request_id consistent;

    {%- for server in oct_conf_servers %}
    server {{ grains['cluster_map']['hosts'][server]['ipv4']['addr'] }}:8082;
    {%- endfor %}
}

server {
    listen oct-{{ oct_cluster_id }}-balancer:8082;

    access_log /var/log/nginx/contrail-api-{{ oct_cluster_id }}_short.log log_for_robot;
    access_log /var/log/nginx/contrail-api-{{ oct_cluster_id }}_access.log contrail_log_debug;
    error_log /var/log/nginx/contrail-api-{{ oct_cluster_id }}_error.log;

    location / {
        proxy_pass http://contrailapi-{{ oct_cluster_id }};
        include proxy_params;
        proxy_read_timeout 30;
    }
}

{% endfor %}
