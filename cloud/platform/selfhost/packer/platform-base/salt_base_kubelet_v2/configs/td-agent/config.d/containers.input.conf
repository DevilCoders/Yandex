<source>
  @type forward
  bind 127.0.0.1
  port 24224
  add_tag_prefix raw.kubelet
</source>

# Detect exceptions in the log output and forward them as one log entry.
<match raw.kubelet.**>
  @id raw.kubelet
  @label @CONTAINERS
  @type detect_exceptions
  remove_tag_prefix raw
  message log
  stream stream
  multiline_flush_interval 5
  max_bytes 500000
  max_lines 1000
</match>

<label @ERROR>
  <match **>
    @id error_output
    @type file
    path  /var/log/fluent/unparsed.${tag}.%Y%m%d
    append true
    include_tag_key true
    <buffer tag,time>
      @type memory
      time_slice_format %Y%m%d
      flush_mode interval
      retry_type exponential_backoff
      flush_thread_count 1
      flush_interval 5s
      retry_forever
      retry_max_interval 30
      chunk_limit_size 1MB
      total_limit_size 8MB
      queue_limit_length 8
      overflow_action throw_exception
    </buffer>
  </match>
</label>

<match **>
  @type copy
  <store>
    @type prometheus
    <metric>
      name fluentd_non_labeled_output_records_total
      type counter
      desc The total number of records without label
      <labels>
        tag non_labeled
      </labels>
    </metric>
  </store>
  <store>
    @id output
    @type file
    path  /var/log/fluent/output.${tag}.%Y%m%d
    append true
    include_tag_key true
    <buffer tag,time>
      @type memory
      time_slice_format %Y%m%d
      flush_mode interval
      retry_type exponential_backoff
      flush_thread_count 1
      flush_interval 5s
      retry_forever
      retry_max_interval 30
      chunk_limit_size 1MB
      total_limit_size 8MB
      queue_limit_length 8
      overflow_action throw_exception
    </buffer>
  </store>
</match>
