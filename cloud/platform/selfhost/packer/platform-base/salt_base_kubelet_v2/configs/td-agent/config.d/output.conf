<label @CONTAINERS>
  <filter>
    @type concat
    key log
    use_partial_metadata true
    separator ""
  </filter>

  <filter kubelet.**>
    @type prometheus
    <metric>
      name fluentd_input_container_records_total
      type counter
      desc The total number of incoming containers records
      <labels>
        tag containers_input
      </labels>
    </metric>
  </filter>

  <match kubelet.**>
    @type rewrite_tag_filter

    <rule>
      key container_name
      pattern /^\/k8s_(.+?)_.*$/
      tag $1.log
    </rule>
  </match>

  <match *.log>
    @type rewrite_tag_filter
    <rule>
      key source
      pattern /^(.+)$/
      tag $1.${tag}
    </rule>
  </match>

  <match stdout.**>
    @type copy
    <store>
      @type prometheus
      <metric>
        name fluentd_stdout_records_total
        type counter
        desc The total number of stdout records
        <labels>
          tag containers_stdout
        </labels>
      </metric>
    </store>
    <store>
      @id stdout
      @type file
      path  /var/log/fluent/access_log.${tag[1]}.%Y%m%d
      append true
      include_tag_key true
      <format>
        @type single_value
        add_newline true
        message_key log
      </format>
      <buffer tag,time>
        @type memory
        time_slice_format %Y%m%d
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 1
        flush_interval 5s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 1MB
        total_limit_size 8MB
        queue_limit_length 8
        overflow_action throw_exception
      </buffer>
    </store>
  </match>

  <match stderr.**>
    @type copy
    <store>
      @type prometheus
      <metric>
        name fluentd_stderr_records_total
        type counter
        desc The total number of stderr records
        <labels>
          tag containers_stderr
        </labels>
      </metric>
    </store>
    <store>
      @id stderr
      @type file
      path  /var/log/fluent/error_log.${tag[1]}.%Y%m%d
      append true
      include_tag_key true
      <format>
        @type single_value
        add_newline true
        message_key log
      </format>
      <buffer tag,time>
        @type memory
        time_slice_format %Y%m%d
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 1
        flush_interval 5s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 1MB
        total_limit_size 8MB
        queue_limit_length 8
        overflow_action throw_exception
      </buffer>
    </store>
  </match>
</label>

<label @KERNEL>
  <match kernel**>
    @type copy
    <store>
      @type prometheus
      <metric>
        name fluentd_kernel_records_total
        type counter
        desc The total number of kernel records
      </metric>
    </store>
    <store>
      @id kernel_output
      @type file
      path  /var/log/fluent/kernel.log.%Y%m%d
      append true
      include_tag_key true
      <buffer>
        @type memory
        time_slice_format %Y%m%d
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 1
        flush_interval 10s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 1MB
        total_limit_size 8MB
        queue_limit_length 8
        overflow_action throw_exception
      </buffer>
    </store>
  </match>
</label>

<label @SYSTEMD>
# Concatenate multi-line logs
  <filter **>
    @type concat
    key message
    multiline_end_regexp /\n$/
    separator ""
  </filter>

  <match **>
    @type copy
    <store>
      @type prometheus
      <metric>
        name fluentd_systemd_records_total
        type counter
        desc The total number of systemd records
        <label>
          tag systemd
        </label>
      </metric>
    </store>
    <store>
      @id system_output
      @type file
      path  /var/log/fluent/system.${tag}.%Y%m%d
      append true
      include_tag_key true
      <buffer tag,time>
        @type memory
        time_slice_format %Y%m%d
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 1
        flush_interval 5s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 1MB
        total_limit_size 8MB
        queue_limit_length 8
        overflow_action throw_exception
      </buffer>
    </store>
  </match>
</label>
