# Billing services terraform + terragrunt

Тут лежат описания инфраструктуры развертывания сервисов биллинга:
- modules - общие модули, переиспользуемые в разных средах
- deploy_rnd - фолдер с тестовыми машинами для проверки базовых и собранных новых образов.

#### Install Tools

Если вы уже здесь, но у вас нет утилиты `ya`, то поставить по [инструкции](https://wiki.yandex-team.ru/yatool/distrib/).

А также вам понадобятся:
- https://docs.docker.com/compose/
- https://wiki.yandex-team.ru/cloud/devel/platform-team/infra/skm/

В случае необходимости использовать без docker, см. [Dockerfile](../ci_tools/Dockerfile) для подробностей установки инструментов.

### Как это работает

Для применения используем terragrunt. Это небольшая обвязка над terraform, которая позволяет
автоматизировать и сделать единообразными настройки окружений.

В корне лежат несколько файлов `*.hcl`. Это описания дополнительных действий для примененя терраформа.
Например, в `root.hcl` добавлена пересборка утилит из `./modules` и получение секретов для доступа к
состоянию terraform в S3.

Для авторизации в Cloud используются учетные данные, зашифрованные в бандлы (`./secrets/*/skm-encrypted-keys.yaml`)
Расшифровка бандлов осуществляется в хуке terragrunt.
Для авторизации во внутренних сервисах используется [утилита](../ci_tools/utils/yt-oauth), обменивающая ssh ключ на OAuth токен.

В каталогах окружений лежат файлы `terragrunt.hcl`. В них инклудятся файлы `./*.hcl`, которые добавляют
в них настройки storage, креды, переменные и т.п. Так же не запрещается делать какие-то другие свяазанные
действия, которые упростят описание инфраструктуры.

Применение изменений предпочтительно делать из сборочного цеха, но возможен и локальный запуск shell с установленными
инструментами через скрипт `docker-shell.sh`

Чтобы сделать что-то с окружением (prod, preprod, etc) заходим в соответсвующий каталог и запускаем
соответствующие команды terragrunt (`-h` и документация в помощь). При этом инструкции из hcl будут применены
автоматически. Если поставлены все нужные инструменты, то все сборки дополнительных тулов и инициализации
должны быть сделаны автоматически.

### Known issues
Если terragrunt не может подключиться к серверам с ошибкой `No keys in the SSH Agent.`,
то нужно проверить, что в `.bash_profile`/`.zshrc` присутствует команда `ssh-add ~/.ssh/id_rsa`,
а также, что публичный ключ загружен на staff.

Если при запуске `docker-shell.sh` возникает ошибка вида `Error response from daemon: unauthorized: Authentication problem ; requestId = c6d4fe7b-13c5-4b21-88df-765e5aab6c29`, то нужно выполнить:
```shell
yc container registry configure-docker
```
