# Как добавить SKU

Основная информация по подключению на [wiki](https://wiki.yandex-team.ru/cloud/devel/billing/how-to-new-metrics/)

Информация по структуре бандла в [Readme](https://a.yandex-team.ru/arc_vcs/cloud/billing/bootstrap/)

## Чеклист исходных данных для selfsku
  - Сервис для которого заводится SKU:
    - *Уже существует* - проверяем корректность данных в каталоге `services`, если не смигрирован, то переносим заполнение как для нового сервиса
    - *Новый сервис* - создаем новый файл, понадобится:
      - "кодовое имя сервиса" - внутренний идентификатор, например `yt` или `mdb`
      - "описание" - описание сервиса "для людей"
      - "группа" - `неведомая группировка, требует уточнения`
      - "id" - сгенерировать новый идентификатор "без префикса"
    - Напомнить сервису про инструкцию https://wiki.yandex-team.ru/cloud/devel/billing/how-to-meter/
  - Схема обрабатываемых метрик для SKU:
    - выяснить требования к тегам в схеме, если есть участвующие в расчетах, то проверить и актуализировать описание в каталоге `schemas`
  - Определиться с основной информацией требуемых SKU и создать запись в каталоге `skus`:
    - "имя" - внутренний идентификатор, желательно придерживаться формата `<service_name>.<some_descriptive_name>.<other_parts_like_entity>`
    - названия SKU на русском и английском языках, видимые конечным пользователям
    - имя сервиса и подсервиса SKU в отчетах (в общем случае имя сервиса совпадает с основным сервисом SKU)
    - схемы метрик, в которых будет передаваться потребление SKU
    - правила резолвинга метрик для SKU, одно из:
      - формула на модифицированном диалекте jmespath, расчитывающая логическое значение что метрика содержит потребление SKU
      - правила матчинга метрики
    - является ли sku скрытым от пользователей (не показывается пользователям, у которых не было потребления по этому SKU)
    - информация по расчету потребления:
      - тип потребления:
        - `delta` - каждая метрика содержит отдельное количество единиц потребленния
        - `cumulative` - каждая метрика содержит текущее месячное потребление для ресурса (resource_id в метрике)
      - формула расчета потребления:
        - если в `usage.quantity` метрики передается уже расчитанное потребление, то можно не заполнять
        - иначе необходимо описать формулу расчета на модифицированном диалекте jsmepath
      - единицы измерения переданного потребления (то, что получается после применения формулы) и единицы, для которых указывается цена. Если не совпадают, то необходимо убедиться в наличии правила пересчета в каталоге `units`
  - Тест-кейсы для резолвинга метрик
  - Информацию для включения SKU в бандлы:
    - цены на SKU:
      - дата начала действия цены
      - принцип расчета и значения для него:
        - фиксированная цена
        - цена с порогами потребления (нужны границы каждого порога потребления и цена)
    - "id" - сгенерировать новый идентификатор "без префикса"

## Диалект Jmespath

Основной синтаксис описан в [документации](https://jmespath.org/)

В применяемом диалекте сделаны следующие допущения:
  - все числа представляются как `decimal(35,15)` (тип для расчета билинга) и могут быть распаршены из строк
  - строки в json литералах могут быть не заключены в двойные кавычки (не стоит злоупотреблять, лучше использовать одинарную кавычку в соответствии со спецификацией)
  - добавлены функции:
    - `add` - складывает 2 числовых параметра
    - `sub` - вычитает 2 числовых параметра
    - `mul` - перемножает 2 числовых парамтер
    - `div` - делит 2 числовых парамтер
    - `quantum` - функция квантования (a // b) * b
    - `hash_mod` - вычисляет `xxhash64` от первого аргумента и берет остаток от деления на второй аргумент
    - `if` - в зависимости от истинности первого аргумента возвращает второй или третий
    - `decimal` - пытается перевести параметр в число, синоним `to_number`
