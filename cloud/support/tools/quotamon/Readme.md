# 1. Принцип работы скрипта
## 1.1 Запуск скрипта
Скрипт запускается по cron расписанию. Пример команды запуска:

  00 06 * * * /usr/bin/python3 /path/to_your_script/qmon.py
## 1.2 Чтение конфигураций
Скрипт проходит по всем конфигурационным файлам в директории ./conf, читает по одному файлы конфигурации и вычитывает из них нужные для работы параметры.
## 1.3 Отправка уведомления на почту
После того, как скрипт прочитал все квоты и вычислил, по каким квотам превышен установленный порог использования (по умолчанию 85%), происходит отправка уведомления на почту, указанную в конфиге.
Для отправки используется Рассылятор (https://sender.yandex-team.ru/yandex.cloud/campaign/751178/overview). На вход экземпляр  рассылятора принимает следующие аргументы:
- id облака;
- имя квоты;
- использование квоты;
- лимит квоты;
- процент использования квоты;
- адрес получателя уведомления.
В используемом экземпляре рассылятора вшито правила парсинга переданных параметров и формирование текста письма в целовекочитаемом виде.

В конце письма добавляется прямая ссылка на страницу увеличения квот для каждого облака, присутствующего в теле письма.

## 1.4 Запись лога 
 Все действия скрипта логируются в файлы в директории ./logs. Логи разбиваются по дням. В лог выводится информация о времени выпонения, модуле, от которого поступила информации, уровня сообщения (INFO, WARN, ERROR) и само сообщение.
# 2. Структура скрипта
Скрипт состоит из python файла qmon.py, бинарника quotactl-l2 и директорий:
- ./conf - каталог с конфигурационными файлами;
- ./logs - каталог с логами
- quotactl-l2 - бинарный файл, через который происходит запрос значений квот из различных сервисов. Должен находится в корневой директории скрипта;

# 3. Установка скрипта
## 3.1 Среда разработки и необходимые зависимости
- Для запуска скрипта в системе должен быть установлен python версии не ниже 3.8.10 (тесты работоспособности проводились на этой версии)
- Скрипт работает только под yandex_vpn (обычный vpn для наших ноутов);
- Монтируем аркадию, обновляем локальный репозиторий и скачиваем скрипт:
  
  arc mount ~/arcadia
  
  arc pull trunk

  cd ~/arcadia/cloud/support/tools/quotamon

- Собираем из аркадии утилиту quotactl-l2:

  cd ~/arcadia/cloud/support/tools/quotactl-l2 

  ya make
- Дожидаемся процесса сборки (он может идти минут 10-20), сообщения OK, после чего в каталоге появится ссылка на бинарь (прим. ~/.ya/build/symres/9ca084f9300d0c036ca0a68fe79f2483/quotactl-l2), который нужно скопировать в корень каталога со скриптом quotamon;
- Для того, чтобы quotactl-l2 заработал нужно:
    - Скопировать конфигурационный файл qctl.yml в директорию ~/.config, заполнить внутри него недостающие параметры (путь к сертификату и ключи доступа в прод и препрод); Он нужен для запуска утилиты quotactl-l2;
    - Скачать сертификат wget "https://crls.yandex.net/allCAs.pem" и положить его в директорию ~/.config/.
## 3.2 Настройка скрипта
- Для запуска скрипта необходимо добавить в каталог conf файлы с настройками под каждого клиента. Пример файла есть в каталоге conf;
- Далее нужно добавить в crontab расписание запуска:

00 06 * * * /usr/bin/python3 /path_to_your_script/qmon.py
