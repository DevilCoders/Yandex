{
    "id": "openid-server-l7-unhealthy-internal",
    "name": "openid-server l7 unhealthy targets INTERNAL",
    "type": {
        "expression": {
            "program": "let healthy = min(group_lines('min',group_by_labels({cluster=\"cloud_prod_cpl\", service=\"api_envoy_tags_ma\", name=\"alb_membership_healthy\", backend_group_id=\"ds7vrn64a82u9smd2lok\", cluster_name=\"ds7vrn64a82u9smd2lok_openid_server_backend\", \"project\"=\"platform\"},'zone',v -> group_lines('max', v))));\nlet total = max(group_lines('min',{cluster=\"cloud_prod_cpl\", service=\"api_envoy_tags_ma\", name=\"alb_membership_total\", backend_group_id=\"ds7vrn64a82u9smd2lok\", cluster_name=\"ds7vrn64a82u9smd2lok_openid_server_backend\", \"project\"=\"platform\"}) );\nlet unhealthy = total - healthy;\nunhealthy;",
            "checkExpression": "unhealthy > 1"
        }
    },
    "annotations": {
        "description": "Status not equal to OK means too many unhealthy targets in l7-balancer. https://solomon.cloud.yandex-team.ru/admin/projects/yc.iam.service-cloud/alerts/openid-server-l7-unhealthy-internal"
    },
    "windowSecs": 60,
    "delaySecs": 0,
    "channels": ${CHANNELS}
}
