{
    "id": "openid-server-l7-unhealthy-preprod",
    "name": "openid-server l7 unhealthy targets PREPROD",
    "type": {
        "expression": {
            "program": "let healthy = min(group_lines('min',group_by_labels({cluster=\"cloud_preprod_api-router\", service=\"api_envoy_tags_ma\", name=\"alb_membership_healthy\", backend_group_id=\"a5dvtaut5r29inlhrrlg\", host=\"api-router-*\", project=\"platform\"},'zone',v -> group_lines('max', v))));\nlet total = max(group_lines('max',{cluster=\"cloud_preprod_api-router\", service=\"api_envoy_tags_ma\", name=\"alb_membership_total\", backend_group_id=\"a5dvtaut5r29inlhrrlg\", host=\"api-router-*\", \"project\"=\"platform\"}) );\nlet unhealthy = total - healthy;\nunhealthy;",
            "checkExpression": "unhealthy > 1"
        }
    },
    "annotations": {
        "description": "Status not equal to OK means too many unhealthy targets in l7-balancer. https://solomon.cloud.yandex-team.ru/admin/projects/yc.iam.service-cloud/alerts/openid-server-l7-unhealthy-preprod"
    },
    "windowSecs": 60,
    "delaySecs": 0,
    "channels": ${CHANNELS}
}
