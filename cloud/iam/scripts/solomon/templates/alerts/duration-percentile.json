{
  "id": "${CLUSTER_NAME}-duration-percentile",
  "projectId": "${PROJECT_ID}",
  "name": "${CLUSTER_NAME} duration percentile",
  "groupByLabels": [
    "host"
  ],
  "type": {
    "expression": {
      "program": "let percentileLine = histogram_percentile(99.9, 'le', sum(group_by_time(5m, 'sum', diff({'app'='${SERVICE_NAME}_server', 'cluster'='${CLUSTER_NAME}', 'project'='${PROJECT_ID}', 'service'='${SERVICE_NAME}', le='*', 'sensor'='grpc_durations', method=~'servicecontrol.*|accessservice.*'}))) by (le));\nlet maxVal = max(percentileLine);",
      "checkExpression": "maxVal > 0.3"
    }
  },
  "annotations": {
    "description": "{{alert.name}} p99.9 duration within 5m is {{expression.maxVal}} for {{labels.host}}",
    "url": "https://${SOLOMON_ENDPOINT}/admin/projects/${PROJECT_ID}/alerts/${CLUSTER_NAME}-duration-percentile/subAlerts"
  },
  "windowSecs": 3600,
  "delaySecs": 0,
  "channels": ${CHANNELS}
}
