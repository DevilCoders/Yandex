# Planning Tool

## Зачем это нужно

Отчет по потраченному времени, позволяют увидеть:

- Кто что делал вчера (от стендапа до стендапа).
- У кого есть задачи, которые In Progress, но по ним нет отметок о времени, т.е. они не делаются.
- У кого есть задачи, которые не в спринте, но которые либо в In Progress, либо по которым были отметки о потраченном времени.

Агрегированный отчет с даты по дату позволяет увидеть:

- Сколько времени потрачено на разные группы задач.
- Сколько времени теряется на дежурства, отпуска, отгулы, болезни.
- Как планируемое время соотносится с фактическим по задаче, по группе, по человеку.
- Сколько времени потрачено на достижение какой-либо большой цели, которая состоит из подзадач.

Примеры отчетов:

- [Ежедневный](https://s3.mds.yandex.net/iam/daily/)
- [Месячный](https://s3.mds.yandex.net/iam/monthly/)

## Как это работает

Генераторы используют API Starktek, Staff для полчения исходных данных. Итоговый результат закачивается в Wiki, при этом
можно автоматически сохранять дневной отчет с указанной датой или генерировать на месте старого новый.

При построении агрегатных отчетов рабочее время за день нормализуется до сферического рабочего дня (по умолчанию равному 8
астрономическим часам). Это делается по двум причинам:

1. В Startrek нет удобного способа удалить однажды залоггированое в задачу время.
1. Для месячных отчетов более актуально количество рабочих дней, а не реальных часов.

В config.yaml важно настроить следующие параметры:

- auth.token_file - путь к файлу с OAuth-токеном для доступа к Staff/Startrek/Wiki API.
- timesheet.board_id - ID доски в ST (пока обязательно, но можно сделать опциональным).
- timesheet.team - список логинов людей, по которым строится отчет.
- timesheet.groups - список условий, по которым группируются тикеты в агрегированных отчетах, каждый тикет может попасть
  не более чем под одно из условий.
- timesheet.group_tag - тэг, который должен быть у задачи, по которой будет вестить группировка всех подтикетов этой
  задачи в агрегированном отчете.
- daily.wiki.path - путь на вики, куда будут закачиваться дневные отчеты. По указанному пути будет лежать страница со списком отчетов.
- daily.wiki.title - название страницы на вики с дневным отчетом.
- worklog.day_start - время ежедневного стендапа.
- worklog.day_length - длина рабочего дня (важно в агрегированных отчетах), по умолчанию 8 часов.

## Как нужно вести задачи, чтобы все работало правильно

- Каждая задача должна попадать под одно из условий в timesheet.groups.
- У каждой задачи (кроме багов, дежурных и сапортных тикетов) должен быть Epic, либо она должна являться подзадачей
  такой задачи.
- Для глубоких иерархий подзадач тэгом timesheet.group_tag размечается задача, по которой эти подзадачи будут
  сгруппированы в агрегированном отчете (задачи выше по иерархии не будут отображаться в отчете). Если такой тэг
  не поставить, то в качестве задачи для группировки будет использован Epic.
- При заполнении рабочего времени важно, чтобы StartTime попадал в интервал от worklog.day_start предыдущего дня
  до worklog.day_start текущего дня. Таким образом, лучше всего выбрать в качестве StartTime время окончания ежедневного
  стендапа. Тогда дополнительно исправлять StartTime при логгировании времени не требуется, его можно всегда оставлять
  дефолтным и значение попадет в правильный интервал.
- При использовании отгула за дежурство на стаффе в комментарии к отсутствию надо добавить #duty.


## Как запустить локально

1. Скопировать токен API стартрека (https://oauth.yandex-team.ru/authorize?response_type=token&client_id=5f671d781aca402ab7460fde4050267b)
2. Положить в какой-нибудь файл и указать путь в configs (по умолчанию берется файл token, поэтому достаточно создать файл token в корневом каталоге проекта и положить скопированные данные туда)
3. Запустить
```bash
ya make && ./planning_tool daily -o result.html --mds-off
```
(Может работать дольше минуты, это нормально. А месячный отчет ```monthly``` совсем долгий)

Параметр ```-o result.html``` нужен, чтобы сохранить результат в файл ```result.html```.

Параметр ```--mds-off``` нужен, чтобы не сохранять результат на сервер (иначе понадобится mds key, путь до файла и key id нужно указать в configs)

Посмотреть другие виды отчетов:
```bash
ya make && ./planning_tool --help
```

Посмотреть параметры для фиксированного вида отчета (здесь пример для ежедневного отчета):
```bash
ya make && ./planning_tool daily --help
```


## Особые сценарии использования

На базе этой тулы сделан сбор отчетов для налоговой в Яндекс Облаке.

- [конфиг с разбиением тикетов на категории](https://a.yandex-team.ru/arc/trunk/arcadia/cloud/iam/planning_tool/configs/tax.yaml)
- пример:

```bash
ya make && ./planning_tool tax --config configs/tax.yaml -f 2021-10-01 -t 2022-01-01 --title 'Yandex Cloud 2021Q4' --path users/potamus/tax-2021q4
```
