@dependent-scenarios
Feature: Internal API MongoDB Cluster lifecycle

  Background: Wait until internal api is ready
    Given Internal API is up and running
    And feature flag "MDB_MONGODB_ALLOW_DEPRECATED_VERSIONS" is set
    And actual MetaDB version
    And actual DeployDB version
    And Deploy API is up and running
    And Fake DBM is up and running
    And s3 is up and running
    And Mlock api is up and running
    And Secrets api is up and running
    And we are working with standard_replicaset_4_0 MongoDB cluster
    And feature flag "mongodb_sharding" is set

  @setup
  Scenario: MongoDB cluster creation and sharding works
    When we enable feature flag "MDB_MONGODB_INFRA_CFG"
    And we try to create cluster "test_cluster"
    Then response should have status 200
    And generated task is finished within "15 minutes"
    And s3 has bucket for cluster
    And cluster "test_cluster" is up and running
    And cluster has no pending changes
    And mongodb MONGOD "rs01" shard replset in cluster "test_cluster" has 3 members
    And mongodb MONGOD "rs01" shard replset in cluster "test_cluster" is synchronized
    And mongodb major version is "4.0"
    And mongodb featureCompatibilityVersion is "4.0"
    When we attempt to enable sharding in cluster "test_cluster"
    """
    mongos:
      resources:
        resourcePresetId: db1.nano
        diskSize: 10737418240
        diskTypeId: local-ssd
    mongocfg:
      resources:
        resourcePresetId: db1.nano
        diskSize: 21474836480
        diskTypeId: local-ssd
    mongoinfra:
      resources:
        resourcePresetId: db1.nano
        diskSize: 21474836480
        diskTypeId: local-ssd
    hostSpecs:
        - zoneId: sas
          type: MONGOINFRA
        - zoneId: man
          type: MONGOINFRA
        - zoneId: vla
          type: MONGOINFRA
    """
    Then response should have status 200
    And generated task is finished within "15 minutes"
    And cluster "test_cluster" is up and running
    And cluster has no pending changes
    And mongodb MONGOD "rs01" shard replset in cluster "test_cluster" has 3 members

  Scenario: Upgrade Sharded MongoDB version to 4.2
    Given cluster "test_cluster" is up and running
    When we attempt to modify cluster "test_cluster" with following parameters
    """
    configSpec:
      version: "4.2"
    """
    Then response should have status 200
    And generated task is finished within "20 minutes"
    And cluster has no pending changes
    And mongodb major version is "4.2"
    And mongodb featureCompatibilityVersion is "4.0"

  Scenario: Upgrade MongoDB version featureCompatibilityVersion to 4.2
    Given cluster "test_cluster" is up and running
    When we attempt to modify cluster "test_cluster" with following parameters
    """
    configSpec:
      featureCompatibilityVersion: "4.2"
    """
    Then response should have status 200
    And generated task is finished within "15 minutes"
    And cluster "test_cluster" is up and running
    And cluster has no pending changes
    And mongodb MONGOD "rs01" shard replset in cluster "test_cluster" has 3 members
    And mongodb MONGOD "rs01" shard replset in cluster "test_cluster" is synchronized
    And mongodb major version is "4.2"
    And mongodb featureCompatibilityVersion is "4.2"

  @clean
  Scenario: Remove cluster
    Given cluster "test_cluster" is up and running
    When we attempt to remove cluster "test_cluster"
    Then response should have status 200
    And generated task is finished within "15 minutes"
    And in worker_queue exists "mongodb_cluster_delete_metadata" task
    And this task is done
    And autogenerated shard was deleted from Solomon
    And we are unable to find cluster "test_cluster"
    But s3 has bucket for cluster
    And in worker_queue exists "mongodb_cluster_purge" task
    When delayed_until time has come
    Then this task is done
    And s3 has no bucket for cluster
