Интеграционные тесты DBaaS
======

## Запуск
Для запуска следует выполнить `test`:
```
make test
```
Команда запустит все образы, и приступит к выполнению заданий Behave.
В случае неуспешного выполнения, контейнеры продолжат работу. Для их остановки следует дать команду `make clean`.
Эта команда также выполнит очистку директории, где производилась сборка (по ум. `staging`).

## Настройка
Все, что может повлиять на прохождение тестов, включая общие параметры, список проектов и их настройки находятся в файле
`tests/configuration.py`. Файл содержит комментарии, поясняющие предназначение параметров.

## Структура и control-flow
```
+-- images          # Директория содержит образы и конфигурационные файлы.
|   +-- base        # Содержит базовый образ, которые используется для моков
|   |   \-- config  # Дефолтная конфигурация. Файлы из этой директории будут видны всем образам.
|   |       +-- ...
|   +-- ...         # Прочие образы и их конфигурация также объявлены в данной директории.
|   |   \-- config
\-- staging         # Директория содержит все, что сгенинерировано для данной тестовой сессии.
|   +-- code        # В эту директорию делается git clone кода. Доступна внутри контейнера как /code
|   +-- arbiter     # Содержит unix-socket для общения с арбитром
|   +-- images      # Содержит результат отрисовки конфигов из ../images
|   +-- docker-compose.yaml  # Описывает общую конфигурацию докеров. Как и все остальное, генерится динамически.
\-- tests           # Содержит код для разворачивания тестов.
    +-- features    # Behave features
    +-- helpers     # В данной директории лежит код, который генерирует стейт для тестовой сессии.
    |   +-- arbiter.py  # Описывает код арбитра для общения с docker-compose из контейнеров.
    |   +-- compose.py  # реализует работу с docker-compose: конфиги, запуск, остановка.
    |   +-- crypto.py   # Описывает ряд криптографических примитивов (для pgaas-proxy и int-api).
    |   +-- docker.py   # Реализует работу с докером: поднятие и уничтожение сети.
    |   +-- templates.py  # Отрисовывает шаблоны из images.
    |   +-- unix_socket_server.py  # Копипаста из стандартной библиотеки, реализующая простой unix-сервер.
    |   \-- git.py      # Скачивает код в staging по заданным параметрам.
    \-- steps       # Behave tests implementations.
```

При выполнении `behave`, вначале вызывается `before_all(context)` из `tests/environment`. В данной функции описано несколько этапов, по
завершении которых ожидается готовый к работе тестовый стенд.
Результат работы каждого этапа оказывается в `./staging`, что позволяет при необходимости вернуться к изначальному состоянию просто удалив
эту директорию.

## Шаблоны
После генерации базовых образов и поднятия сети, директории из images, если они имеют ключ из config'а, подаются на ввод рендеру Jinja. Рендер
имеет следующий контекст:
1. `conf`: содержит всю конфигурацию из `tests/configuration.py`
2. `state`: содержит state (см `tests/environment.py`)
3. `compose`: содержит конфигурацию docker-compose
4. `ssl`: содержит указатель на объект SSLCerts, который может генерировать сертификаты и СА по запросу. Доступны следующие методы:
   `get_ca_cert(), get_ca_key(), get_cert(cn), get_key(cn), get_crl()`.
Результаты работы render-ера также оказываются в staging, `staging/images`. Отрисовка производится рекурсивно и на всех уровнях вложенности.


## Хинты
### Запуск отдельных Scenario

Активируем `venv`

```
. .tox/py35/bin/activate
```

```
behave tests/features/my-new-cool-feature.feature -t my-new-cool-feature -k -D debug
```

* `-t` `--tag` - удобно для фильтрации
* `-k` `--no-skipped` - не засоряет stdout пропущенными `scenario`
* `-D debug` - запустит дебаггер на упавшем степе
