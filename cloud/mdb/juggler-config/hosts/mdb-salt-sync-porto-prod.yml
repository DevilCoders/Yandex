- hosts: localhost
  connection: local
  gather_facts: false
  vars:
      namespace: dbaas.core
      host: mdb-salt-sync-porto-prod
      cgroup: mdb_salt_sync_porto_prod
      installation: porto_prod

  tasks:
      - juggler_facts: jserver_api=http://juggler-api.search.yandex.net:8998/api
      - include_vars: ../configs/core_resps.yml
      - include_vars: ../configs/core_tags.yml
      - include_vars: ../configs/common.yml
      - include_vars: ../configs/limit.yml
      - include_vars: ../configs/notifications_worktime.yml
      - include: ../checks/meta-unreach.yml
      - include: ../checks/common.yml
      - include: ../checks/unispace.yml
      - include: ../checks/common-act.yml
      - include: ../checks/common-dns.yml
      - juggler_check:
            host: "{{ host }}"
            service: salt-sync-image-age
            namespace: "{{ namespace }}"
            tags: "{{ default_tags | default([]) }}"
            aggregator: logic_or
            aggregator_kwargs:
                unreach_mode: force_ok
                unreach_service:
                    - check: :UNREACHABLE
            notifications: "{{ notifications }}"
            refresh_time: 60
            ttl: 360
            meta:
                urls:
                    - {title: "How to handle?", url: "https://wiki.yandex-team.ru/mdb/internal/operations/duty-howto/handling-alerts/salt-sync-image-age/", type: "mdb"}
            children:
                name: "{{ cgroup }}"
                type: "CGROUP"
                service: salt_sync_image_age
            __force__: True
  post_tasks:
      - juggler_cleanup: jcheck_mark={{ host }}
