- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    host: mdb-terraform-acc-tests
    ttl: 86400
    refresh_time: 90

  tasks:
    - juggler_facts: jserver_api=http://juggler-api.search.yandex.net:8998/api
    - include_vars: ../configs/gendb_resps.yml
    - include_vars: ../configs/notifications_worktime.yml

    - juggler_check:
        host: "{{ host }}"
        service: terraform-acc-tests-postgresql
        namespace: dbaas.postgresql
        aggregator: logic_or
        notifications: "{{ notifications_sms }}"
        refresh_time: "{{ refresh_time }}"
        ttl: "{{ ttl }}"
        children:
            - host: yc-terraform-acc-tests-sweeper
              service: mdb-postgres
            - host: yc-terraform-acc-tests-runner
              service: mdb-postgres
        __force__: True
        meta:
          urls:
            - { title: "How to handle?", url: "https://wiki.yandex-team.ru/mdb/internal/operations/duty-howto/handling-alerts/terraform-acceptance-tests/", type: "mdb" }

    - juggler_check:
        host: "{{ host }}"
        service: terraform-acc-tests-greenplum
        namespace: dbaas.greenplum
        aggregator: logic_or
        notifications: "{{ notifications_sms }}"
        refresh_time: "{{ refresh_time }}"
        ttl: "{{ ttl }}"
        children:
            - host: yc-terraform-acc-tests-sweeper
              service: mdb-greenplum
            - host: yc-terraform-acc-tests-runner
              service: mdb-greenplum
        __force__: True
        meta:
          urls:
            - { title: "How to handle?", url: "https://wiki.yandex-team.ru/mdb/internal/operations/duty-howto/handling-alerts/terraform-acceptance-tests/", type: "mdb" }
