# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
{% set services = salt['pillar.get']('data:services') %}

spark.master                                            yarn
spark.eventLog.enabled                                  true
spark.submit.deployMode                                 client
spark.eventLog.dir                                      {{ event_log_dir }}
spark.history.fs.logDirectory                           {{ history_log_dir }}
spark.yarn.historyServer.address                        {{ spark_history_server }}
spark.history.ui.port                                   {{ spark_history_server_port }}
spark.shuffle.service.enabled                           true
spark.driver.extraJavaOptions                           -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=70 -XX:MaxHeapFreeRatio=70 -XX:+CMSClassUnloadingEnabled -XX:OnOutOfMemoryError='kill -9 %p'

spark.dynamicAllocation.enabled                         true
spark.dynamicAllocation.timeout                         1h
spark.dynamicAllocation.enabled                         true
spark.dynamicAllocation.minExecutors                    1
spark.dynamicAllocation.maxExecutors                    8192

spark.blacklist.decommissioning.enabled                 true
spark.blacklist.decommissioning.timeout                 1h
spark.resourceManager.cleanupExpiredHost                true
spark.stage.attempt.ignoreOnDecommissionFetchFailure    true
spark.decommissioning.timeout.threshold                 20
spark.executor.extraJavaOptions                         -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=70 -XX:MaxHeapFreeRatio=70 -XX:+CMSClassUnloadingEnabled -XX:OnOutOfMemoryError='kill -9 %p'
spark.hadoop.yarn.timeline-service.enabled              false
spark.yarn.appMasterEnv.SPARK_PUBLIC_DNS                $(hostname -f)
spark.files.fetchFailure.unRegisterOutputOnHost         true
spark.executor.memory                                   {{ spark_executor_memory }}
spark.executor.cores                                    {{ spark_executor_cores }}
spark.yarn.am.memory                                    {{ spark_executor_memory }}
spark.driver.memory                                     {{ spark_driver_memory }}
spark.driver.maxResultSize                              {{ spark_driver_result_size_memory }}

spark.sql.cbo.enable=true
spark.yarn.jars=local:/usr/lib/spark/jars/*,local:/usr/lib/spark/external/lib/*

{% if 'hive' in services -%}
spark.yarn.dist.files                                   /etc/spark/conf/hive-site.xml
{%- endif %}
