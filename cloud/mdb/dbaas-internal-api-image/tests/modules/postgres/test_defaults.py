# -*- coding: utf-8 -*-
"""
PostgreSQL defaults logic tests
"""
import pytest
from dbaas_internal_api.utils.types import MEGABYTE, GIGABYTE
from dbaas_internal_api.modules.postgres.schema_defaults import get_maintenance_work_mem


@pytest.mark.parametrize(
    ['instance_type', 'expected'],
    [
        ({'cpu_limit': 1, 'memory_limit': '2GB'}, '64MB'),
        ({'cpu_limit': 1, 'memory_limit': '4GB'}, '128MB'),
        ({'cpu_limit': 1, 'memory_limit': '8GB'}, '256MB'),
        ({'cpu_limit': 2, 'memory_limit': '2GB'}, '64MB'),
        ({'cpu_limit': 2, 'memory_limit': '4GB'}, '128MB'),
        ({'cpu_limit': 2, 'memory_limit': '8GB'}, '256MB'),
        ({'cpu_limit': 2, 'memory_limit': '12GB'}, '384MB'),
        ({'cpu_limit': 2, 'memory_limit': '16GB'}, '512MB'),
        ({'cpu_limit': 4, 'memory_limit': '8GB'}, '192MB'),
        ({'cpu_limit': 4, 'memory_limit': '16GB'}, '384MB'),
        ({'cpu_limit': 4, 'memory_limit': '24GB'}, '576MB'),
        ({'cpu_limit': 4, 'memory_limit': '32GB'}, '768MB'),
        ({'cpu_limit': 4, 'memory_limit': '48GB'}, '1024MB'),
        ({'cpu_limit': 4, 'memory_limit': '64GB'}, '1024MB'),
        ({'cpu_limit': 4, 'memory_limit': '80GB'}, '1024MB'),
        ({'cpu_limit': 6, 'memory_limit': '48GB'}, '832MB'),
        ({'cpu_limit': 6, 'memory_limit': '60GB'}, '1024MB'),
        ({'cpu_limit': 6, 'memory_limit': '64GB'}, '1024MB'),
        ({'cpu_limit': 6, 'memory_limit': '78GB'}, '1024MB'),
        ({'cpu_limit': 6, 'memory_limit': '80GB'}, '1024MB'),
        ({'cpu_limit': 6, 'memory_limit': '96GB'}, '1024MB'),
        ({'cpu_limit': 8, 'memory_limit': '16GB'}, '192MB'),
        ({'cpu_limit': 8, 'memory_limit': '32GB'}, '384MB'),
        ({'cpu_limit': 8, 'memory_limit': '64GB'}, '896MB'),
        ({'cpu_limit': 8, 'memory_limit': '96GB'}, '1024MB'),
        ({'cpu_limit': 8, 'memory_limit': '128GB'}, '1024MB'),
        ({'cpu_limit': 8, 'memory_limit': '160GB'}, '1024MB'),
        ({'cpu_limit': 8, 'memory_limit': '192GB'}, '1024MB'),
        ({'cpu_limit': 8, 'memory_limit': '224GB'}, '1024MB'),
        ({'cpu_limit': 8, 'memory_limit': '256GB'}, '1024MB'),
        ({'cpu_limit': 10, 'memory_limit': '80GB'}, '896MB'),
        ({'cpu_limit': 10, 'memory_limit': '160GB'}, '1024MB'),
        ({'cpu_limit': 12, 'memory_limit': '24GB'}, '192MB'),
        ({'cpu_limit': 12, 'memory_limit': '48GB'}, '384MB'),
        ({'cpu_limit': 12, 'memory_limit': '96GB'}, '896MB'),
        ({'cpu_limit': 12, 'memory_limit': '192GB'}, '1024MB'),
        ({'cpu_limit': 12, 'memory_limit': '256GB'}, '1024MB'),
        ({'cpu_limit': 12, 'memory_limit': '320GB'}, '1024MB'),
        ({'cpu_limit': 12, 'memory_limit': '384GB'}, '1024MB'),
        ({'cpu_limit': 12, 'memory_limit': '448GB'}, '1024MB'),
        ({'cpu_limit': 14, 'memory_limit': '224GB'}, '1024MB'),
        ({'cpu_limit': 16, 'memory_limit': '32GB'}, '192MB'),
        ({'cpu_limit': 16, 'memory_limit': '64GB'}, '448MB'),
        ({'cpu_limit': 16, 'memory_limit': '128GB'}, '960MB'),
        ({'cpu_limit': 16, 'memory_limit': '192GB'}, '1024MB'),
        ({'cpu_limit': 16, 'memory_limit': '256GB'}, '1024MB'),
        ({'cpu_limit': 16, 'memory_limit': '512GB'}, '1024MB'),
        ({'cpu_limit': 20, 'memory_limit': '160GB'}, '960MB'),
        ({'cpu_limit': 20, 'memory_limit': '320GB'}, '1024MB'),
        ({'cpu_limit': 24, 'memory_limit': '48GB'}, '192MB'),
        ({'cpu_limit': 24, 'memory_limit': '96GB'}, '448MB'),
        ({'cpu_limit': 24, 'memory_limit': '192GB'}, '960MB'),
        ({'cpu_limit': 24, 'memory_limit': '384GB'}, '1024MB'),
        ({'cpu_limit': 28, 'memory_limit': '224GB'}, '960MB'),
        ({'cpu_limit': 28, 'memory_limit': '448GB'}, '1024MB'),
        ({'cpu_limit': 32, 'memory_limit': '64GB'}, '192MB'),
        ({'cpu_limit': 32, 'memory_limit': '128GB'}, '448MB'),
        ({'cpu_limit': 32, 'memory_limit': '256GB'}, '960MB'),
        ({'cpu_limit': 32, 'memory_limit': '384GB'}, '1024MB'),
        ({'cpu_limit': 32, 'memory_limit': '512GB'}, '1024MB'),
        ({'cpu_limit': 40, 'memory_limit': '80GB'}, '256MB'),
        ({'cpu_limit': 40, 'memory_limit': '160GB'}, '576MB'),
        ({'cpu_limit': 40, 'memory_limit': '320GB'}, '1024MB'),
        ({'cpu_limit': 48, 'memory_limit': '96GB'}, '320MB'),
        ({'cpu_limit': 48, 'memory_limit': '192GB'}, '704MB'),
        ({'cpu_limit': 48, 'memory_limit': '384GB'}, '1024MB'),
        ({'cpu_limit': 56, 'memory_limit': '448GB'}, '1024MB'),
        ({'cpu_limit': 64, 'memory_limit': '128GB'}, '448MB'),
        ({'cpu_limit': 64, 'memory_limit': '256GB'}, '960MB'),
        ({'cpu_limit': 64, 'memory_limit': '512GB'}, '1024MB'),
        ({'cpu_limit': 76, 'memory_limit': '640GB'}, '1024MB'),
        ({'cpu_limit': 80, 'memory_limit': '160GB'}, '576MB'),
        ({'cpu_limit': 80, 'memory_limit': '320GB'}, '1024MB'),
        ({'cpu_limit': 80, 'memory_limit': '400GB'}, '1024MB'),
        ({'cpu_limit': 80, 'memory_limit': '640GB'}, '1024MB'),
        ({'cpu_limit': 96, 'memory_limit': '192GB'}, '704MB'),
        ({'cpu_limit': 96, 'memory_limit': '576GB'}, '1024MB'),
        ({'cpu_limit': 104, 'memory_limit': '256GB'}, '960MB'),
        ({'cpu_limit': 104, 'memory_limit': '728GB'}, '1024MB'),
    ],
)
def test_default_maintenance_work_mem(instance_type, expected):
    instance_type['memory_limit'] = int(instance_type['memory_limit'][:-2]) * GIGABYTE
    expected_bytes = int(expected[:-2]) * MEGABYTE
    assert get_maintenance_work_mem(instance_type) == expected_bytes
