
<% set dom0_tags_list = ['itype=mdbdom0'] %>
<% set domu_ch_tags_list = ['itype=mdbclickhouse'] %>
<% set domu_zk_tags_list = ['itype=mdbzk'] %>

<% do dom0_tags_list.append('ctype=' ~ cid) %>
<% do domu_ch_tags_list.append('ctype=' ~ cid) %>
<% do domu_zk_tags_list.append('ctype=' ~ cid) %>


<% if shard %>
<% do dom0_tags_list.append('prj=' ~ shard) %>
<% do domu_ch_tags_list.append('prj=' ~ shard) %>
<% endif %>


<% if tier %>
<% do dom0_tags_list.append('tier=' ~ tier) %>
<% do domu_ch_tags_list.append('tier=' ~ tier) %>
<% else %>
<% do domu_ch_tags_list.append('tier=replica') %>
<% do domu_zk_tags_list.append('tier=follower') %>
<% endif %>

<% set dom0_tags = ';'.join(dom0_tags_list)%>
<% set domu_ch_tags = ';'.join(domu_ch_tags_list)%>
<% set domu_zk_tags = ';'.join(domu_zk_tags_list)%>


<% if geo %>
<% set dom0_tags = dom0_tags ~ ';geo=' ~ geo %>
<% set domu_ch_tags = domu_ch_tags ~ ';geo=' ~ geo %>
<% set domu_zk_tags = domu_zk_tags ~ ';geo=' ~ geo %>
<% endif %>

{
<% if shard %>
    "title": "Cluster: << cid >>; Shard: << shard >>",
<% else %>
    "title": "Cluster: << cid >>",
<% endif %>
    "type": "panel",
    "charts": [
        {
            "id": "cpu",
            "type": "graphic",
            "row": 1,
            "col": 1,
            "yAxis": [
                {
                    "minValue": 0,
                    "maxValue": 32
                },
                {
                    "minValue": 0,
                    "maxValue": 32
                }
            ],
            "signals": [
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-cpu_usage_cores_tmmv",
                    "title": "Used",
                    "yAxis": 0
                },
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-cpu_guarantee_cores_tmmv",
                    "title": "Guaranteed",
                    "stacked": false,
                    "yAxis": 1
                },
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-cpu_limit_cores_tmmv",
                    "title": "Limit",
                    "stacked": false,
                    "yAxis": 1
                },
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-cpu_wait_cores_tmmv",
                    "title": "Wait",
                    "yAxis": 0
                }
            ],
            "consts": [],
            "title": "CPU (Cores)",
            "stacked": true,
            "normalize": true
        },
        {
            "id": "mem",
            "type": "graphic",
            "row": 1,
            "col": 3,
            "yAxis": [
                {}
            ],
            "signals": [
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-memory_usage_gb_tmmv",
                    "title": "Used"
                },
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-memory_guarantee_gb_tmmv",
                    "title": "Guaranteed"
                },
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-memory_limit_gb_tmmv",
                    "title": "Limit"
                },
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-anon_usage_gb_tmmv",
                    "title": "Anon used"
                }
            ],
            "consts": [],
            "range": 1500,
            "title": "Memory (GB)",
            "stacked": false,
            "normalize": true
        },
        {
            "id": "io",
            "type": "graphic",
            "row": 1,
            "col": 5,
            "yAxis": [
                {
                    "minValue": 0,
                    "maxValue": 1000000000
                },
                {
                    "minValue": 0,
                    "maxValue": 1000000000
                }
            ],
            "signals": [
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-io_read_bytes_tmmv",
                    "title": "Read",
                    "normalizable": true,
                    "yAxis": 0
                },
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-io_write_fs_bytes_tmmv",
                    "title": "Write",
                    "normalizable": true,
                    "yAxis": 0
                },
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-io_limit_bytes_tmmv",
                    "title": "Limit",
                    "stacked": false,
                    "normalizable": true,
                    "yAxis": 1
                }
            ],
            "consts": [],
            "range": 1500,
            "title": "I/O (B/s)",
            "stacked": true,
            "normalize": true
        },

        {
            "id": "net",
            "type": "graphic",
            "row": 3,
            "col": 1,
            "yAxis": [
                {}
            ],
            "signals": [
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "sum(portoinst-net_rx_mb_summ, portoinst-net_tx_mb_summ)",
                    "title": "Used"
                },
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-net_guarantee_mb_summ",
                    "title": "Guaranteed"
                },
                {
                    "tag": "<< dom0_tags >>",
                    "host": "CON",
                    "name": "portoinst-net_limit_mb_summ",
                    "title": "Limit"
                }
            ],
            "consts": [],
            "range": 1500,
            "title": "Network (MB/s)",
            "stacked": false,
            "normalize": true
        },
        {
            "id": "conn",
            "type": "graphic",
            "row": 3,
            "col": 3,
            "yAxis": [
                {},
                {}
            ],
            "signals": [
                {
                    "tag": "<< domu_ch_tags >>",
                    "host": "CON",
                    "name": "or(push-ch_system_metrics_HTTPConnection_tmmx, push-ch_system_metrics_HTTPConnection_vmmv)",
                    "title": "HTTP connections"
                },
                {
                    "tag": "<< domu_ch_tags >>",
                    "host": "CON",
                    "name": "or(ch_system_metrics_TCPConnection_tmmx, ch_system_metrics_TCPConnection_vmmv)",
                    "title": "TCP connections"
                }
            ],
            "consts": [],
            "range": 1500,
            "title": "Connections",
            "stacked": false,
            "normalize": true
        },
        {
            "id": "space",
            "type": "graphic",
            "row": 3,
            "col": 5,
            "yAxis": [
                {}
            ],
            "signals": [
                {
                    "tag": "<< domu_ch_tags >>",
                    "host": "CON",
                    "name": "max(or(push-disk-total_bytes_/var/lib/clickhouse_tmmx, push-disk-total_bytes_/var/lib/clickhouse_vmmv))",
                    "title": "Total"
                },
                {
                    "tag": "<< domu_ch_tags >>",
                    "host": "CON",
                    "name": "max(or(push-disk-used_bytes_/var/lib/clickhouse_tmmx, push-disk-used_bytes_/var/lib/clickhouse_vmmv))",
                    "title": "Used"
                }
            ],
            "consts": [],
            "range": 1500,
            "title": "Disk space (bytes)",
            "stacked": false,
            "normalize": true
        },

        {
            "id": "rps",
            "type": "graphic",
            "row": 5,
            "col": 1,
            "yAxis": [
                {}
            ],
            "signals": [
                {
                    "tag": "<< domu_ch_tags >>",
                    "host": "CON",
                    "name": "push-ch_system_events_Query_rate_tmmx",
                    "title": "Queries"
                },
                {
                    "tag": "<< domu_ch_tags >>",
                    "host": "CON",
                    "name": "push-ch_system_events_InsertQuery_rate_tmmx",
                    "title": "Insert queries"
                },
                {
                    "tag": "<< domu_ch_tags >>",
                    "host": "CON",
                    "name": "push-ch_system_events_SelectQuery_rate_tmmx",
                    "title": "Select queries"
                }
            ],
            "consts": [],
            "range": 1500,
            "title": "RPS",
            "stacked": false,
            "normalize": true
        },
        {
            "id": "query_time",
            "type": "graphic",
            "row": 5,
            "col": 3,
            "yAxis": [
                {}
            ],
            "signals": [
                {
                    "tag": "<< domu_ch_tags >>",
                    "host": "CON",
                    "name": "or(push-ch_system_query_log_avg_query_ms_tmmx, push-ch_system_query_log_avg_query_ms_vmmv)",
                    "title": "Average"
                }
            ],
            "consts": [],
            "title": "Query time (ms)",
            "stacked": false,
            "normalize": true
        },
        {
            "id": "ch_replication",
            "type": "graphic",
            "row": 5,
            "col": 5,
            "yAxis": [
                {}
            ],
            "signals": [
                {
                    "tag": "<< domu_ch_tags >>",
                    "host": "CON",
                    "name": "push-ch_system_async_metrics_ReplicasMaxAbsoluteDelay_tmmx",
                    "title": "Max absolute delay"
                }
            ],
            "consts": [],
            "title": "Replication delay (s)",
            "stacked": false,
            "normalize": true
        },

        {
            "id": "zk_latency",
            "type": "graphic",
            "row": 7,
            "col": 1,
            "yAxis": [
                {}
            ],
            "signals": [
                           {
                    "tag": "<< domu_zk_tags >>",
                    "host": "CON",
                    "name": "push-zk_avg_latency_tmmx",
                    "title": "Average"
                }

            ],
            "consts": [],
            "title": "ZooKeeper latency (ms)",
            "stacked": false,
            "normalize": true
        },
        {
            "id": "zk_size",
            "type": "graphic",
            "row": 7,
            "col": 3,
            "yAxis": [
                {}
            ],
            "signals": [
                {
                    "tag": "<< domu_zk_tags >>",
                    "host": "CON",
                    "name": "max(or(push-disk-total_bytes_/var/lib/zookeeper_tmmx, push-disk-total_bytes_/var/lib/zookeeper_vmmv))",
                    "title": "Total"
                },
                {
                    "tag": "<< domu_zk_tags >>",
                    "host": "CON",
                    "name": "max(or(push-disk-used_bytes_/var/lib/zookeeper_tmmx, push-disk-used_bytes_/var/lib/zookeeper_vmmv))",
                    "title": "Used"
                }
            ],
            "consts": [],
            "range": 1500,
            "title": "ZooKeeper disk space (bytes)",
            "stacked": false,
            "normalize": true
        },
        {
            "id": "zk_nodes_count",
            "type": "graphic",
            "row": 7,
            "col": 5,
            "yAxis": [
                {}
            ],
            "signals": [
                       {
                    "tag": "<< domu_zk_tags >>",
                    "host": "CON",
                    "name": "or(push-zk_znode_count_tmmx, push-zk_znode_count_vmmv)",
                    "title": "Znodes"
                },
                {
                    "tag": "<< domu_zk_tags >>",
                    "host": "CON",
                    "name": "or(push-zk_ephemerals_count_tmmx, push-zk_ephemerals_count_vmmv)",
                    "title": "Ephemeral nodes"
                },
                           {
                    "tag": "<< domu_zk_tags >>",
                    "host": "CON",
                    "name": "or(push-zk_watch_count_tmmx, push-zk_watch_count_vmmv)",
                    "title": "Watches"
                }

            ],
            "consts": [],
            "title": "ZooKeeper nodes",
            "stacked": false,
            "normalize": true
        },

        {
            "id": "zk_conn",
            "type": "graphic",
            "row": 9,
            "col": 1,
            "yAxis": [
                {},
                {}
            ],
            "signals": [
                {
                    "tag": "<< domu_zk_tags >>",
                    "host": "CON",
                    "name": "push-zk_num_alive_connections_tmmx",
                    "title": "Connections"
                }
            ],
            "consts": [],
            "range": 1500,
            "title": "ZooKeeper connections",
            "stacked": false,
            "normalize": true
        }
    ]
}
