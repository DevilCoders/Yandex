---
{% set ch_tm_writer_password = yav('ver-01g7vvk9v7kbn8wmem8zxnrpc6', 'password') %}
# Token can be obtained here:
# yc --profile=compute-preprod iam create-token
token: {{ env.get('TOKEN') }}
# Folder ID of MDB sink Clickhouse cluster
folder_id: aoeme1ci0qvbsjia4ks7
endpoint: https://tm-rest.private-api.ycp.cloud-preprod.yandex.net
logbroker: yc-logbroker-prestable
transfers:
  # pg_stat_activity
  - service: pg_stat_activity
    src:
      consumer: aoe9shbqc2v314v7fp3d/dataplane_rt/perf_diag/consumer
      topic: aoe9shbqc2v314v7fp3d/dataplane_rt/perf_diag/pg_stat_activity
      format: json
      fields: &pg_stat_activity
        - name: collect_time
          type: DATETIME
          key: true
        - name: cluster_id
          type: STRING
          key: true
        - name: cluster_name
          type: STRING
        - name: host
          type: STRING
          key: true
        - name: database
          type: STRING
          required: true
        - name: pid
          type: UINT32
          required: true
        - name: user
          type: STRING
          required: true
        - name: application_name
          type: STRING
        - name: client_addr
          type: STRING
        - name: client_hostname
          type: STRING
        - name: client_port
          type: UINT32
        - name: backend_start
          type: DATETIME
        - name: xact_start
          type: DATETIME
        - name: query_start
          type: DATETIME
        - name: state_change
          type: DATETIME
        - name: wait_event_type
          type: STRING
          required: true
        - name: wait_event
          type: STRING
          required: true
        - name: state
          type: STRING
          required: true
        - name: backend_xid
          type: UINT32
        - name: backend_xmin
          type: UINT32
        - name: query
          type: STRING
        - name: backend_type
          type: STRING
        - name: blocking_pids
          type: STRING
        - name: queryid
          type: STRING
    dst: &dst-compute-ch
      database: perf_diag
      mdb_cluster_id: e4uhg01rdhlkhlurj5pi
      user: tm_writer
      password:
        raw: {{ ch_tm_writer_password }}

  # pg_stat_statements
  - service: pg_stat_statements
    src:
      consumer: aoe9shbqc2v314v7fp3d/dataplane_rt/perf_diag/consumer
      topic: aoe9shbqc2v314v7fp3d/dataplane_rt/perf_diag/pg_stat_statements
      format: json
      fields: &pg_stat_statements
        - name: collect_time
          type: DATETIME
          key: true
        - name: cluster_id
          type: STRING
          key: true
        - name: host
          type: STRING
          key: true
        - name: user
          type: STRING
          key: true
        - name: database
          type: STRING
          key: true
        - name: queryid
          type: STRING
          key: true
        - name: calls
          type: UINT64
          required: true
        - name: total_time
          type: DOUBLE
          required: true
        - name: min_time
          type: DOUBLE
          required: true
        - name: max_time
          type: DOUBLE
          required: true
        - name: mean_time
          type: DOUBLE
          required: true
        - name: stddev_time
          type: DOUBLE
          required: true
        - name: rows
          type: UINT64
          required: true
        - name: shared_blks_hit
          type: UINT64
          required: true
        - name: shared_blks_read
          type: UINT64
          required: true
        - name: shared_blks_dirtied
          type: UINT64
          required: true
        - name: shared_blks_written
          type: UINT64
          required: true
        - name: local_blks_hit
          type: UINT64
          required: true
        - name: local_blks_read
          type: UINT64
          required: true
        - name: local_blks_dirtied
          type: UINT64
          required: true
        - name: local_blks_written
          type: UINT64
          required: true
        - name: temp_blks_read
          type: UINT64
          required: true
        - name: temp_blks_written
          type: UINT64
          required: true
        - name: blk_read_time
          type: DOUBLE
          required: true
        - name: blk_write_time
          type: DOUBLE
          required: true
        - name: reads
          type: UINT64
          required: true
        - name: writes
          type: UINT64
          required: true
        - name: user_time
          type: DOUBLE
          required: true
        - name: system_time
          type: DOUBLE
          required: true
    dst: *dst-compute-ch
