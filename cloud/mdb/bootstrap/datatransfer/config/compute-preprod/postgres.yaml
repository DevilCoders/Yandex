---
{% set ch_tm_writer_password = yav('ver-01e61vbfqkm5c10ncgms3xjxgn', 'mdb-logsdb-consumer-compute-preprod-user-password') %}
# Token can be obtained here:
# yc --profile=compute-preprod iam create-token
token: {{ env.get('TOKEN') }}
endpoint: https://tm-rest.private-api.ycp.cloud-preprod.yandex.net
logbroker: yc-logbroker-prestable
# Folder ID of MDB sink Clickhouse cluster
folder_id: aoeme1ci0qvbsjia4ks7
transfers:
  # postgresql-log
  - service: postgres
    src:
      consumer: aoe9shbqc2v314v7fp3d/dataplane/logsdb-consumer
      topic: aoe9shbqc2v314v7fp3d/dataplane/postgresql-logs
      fields:
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: log_time
          type: DATETIME
        - name: timestamp
          type: DATETIME
        - name: user_name
          type: STRING
        - name: database_name
          type: STRING
        - name: process_id
          type: UINT32
        - name: connection_from
          type: STRING
        - name: session_id
          type: STRING
        - name: session_line_num
          type: UINT32
        - name: command_tag
          type: STRING
        - name: session_start_time
          type: DATETIME
        - name: virtual_transaction_id
          type: STRING
        - name: transaction_id
          type: UINT64
        - name: error_severity
          type: STRING
        - name: sql_state_code
          type: STRING
        - name: message
          type: STRING
        - name: detail
          type: STRING
        - name: hint
          type: STRING
        - name: internal_query
          type: STRING
        - name: internal_query_pos
          type: UINT32
        - name: context
          type: STRING
        - name: query
          type: STRING
        - name: query_pos
          type: UINT32
        - name: location
          type: STRING
        - name: application_name
          type: STRING
        - name: ms
          type: UINT32
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: origin
          type: STRING
    dst: &dst-compute-preprod
      database: mdb
      mdb_cluster_id: e4uh169bluasvlmd6eds
      user: tm_writer
      password:
        raw: {{ ch_tm_writer_password }}

  # pgbouncer-log
  - service: pgbouncer
    src:
      consumer: aoe9shbqc2v314v7fp3d/dataplane/logsdb-consumer
      topic: aoe9shbqc2v314v7fp3d/dataplane/pgbouncer-logs
      fields:
        - name: timestamp
          type: DATETIME
        - name: session_id
          type: STRING
        - name: db
          type: STRING
        - name: user
          type: STRING
        - name: source
          type: STRING
        - name: text
          type: STRING
        - name: pid
          type: UINT32
        - name: level
          type: STRING
        - name: ms
          type: UINT16
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: log_time
          type: DATETIME
        - name: origin
          type: STRING
        - name: log_format
          type: STRING
    dst: *dst-compute-preprod

  # odyssey-log
  - service: odyssey_original
    src:
      consumer: aoe9shbqc2v314v7fp3d/dataplane/logsdb-consumer
      topic: aoe9shbqc2v314v7fp3d/dataplane/odyssey-logs
      fields:
        - name: unixtime
          type: DATETIME
        - name: cid
          type: STRING
        - name: sid
          type: STRING
        - name: db
          type: STRING
        - name: user
          type: STRING
        - name: ctx
          type: STRING
        - name: msg
          type: STRING
        - name: pid
          type: UINT32
        - name: level
          type: STRING
        - name: ms
          type: UINT32
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: origin
          type: STRING
    dst: *dst-compute-preprod
