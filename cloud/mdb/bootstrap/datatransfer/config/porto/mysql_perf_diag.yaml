---
{% set mdb_logsdb_consumer_porto_test_user_password = yav('ver-01eemqqew06fdkc041m23c65x1', 'password') %}
{% set mdb_logsdb_consumer_porto_prod_user_password = yav('ver-01efc84jqg4t3ch2d1b9egdw28', 'password') %}
{% set mdb_logsdb_consumer_compute_preprod_user_password = yav('ver-01efe6r51s9kgx7fbn2cnnxwgc', 'password') %}
{% set mdb_logsdb_consumer_compute_prod_user_password = yav('ver-01efe7dt6sk8nppnt7qyg8f6x2', 'password') %}
# Token can be obtained here:
# https://wiki.yandex-team.ru/transfer-manager/replication/quickstart/
token: {{ env.get('TOKEN') }}
# Folder ID of MDB sink Clickhouse cluster
folder_id: fooi5vu9rdejqc3p4b60  # mdb-internal
endpoint: http://cdc.n.yandex-team.ru
transfers:

  # Porto-Test
  - service: my_sessions
    src:
      format: json
      consumer: mdb/porto/test/perf_diag/consumer
      topic: mdb/porto/test/perf_diag/my_sessions
      fields: &my_sessions
        - name: collect_time
          type: DATETIME
          required: true
          key: true
        - name: cluster_id
          type: STRING
          required: true
          key: true
        - name: host
          type: STRING
          required: true
          key: true
        - name: database
          type: STRING
          required: true
        - name: user
          type: STRING
          required: true
        - name: thd_id
          type: UINT32
          required: true
        - name: conn_id
          type: UINT32
          required: true
        - name: command
          type: STRING
          required: true
        - name: query
          type: STRING
        - name: digest
          type: STRING
        - name: query_latency
          type: DOUBLE
        - name: lock_latency
          type: DOUBLE
        - name: stage
          type: STRING
        - name: stage_latency
          type: DOUBLE
        - name: current_wait
          type: STRING
        - name: wait_object
          type: STRING
        - name: wait_latency
          type: DOUBLE
        - name: trx_latency
          type: DOUBLE
        - name: current_memory
          type: UINT64
        - name: client_addr
          type: STRING
        - name: client_hostname
          type: STRING
        - name: client_port
          type: UINT32

    dst: &dst-porto-test
      database: perf_diag
      mdb_cluster_id: mdbpb2fdin0s0v9j7h1c
      user: tm_writer
      password:
        raw: {{ mdb_logsdb_consumer_porto_test_user_password }}

  - service: my_statements
    src:
      format: json
      consumer: mdb/porto/test/perf_diag/consumer
      topic: mdb/porto/test/perf_diag/my_statements
      fields: &my_statements
        - name: collect_time
          type: DATETIME
          required: true
          key: true
        - name: cluster_id
          type: STRING
          required: true
          key: true
        - name: host
          type: STRING
          required: true
          key: true
        - name: database
          type: STRING
          required: true
          key: true
        - name: digest
          type: STRING
          required: true
          key: true
        - name: query
          type: STRING
          required: true
        - name: total_query_latency
          type: DOUBLE
          required: true
        - name: total_lock_latency
          type: DOUBLE
          required: true
        - name: avg_query_latency
          type: DOUBLE
          required: true
        - name: avg_lock_latency
          type: DOUBLE
          required: true
        - name: calls
          type: UINT64
          required: true
        - name: errors
          type: UINT64
          required: true
        - name: warnings
          type: UINT64
          required: true
        - name: rows_examined
          type: UINT64
          required: true
        - name: rows_sent
          type: UINT64
          required: true
        - name: rows_affected
          type: UINT64
          required: true
        - name: tmp_tables
          type: UINT64
          required: true
        - name: tmp_disk_tables
          type: UINT64
          required: true
        - name: select_full_join
          type: UINT64
          required: true
        - name: select_full_range_join
          type: UINT64
          required: true
        - name: select_range
          type: UINT64
          required: true
        - name: select_range_check
          type: UINT64
          required: true
        - name: select_scan
          type: UINT64
          required: true
        - name: sort_merge_passes
          type: UINT64
          required: true
        - name: sort_range
          type: UINT64
          required: true
        - name: sort_rows
          type: UINT64
          required: true
        - name: sort_scan
          type: UINT64
          required: true
        - name: no_index_used
          type: UINT64
          required: true
        - name: no_good_index_used
          type: UINT64
          required: true
    dst: *dst-porto-test


  # Porto-Prod
  - service: my_sessions
    src:
      format: json
      consumer: mdb/porto/prod/perf_diag/consumer
      topic: mdb/porto/prod/perf_diag/my_sessions
      fields: *my_sessions
    dst: &dst-porto-prod
      database: perf_diag
      mdb_cluster_id: mdbq5la0ctgafe94pgcn
      user: tm_writer
      password:
        raw: {{ mdb_logsdb_consumer_porto_prod_user_password }}

  - service: my_statements
    src:
      format: json
      consumer: mdb/porto/prod/perf_diag/consumer
      topic: mdb/porto/prod/perf_diag/my_statements
      fields: *my_statements
    dst: *dst-porto-prod

  # Compute-Preprod
  - service: my_sessions
    src:
      format: json
      consumer: mdb/compute/preprod/perf_diag/consumer
      topic: mdb/compute/preprod/perf_diag/my_sessions
      fields: *my_sessions
    dst: &dst-compute-preprod
      database: perf_diag
      mdb_cluster_id: mdb02j4kqil74fpgm1te
      user: tm_writer
      password:
        raw: {{ mdb_logsdb_consumer_compute_preprod_user_password }}

  - service: my_statements
    src:
      format: json
      consumer: mdb/compute/preprod/perf_diag/consumer
      topic: mdb/compute/preprod/perf_diag/my_statements
      fields: *my_statements
    dst: *dst-compute-preprod

  # Compute-Prod
  - service: my_sessions
    src:
      format: json
      consumer: mdb/compute/prod/perf_diag/consumer
      topic: mdb/compute/prod/perf_diag/my_sessions
      fields: *my_sessions
    dst: &dst-compute-prod
      database: perf_diag
      mdb_cluster_id: mdbd6pm5ea7tsriofcvg
      user: tm_writer
      password:
        raw: {{ mdb_logsdb_consumer_compute_prod_user_password }}

  - service: my_statements
    src:
      format: json
      consumer: mdb/compute/prod/perf_diag/consumer
      topic: mdb/compute/prod/perf_diag/my_statements
      fields: *my_statements
    dst: *dst-compute-prod
