---
{% set mdb_logsdb_consumer_porto_test_user_password = yav('ver-01e61vbfqkm5c10ncgms3xjxgn', 'mdb-logsdb-consumer-porto-test-user-password') %}
{% set mdb_logsdb_consumer_porto_prod_user_password = yav('ver-01e61vbfqkm5c10ncgms3xjxgn', 'mdb-logsdb-consumer-porto-prod-user-password') %}
# Token can be obtained here:
# https://wiki.yandex-team.ru/transfer-manager/replication/quickstart/
token: {{ env.get('TOKEN') }}
# Folder ID of MDB sink Clickhouse cluster
folder_id: fooi5vu9rdejqc3p4b60  # mdb-internal
endpoint: https://cdc.n.yandex-team.ru
transfers:
  # Mysql
  # audit-log
  # Porto-Test
  - service: mysql_audit
    src:
      consumer: mdb/porto/test/logsdb-consumer
      topic: mdb/porto/test/mysql-audit-logs
      fields: &mysql-audit-logs
        - name: origin
          type: STRING
        - name: timestamp
          type: DATETIME
        - name: ms
          type: UINT16
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: name
          type: STRING
        - name: record
          type: STRING
        - name: command_class
          type: STRING
        - name: connection_id
          type: UINT32
        - name: connection_type
          type: STRING
        - name: db
          type: STRING
        - name: ip
          type: STRING
        - name: mysql_version
          type: STRING
        - name: os_login
          type: STRING
        - name: os_user
          type: STRING
        - name: os_version
          type: STRING
        - name: priv_user
          type: STRING
        - name: proxy_user
          type: STRING
        - name: server_id
          type: UINT32
        - name: sqltext
          type: STRING
        - name: startup_optionsi
          type: STRING
        - name: status
          type: UINT32
        - name: status_code
          type: UINT32
        - name: user
          type: STRING
        - name: version
          type: UINT32
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: raw
          type: STRING
    dst: &dst-porto-test
      database: mdb
      mdb_cluster_id: mdbnq9ar9md7hmkg2kju
      user: tm_writer
      password:
        raw: {{ mdb_logsdb_consumer_porto_test_user_password }}

  # Porto-Prod
  - service: mysql_audit
    src:
      consumer: mdb/porto/prod/logsdb-consumer
      topic: mdb/porto/prod/mysql-audit-logs
      fields: *mysql-audit-logs
    dst: &dst-porto-prod
      database: mdb
      mdb_cluster_id: mdbmas2jjul3ct5q39sm
      user: tm_writer
      password:
        raw: {{ mdb_logsdb_consumer_porto_prod_user_password }}

  # error-log
  # Porto-Test
  - service: mysql_error
    src:
      consumer: mdb/porto/test/logsdb-consumer
      topic: mdb/porto/test/mysql-error-logs
      fields: &mysql-error-logs
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: origin
          type: STRING
        - name: id
          type: STRING
        - name: status
          type: STRING
        - name: message
          type: STRING
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: ms
          type: UINT16
        - name: timestamp
          type: DATETIME
        - name: raw
          type: STRING
    dst: *dst-porto-test

  # Porto-Prod
  - service: mysql_error
    src:
      consumer: mdb/porto/prod/logsdb-consumer
      topic: mdb/porto/prod/mysql-error-logs
      fields: *mysql-error-logs
    dst: *dst-porto-prod

  # general-log
  # Porto-Test
  - service: mysql_general
    src:
      consumer: mdb/porto/test/logsdb-consumer
      topic: mdb/porto/test/mysql-general-logs
      fields: &mysql-general-logs
        - name: origin
          type: STRING
        - name: id
          type: STRING
        - name: command
          type: STRING
        - name: argument
          type: STRING
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: ms
          type: UINT16
        - name: timestamp
          type: DATETIME
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: raw
          type: STRING
    dst: *dst-porto-test

  # Porto-Prod
  - service: mysql_general
    src:
      consumer: mdb/porto/prod/logsdb-consumer
      topic: mdb/porto/prod/mysql-general-logs
      fields: *mysql-general-logs
    dst: *dst-porto-prod

  # slow-log
  # Porto-Test
  - service: mysql_slow_query
    src:
      consumer: mdb/porto/test/logsdb-consumer
      topic: mdb/porto/test/mysql-slow-logs
      fields: &mysql-slow-logs
        - name: origin
          type: STRING
        - name: user
          type: STRING
        - name: id
          type: STRING
        - name: schema
          type: STRING
        - name: query
          type: STRING
        - name: last_errno
          type: UINT32
        - name: killed
          type: UINT32
        - name: query_time
          type: DOUBLE
        - name: lock_time
          type: DOUBLE
        - name: rows_sent
          type: UINT32
        - name: rows_examined
          type: UINT32
        - name: rows_affected
          type: UINT32
        - name: bytes_sent
          type: UINT64
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: ms
          type: UINT16
        - name: timestamp
          type: DATETIME
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: raw
          type: STRING
    dst: *dst-porto-test

  # Porto-Prod
  - service: mysql_slow_query
    src:
      consumer: mdb/porto/prod/logsdb-consumer
      topic: mdb/porto/prod/mysql-slow-logs
      fields: *mysql-slow-logs
    dst: *dst-porto-prod
