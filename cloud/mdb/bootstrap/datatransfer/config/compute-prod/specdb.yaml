---
{% set ch_tm_writer_password = yav('ver-01e61vbfqkm5c10ncgms3xjxgn', 'mdb-logsdb-consumer-compute-prod-user-password') %}
# Token can be obtained here:
# yc --profile=compute-prod iam create-token
token: {{ env.get('TOKEN') }}
endpoint: https://data-transfer-rest.private-api.ycp.cloud.yandex.net
logbroker: yc-logbroker
# Folder ID of MDB sink Clickhouse cluster
folder_id: b1g0r9fh49hee3rsc0aa
transfers:
  # Clickhouse
  - service: clickhouse
    src:
      consumer: b1ggh9onj7ljr7m9cici/dataplane/logsdb-consumer
      topic: b1ggh9onj7ljr7m9cici/dataplane/clickhouse-logs
      fields:
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: timestamp
          type: DATETIME
        - name: origin
          type: STRING
        - name: message
          type: STRING
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: component
          type: STRING
        - name: thread
          type: UINT32
        - name: severity
          type: STRING
        - name: query_id
          type: STRING
        - name: ms
          type: UINT16
    dst: &dst-compute-preprod
      database: mdb
      mdb_cluster_id: c9q2oes4qc45bh9s965s
      user: tm_writer
      password:
        raw: {{ ch_tm_writer_password }}

  # Mongodb
  - service: mongodb
    src:
      consumer: b1ggh9onj7ljr7m9cici/dataplane/logsdb-consumer
      topic: b1ggh9onj7ljr7m9cici/dataplane/mongodb-logs
      fields:
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: timestamp
          type: DATETIME
        - name: message
          type: STRING
        - name: origin
          type: STRING
        - name: severity
          type: STRING
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: component
          type: STRING
        - name: context
          type: STRING
        - name: ms
          type: UINT16
    dst: *dst-compute-preprod

  - service: mongodb_audit
    src:
      consumer: b1ggh9onj7ljr7m9cici/dataplane/logsdb-consumer
      topic: b1ggh9onj7ljr7m9cici/dataplane/mongodb-audit-logs
      format: json
      fields:
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: timestamp
          type: DATETIME
        - name: message
          type: STRING
        - name: origin
          type: STRING
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: ms
          type: UINT16
    dst: *dst-compute-preprod

  # Redis
  - service: redis
    src:
      consumer: b1ggh9onj7ljr7m9cici/dataplane/logsdb-consumer
      topic: b1ggh9onj7ljr7m9cici/dataplane/redis-logs
      fields:
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: timestamp
          type: DATETIME
        - name: origin
          type: STRING
        - name: message
          type: STRING
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: role
          type: STRING
        - name: pid
          type: UINT32
        - name: ms
          type: UINT16
    dst: *dst-compute-preprod

  # Elasticsearch
  - service: elasticsearch
    src:
      consumer: b1ggh9onj7ljr7m9cici/dataplane/logsdb-consumer
      topic: b1ggh9onj7ljr7m9cici/dataplane/elasticsearch-logs
      fields:
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: origin
          type: STRING
        - name: timestamp
          type: DATETIME
        - name: ms
          type: UINT16
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: level
          type: STRING
        - name: component
          type: STRING
        - name: message
          type: STRING
        - name: stacktrace
          type: STRING
    dst: *dst-compute-preprod

  # Kibana
  - service: kibana
    src:
      consumer: b1ggh9onj7ljr7m9cici/dataplane/logsdb-consumer
      topic: b1ggh9onj7ljr7m9cici/dataplane/kibana-logs
      fields:
        - name: datetime
          type: DATETIME
        - name: log_format
          type: STRING
        - name: origin
          type: STRING
        - name: timestamp
          type: DATETIME
        - name: ms
          type: UINT16
        - name: cluster
          type: STRING
        - name: hostname
          type: STRING
        - name: type
          type: STRING
        - name: message
          type: STRING
    dst: *dst-compute-preprod
