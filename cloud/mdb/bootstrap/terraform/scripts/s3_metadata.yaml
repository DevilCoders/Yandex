#cloud-config
users:
  - name: root
    lock_passwd: false
    hashed_passwd: $6$AmLQ4fU3$/0kqz7HlZRatHL6wCvgoqTed6JdHdNAStxKF2x0fCgRSQGqnIWvpPtazGN.RtgAZpdWvPBUnt/k2aBrUyGInW/
apt:
  preserve_sources_list: false
  sources_list: |
    deb http://mirror.yandex.ru/ubuntu bionic main restricted universe multiverse
    deb http://mirror.yandex.ru/ubuntu bionic-security main restricted universe multiverse
    deb http://mirror.yandex.ru/ubuntu bionic-updates main restricted universe multiverse
  sources:
    mdb-bionic.list:
      source: |
        deb http://dist.yandex.ru/mdb-bionic stable/all/
        deb http://dist.yandex.ru/mdb-bionic stable/$(ARCH)/
      key: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----
        Version: GnuPG v1

        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
        NAwjtc3xqQhs6e8yrlDAtw==
        =Zrbu
        -----END PGP PUBLIC KEY BLOCK-----
      filename: mdb-bionic-stable.list
bootcmd:
  - [ rm, -f, /etc/resolv.conf ]
  - [ bash, -c, 'echo -e "nameserver 2a02:6b8::1:1\nnameserver 2a02:6b8:0:3400::1" > /etc/resolv.conf' ]
package_update: true
package_upgrade: true
packages:
  - python
  - python-httplib2
  - [salt-common, 3000.9+ds-1+yandex0]
  - [salt-minion, 3000.9+ds-1+yandex0]
  - yandex-selfdns-client
  - config-caching-dns
  - mdb-config-salt
  - mdb-ssh-keys
  - mdadm
runcmd:
  - [ bash, -c, 'echo "${fqdn}" > /etc/hostname' ]
  - [ /bin/hostname, -F, /etc/hostname ]
%{ if nvme_disks > 0 ~}
  - [ /sbin/mdadm, --create, /dev/md0, --level=0, --force, --raid-devices=${nvme_disks}, ${ join(", ", formatlist("/dev/vd%s", split("", substr("abcdefghijklmnopqrstuvwxyz", 0, nvme_disks)))) } ]
  - [ /sbin/mkfs.ext4, -L, data, /dev/md0 ]
  - [ bash, -c, 'echo "LABEL=data ${datadir} ext4 errors=remount-ro 0 1" >> /etc/fstab' ]
  - [ mkdir, ${datadir} ]
  - [ mount, --label, data ]
%{ endif ~}
  - [ bash, -c, 'rm -f /etc/netplan/50-cloud-init.yaml' ]
%{ if cafile != "" ~}
  - [ /bin/mv, /opt/yandex/allCAs.pem.new, /opt/yandex/allCAs.pem ]
%{ endif ~}
  - [ /usr/sbin/service, salt-minion, restart ]
  - [ bash, -c, 'salt-call test.ping' ]
  - [ bash, -c, 'salt-call saltutil.sync_all' ]
  - [ /usr/sbin/service, salt-minion, stop ]
  - [ /bin/rm, -f, /tmp/.grains_conductor.cache ]
  - [ /usr/sbin/service, salt-minion, start ]
  - [ bash, -c, 'salt-call saltutil.sync_all' ]
  - [ bash, -c, 'echo "service =  $(salt-call pillar.get data:selfdns-api:service default=https://selfdns-api.yandex.net | tail -n 1)" >> /etc/yandex/selfdns-client/default.conf' ]
  - [ bash, -c, 'echo "token =  $(salt-call pillar.get data:selfdns-api:token default=0123456789 | tail -n 1)" >> /etc/yandex/selfdns-client/default.conf' ]
  - [ bash, -c, 'selfdns-client --debug --terminal' ]
  - [ bash, -c, "sed -i '/swapfile/d' /etc/fstab" ]
  - [ bash, -c, 'swapoff -a' ]
growpart:
  mode: auto
  devices: ['/']
  ignore_growroot_disabled: false
write_files:
  - path: /etc/yandex/mdb-deploy/deploy_version
    content: '2'
  - path: /etc/yandex/mdb-deploy/mdb_deploy_api_host
    content: ${deploy_api}
  - path: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
    content: 'network: {config: disabled}'
  - path: /etc/networkd-dispatcher/routable.d/10-route
    permissions: '0755'
    owner: 'root:root'
    content: |
      #!/bin/sh
      /sbin/ip -6 link set dev eth0 mtu 8950
      exit 0
%{ if cafile != "" ~}
  - path: /opt/yandex/allCAs.pem.new
    content: |
      ${ cafile }
%{ endif ~}
