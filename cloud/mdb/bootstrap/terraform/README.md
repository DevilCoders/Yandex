# Terraform config for MDB control plane
## Install Terraform
Best way to install terraform is to install [tfswitch](https://tfswitch.warrensbox.com/Install/). 
To switch terraform to required version inside the terraform configuration folder: 

    khattu@khattu-osx ~/g/s/a/c/m/b/t/preprod [1]> tfswitch
    Reading required version from terraform file, constraint: 0.12.29
    Matched version: 0.12.29
    Switched terraform to version "0.12.29"

## Usage
In order to use this config you need to provide vars.
The best way is to generate them.

    cd preprod
    ./generate-secret-vars.sh

Or yor can create `secrets.auto.tfvars` manually (this name is ignored by VCS) and fill it like so:
    s3_admin_access_key = "<s3_admin_access_key>"
    s3_admin_secret_key = "<s3_admin_secret_key>"

To initialize terraform config you need to provide keys to S3.

### S3 setup
- Install [direnv](https://direnv.net/)
- `.envrc` was generated by `./generate-secret-vars.sh` script.

#### Manual S3 setup

Values for S3 can be found at [preprod](https://yav.yandex-team.ru/secret/sec-01ebg2hcwqq4nr0mtqdbdx51g3)
and [prod](https://yav.yandex-team.ru/secret/sec-01ecpqahs4jrjg6beqg0jnxr97).

You can either provide ENV vars:

    set -x AWS_ACCESS_KEY_ID <access_key>
    set -x AWS_SECRET_ACCESS_KEY <secret_key>

Or you can create AWS credentials file `~/.aws/credentials` with profiles:

    [preprod]
    aws_access_key_id = <access_key>
    aws_secret_access_key = <secret_key>
    [prod]
    aws_access_key_id = <access_key>
    aws_secret_access_key = <secret_key>

In which case you can init terraform with required profile:

    terraform init -backend-config="profile=preprod"

#### Conductor provider
https://github.yandex-team.ru/spooner/terraform-provider-conductor
```
$ git clone https://github.yandex-team.ru/spooner/terraform-provider-conductor.git
$ cd terraform-provider-conductor/
terraform-provider-conductor (master|âœ”) $ go build -o ~/.terraform.d/plugins/yandex-team.ru/tools/conductor/0.1/${OS}_${ARCH}/terraform-provider-conductor 
```

### Run plan
#### Prerequisites
For provision scripts need to be installed requirements.txt from scripts folder.
To use environment variables from .envrc install and run terraform under https://direnv.net/
#### Run
To run plan you need initialized terraform:

    terraform init
To see changes:

    terraform plan
To apply changes:

    terraform plan -out out
    terraform apply "out"
### Adding new resourses
If you want to add new resources, write configuration and run `terraform plan` to ensure it is doing exactly as you want.
If you do not have rights to run `terraform apply`, then ask duty  to do so.

When adding new VMs you do not need to fill `data boot_disk` as in imported VMs.
Write desired disc config  inside VM's config.

      boot_disk {
        disk_spec {
          name      = "my favourite disk"
          size      = 30
          image_id  = "image_id"
          type_id   = "network_ssd"
        }
      }

## Naming
### Instances

All FQDNs should start with prefix `mdb-`, service name (`deploy`,`deploydb`, etc),
optional `-test`/`-preprod` part for non-prod envs,
instance number in (`01`), AZ-suffix (`vla`, `man`, `rc1a`, `gpn-spb99`), DNS zone (`db.yandex.net`):

    mdb-metadb-test01-man.db.yandex.net
    mdb-deploy01-sas.db.yandex.net
    mdb-deploydb-preprod01-rc1a.cloud-preprod.yandex.net
    mdb-mlock01-rc1c.yandexcloud.net
    mdb-report01-gpn-spb99.mdb.gpn.yandexcloud.net

## Networks, folders etc

Our config is based on [common bootstrap](https://bb.yandex-team.ru/projects/CLOUD/repos/bootstrap-templates/browse/terraform). Responsibles are [bootrstrap team](https://staff.yandex-team.ru/departments/yandex_exp_9053_9518_dep85042/), [support chat](https://t.me/joinchat/AIZQClhzwueeRBMiZPG_nw) Read [how to apply it](https://wiki.yandex-team.ru/cloud/devel/selfhost/terraform/#m-kakdobavitnovyeresursy). There you can add networks, folders etc.
