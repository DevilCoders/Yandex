# Generated by "make generate" from cloud/mdb/clickhouse/versions
info: Major update of deprecated ClickHouse version 21.10 to 22.3 LTS
repeatable: true
supports_offline: true
clusters_selection:
  db: >-
    WITH clusters AS (
        SELECT
            c.cid,
            CAST(string_to_array(p.value #>> '{data,clickhouse,ch_version}', '.') AS int[]) AS version_nums
         FROM dbaas.subclusters sc
         JOIN dbaas.clusters c USING(cid)
         JOIN dbaas.pillar p USING(subcid)
        WHERE c.status IN ('RUNNING', 'STOPPED')
          AND sc.roles && '{clickhouse_cluster}'
          AND CAST(p.value #>> '{data,clickhouse,unmanaged,major_updates_disabled}' AS bool) IS DISTINCT FROM true
          AND EXISTS (SELECT 1
                      FROM dbaas.hosts h
                      JOIN dbaas.flavors f ON (f.id = h.flavor)
                      WHERE subcid = h.subcid AND vtype = ANY(CAST('{porto,compute}' AS dbaas.virt_type[])))
    )
    SELECT c.cid
      FROM clusters c
     WHERE c.version_nums[1::2] = ARRAY[21, 10]
pillar_change: >-
  UPDATE dbaas.pillar p
     SET value = jsonb_set(value, '{data,clickhouse,ch_version}', to_jsonb(CAST('22.3.8.39' AS text)))
    FROM dbaas.subclusters sc
   WHERE p.subcid=sc.subcid
     AND sc.cid=:cid
     AND sc.roles && '{clickhouse_cluster}'
worker:
  operation_type: clickhouse_cluster_modify
  task_type: clickhouse_cluster_maintenance
  task_args_query: >-
    SELECT
        jsonb_build_object(
            'restart', true,
            'version_from', p.value #>> '{data,clickhouse,ch_version}',
            'version_to', '22.3.8.39'
        )
      FROM dbaas.clusters c
      JOIN dbaas.subclusters sc USING (cid)
      JOIN dbaas.pillar p USING (subcid)
     WHERE sc.roles && '{clickhouse_cluster}'
       AND c.cid = :cid
  timeout_query: >-
    SELECT
      CONCAT(
        CASE
          WHEN count(*) < 16
            THEN floor(log(2, count(*))) + 1
            ELSE floor((count(*) + 34) / 10)
          END * 2,
        'h')
      FROM dbaas.shards s
      JOIN dbaas.subclusters sc
      USING (subcid)
    WHERE sc.cid = :cid
      AND sc.roles && '{clickhouse_cluster}'
max_delay_days: 21
min_days: 7
