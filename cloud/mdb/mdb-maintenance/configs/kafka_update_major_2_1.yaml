info: Update Kafka cluster from 2.1 to 2.8.1
clusters_selection:
  db: >-
    SELECT cid
      FROM (
        SELECT cid,
             CAST(
               string_to_array(
                 regexp_replace(p.value #>> '{data,kafka,package_version}', '([\d\.]+)-.+', '\1'),
                 '.'
               ) AS int[]
             ) AS version_nums
        FROM dbaas.clusters c
        JOIN dbaas.pillar p USING(cid)
        WHERE c.type='kafka_cluster' AND c.status='RUNNING'
      ) x
    WHERE version_nums > ARRAY[2, 1]
      AND version_nums < ARRAY[2, 6]
pillar_change: >-
  UPDATE dbaas.pillar p
    SET value = jsonb_set(
      jsonb_set(
        jsonb_set(value, '{data,kafka,version}', to_jsonb(CAST('2.8' AS text))),
        '{data,kafka,inter_broker_protocol_version}', to_jsonb(CAST('2.1' AS text))),
    '{data,kafka,package_version}', to_jsonb(CAST('2.8.1.1-java11' AS text)))
   WHERE p.cid=:cid
worker:
  operation_type: kafka_cluster_upgrade
  task_type: kafka_cluster_upgrade
  task_args:
    restart: true
  timeout: 4h
max_delay_days: 21
min_days: 7
