CREATE TYPE dbaas.placement_group_status AS ENUM (
    'DESCRIBED',
    'CREATING',
    'CREATE-ERROR',
    'COMPLETE',
    'DELETING',
    'DELETE-ERROR',
    'DELETED'
);

CREATE TABLE dbaas.placement_groups (
    pg_id                       bigint GENERATED BY DEFAULT AS IDENTITY,
    cid                         text NOT NULL,
    subcid                      text,
    shard_id                    text,
    placement_group_id          text,
    status                      dbaas.placement_group_status NOT NULL,

    CONSTRAINT pk_placement_groups PRIMARY KEY (pg_id),

    CONSTRAINT fk_placement_groups_clusters FOREIGN KEY (cid)
        REFERENCES dbaas.clusters (cid) ON DELETE RESTRICT
);

CREATE UNIQUE INDEX uk_placement_groups_cid ON dbaas.placement_groups (cid);
CREATE UNIQUE INDEX uk_placement_groups_placement_group_id ON dbaas.placement_groups (placement_group_id) WHERE (placement_group_id IS NOT NULL);

comment on column dbaas.placement_groups.placement_group_id is 'The placement group id from API';

CREATE TABLE dbaas.placement_groups_revs (
    pg_id                       bigint GENERATED BY DEFAULT AS IDENTITY,
    rev                         bigint NOT NULL,
    cid                         text NOT NULL,
    subcid                      text,
    shard_id                    text,
    placement_group_id          text,
    status                      dbaas.placement_group_status NOT NULL,

    CONSTRAINT pk_placement_groups_revs PRIMARY KEY (pg_id, rev),

    CONSTRAINT fk_placement_groups_revs_clusters_revs FOREIGN KEY (cid, rev)
        REFERENCES dbaas.clusters_revs (cid, rev) ON DELETE CASCADE
);

CREATE INDEX i_placement_groups_revs_cid_rev
    ON dbaas.placement_groups_revs(cid, rev);
