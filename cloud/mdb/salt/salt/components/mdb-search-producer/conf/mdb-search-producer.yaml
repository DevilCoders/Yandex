{% set producer = salt.pillar.get('data:mdb-search-producer') %}
{% set use_yc_lb = producer.logbroker.use_yc_lb | default(False) %}
{% if not use_yc_lb %}
{% set tvmtool = salt.pillar.get('data:tvmtool') %}
{% endif %}
app:
    level: Debug
    instrumentation:
        addr: "[::1]:{{ producer.instrumentation.port }}"
    sentry:
        environment: {{ salt.pillar.get('data:sentry:environment') }}
        dsn: {{ producer.sentry.dsn }}
metadb:
    addrs: {{ salt.pillar.get('data:metadb:hosts') | tojson }}
    db: dbaas_metadb
    user: mdb_search_producer
    password: {{ salt.pillar.get('data:config:pgusers:mdb_search_producer:password') | yaml_encode }}
    sslmode: 'verify-full'
    sslrootcert: '/opt/yandex/allCAs.pem'
logbroker:
{% if use_yc_lb %}
    endpoint: {{ salt.pillar.get('data:yc_logbroker:address') }}
    database: {{ salt.pillar.get('data:yc_logbroker:database') }}
    tls:
      ca_file: '/opt/yandex/allCAs.pem'
    iam:
      token_service:
        endpoint: {{ salt.pillar.get('data:token_service:address') }}
        useragent: 'MDB Search Producer'
      service_account:
        id: {{ producer.service_account.id }}
        key_id: {{ producer.service_account.key_id }}
        private_key: {{ producer.service_account.private_key | yaml_encode }}
{% else %}
    endpoint: {{ producer.logbroker.endpoint | yaml_encode }}
    tvm:
      token: {{ tvmtool.token | yaml_encode }}
      logbroker_alias: logbroker
      client_alias: search-producer
      port: {{ tvmtool.port }}
{% endif %}
    topic: {{ producer.logbroker.topic | yaml_encode }}
    source_id: mdb-search-producer-{{ salt['grains.get']('id') }}

