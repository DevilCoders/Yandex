app:
  app_name: "mdb-secrets"
  logging:
    level: debug
    file: "/var/log/mdb-secrets/mdb-secrets.log"
  instrumentation:
    addr: "{{ salt['dbaas.pillar']('data:mdb-secrets:config:app:instrumentation:addr', '[::1]:6060') }}"
    shutdown_timeout: 1s
  sentry:
    dsn: {{ salt['dbaas.pillar']('data:mdb-secrets:config:app:sentry:dsn') }}
    environment: {{ salt['dbaas.pillar']('data:sentry:environment') }}
secretsdb:
  addrs:
{% for addr in salt['dbaas.pillar']('data:mdb-secrets:config:secretsdb:addrs') %}
    - {{ addr }}
{% endfor %}
  db: secretsdb
  user: secrets_api
  password: {{ salt['dbaas.pillar']('data:mdb-secrets:config:secretsdb:password') }}
  sslmode: 'verify-full'
  sslrootcert: '/opt/yandex/allCAs.pem'
  max_open_conn: {{ salt['dbaas.pillar']('data:mdb-secrets:config:secretsdb:max_open_conn', 32) }}
  max_idle_conn: {{ salt['dbaas.pillar']('data:mdb-secrets:config:secretsdb:max_idle_conn', 32) }}
auth:
{% set blackbox_enabled = salt['dbaas.pillar']('data:mdb-secrets:config:blackbox_enabled', True)  %}
  blackbox_enabled: {{ blackbox_enabled }}
{% if blackbox_enabled %}
  blackbox:
    tvmtool:
      alias: 'mdb-secrets'
      uri: http://localhost:{{ salt['dbaas.pillar']('data:tvmtool:port', 50001) }}
      token: {{ salt['dbaas.pillar']('data:tvmtool:token') }}
    blackbox_uri: {{ salt['dbaas.pillar']('data:mdb-secrets:config:blackbox:blackbox_uri', 'http://blackbox.yandex-team.ru') }}
    blackbox_alias: {{ salt['dbaas.pillar']('data:mdb-secrets:config:blackbox:blackbox_alias', 'blackbox') }}
{% endif %}
{% set iam_enabled = salt['dbaas.pillar']('data:mdb-secrets:config:iam_enabled', False) %}
  iam_enabled: {{ iam_enabled }}
{% if iam_enabled %}
  iam:
    host: {{ salt['dbaas.pillar']('data:mdb-secrets:config:iam:host') }}
    permission: {{ salt['dbaas.pillar']('data:mdb-secrets:config:iam:permission', 'mdb.internal.secrets') }}
    cloud_id: {{ salt['dbaas.pillar']('data:mdb-secrets:config:iam:cloud_id') }}
    client: {{ salt['dbaas.pillar']('data:mdb-secrets:config:iam:client', 'mdb secrets') }}
{% endif %}
saltkey: {{ salt['dbaas.pillar']('data:mdb-secrets:config:saltkey') }}
privatekey: {{ salt['dbaas.pillar']('data:mdb-secrets:config:privatekey') }}
{% set certificate_to_use = salt['dbaas.pillar']('data:mdb-secrets:config:certificate_to_use', 'cloud') %}
certificate_to_use: {{ certificate_to_use }}  # cloud or yandex
{% if certificate_to_use == 'yandex' %}
yandex_crt:
  oauth: {{ salt['dbaas.pillar']('data:mdb-secrets:config:yandex_crt:oauth') }}
  abc: {{ salt['dbaas.pillar']('data:mdb-secrets:config:yandex_crt:abc') }}
  url: {{ salt['dbaas.pillar']('data:mdb-secrets:config:yandex_crt:url', 'https://crt-api.yandex-team.ru/api/certificate/') }}
{% else %}
cloud_crt:
  url: {{ salt['dbaas.pillar']('data:mdb-secrets:config:cloud_crt:url') }}
  # YC.MDB
  abc_service_id: {{ salt['dbaas.pillar']('data:mdb-secrets:config:cloud_crt:abc_service_id', 1895) }}
  oauth: {{ salt['dbaas.pillar']('data:mdb-secrets:config:cloud_crt:oauth') }}
{% endif %}
