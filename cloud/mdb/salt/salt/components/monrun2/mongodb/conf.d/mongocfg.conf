[mongocfg_up]
execution_interval=60
execution_timeout=10

{% if salt.pillar.get('data:mongodb:use_mongocfg') %}
{%- set mongodb = salt.slsutil.renderer('salt://components/mongodb/defaults.py?saltenv=' ~ saltenv) %}
{%- set username = 'monitor' %}
{%- set password = mongodb.users['monitor'].password %}
{%- set host = salt.grains.get('id') %}
{%- set authdb = 'admin' %}
{%  set uri =  'mongodb://{0}:{1}@{2}:{3}/{4}?appname=mdb_monrun{5}'.format(username, password, host, mongodb.config.mongocfg.net.port, authdb, mongodb.config.mongocfg.cli.ssl_uri_args) %}
command=/usr/local/yandex/monitoring/mongodb.py --action up --uri '{{uri}}'
{% else %}
command=echo '0;OK'
{% endif %}
type=mongodb
{% if salt.pillar.get('data:dbaas:vtype') == 'compute' and salt.pillar.get('data:dbaas:cluster_id') %}
send_for_host={{ salt.dbaas.managed_hostname() }}
{% endif %}
