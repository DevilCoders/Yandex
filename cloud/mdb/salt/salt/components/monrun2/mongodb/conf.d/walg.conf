{% from "components/mongodb/walg/map.jinja" import walg with context %}
{%- set send_for_host_opt = '' %}
{%- if salt.pillar.get('data:dbaas:vtype') == 'compute' and salt.pillar.get('data:dbaas:cluster_id') %}
{%-   set send_for_host_opt = 'send_for_host=' + salt.dbaas.managed_hostname() %}
{%- endif %}

[walg_backup_age]
execution_interval=1200
execution_timeout=180
start_random_sleep=1000
{% if walg.enabled %}
command=/usr/local/yandex/monitoring/mongodb_walg_backup_age.py --warn-max-count {{salt.pillar.get('data:backup:retain_period', 7) + 1}} --warn-old 2 --crit-old 3
{% else %}
command=echo "0;OK"
{% endif %}
type=backup
{{ send_for_host_opt }}

[walg_oplog_push]
execution_interval=60
execution_timeout=10
{% if walg.oplog_push %}
command=/usr/local/yandex/monitoring/mongodb_walg_oplog_push.py --warn-lag 600 --crit-lag 3600
{% else %}
command=echo "0;OK"
{% endif %}
type=backup
{{ send_for_host_opt }}

