{% set mongodb = salt.slsutil.renderer('salt://components/mongodb/defaults.py?saltenv=' ~ saltenv) %}

{%- set username = 'monitor' %}
{%- set password = mongodb.users['monitor'].password %}
{%- set host = salt.grains.get('id') %}
{%- set authdb = 'admin' %}
{%- set send_for_host_opt = '' %}
{%- if salt.pillar.get('data:dbaas:vtype') == 'compute' and salt.pillar.get('data:dbaas:cluster_id') %}
{%-   set send_for_host_opt = 'send_for_host=' + salt.dbaas.managed_hostname() %}
{%- endif %}

{%- for srv in mongodb.services_deployed if srv != 'mongos' %}
{%   set config = mongodb.config.get(srv) %}
{%   set uri =  'mongodb://{0}:{1}@{2}:{3}/{4}?appname=mdb_monrun{5}'.format(username, password, host, config.net.port, authdb, config.cli.ssl_uri_args) %}
[mongodb_ping]
execution_interval=60
execution_timeout=10
command=/usr/local/yandex/monitoring/mongodb.py --action up --uri '{{uri}}'
type=mongodb
{{ send_for_host_opt }}

[mongodb_role_changed]
execution_interval=60
execution_timeout=10
command=/usr/local/yandex/monitoring/mongodb.py --action role --uri '{{uri}}'
type=mongodb
{{ send_for_host_opt }}

[mongodb_locked_queue]
execution_interval=60
execution_timeout=10
command=/usr/local/yandex/monitoring/mongodb.py --action locked_queue --uri '{{uri}}' --critical 5000 --warning 1000
type=mongodb
{{ send_for_host_opt }}

[mongodb_primary_exists]
execution_interval=60
execution_timeout=10
command=/usr/local/yandex/monitoring/mongodb.py --action master --uri '{{uri}}'
type=mongodb
{{ send_for_host_opt }}

[mongodb_replication_lag]
execution_interval=60
execution_timeout=10
command=/usr/local/yandex/monitoring/mongodb.py --action lag --uri '{{uri}}'
type=mongodb
{{ send_for_host_opt }}

[mongodb_session_count]
execution_interval=60
execution_timeout=30
command=/usr/local/yandex/monitoring/mongodb_session_count.sh
type=mongodb
{{ send_for_host_opt }}

{% set uri_tpl =  'mongodb://{0}:{1}/{2}?appname=mdb_monrun{3}'.format('{host}', '{port}', authdb, config.cli.ssl_uri_args) %}
[mongodb_shard_primaries]
execution_interval=600
execution_timeout=300
command=/usr/bin/timeout 120s /usr/local/yandex/monitoring/mongodb_shard_primaries.py --srv {{srv}} --uri-template '{{uri_tpl}}' || echo '1;Timeout reached'
type=mongodb
{{ send_for_host_opt }}

{%- endfor %}

{% set srv = 'mongos' %}
{% if srv in mongodb.services_deployed %}
{%   set config = mongodb.config.get(srv) %}
{%   set uri =  'mongodb://{0}:{1}@{2}:{3}/{4}?appname=mdb_monrun{5}'.format(username, password, host, config.net.port, authdb, config.cli.ssl_uri_args) %}
[mongos_ping]
execution_interval=60
execution_timeout=10
command=/usr/local/yandex/monitoring/mongodb.py --action up --uri '{{uri}}'
type=mongodb
{{ send_for_host_opt }}

[mongos_actionlog_errors]
execution_interval=60
execution_timeout=10
command=/usr/local/yandex/monitoring/mongodb.py --action actionlog_errors --silent --uri '{{uri}}'
type=mongodb
{{ send_for_host_opt }}

{% endif %}
