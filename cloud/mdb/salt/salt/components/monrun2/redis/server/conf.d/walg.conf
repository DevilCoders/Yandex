{% from "components/redis/walg/map.jinja" import walg with context %}
{%- set send_for_host_opt = '' %}
{%- if salt.pillar.get('data:dbaas:vtype') == 'compute' and salt.pillar.get('data:dbaas:cluster_id') %}
{%-   set send_for_host_opt = 'send_for_host=' + salt.dbaas.managed_hostname() %}
{%- endif %}
{% set is_walg_enabled = salt.mdb_redis.is_walg_enabled() %}

[walg_backup_age]
execution_interval=1200
execution_timeout=180
start_random_sleep=1000
{% if is_walg_enabled %}
command=/usr/local/yandex/monitoring/walg_backup_age.py --warn-max-count 32 --warn-old 2 --crit-old 5
{% else %}
command=echo "0;OK"
{% endif %}
type=backup
{{ send_for_host_opt }}
