{% set mongodb = salt.slsutil.renderer('salt://components/mongodb/defaults.py?saltenv=' ~ saltenv) %}

{% set srv = None %}
{% if mongodb.use_mongod %}
{%   set srv = 'mongod' %}
{% elif mongodb.use_mongocfg %}
{%   set srv = 'mongocfg' %}
{% endif %}

{% set host = salt.grains.get('id') %}
{% set port = mongodb.config.get(srv).net.port %}
{% set username = 'admin' %}
{% set password = mongodb.users.get(username).password %}
{% set dbname = 'admin' %}
{% set rs_host_count = salt.mdb_mongodb_helpers.replset_hosts(srv)|length %}
{% set is_ha_cluster = rs_host_count > 2%}
{% set is_one_node_cluster = rs_host_count == 1%}

mongodb:
    port: {{port}}
    auth: True
    username: {{username}}
    password: {{password}}
    database: {{dbname}}
    options:
{% if mongodb.use_ssl %}
        ssl: "true"
        ssl_ca_certs: {{mongodb.config_prefix}}/ssl/allCAs.pem
{% else %}
        ssl: "false"
{% endif %}

control:
    service_ctl: sysvinit

resetup:
    replset_checks:
        quorum:
            enabled: {{ is_ha_cluster }}
            warn_only: False
            reserved_votes: 0
        write_concern:
            enabled: True
            warn_only: False
{% if is_ha_cluster %}
            required: "majority"
{% else %}
            required: 1
{% endif %}
            lag_threshold:
                seconds: 30
        eta_acceptable:
            enabled: True
            warn_only: True
            multiplier: 1.2
            net_bps: 4194304

stepdown:
    replset_checks:
        quorum:
            enabled: {{ is_ha_cluster }}
            warn_only: False
            reserved_votes: 0
        write_concern:
            enabled: True
            warn_only: False
{% if is_ha_cluster %}
            required: "majority"
{% else %}
            required: 1
{% endif %}
            lag_threshold:
                seconds: 30
        fresh_secondaries:
            enabled: True
            warn_only: False
            hosts_required: 1
            lag_threshold:
                seconds: 30

getter:
    replset_checks:
        quorum:
            enabled: {{ is_ha_cluster }}
            warn_only: False
            reserved_votes: 0
        write_concern:
            enabled: {{ not is_one_node_cluster }}
            warn_only: False
{% if is_ha_cluster %}
            required: "majority"
{% else %}
            required: 1
{% endif %}
            lag_threshold:
                seconds: 30
        fresh_secondaries:
            enabled: {{ not is_one_node_cluster }}
            warn_only: False
            hosts_required: 1
            lag_threshold:
                seconds: 30
