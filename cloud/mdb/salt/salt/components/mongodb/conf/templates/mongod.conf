{% set mongodb = salt.slsutil.renderer('salt://components/mongodb/defaults.py?saltenv=' ~ saltenv) %}
{% set config = mongodb.config.get('mongod') %}
{% set mongodb_version = salt.mdb_mongodb.version() %}
{% set mongodb_full_version = mongodb_version.full_num | int %}
{% set mongodb_edition = mongodb_version.edition %}

{% if mongodb_edition != 'enterprise' %}
cloud:
    monitoring:
        free:
            state: off
{% endif %}
systemLog:
    destination: file
    path: "{{ config.systemLog.path }}"
    logAppend: true
    logRotate: reopen
{% if mongodb_edition == 'enterprise' %}
auditLog:
   destination: file
   path: "{{config.auditLog.path}}"
   format: JSON
   filter: '{{config.auditLog.filter}}'
{%   if mongodb_version.major_num | int >= 500 %}
   runtimeConfiguration: {{ 'true' if config.auditLog.runtimeConfiguration else 'false' }}
{%   endif %}
{% endif %}
storage:
    dbPath: "{{config.storage.dbPath}}"
    syncPeriodSecs: {{config.storage.syncPeriodSecs}}
    directoryPerDB: true
    journal:
        enabled: {{ 'true' if config.storage.journal.enabled else 'false' }}
        commitIntervalMs: {{config.storage.journal.commitInterval}}
    engine: {{config.storage.engine}}
{% if config.storage.engine == 'wiredTiger' %}
    wiredTiger:
        engineConfig:
            cacheSizeGB: {{config.storage.wiredTiger.engineConfig.cacheSizeGB}}
        collectionConfig:
            blockCompressor: {{config.storage.wiredTiger.collectionConfig.blockCompressor}}
{% endif %}
{% if mongodb.sharding_enabled %}
sharding:
    clusterRole: shardsvr
{% endif %}
processManagement:
    pidFilePath: "{{config.processManagement.pidFilePath}}"
replication:
    replSetName: "{{config.replication.replSetName}}"
operationProfiling:
    slowOpThresholdMs: {{config.operationProfiling.slowOpThresholdMs}}
    mode: {{config.operationProfiling.mode}}
net:
    bindIpAll: true
    port: {{config.net.port}}
    ipv6: true
    maxIncomingConnections: {{config.net.maxIncomingConnections}}
    maxIncomingConnectionsOverride:
{% for v in config.net.maxIncomingConnectionsOverride + salt.mdb_mongodb_helpers.get_cluster_conn_override() %}
      -  {{ v }}
{% endfor %}
    reservedAdminThreads: {{config.net.reservedAdminThreads}}
{% if mongodb.use_ssl %}
{%   if mongodb_version.major_num | int < 402 %}
    ssl:
{%   else %}
    tls:
{%   endif %}
        mode: {{config.net.ssl.mode}}
        CAFile: {{mongodb.config_prefix}}/ssl/allCAs.pem
        allowConnectionsWithoutCertificates: true
{%   if mongodb_version.major_num | int < 402 %}
        PEMKeyFile: {{mongodb.config_prefix}}/ssl/certkey.pem
{%   else %}
        certificateKeyFile: {{mongodb.config_prefix}}/ssl/certkey.pem
{%   endif %}
        disabledProtocols: {{config._settings.tlsDisabledProtocols}}
{% endif %}
{% if mongodb_version.major_num | int > 400 %}
    compression:
        compressors: "zstd,snappy,zlib"
{% endif %}
setParameter:
    honorSystemUmask: true
{% if mongodb.use_auth %}
    enableLocalhostAuthBypass: true
{% endif %}
{% if (mongodb_version.major_num | int) < 404 %}
    failIndexKeyTooLong: false
{% endif %}
{% if (mongodb_version.major_num | int) >= 402 %}
    enableFlowControl: false
{% endif %}
{% if mongodb.low_memory %}
    maxIndexBuildMemoryUsageMegabytes: 100
    tcmallocReleaseRate: 2.0
    tcmallocAggressiveMemoryDecommit: 1
{% endif %}
{% for k, v in config.setParameter.items() %}
    {{k}}: {{v | yaml_encode}}
{% endfor %}
{% if mongodb.use_auth or config.security.enableEncryption %}
security:
{% if mongodb.cluster_auth == 'keyfile' %}
    clusterAuthMode: keyFile
    keyFile: {{mongodb.config_prefix}}/mongodb.key
{% endif %}
{% if config.security.enableEncryption %}
    enableEncryption: true
    kmip:
        serverName: {{config.security.kmip.serverName}}
        port: {{config.security.kmip.port}}
        serverCAFile: {{mongodb.config_prefix}}/ssl/kmip_ca.pem
        clientCertificateFile: {{mongodb.config_prefix}}/ssl/kmip_client.pem
{% if config.security.kmip.keyIdentifier %}
        keyIdentifier: "{{config.security.kmip.keyIdentifier}}"
{% endif %}
        #clientCertificatePassword: NONE
        #connectRetries: 10
        #connectTimeoutMS: 10000
        #rotateMasterKey: false
{% endif %}
{% endif %}
