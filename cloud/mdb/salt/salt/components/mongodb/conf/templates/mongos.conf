{% set mongodb = salt.slsutil.renderer('salt://components/mongodb/defaults.py?saltenv=' ~ saltenv) %}
{% set config = mongodb.config.get('mongos') %}
{% set mongodb_version = salt.mdb_mongodb.version() %}
{% set mongodb_full_version = mongodb_version.full_num | int %}
{% set mongodb_edition = mongodb_version.edition %}
{% set cores = salt.pillar.get('data:dbaas:flavor:cpu_guarantee') | float %}

systemLog:
    destination: file
    path: "{{ config.systemLog.path }}"
    logAppend: true
    logRotate: reopen
{% if mongodb_edition == 'enterprise' %}
auditLog:
   destination: file
   path: "{{config.auditLog.path}}"
   format: JSON
{% endif %}
sharding:
    configDB: "{{config.sharding.configDB}}"
processManagement:
    pidFilePath: "{{config.processManagement.pidFilePath}}"
replication:
    localPingThresholdMs: {{config.replication.localPingThresholdMs}}
{# new in mongodb 4
operationProfiling:
    slowOpThresholdMs: {{config.operationProfiling.slowOpThresholdMs}}
    slowOpSampleRate: {{config.operationProfiling.slowOpSampleRate}}
    mode: {{config.operationProfiling.mode}}
#}
net:
    bindIpAll: true
    port: {{config.net.port}}
    ipv6: true
    maxIncomingConnections: {{config.net.maxIncomingConnections}}
    maxIncomingConnectionsOverride:
{% for v in config.net.maxIncomingConnectionsOverride + salt.mdb_mongodb_helpers.get_cluster_conn_override() %}
      -  {{ v }}
{% endfor %}
    reservedAdminThreads: {{config.net.reservedAdminThreads}}
{% if mongodb.use_ssl %}
{%   if mongodb_version.major_num | int < 402 %}
    ssl:
{%   else %}
    tls:
{%   endif %}
        mode: {{config.net.ssl.mode}}
        CAFile: {{mongodb.config_prefix}}/ssl/allCAs.pem
        allowConnectionsWithoutCertificates: true
{%   if mongodb_version.major_num | int < 402 %}
        PEMKeyFile: {{mongodb.config_prefix}}/ssl/certkey.pem
{%   else %}
        certificateKeyFile: {{mongodb.config_prefix}}/ssl/certkey.pem
{%   endif %}
        disabledProtocols: {{config._settings.tlsDisabledProtocols}}
{% endif %}
{% if mongodb_version.major_num | int > 400 %}
    compression:
        compressors: "zstd,snappy,zlib"
{% endif %}
setParameter:
    honorSystemUmask: true
    taskExecutorPoolSize: {{config.setParameter.get('taskExecutorPoolSize', (cores * 0.75 , 1) | max | int) }}
{% if mongodb.low_memory %}
    tcmallocReleaseRate: 2.0
    tcmallocAggressiveMemoryDecommit: 1
{% endif %}
{% for k, v in config.setParameter.items() if k not in ['taskExecutorPoolSize'] %}
    {{k}}: {{v}}
{% endfor %}
{% if mongodb.use_auth %}
security:
{% if mongodb.cluster_auth == 'keyfile' %}
    clusterAuthMode: keyFile
    keyFile: {{mongodb.config_prefix}}/mongodb.key
{% endif %}
{% endif %}
