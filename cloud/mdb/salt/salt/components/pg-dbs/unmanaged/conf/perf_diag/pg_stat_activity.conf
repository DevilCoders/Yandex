{% if salt['pillar.get']('data:dbaas:flavor:cpu_limit') %}
    {% set cpu = salt['pillar.get']('data:dbaas:flavor:cpu_limit')|int %}
{% else %}
    {% set cpu = 4 %}
{% endif %}
{% if cpu > 2 %}
    {% set default_interval = 1 %}
{% else %}
    {% set default_interval = 60 %}
{% endif %}
{% set interval = salt['pillar.get']('data:perf_diag:pgsa_sample_period', default_interval)|int %} 
{
    "args": {
        "config": {
            "activity_log_file": "/var/log/dbaas-pg-stat-reporter/pg-stat-activity.log",
            "service_log_file": "/var/log/dbaas-pg-stat-reporter/service_activity.log",
            "rotate_size": 10485760,
            "backup_count": 1,
            "conn_string": "dbname=postgres user=monitor connect_timeout=1 host=localhost",
            "cluster_id": "{{ salt['pillar.get']('data:dbaas:cluster_id', salt['pillar.get']('data:perf_diag:cluster_id')) }}",
            "cluster_name": "{{ salt['pillar.get']('data:dbaas:cluster_name', salt['pillar.get']('data:perf_diag:cluster_name')) }}"
        }
    },
    "id": "pg_stat_activity",
    "misfire_grace_time": {{ interval }},
    "module": "pg_stat_activity",
    "schedule": {
        "seconds": {{ interval }},
        "trigger": "interval"
    },
    "timeout": {{ interval+55 }}
}
