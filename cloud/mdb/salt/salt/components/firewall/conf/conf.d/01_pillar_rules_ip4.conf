{% set rules = salt['pillar.get']('firewall', {}) or salt['pillar.get']('data:firewall', {}) %}
{% set nameserver = salt['mdb_resolv_conf.get_compute_dns']() %}
table filter {
    chain INPUT {
        policy {{ rules.get('policy', 'ACCEPT') }};

{% for sense in 'ACCEPT', 'REJECT', 'DROP' %}
{%     for rule in rules.get(sense, {}) %}
{%         set ip4_addrs = [] %}
{%         set typ = rule['type'] %}
{%         if 'proto' in rule %}
{%             set proto = rule['proto']|join(' ') %}
{%         else %}
{%             set proto = 'tcp' %}
{%         endif %}
{%         if typ == 'addr4' %}
{%             set ip4_addrs = [rule['net']] if rule['net'] is string else rule['net'] %}
{%         elif typ == 'macro' %}
{%             set ip4_addrs = salt['golem.fw'](rule['net'], 'ip4') %}
{%         elif typ == 'fqdn' %}
{%             set ip4_addrs = salt['mdb_network.resolve_fqdn'](rule['net'], 'A', nameserver=nameserver) %}
{%         elif typ == 'pillar_fqdn' %}
{%             set host_list = salt['pillar.get'](rule['net']) %}
{%             if host_list is string %}
{%                 set host_list = [host_list] %}
{%             endif %}
{%             for host in host_list %}
{%                 do ip4_addrs.extend(salt['mdb_network.resolve_fqdn'](host, 'A', nameserver=nameserver)) %}
{%             endfor %}
{%         endif %}
{%         if rule.get('ports_function') %}
{%             set ports = salt[rule['ports_function']]() %}
{%         else %}
{%             set ports = rule.get('ports') %}
{%         endif %}
{%         if ip4_addrs %}
        # {{ typ }} {{ rule['net'] | string }}: {{ sense }}
        saddr (
{%             for src_host in ip4_addrs %}
            {{ src_host }}
{%             endfor %}
        ) proto ({{ proto }})
{%             if rule.get('int') %}
        interface {{ rule['int'] }}
{%             endif %}
{%             if ports %}
        mod multiport destination-ports ( {{ ports | join(' ') }} )
{%             endif %}
        {{sense}};

{%         endif %}
{%     endfor %}
{% endfor %}
    }
}
