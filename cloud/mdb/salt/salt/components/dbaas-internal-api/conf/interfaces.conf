{% set balancer6 = salt['pillar.get']('balancer6', '') %}
{% set balancer4 = salt['pillar.get']('balancer4', '') %}
{% set addr = salt['pillar.get']('addr', '') %}
{% set gw = salt['pillar.get']('balancer_gw', 'fe80::1') %}
{% set noc_magic_addr = '2a02:6b8:0:3400::aaaa' %}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet6 dhcp
    accept_ra 1

auto eth1
iface eth1 inet6 static
    address {{ addr }}
    post-up /sbin/ip -6 route add {{ balancer6 }}/128 via {{ gw }} dev eth1 mtu 1450 advmss 1390 table 200
    pre-down /sbin/ip -6 route del {{ balancer6 }}/128 via {{ gw }} dev eth1 mtu 1450 advmss 1390 table 200
    post-up /sbin/ip -6 route add 2a02:6b8::/32 dev eth0
    pre-down /sbin/ip -6 route del 2a02:6b8::/32 dev eth0
    pre-up echo 0 > /proc/sys/net/ipv6/conf/eth1/accept_ra

auto ip6tnl0
iface ip6tnl0 inet manual
    mtu 8950
    up modprobe ip6_tunnel || true
    up ifconfig ip6tnl0 up mtu 8950
    post-up sysctl "net.ipv4.conf.ip6tnl0.rp_filter=0" || true
    post-up /sbin/ip -6 route add default via {{ gw }} dev eth1 mtu 1450 advmss 1390 table 200
    pre-down /sbin/ip -6 route del default via {{ gw }} dev eth1 mtu 1450 advmss 1390 table 200
    down ifconfig ip6tnl0 down

auto lo:200
iface lo:200 inet manual
    up /sbin/ip address add {{ balancer6 }} dev lo label lo:200
    post-up /sbin/ip -6 rule add from {{ balancer6 }} lookup 200
    pre-down /sbin/ip -6 rule del from {{ balancer6 }} lookup 200
    down /sbin/ip address del {{ balancer6 }} dev lo label lo:200


auto 4to6tun0
iface 4to6tun0 inet manual
    pre-up ip -6 tun change ip6tnl0 mode any || true
    pre-up ip -6 tunnel add 4to6tun0 mode ipip6 remote {{ noc_magic_addr }} local {{ addr }}
    up ifconfig 4to6tun0 up
    post-up /sbin/ip route add default dev 4to6tun0 mtu 1450 advmss 1410 table 666
    pre-down /sbin/ip route del default dev 4to6tun0 mtu 1450 advmss 1410 table 666
    post-up /sbin/ip -6 route add {{ noc_magic_addr }} via fe80::1 dev eth1
    pre-down /sbin/ip -6 route del {{ noc_magic_addr }} via fe80::1 dev eth1
    pre-down ip -6 tunnel del 4to6tun0

auto lo:201
iface lo:201 inet manual
    up /sbin/ip address add {{ balancer4 }} dev lo label lo:201
    post-up /sbin/ip rule add from {{ balancer4 }} lookup 666
    pre-down /sbin/ip rule del from {{ balancer4 }} lookup 666
    down /sbin/ip address del {{ balancer4 }} dev lo label lo:201
