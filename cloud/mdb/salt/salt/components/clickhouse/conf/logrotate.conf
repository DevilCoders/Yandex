/var/log/clickhouse-server/clickhouse-server*.log {
    daily
    maxsize 200M
    rotate 99
    delaycompress
    compress
    missingok
    su clickhouse clickhouse
    create 644 clickhouse clickhouse
    sharedscripts
    # This script is required because logrotate by itself is unable to calculate
    # the total sum of all compressed files after they were rotated.
    #
    # Do rotation before, because rotation itself may lead to disk overquota.
    prerotate
        chmod -R a+r /var/log/clickhouse-server/
        /usr/local/yandex/log_curator.py clear-old-logs --pool /var/log/clickhouse-server/ --size 400M --mask 'clickhouse-server.err.log.*gz'
        /usr/local/yandex/log_curator.py clear-old-logs --pool /var/log/clickhouse-server/ --size 1600M --mask 'clickhouse-server.log.*gz'
        flock -n -o /tmp/log-curator.lock /usr/local/yandex/log_curator.py truncate-unrotatable --pool /var/log/clickhouse-server/ --mask 'clickhouse-server.*log'
    endscript
    postrotate
        kill -HUP `cat /run/clickhouse-server/clickhouse-server.pid`
        pkill -f clickhouse_server_log_parser.py
    endscript
}

{% if salt.mdb_clickhouse.has_separated_keeper() %}
/var/log/clickhouse-keeper/clickhouse-keeper*.log {
    daily
    maxsize 200M
    rotate 99
    delaycompress
    compress
    missingok
    su clickhouse clickhouse
    create 644 clickhouse clickhouse
    sharedscripts
    # This script is required because logrotate by itself is unable to calculate
    # the total sum of all compressed files after they were rotated.
    #
    # Do rotation before, because rotation itself may lead to disk overquota.
    prerotate
        chmod -R a+r /var/log/clickhouse-keeper/
        /usr/local/yandex/log_curator.py clear-old-logs --pool /var/log/clickhouse-keeper/ --size 400M --mask 'clickhouse-keeper.err.log.*gz'
        /usr/local/yandex/log_curator.py clear-old-logs --pool /var/log/clickhouse-keeper/ --size 1600M --mask 'clickhouse-keeper.log.*gz'
        flock -n -o /tmp/log-curator.lock /usr/local/yandex/log_curator.py truncate-unrotatable --pool /var/log/clickhouse-keeper/ --mask 'clickhouse-keeper.*log'
    endscript
    postrotate
        kill -HUP `cat /run/clickhouse-keeper/clickhouse-keeper.pid`
    endscript
}

{% endif %}
/var/log/clickhouse-server/clickhouse-odbc*.log {
    size 50M
    rotate 99
    compress
    missingok
    copytruncate
    notifempty
    su clickhouse clickhouse
    sharedscripts
    prerotate
        /usr/local/yandex/log_curator.py clear-old-logs --pool /var/log/clickhouse-server/ --size 50M --mask 'clickhouse-odbc.*gz'
    endscript
    postrotate
        kill -HUP `cat /run/clickhouse-server/clickhouse-server.pid`
    endscript
}

/var/log/clickhouse-server/stdout.log
/var/log/clickhouse-server/stderr.log
{
    size 50M
    rotate 99
    compress
    missingok
    copytruncate
    notifempty
    su clickhouse clickhouse
    sharedscripts
    prerotate
        /usr/local/yandex/log_curator.py clear-old-logs --pool /var/log/clickhouse-server/ --size 50M --mask 'std(out|err).*gz'
    endscript
    postrotate
        kill -HUP `cat /run/clickhouse-server/clickhouse-server.pid`
    endscript
}
{% if salt.mdb_clickhouse.has_separated_keeper() %}

/var/log/clickhouse-keeper/stdout.log
/var/log/clickhouse-keeper/stderr.log
{
    size 50M
    rotate 99
    compress
    missingok
    copytruncate
    notifempty
    su clickhouse clickhouse
    sharedscripts
    prerotate
        /usr/local/yandex/log_curator.py clear-old-logs --pool /var/log/clickhouse-keeper/ --size 50M --mask 'std(out|err).*gz'
    endscript
    postrotate
        kill -HUP `cat /run/clickhouse-keeper/clickhouse-keeper.pid`
    endscript
}
{% endif %}