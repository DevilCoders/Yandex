[pg_s3meta_bucket_proc]
plugin = postgres
module = pg_proc_stat
interval = 5

prefix = s3_bucket
query = SELECT
        usename AS backend_type,
        regexp_replace(regexp_replace(substring(query, $$i_bucket_name=>'([^,]+)'$$), 'internal-dbaas-.+', 'internal-dbaas'), 'yandexcloud-dbaas-.+', 'yandexcloud-dbaas') AS usename,
        coalesce(substring(query, $$sql: ([^\ ]+)$$), substring(query, $$\.([a-z_]+)\($$)) AS datname,
        array_agg(pid) AS pids
    FROM pg_stat_activity
    WHERE
        datname = 's3meta'
        AND usename NOT IN ('monitor', 'postgres', 'repl', 'admin')
        AND state = 'active'
        AND pid != pg_backend_pid()
        AND backend_type = 'client backend'
        AND query !~ 'SET application_name'
    GROUP BY 1, 2, 3
    LIMIT 10

yasm_suffix = tmmx
yasm_tags_cmd = /usr/local/yasmagent/mail_postgresql_getter.py
