[ch_disk_parts]
plugin = common
module = ch_query
interval = {{ 15 if not is_burst else (15, min_burst_interval) | max }}
prefix = ch

{% if salt.mdb_clickhouse.version_cmp('20.8') >= 0 %}
query = SELECT concat(d.type, '_disk_parts_size') AS metric,
               sum(p.bytes_on_disk) AS value
    FROM system.parts AS p
    INNER JOIN system.disks AS d ON p.disk_name = d.name
    GROUP BY d.type
    FORMAT JSON;
{% else %}
query = SELECT 'local_disk_parts_size' AS metric,
               sum(p.bytes_on_disk) AS value
    FROM system.parts AS p
    FORMAT JSON;
{% endif %}
databases = system
clickhouse_user = _metrics
{% if salt['mdb_clickhouse.ssl_enabled']() %}
clickhouse_protocol = https
clickhouse_port = 8443
ca_path = {{ salt['mdb_clickhouse.ca_path']() }}
{% endif %}

yasm_suffix = tmmx
yasm_tags_db = clickhouse
