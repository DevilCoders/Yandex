[ch_merges]
plugin = common
module = ch_query
interval = {{ 600 if not is_burst else (600, min_burst_interval) | max}}
send_interval = {{ 15 if not is_burst else (15, min_burst_interval) | max }}
prefix = ch_merged
report_current = False
report_inc = True

query = SELECT 'bytes' AS metric, sum(read_bytes) AS value
    FROM system.part_log
    WHERE event_type = 'MergeParts' AND database != 'system'

    UNION ALL

    SELECT 'rows' AS metric, sum(read_rows) AS value
    FROM system.part_log
    WHERE event_type = 'MergeParts' AND database != 'system'

    FORMAT JSON;

databases = system

yasm_suffix = tmmv,tmmx
yasm_tags_db = clickhouse
yasm_ttl = 1200

clickhouse_timeout=30
clickhouse_user = _metrics

{% if salt['mdb_clickhouse.ssl_enabled']() %}
clickhouse_protocol = https
clickhouse_port = 8443
ca_path = {{ salt['mdb_clickhouse.ca_path']() }}
{% endif %}
